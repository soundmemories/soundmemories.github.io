<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Monda:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"soundmemories.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":true,"version":"8.17.1","exturl":true,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="åŸºç¡€ä»‹ç» ç®€å•ç¤ºä¾‹ 1.å®‰è£… 12pip install fastapipip install uvicorn 2.åˆ›å»ºé¡¹ç›® main.py1234567891011import unicornfrom fastapi import FastAPIapp &#x3D; FastAPI()@app.get(&quot;&#x2F;&quot;)async def root():    return &amp;#123">
<meta property="og:type" content="article">
<meta property="og:title" content="FastAPI">
<meta property="og:url" content="https://soundmemories.github.io/2024/10/09/Python/23.FastAPI/index.html">
<meta property="og:site_name" content="SoundMemories">
<meta property="og:description" content="åŸºç¡€ä»‹ç» ç®€å•ç¤ºä¾‹ 1.å®‰è£… 12pip install fastapipip install uvicorn 2.åˆ›å»ºé¡¹ç›® main.py1234567891011import unicornfrom fastapi import FastAPIapp &#x3D; FastAPI()@app.get(&quot;&#x2F;&quot;)async def root():    return &amp;#123">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-10-08T16:00:00.000Z">
<meta property="article:modified_time" content="2024-11-01T08:16:32.542Z">
<meta property="article:author" content="SoundMemories">
<meta property="article:tag" content="Python">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://soundmemories.github.io/2024/10/09/Python/23.FastAPI/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":"","permalink":"https://soundmemories.github.io/2024/10/09/Python/23.FastAPI/","path":"2024/10/09/Python/23.FastAPI/","title":"FastAPI"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>FastAPI | SoundMemories</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">SoundMemories</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="æœç´¢" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾<span class="badge">10</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»<span class="badge">10</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£<span class="badge">129</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.</span> <span class="nav-text">åŸºç¡€ä»‹ç»</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E7%A4%BA%E4%BE%8B"><span class="nav-number">2.</span> <span class="nav-text">ç®€å•ç¤ºä¾‹</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#api%E9%85%8D%E7%BD%AE"><span class="nav-number">3.</span> <span class="nav-text">APIé…ç½®</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#api%E5%8F%82%E6%95%B0"><span class="nav-number">3.1.</span> <span class="nav-text">APIå‚æ•°</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E6%A1%A3%E5%8F%82%E6%95%B0"><span class="nav-number">3.2.</span> <span class="nav-text">æ–‡æ¡£å‚æ•°</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1%E6%93%8D%E4%BD%9C"><span class="nav-number">4.</span> <span class="nav-text">è·¯ç”±æ“ä½œ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%93%8D%E5%BA%94%E7%A0%81"><span class="nav-number">4.1.</span> <span class="nav-text">å“åº”ç </span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1%E5%8F%82%E6%95%B0"><span class="nav-number">4.2.</span> <span class="nav-text">è·¯ç”±å‚æ•°</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%B7%AF%E5%BE%84%E5%8F%82%E6%95%B0"><span class="nav-number">5.</span> <span class="nav-text">è·¯å¾„å‚æ•°</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8"><span class="nav-number">5.1.</span> <span class="nav-text">åŸºç¡€ä½¿ç”¨</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8C"><span class="nav-number">5.2.</span> <span class="nav-text">å‚æ•°æ ¡éªŒ</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E5%8F%82%E6%95%B0"><span class="nav-number">6.</span> <span class="nav-text">æŸ¥è¯¢å‚æ•°</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8-1"><span class="nav-number">6.1.</span> <span class="nav-text">åŸºç¡€ä½¿ç”¨</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8C-1"><span class="nav-number">6.2.</span> <span class="nav-text">å‚æ•°æ ¡éªŒ</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A0%A1%E9%AA%8C%E7%B1%BB%E5%9E%8B"><span class="nav-number">7.</span> <span class="nav-text">è‡ªå®šä¹‰æ ¡éªŒç±»å‹</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#pydantic%E6%A8%A1%E5%9E%8B"><span class="nav-number">7.1.</span> <span class="nav-text">Pydanticæ¨¡å‹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pydantic%E5%B5%8C%E5%A5%97%E6%A8%A1%E5%9E%8B"><span class="nav-number">7.2.</span> <span class="nav-text">PydanticåµŒå¥—æ¨¡å‹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pydantic%E7%89%B9%E6%AE%8A%E7%B1%BB%E5%9E%8B"><span class="nav-number">7.3.</span> <span class="nav-text">Pydanticç‰¹æ®Šç±»å‹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dataclass%E6%A8%A1%E5%9E%8B"><span class="nav-number">7.4.</span> <span class="nav-text">dataclassæ¨¡å‹</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%AF%B7%E6%B1%82%E4%BD%93"><span class="nav-number">8.</span> <span class="nav-text">è¯·æ±‚ä½“</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8-2"><span class="nav-number">8.1.</span> <span class="nav-text">åŸºç¡€ä½¿ç”¨</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%9A%E5%8F%82%E6%95%B0%E6%B7%B7%E5%90%88"><span class="nav-number">8.2.</span> <span class="nav-text">å¤šå‚æ•°æ··åˆ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8C-2"><span class="nav-number">8.3.</span> <span class="nav-text">å‚æ•°æ ¡éªŒ</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#cookie%E5%8F%82%E6%95%B0"><span class="nav-number">9.</span> <span class="nav-text">Cookieå‚æ•°</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%93%8D%E5%BA%94cookie"><span class="nav-number">10.</span> <span class="nav-text">å“åº”Cookie</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#header%E5%8F%82%E6%95%B0"><span class="nav-number">11.</span> <span class="nav-text">Headerå‚æ•°</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%93%8D%E5%BA%94header"><span class="nav-number">12.</span> <span class="nav-text">å“åº”Header</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%93%8D%E5%BA%94%E6%96%B9%E5%BC%8F"><span class="nav-number">13.</span> <span class="nav-text">å“åº”æ–¹å¼</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%93%8D%E5%BA%94%E6%A8%A1%E5%9E%8B"><span class="nav-number">14.</span> <span class="nav-text">å“åº”æ¨¡å‹</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="nav-number">15.</span> <span class="nav-text">å¼‚å¸¸å¤„ç†</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%A1%A8%E5%8D%95%E5%8F%82%E6%95%B0"><span class="nav-number">16.</span> <span class="nav-text">è¡¨å•å‚æ•°</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E5%8F%82%E6%95%B0"><span class="nav-number">17.</span> <span class="nav-text">æ–‡ä»¶å‚æ•°</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BC%96%E7%A0%81%E5%85%BC%E5%AE%B9"><span class="nav-number">18.</span> <span class="nav-text">ç¼–ç å…¼å®¹</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96%E9%A1%B9"><span class="nav-number">19.</span> <span class="nav-text">ä¾èµ–é¡¹</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%AB%98%E7%BA%A7%E4%BE%9D%E8%B5%96%E9%A1%B9"><span class="nav-number">20.</span> <span class="nav-text">é«˜çº§ä¾èµ–é¡¹</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E5%85%A8%E6%80%A7"><span class="nav-number">21.</span> <span class="nav-text">å®‰å…¨æ€§</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#oauth2%E7%AE%80%E5%8D%95%E7%9A%84-password-%E5%92%8C-bearer-%E9%AA%8C%E8%AF%81"><span class="nav-number">21.1.</span> <span class="nav-text">OAuth2ç®€å•çš„ Password å’Œ
Bearer éªŒè¯</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#oauth2%E5%AE%9E%E7%8E%B0%E5%AF%86%E7%A0%81%E5%93%88%E5%B8%8C%E4%B8%8Ebearer-jwt%E4%BB%A4%E7%89%8C%E9%AA%8C%E8%AF%81"><span class="nav-number">21.2.</span> <span class="nav-text">OAuth2å®ç°å¯†ç å“ˆå¸Œä¸Bearer
JWTä»¤ç‰ŒéªŒè¯</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#oauth2%E4%BD%9C%E7%94%A8%E5%9F%9F"><span class="nav-number">21.3.</span> <span class="nav-text">OAuth2ä½œç”¨åŸŸ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#http%E5%9F%BA%E7%A1%80%E6%8E%88%E6%9D%83"><span class="nav-number">21.4.</span> <span class="nav-text">HTTPåŸºç¡€æˆæƒ</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="nav-number">22.</span> <span class="nav-text">ä¸­é—´ä»¶</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%AB%98%E7%BA%A7%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="nav-number">23.</span> <span class="nav-text">é«˜çº§ä¸­é—´ä»¶</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AD%90%E8%B7%AF%E7%94%B1"><span class="nav-number">24.</span> <span class="nav-text">å­è·¯ç”±</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%90%8E%E5%8F%B0%E4%BB%BB%E5%8A%A1"><span class="nav-number">25.</span> <span class="nav-text">åå°ä»»åŠ¡</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6"><span class="nav-number">26.</span> <span class="nav-text">é™æ€æ–‡ä»¶</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%8C%82%E8%BD%BD%E5%AD%90%E5%BA%94%E7%94%A8"><span class="nav-number">27.</span> <span class="nav-text">æŒ‚è½½å­åº”ç”¨</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8%E8%AF%B7%E6%B1%82"><span class="nav-number">28.</span> <span class="nav-text">ç›´æ¥ä½¿ç”¨è¯·æ±‚</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E"><span class="nav-number">29.</span> <span class="nav-text">æ¨¡æ¿å¼•æ“</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#websockets%E9%80%9A%E4%BF%A1"><span class="nav-number">30.</span> <span class="nav-text">WebSocketsé€šä¿¡</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E5%85%B3%E9%97%AD%E4%BA%8B%E4%BB%B6"><span class="nav-number">31.</span> <span class="nav-text">åº”ç”¨å¯åŠ¨å…³é—­äº‹ä»¶</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95"><span class="nav-number">32.</span> <span class="nav-text">æ¥å£æµ‹è¯•</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="nav-number">33.</span> <span class="nav-text">å‚è€ƒæ–‡çŒ®</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="SoundMemories"
      src="/images/avstar.png">
  <p class="site-author-name" itemprop="name">SoundMemories</p>
  <div class="site-description" itemprop="description">ä»Šæ—¥äº‹ï¼Œä»Šæ—¥æ¯•</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">129</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3NvdW5kbWVtb3JpZXM=" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;soundmemories"><i class="fab fa-github fa-fw"></i>GitHub</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="bWFpbHRvOnNvdW5kbWVtb3JpZXNAMTYzLmNvbQ==" title="E-Mail â†’ mailto:soundmemories@163.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</span>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC8="><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></span>
  </div>

        </div>
      </div>
    </div>

    
        <div class="pjax">
        </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://soundmemories.github.io/2024/10/09/Python/23.FastAPI/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avstar.png">
      <meta itemprop="name" content="SoundMemories">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SoundMemories">
      <meta itemprop="description" content="ä»Šæ—¥äº‹ï¼Œä»Šæ—¥æ¯•">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="FastAPI | SoundMemories">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          FastAPI
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2024-10-09 00:00:00" itemprop="dateCreated datePublished" datetime="2024-10-09T00:00:00+08:00">2024-10-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>18k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>1:04</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="åŸºç¡€ä»‹ç»">åŸºç¡€ä»‹ç»</h1>
<h1 id="ç®€å•ç¤ºä¾‹">ç®€å•ç¤ºä¾‹</h1>
<p>1.å®‰è£…<br />
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install fastapi</span><br><span class="line">pip install uvicorn</span><br></pre></td></tr></table></figure></p>
<p>2.åˆ›å»ºé¡¹ç›®<br />
<figure class="highlight python"><figcaption><span>main.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> unicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">root</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Hello World&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    uvicorn.run(app, host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">8000</span>)</span><br></pre></td></tr></table></figure></p>
<p>3.å¯åŠ¨é¡¹ç›®<br />
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mainæŒ‡main.pyï¼ŒappæŒ‡FastAPIå®ä¾‹</span></span><br><span class="line"><span class="comment"># --host 0.0.0.0è¡¨ç¤ºç›‘å¬æ‰€æœ‰åœ°å€ï¼Œ--port 8000è¡¨ç¤ºç›‘å¬8000ç«¯å£ï¼Œ--workersè¡¨ç¤ºå¯åŠ¨å¤šä¸ªè¿›ç¨‹ï¼Œ--reloadè¡¨ç¤ºå¼€å¯çƒ­é‡è½½</span></span><br><span class="line">uvicorn main:app --host 0.0.0.0 --port 8000 --workers 4 --reload</span><br></pre></td></tr></table></figure></p>
<h1 id="apié…ç½®">APIé…ç½®</h1>
<h2 id="apiå‚æ•°">APIå‚æ•°</h2>
<p><code>FastAPI()</code>ä¸­çš„å‚æ•°ï¼ŒæŒ‡å®šAPIçš„å…ƒæ•°æ®å’Œè‡ªåŠ¨æ–‡æ¡£ä½¿ç”¨çš„å­—æ®µï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">å‚æ•°                ç±»å‹        æè¿°</span><br><span class="line">title               <span class="built_in">str</span>         APIçš„æ ‡é¢˜</span><br><span class="line">summary             <span class="built_in">str</span>         APIçš„ç®€è¦æè¿°</span><br><span class="line">description         <span class="built_in">str</span>         APIçš„è¯¦ç»†æè¿°</span><br><span class="line">vsersion            <span class="built_in">str</span>         APIçš„ç‰ˆæœ¬</span><br><span class="line">terms_of_service    <span class="built_in">str</span>         APIçš„æœåŠ¡æ¡æ¬¾URLï¼Œå¿…é¡»ä¸ºURL</span><br><span class="line">contact             <span class="built_in">dict</span>        å…¬å¼€çš„APIè”ç³»ä¿¡æ¯ï¼Œå¿…é¡»ä¸º<span class="built_in">dict</span>ï¼ŒåŒ…å«nameã€urlã€emailå­—æ®µ</span><br><span class="line">license_of          <span class="built_in">dict</span>        å…¬å¼€çš„APIè®¸å¯è¯ä¿¡æ¯ï¼Œå¿…é¡»ä¸º<span class="built_in">dict</span>ï¼ŒåŒ…å«nameã€urlå­—æ®µ</span><br></pre></td></tr></table></figure></p>
<p>1.ä½¿ç”¨ç¤ºä¾‹ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">description = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">ChimichangApp API helps you do awesome stuff. ğŸš€</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## Items</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">You can **read items**.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## Users</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">You will be able to:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">* **Create users** (_not implemented_).</span></span><br><span class="line"><span class="string">* **Read users** (_not implemented_).</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">app = FastAPI(</span><br><span class="line">    title=<span class="string">&quot;ChimichangApp&quot;</span>,</span><br><span class="line">    description=description,</span><br><span class="line">    summary=<span class="string">&quot;Deadpool&#x27;s favorite app. Nuff said.&quot;</span>,</span><br><span class="line">    version=<span class="string">&quot;0.0.1&quot;</span>,</span><br><span class="line">    terms_of_service=<span class="string">&quot;http://example.com/terms/&quot;</span>,</span><br><span class="line">    contact=&#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Deadpoolio the Amazing&quot;</span>,</span><br><span class="line">        <span class="string">&quot;url&quot;</span>: <span class="string">&quot;http://x-force.example.com/contact/&quot;</span>,</span><br><span class="line">        <span class="string">&quot;email&quot;</span>: <span class="string">&quot;dp@x-force.example.com&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    license_info=&#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Apache 2.0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;url&quot;</span>: <span class="string">&quot;https://www.apache.org/licenses/LICENSE-2.0.html&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_items</span>():</span><br><span class="line">    <span class="keyword">return</span> [&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Katana&quot;</span>&#125;]</span><br></pre></td></tr></table></figure></p>
<h2 id="æ–‡æ¡£å‚æ•°">æ–‡æ¡£å‚æ•°</h2>
<p>1.FastAPIæä¾›äº†åŸºäºOpenAPIçš„æ–‡æ¡£ç”Ÿæˆå™¨ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line"><span class="comment"># OpenAPI æ¨¡å¼æœåŠ¡äº /openapi.jsonï¼Œå¯ä»¥é€šè¿‡å‚æ•° openapi_url å¯¹å…¶è¿›è¡Œé…ç½®</span></span><br><span class="line"><span class="comment"># å®Œå…¨ç¦ç”¨ OpenAPI æ¨¡å¼ï¼Œå¯ä»¥å°†å…¶è®¾ç½®ä¸º openapi_url=Noneï¼Œè¿™æ ·ä¹Ÿä¼šç¦ç”¨ä½¿ç”¨å®ƒçš„æ–‡æ¡£ç”¨æˆ·ç•Œé¢</span></span><br><span class="line">app = FastAPI(openapi_url=<span class="string">&quot;/api/v1/openapi.json&quot;</span>) <span class="comment"># å°†å…¶è®¾ç½®ä¸ºæœåŠ¡äº /api/v1/openapi.json</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_items</span>():</span><br><span class="line">    <span class="keyword">return</span> [&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Foo&quot;</span>&#125;]</span><br></pre></td></tr></table></figure></p>
<p>2.å¯ä»¥é€šè¿‡<code>docs_url</code>å’Œ<code>redoc_url</code>å‚æ•°é…ç½®ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line"><span class="comment"># Swagger UI æœåŠ¡äº /docsï¼Œå¯ä»¥é€šè¿‡å‚æ•° docs_url è®¾ç½®å®ƒçš„ URLï¼Œdocs_url=None ç¦ç”¨å®ƒ</span></span><br><span class="line"><span class="comment"># ReDoc æœåŠ¡äº /redocï¼Œå¯ä»¥ä½¿ç”¨å‚æ•° redoc_url è®¾ç½®å®ƒçš„ URLï¼Œredoc_url=None ç¦ç”¨å®ƒ</span></span><br><span class="line">app = FastAPI(docs_url=<span class="string">&quot;/documentation&quot;</span>, redoc_url=<span class="literal">None</span>) <span class="comment"># è®¾ç½® Swagger UI æœåŠ¡äº /documentation å¹¶ç¦ç”¨ ReDoc</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_items</span>():</span><br><span class="line">    <span class="keyword">return</span> [&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Foo&quot;</span>&#125;]</span><br></pre></td></tr></table></figure></p>
<h1 id="è·¯ç”±æ“ä½œ">è·¯ç”±æ“ä½œ</h1>
<p>åœ¨å¼€å‘ API æ—¶ï¼Œé€šå¸¸ä½¿ç”¨ç‰¹å®šçš„ HTTP
æ–¹æ³•å»æ‰§è¡Œç‰¹å®šçš„è¡Œä¸ºï¼Œé€šå¸¸ä½¿ç”¨ï¼š<br />
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POSTï¼šåˆ›å»ºæ•°æ®ã€‚</span><br><span class="line">GETï¼šè¯»å–æ•°æ®ã€‚</span><br><span class="line">PUTï¼šæ›´æ–°æ•°æ®ã€‚</span><br><span class="line">DELETEï¼šåˆ é™¤æ•°æ®ã€‚</span><br></pre></td></tr></table></figure></p>
<p>FastAPIä¸­å®šä¹‰çš„è·¯å¾„æ“ä½œè£…é¥°å™¨ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.get()</span></span><br><span class="line"><span class="meta">@app.post()</span></span><br><span class="line"><span class="meta">@app.put()</span></span><br><span class="line"><span class="meta">@app.delete()</span></span><br><span class="line"><span class="meta">@app.options()</span></span><br><span class="line"><span class="meta">@app.head()</span></span><br><span class="line"><span class="meta">@app.patch()</span></span><br><span class="line"><span class="meta">@app.trace()</span></span><br></pre></td></tr></table></figure></p>
<h2 id="å“åº”ç ">å“åº”ç </h2>
<p>1.å¯ä»¥åœ¨è·¯ç”±ä¸­ä½¿ç”¨ <code>status_code</code> å‚æ•°å£°æ˜ç”¨äº "å“åº”æˆåŠŸ"
çš„ HTTP çŠ¶æ€ç ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/items/&quot;</span>, status_code=<span class="number">201</span></span>) </span><span class="comment"># status_codeçŠ¶æ€ç </span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_item</span>(<span class="params">name: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;name&quot;</span>: name&#125;</span><br></pre></td></tr></table></figure></p>
<p>2.<code>status_code</code>
è¿˜å¯ä»¥æ¥æ”¶<code>fastapi.status</code>ä¸­çš„å¿«æ·å˜é‡ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, status</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"><span class="comment"># HTTP_201_CREATEDä¸ºfastapiä¸­çš„å¿«æ·å˜é‡</span></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/items/&quot;</span>, status_code=status.HTTP_201_CREATED</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_item</span>(<span class="params">name: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;name&quot;</span>: name&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># status_code è¿˜èƒ½æ¥æ”¶ IntEnum ç±»å‹ï¼Œæ¯”å¦‚ Python çš„ http.HTTPStatus</span></span><br><span class="line"><span class="comment"># status_code è¿˜èƒ½æ¥æ”¶ starlette.status</span></span><br></pre></td></tr></table></figure></p>
<p>3.é¢å¤–çš„çŠ¶æ€ç ï¼Œæ¯”å¦‚ï¼Œæ›´æ–°æ—¶æ­£å¸¸è¿”å›200ï¼Œä½†æ¡ç›®ä¸å­˜åœ¨æ—¶å¸Œæœ›åˆ›å»ºå®ƒå¹¶è¿”å›201ï¼Œæ­¤æ—¶éœ€è¦JSONResponseï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Union</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Body, FastAPI, status</span><br><span class="line"><span class="keyword">from</span> fastapi.responses <span class="keyword">import</span> JSONResponse</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line">items = &#123;<span class="string">&quot;foo&quot;</span>: &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Fighters&quot;</span>, <span class="string">&quot;size&quot;</span>: <span class="number">6</span>&#125;, <span class="string">&quot;bar&quot;</span>: &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Tenders&quot;</span>, <span class="string">&quot;size&quot;</span>: <span class="number">3</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">upsert_item</span>(<span class="params"></span></span><br><span class="line"><span class="params">    item_id: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">    name: <span class="type">Union</span>[<span class="built_in">str</span>, <span class="literal">None</span>] = Body(<span class="params">default=<span class="literal">None</span></span>),</span></span><br><span class="line"><span class="params">    size: <span class="type">Union</span>[<span class="built_in">int</span>, <span class="literal">None</span>] = Body(<span class="params">default=<span class="literal">None</span></span>),</span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    <span class="keyword">if</span> item_id <span class="keyword">in</span> items:</span><br><span class="line">        item = items[item_id]</span><br><span class="line">        item[<span class="string">&quot;name&quot;</span>] = name</span><br><span class="line">        item[<span class="string">&quot;size&quot;</span>] = size</span><br><span class="line">        <span class="keyword">return</span> item <span class="comment"># æ›´æ–°æ—¶æ­£å¸¸è¿”å›200</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        item = &#123;<span class="string">&quot;name&quot;</span>: name, <span class="string">&quot;size&quot;</span>: size&#125;</span><br><span class="line">        items[item_id] = item</span><br><span class="line">        <span class="comment"># æ¡ç›®ä¸å­˜åœ¨æ—¶å¸Œæœ›åˆ›å»ºå®ƒå¹¶è¿”å›201</span></span><br><span class="line">        <span class="keyword">return</span> JSONResponse(status_code=status.HTTP_201_CREATED, content=item)</span><br></pre></td></tr></table></figure></p>
<h2 id="è·¯ç”±å‚æ•°">è·¯ç”±å‚æ•°</h2>
<p>1.è·¯ç”±è¯·æ±‚ä¸­çš„å‚æ•°ï¼Œé™¤äº†<code>status_code</code>ï¼Œè¿˜æœ‰<code>tags</code>æ·»åŠ æ ‡ç­¾ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Set</span>, <span class="type">Union</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Item</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="type">Union</span>[<span class="built_in">str</span>, <span class="literal">None</span>] = <span class="literal">None</span></span><br><span class="line">    price: <span class="built_in">float</span></span><br><span class="line">    tax: <span class="type">Union</span>[<span class="built_in">float</span>, <span class="literal">None</span>] = <span class="literal">None</span></span><br><span class="line">    tags: <span class="type">Set</span>[<span class="built_in">str</span>] = <span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨Swaggeræ–‡æ¡£ä¸­ï¼Œtagså­—æ®µä¼šæŠŠåŒä¸€æ ‡ç­¾è¯·æ±‚æ˜¾ç¤ºåœ¨ä¸€èµ·ï¼Œç›¸å½“äºåˆ†ç±»äº†</span></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/items/&quot;</span>, response_model=Item, tags=[<span class="string">&quot;items&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_item</span>(<span class="params">item: Item</span>):</span><br><span class="line">    <span class="keyword">return</span> item</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span>, tags=[<span class="string">&quot;items&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_items</span>():</span><br><span class="line">    <span class="keyword">return</span> [&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Foo&quot;</span>, <span class="string">&quot;price&quot;</span>: <span class="number">42</span>&#125;]</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/&quot;</span>, tags=[<span class="string">&quot;users&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_users</span>():</span><br><span class="line">    <span class="keyword">return</span> [&#123;<span class="string">&quot;username&quot;</span>: <span class="string">&quot;johndoe&quot;</span>&#125;]</span><br></pre></td></tr></table></figure></p>
<p>2.æ”¯æŒ
<code>summary</code>ï¼Œ<code>description</code>ï¼Œ<code>response_description</code>ï¼Œ<code>deprecated=True</code>è·¯å¾„å¼ƒç”¨ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Set</span>, <span class="type">Union</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Item</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="type">Union</span>[<span class="built_in">str</span>, <span class="literal">None</span>] = <span class="literal">None</span></span><br><span class="line">    price: <span class="built_in">float</span></span><br><span class="line">    tax: <span class="type">Union</span>[<span class="built_in">float</span>, <span class="literal">None</span>] = <span class="literal">None</span></span><br><span class="line">    tags: <span class="type">Set</span>[<span class="built_in">str</span>] = <span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="meta">    <span class="string">&quot;/items/&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="meta">    response_model=Item,</span></span></span><br><span class="line"><span class="params"><span class="meta">    summary=<span class="string">&quot;Create an item&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="meta">    description=<span class="string">&quot;Create an item with all the information, name, description, price, tax and a set of unique tags&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="meta">    response_description=<span class="string">&quot;The created item&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="meta">    deprecated=<span class="literal">True</span></span></span></span><br><span class="line"><span class="params"><span class="meta"></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_item</span>(<span class="params">item: Item</span>):</span><br><span class="line">    <span class="keyword">return</span> item</span><br></pre></td></tr></table></figure></p>
<p>3.å½“æè¿°å†…å®¹æ¯”è¾ƒé•¿ä¸”å ç”¨å¤šè¡Œæ—¶ï¼Œå¯ä»¥åœ¨å‡½æ•°çš„ docstring
ä¸­å£°æ˜ï¼ŒFastAPI ä¼šè‡ªåŠ¨æå–åˆ°Swaggerï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Set</span>, <span class="type">Union</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Item</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="type">Union</span>[<span class="built_in">str</span>, <span class="literal">None</span>] = <span class="literal">None</span></span><br><span class="line">    price: <span class="built_in">float</span></span><br><span class="line">    tax: <span class="type">Union</span>[<span class="built_in">float</span>, <span class="literal">None</span>] = <span class="literal">None</span></span><br><span class="line">    tags: <span class="type">Set</span>[<span class="built_in">str</span>] = <span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/items/&quot;</span>, response_model=Item, summary=<span class="string">&quot;Create an item&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_item</span>(<span class="params">item: Item</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Create an item with all the information:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    - **name**: each item must have a name</span></span><br><span class="line"><span class="string">    - **description**: a long description</span></span><br><span class="line"><span class="string">    - **price**: required</span></span><br><span class="line"><span class="string">    - **tax**: if the item doesn&#x27;t have tax, you can omit this</span></span><br><span class="line"><span class="string">    - **tags**: a set of unique tag strings for this item</span></span><br><span class="line"><span class="string">    \f</span></span><br><span class="line"><span class="string">    æ¢é¡µç¬¦ï¼Œ\fåé¢çš„å†…å®¹ä¸ä¼šå‡ºç°åœ¨æ–‡æ¡£ä¸­</span></span><br><span class="line"><span class="string">    :param item: User input.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> item</span><br></pre></td></tr></table></figure></p>
<h1 id="è·¯å¾„å‚æ•°">è·¯å¾„å‚æ•°</h1>
<h2 id="åŸºç¡€ä½¿ç”¨">åŸºç¡€ä½¿ç”¨</h2>
<p>1.FastAPI æ”¯æŒä½¿ç”¨ Python
å­—ç¬¦ä¸²æ ¼å¼åŒ–è¯­æ³•å£°æ˜<strong>è·¯å¾„å‚æ•°</strong>ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>) </span><span class="comment"># è¿™æ®µä»£ç æŠŠè·¯å¾„å‚æ•°item_idçš„å€¼ä¼ é€’ç»™è·¯å¾„å‡½æ•°çš„å‚æ•°item_idã€‚</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_item</span>(<span class="params">item_id</span>): </span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;item_id&quot;</span>: item_id&#125;</span><br></pre></td></tr></table></figure></p>
<p>2.ä½¿ç”¨Pythonæ ‡å‡†ç±»å‹æ³¨è§£ï¼Œå£°æ˜è·¯å¾„æ“ä½œå‡½æ•°ä¸­è·¯å¾„å‚æ•°çš„<strong>ç±»å‹</strong>ï¼ŒFastAPIé€šè¿‡ç±»å‹å£°æ˜<strong>è‡ªåŠ¨è§£æ</strong>è¯·æ±‚ä¸­çš„æ•°æ®ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_item</span>(<span class="params">item_id: <span class="built_in">int</span></span>): <span class="comment"># æŠŠitem_idçš„ç±»å‹å£°æ˜ä¸ºintã€‚</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;item_id&quot;</span>: item_id&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¿é—®http://127.0.0.1:8000/items/3ï¼Œè¿”å›å“åº”&#123;&quot;item_id&quot;:3&#125;</span></span><br><span class="line"><span class="comment"># æ³¨æ„ï¼Œè‡ªåŠ¨è§£æï¼Œå‡½æ•°æ¥æ”¶å¹¶è¿”å›çš„å€¼æ˜¯ 3ï¼ˆ intï¼‰ï¼Œä¸æ˜¯ &quot;3&quot;ï¼ˆstrï¼‰ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¿é—®http://127.0.0.1:8000/items/fooï¼Œä¼šè¿”å›æŠ¥é”™ä¿¡æ¯ï¼Œè¿™æ˜¯å› ä¸ºè·¯å¾„å‚æ•°item_idçš„å€¼ï¼ˆ&quot;foo&quot;ï¼‰çš„ç±»å‹ä¸æ˜¯intã€‚</span></span><br></pre></td></tr></table></figure></p>
<p>3.è·¯å¾„æ“ä½œæ˜¯æŒ‰é¡ºåºæ‰§è¡Œçš„ï¼Œæ‰€ä»¥é¡ºåºå¾ˆé‡è¦ï¼Œæ¯”å¦‚æœ‰ä¸¤ä¸ªè·¯å¾„<code>/users/me</code>å’Œ<code>/users/&#123;user_id&#125;</code>ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸€å®šè¦åœ¨ /users/&#123;user_id&#125; ä¹‹å‰å£°æ˜ /users/meï¼Œå¦åˆ™ /users/me ä¼šè¢« /users/&#123;user_id&#125; åŒ¹é…åˆ°ä»è€ŒæŠ¥é”™ã€‚</span></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/me&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_user_me</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;user_id&quot;</span>: <span class="string">&quot;the current user&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/&#123;user_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_user</span>(<span class="params">user_id: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;user_id&quot;</span>: user_id&#125;</span><br></pre></td></tr></table></figure></p>
<p>4.è·¯å¾„å‚æ•°å¯ä»¥ç”¨Enumé™åˆ¶èŒƒå›´ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ModelName</span>(<span class="built_in">str</span>, Enum):</span><br><span class="line">    alexnet = <span class="string">&quot;alexnet&quot;</span></span><br><span class="line">    resnet = <span class="string">&quot;resnet&quot;</span></span><br><span class="line">    lenet = <span class="string">&quot;lenet&quot;</span></span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/models/&#123;model_name&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_model</span>(<span class="params">model_name: ModelName</span>): <span class="comment"># model_nameçš„å€¼åªèƒ½æ˜¯ModelNameä¸­å®šä¹‰çš„å€¼</span></span><br><span class="line">    <span class="comment"># 1.å¯é€šè¿‡ ModelName.xx è®¿é—®æšä¸¾å€¼</span></span><br><span class="line">    <span class="keyword">if</span> model_name <span class="keyword">is</span> ModelName.alexnet:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;model_name&quot;</span>: model_name, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Deep Learning FTW!&quot;</span>&#125;</span><br><span class="line">    <span class="comment"># 2.å¯é€šè¿‡ model_name.value è®¿é—®æšä¸¾å€¼</span></span><br><span class="line">    <span class="keyword">if</span> model_name.value == <span class="string">&quot;lenet&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;model_name&quot;</span>: model_name, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;LeCNN all the images&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;model_name&quot;</span>: model_name, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Have some residuals&quot;</span>&#125;</span><br></pre></td></tr></table></figure></p>
<p>5.è·¯å¾„çš„è·¯å¾„å‚æ•°ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/files/&#123;file_path:path&#125;&quot;</span></span>) </span><span class="comment"># å‚æ•°åä¸º file_path, :pathè¯´æ˜è¯¥å‚æ•°åº”åŒ¹é…&quot;è·¯å¾„&quot;</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_file</span>(<span class="params">file_path: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;file_path&quot;</span>: file_path&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¯”å¦‚file_pathè·¯å¾„ä¸º /home/johndoe/myfile.txt </span></span><br><span class="line"><span class="comment"># é‚£ä¹ˆè¿™ä¹ˆåº”è®¿é—® /files//home/johndoe/myfile.txt ï¼Œfileså’Œhomeä¹‹é—´è¦ä½¿ç”¨&quot;åŒæ–œæ &quot;ï¼ˆ//ï¼‰</span></span><br></pre></td></tr></table></figure></p>
<h2 id="å‚æ•°æ ¡éªŒ">å‚æ•°æ ¡éªŒ</h2>
<p>1.è·¯å¾„å‚æ•°çš„æ ¡éªŒï¼Œä» fastapi å¯¼å…¥ Pathï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Path, Query</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_items</span>(<span class="params"></span></span><br><span class="line"><span class="params">    item_id: <span class="built_in">int</span> = Path(<span class="params">title=<span class="string">&quot;The ID of the item to get&quot;</span></span>), <span class="comment"># è·¯å¾„å‚æ•°çš„æ ¡éªŒ</span></span></span><br><span class="line"><span class="params">    q: <span class="built_in">str</span> | <span class="literal">None</span> = Query(<span class="params">default=<span class="literal">None</span>, alias=<span class="string">&quot;item-query&quot;</span></span>), <span class="comment"># æŸ¥è¯¢å‚æ•°çš„æ ¡éªŒ</span></span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    results = &#123;<span class="string">&quot;item_id&quot;</span>: item_id&#125;</span><br><span class="line">    <span class="keyword">if</span> q:</span><br><span class="line">        results.update(&#123;<span class="string">&quot;q&quot;</span>: q&#125;)</span><br><span class="line">    <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure></p>
<p>2.å¿…é€‰å‚æ•°ï¼ˆæ— é»˜è®¤å€¼ï¼‰è¦åœ¨å¯é€‰å‚æ•°ï¼ˆæœ‰é»˜è®¤å€¼ï¼‰å‰é¢ï¼Œè‹¥æƒ³æ”¹å˜é¡ºåºä½¿ç”¨"*"æŒ‡å®šåç»­å‚æ•°ä¸ºkwargsï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Path</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># å¸¦æœ‰ã€Œé»˜è®¤å€¼ã€çš„å‚æ•°æ”¾åœ¨æ²¡æœ‰ã€Œé»˜è®¤å€¼ã€çš„å‚æ•°ä¹‹å‰ï¼ŒPythonå°†ä¼šæŠ¥é”™</span></span><br><span class="line"><span class="comment"># é‡æ–°æ’åºï¼Œå¹¶å°†ä¸å¸¦é»˜è®¤å€¼çš„å€¼ï¼ˆæŸ¥è¯¢å‚æ•° qï¼‰æ”¾åˆ°æœ€å‰é¢</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_items</span>(<span class="params">q: <span class="built_in">str</span>, item_id: <span class="built_in">int</span> = Path(<span class="params">title=<span class="string">&quot;The ID of the item to get&quot;</span></span>)</span>):</span><br><span class="line">    results = &#123;<span class="string">&quot;item_id&quot;</span>: item_id&#125;</span><br><span class="line">    <span class="keyword">if</span> q:</span><br><span class="line">        results.update(&#123;<span class="string">&quot;q&quot;</span>: q&#125;)</span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># &quot;*&quot;åä¸ºkwargså…³é”®å­—å‚æ•°ï¼Œæ­¤æ—¶é¡ºåºå¯ä»¥æ”¹å˜</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_items</span>(<span class="params">*, item_id: <span class="built_in">int</span> = Path(<span class="params">title=<span class="string">&quot;The ID of the item to get&quot;</span></span>), q: <span class="built_in">str</span></span>):</span><br><span class="line">    results = &#123;<span class="string">&quot;item_id&quot;</span>: item_id&#125;</span><br><span class="line">    <span class="keyword">if</span> q:</span><br><span class="line">        results.update(&#123;<span class="string">&quot;q&quot;</span>: q&#125;)</span><br><span class="line">    <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure></p>
<p>3.æ•°å€¼å¤§å°æ ¡éªŒï¼Œ"gt"å¤§äºã€"ge"å¤§äºç­‰äºã€"lt"å°äºã€"le"å°äºç­‰äºï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Path</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_items</span>(<span class="params"></span></span><br><span class="line"><span class="params">    *,</span></span><br><span class="line"><span class="params">    item_id: <span class="built_in">int</span> = Path(<span class="params">title=<span class="string">&quot;The ID of the item to get&quot;</span>, gt=<span class="number">0</span>, le=<span class="number">1000</span></span>), <span class="comment"># gtå¤§äºï¼Œleå°äºç­‰äº</span></span></span><br><span class="line"><span class="params">    q: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    results = &#123;<span class="string">&quot;item_id&quot;</span>: item_id&#125;</span><br><span class="line">    <span class="keyword">if</span> q:</span><br><span class="line">        results.update(&#123;<span class="string">&quot;q&quot;</span>: q&#125;)</span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_items</span>(<span class="params"></span></span><br><span class="line"><span class="params">    *,</span></span><br><span class="line"><span class="params">    item_id: <span class="built_in">int</span> = Path(<span class="params">title=<span class="string">&quot;The ID of the item to get&quot;</span>, ge=<span class="number">0</span>, le=<span class="number">1000</span></span>),</span></span><br><span class="line"><span class="params">    q: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">    size: <span class="built_in">float</span> = Query(<span class="params">gt=<span class="number">0</span>, lt=<span class="number">10.5</span></span>), <span class="comment"># åŒæ ·é€‚ç”¨äºæŸ¥è¯¢å‚æ•°ï¼Œfloatç±»å‹</span></span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    results = &#123;<span class="string">&quot;item_id&quot;</span>: item_id&#125;</span><br><span class="line">    <span class="keyword">if</span> q:</span><br><span class="line">        results.update(&#123;<span class="string">&quot;q&quot;</span>: q&#125;)</span><br><span class="line">    <span class="keyword">if</span> size:</span><br><span class="line">        results.update(&#123;<span class="string">&quot;size&quot;</span>: size&#125;)</span><br><span class="line">    <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure></p>
<h1 id="æŸ¥è¯¢å‚æ•°">æŸ¥è¯¢å‚æ•°</h1>
<h2 id="åŸºç¡€ä½¿ç”¨-1">åŸºç¡€ä½¿ç”¨</h2>
<p>1.å£°æ˜çš„å‚æ•°ä¸æ˜¯è·¯å¾„å‚æ•°æ—¶ï¼Œè·¯å¾„æ“ä½œå‡½æ•°ä¼šæŠŠè¯¥å‚æ•°è‡ªåŠ¨è§£é‡Šä¸º<strong>æŸ¥è¯¢</strong>å‚æ•°ã€‚æŸ¥è¯¢å­—ç¬¦ä¸²æ˜¯é”®å€¼å¯¹çš„é›†åˆï¼Œè¿™äº›é”®å€¼å¯¹ä½äº
URL çš„ ? ä¹‹åï¼Œä»¥ &amp; åˆ†éš”ã€‚<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line">fake_items_db = [<span class="string">&quot;Foo&quot;</span>, <span class="string">&quot;Bar&quot;</span>, <span class="string">&quot;Baz&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_item</span>(<span class="params">skip: <span class="built_in">int</span> = <span class="number">0</span>, limit: <span class="built_in">int</span> = <span class="number">10</span></span>):  <span class="comment"># è®¾ç½®äº†é»˜è®¤å€¼</span></span><br><span class="line">    <span class="keyword">return</span> fake_items_db[skip: skip+limit] <span class="comment"># å–åˆ—è¡¨skip~skip+limitçš„å€¼</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¿é—®http://127.0.0.1:8000/items/?skip=0&amp;limit=10ï¼Œè¿”å›[&quot;Foo&quot;, &quot;Bar&quot;, &quot;Baz&quot;], skipå€¼ä¸º0ï¼Œlimitå€¼ä¸º10</span></span><br><span class="line"><span class="comment"># è®¿é—®http://127.0.0.1:8000/items/ï¼Œæ•ˆæœåŒhttp://127.0.0.1:8000/items/?skip=0&amp;limit=10ï¼Œå› ä¸ºè®¾ç½®äº†é»˜è®¤å€¼</span></span><br></pre></td></tr></table></figure></p>
<p>2.é»˜è®¤å€¼è®¾ç½®ä¸ºNoneå³æ˜¯å¯é€‰å‚æ•°ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_item</span>(<span class="params">item_id: <span class="built_in">str</span>, q: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span></span>): <span class="comment"># æŸ¥è¯¢å‚æ•° q æ˜¯å¯é€‰çš„ï¼Œé»˜è®¤å€¼ä¸º Noneã€‚</span></span><br><span class="line">    <span class="keyword">if</span> q:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;item_id&quot;</span>: item_id, <span class="string">&quot;q&quot;</span>: q&#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;item_id&quot;</span>: item_id&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸è®¾ç½®é»˜è®¤å€¼ï¼Œå‚æ•°ä¸ºå¿…é€‰å‚æ•°</span></span><br></pre></td></tr></table></figure></p>
<p>3.å‚æ•°è¿˜å¯ä»¥å£°æ˜ä¸º bool ç±»å‹ï¼ŒFastAPI ä¼šè‡ªåŠ¨è½¬æ¢å‚æ•°ç±»å‹ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># fastapiä¼šè‡ªåŠ¨è½¬æ¢shortä¸ºboolç±»å‹</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_item</span>(<span class="params">item_id: <span class="built_in">str</span>, q: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span>, short: <span class="built_in">bool</span> = <span class="literal">False</span></span>): </span><br><span class="line">    item = &#123;<span class="string">&quot;item_id&quot;</span>: item_id&#125;</span><br><span class="line">    <span class="keyword">if</span> q:</span><br><span class="line">        item.update(&#123;<span class="string">&quot;q&quot;</span>: q&#125;)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> short:</span><br><span class="line">        item.update(</span><br><span class="line">            &#123;<span class="string">&quot;description&quot;</span>: <span class="string">&quot;This is an amazing item that has a long description&quot;</span>&#125;</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">return</span> item</span><br><span class="line"></span><br><span class="line"><span class="comment"># http://127.0.0.1:8000/items/foo?short=1ï¼Œ</span></span><br><span class="line"><span class="comment"># å…¶å®ƒä»»æ„å¤§å°å†™å½¢å¼ï¼ˆå¤§å†™ã€é¦–å­—æ¯å¤§å†™ç­‰ï¼‰ï¼Œå‡½æ•°æ¥æ”¶çš„ short å‚æ•°éƒ½æ˜¯å¸ƒå°”å€¼ Trueã€‚å€¼ä¸º False æ—¶ä¹Ÿä¸€æ ·ã€‚</span></span><br></pre></td></tr></table></figure></p>
<h2 id="å‚æ•°æ ¡éªŒ-1">å‚æ•°æ ¡éªŒ</h2>
<p>1.å¯¼å…¥Queryï¼Œä½¿ç”¨ Query ä½œä¸ºé»˜è®¤å€¼ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># from typing import Union # python 3.8ä½¿ç”¨Union[str, None]</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Query</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># Queryä½œä¸ºé»˜è®¤å€¼ï¼Œå¹¶å°†å®ƒçš„defaulté»˜è®¤å€¼è®¾ç½®ä¸ºNoneï¼Œmin_lengthå‚æ•°è®¾ç½®ä¸º1ï¼Œmax_lengthå‚æ•°è®¾ç½®ä¸º50ï¼Œæ­£åˆ™pattern</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_items</span>(<span class="params">q: <span class="built_in">str</span> | <span class="literal">None</span> = Query(<span class="params">default=<span class="literal">None</span>, min_length=<span class="number">1</span>, max_length=<span class="number">50</span>, </span></span></span><br><span class="line"><span class="params"><span class="params">                                     pattern=<span class="string">&quot;^fixedquery$&quot;</span></span>)</span>): </span><br><span class="line">    results = &#123;<span class="string">&quot;items&quot;</span>: [&#123;<span class="string">&quot;item_id&quot;</span>: <span class="string">&quot;Foo&quot;</span>&#125;, &#123;<span class="string">&quot;item_id&quot;</span>: <span class="string">&quot;Bar&quot;</span>&#125;]&#125;</span><br><span class="line">    <span class="keyword">if</span> q:</span><br><span class="line">        results.update(&#123;<span class="string">&quot;q&quot;</span>: q&#125;)</span><br><span class="line">    <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure></p>
<p>2.Queryå£°æ˜ä¸ºå¿…é¡»å‚æ•°ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Query</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># å¦‚æœå£°æ˜å‚æ•°ä¸ºå¿…é¡»å‚æ•°ï¼Œåˆ™å»æ‰default</span></span><br><span class="line"><span class="comment"># å¦‚æœå£°æ˜å‚æ•°ä¸ºå¿…é¡»å‚æ•°ï¼Œä¸”å¯ä»¥æ˜¯Noneå€¼ï¼Œåˆ™å°†defaulté»˜è®¤å€¼è®¾ä¸º&quot;...&quot;æˆ–&quot;Required&quot;ï¼Œæ­¤æ—¶è¾“å…¥éœ€æ˜¾ç¤ºè¾“å…¥None</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_items</span>(<span class="params">q: <span class="built_in">str</span> | <span class="literal">None</span> = Query(<span class="params">default=..., min_length=<span class="number">3</span></span>)</span>):</span><br><span class="line">    results = &#123;<span class="string">&quot;items&quot;</span>: [&#123;<span class="string">&quot;item_id&quot;</span>: <span class="string">&quot;Foo&quot;</span>&#125;, &#123;<span class="string">&quot;item_id&quot;</span>: <span class="string">&quot;Bar&quot;</span>&#125;]&#125;</span><br><span class="line">    <span class="keyword">if</span> q:</span><br><span class="line">        results.update(&#123;<span class="string">&quot;q&quot;</span>: q&#125;)</span><br><span class="line">    <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure></p>
<p>3.Queryå®šä¹‰æŸ¥è¯¢å‚æ•°ï¼Œå¯ä»¥æ¥æ”¶ä¸€ç»„æ•°å€¼ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Query</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_items</span>(<span class="params">q: <span class="type">List</span>[<span class="built_in">str</span>] | <span class="literal">None</span> = Query(<span class="params">default=<span class="literal">None</span></span>)</span>): <span class="comment"># æŸ¥è¯¢å‚æ•°qå¯ä»¥ä¸ºä¸€ç»„æ•°å€¼</span></span><br><span class="line">    query_items = &#123;<span class="string">&quot;q&quot;</span>: q&#125;</span><br><span class="line">    <span class="keyword">return</span> query_items</span><br><span class="line"><span class="comment"># è®¿é—®http://localhost:8000/items/?q=foo&amp;q=barï¼Œæ¥æ”¶qçš„å¤šä¸ªå€¼ï¼Œè¿”å›&#123;&quot;q&quot;: [&quot;foo&quot;, &quot;bar&quot;]&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>4.Queryè®¾ç½®defaulté»˜è®¤å€¼ä¹Ÿå¯ä»¥ä¸ºä¸€ç»„å€¼ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># default=List[int]ï¼Œä¼šæ£€æŸ¥Listå†…æ˜¯å¦ä¸ºintç±»å‹</span></span><br><span class="line"><span class="comment"># default=[]ï¼Œä¸ä¼šæ£€æŸ¥Listå†…çš„ç±»å‹</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_items</span>(<span class="params">q: <span class="type">List</span>[<span class="built_in">str</span>] = Query(<span class="params">default=[<span class="string">&quot;foo&quot;</span>, <span class="string">&quot;bar&quot;</span>]</span>)</span>):</span><br><span class="line">    query_items = &#123;<span class="string">&quot;q&quot;</span>: q&#125;</span><br><span class="line">    <span class="keyword">return</span> query_items</span><br></pre></td></tr></table></figure></p>
<p>5.Queryçš„å…¶ä»–å‚æ•°ï¼Œ"title"ã€"description"ã€"alias"ã€"deprecated=True"ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Query</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_items</span>(<span class="params"></span></span><br><span class="line"><span class="params">    q: <span class="built_in">str</span> | <span class="literal">None</span> = Query(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="params">      default=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="params"><span class="params">      title=<span class="string">&quot;Query string&quot;</span>, <span class="comment"># å‚æ•°æ ‡é¢˜</span></span></span></span><br><span class="line"><span class="params"><span class="params">      description=<span class="string">&quot;Query string for the items to search in the database that have a good match&quot;</span>, <span class="comment"># å‚æ•°æè¿°</span></span></span></span><br><span class="line"><span class="params"><span class="params">      alias=<span class="string">&quot;item-query&quot;</span>, <span class="comment"># å‚æ•°åˆ«åï¼Œæœ‰æ­¤å‚æ•°æ—¶ï¼Œåªèƒ½ä½¿ç”¨æ­¤å‚æ•°è®¾ç½®çš„item-queryè®¿é—®ï¼Œä¸èƒ½ä½¿ç”¨å˜é‡åqè®¿é—®</span></span></span></span><br><span class="line"><span class="params"><span class="params">      deprecated=<span class="literal">True</span>, <span class="comment"># æœªæ¥ä¼šå¼ƒç”¨ï¼Œç›®å‰ä¸´æ—¶å¯ç”¨</span></span></span></span><br><span class="line"><span class="params"><span class="params">      min_length=<span class="number">3</span>,</span></span></span><br><span class="line"><span class="params"><span class="params">    </span>),</span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    results = &#123;<span class="string">&quot;items&quot;</span>: [&#123;<span class="string">&quot;item_id&quot;</span>: <span class="string">&quot;Foo&quot;</span>&#125;, &#123;<span class="string">&quot;item_id&quot;</span>: <span class="string">&quot;Bar&quot;</span>&#125;]&#125;</span><br><span class="line">    <span class="keyword">if</span> q:</span><br><span class="line">        results.update(&#123;<span class="string">&quot;q&quot;</span>: q&#125;)</span><br><span class="line">    <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure></p>
<h1 id="è‡ªå®šä¹‰æ ¡éªŒç±»å‹">è‡ªå®šä¹‰æ ¡éªŒç±»å‹</h1>
<h2 id="pydanticæ¨¡å‹">Pydanticæ¨¡å‹</h2>
<p>1.å£°æ˜è‡ªå®šä¹‰Pydanticæ¨¡å‹ï¼ˆé»˜è®¤è§£æä¸ºBodyï¼‰ï¼Œå¯ä»¥é‡å¤ä½¿ç”¨è¯¥æ¨¡å‹åœ¨ä¸åŒåœ°æ–¹ï¼Œä½œä¸ºå‚æ•°çš„ç±»å‹è¿›è¡Œæ ¡éªŒï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Literal</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Query</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, Field</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FilterParams</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    limit: <span class="built_in">int</span> = Field(<span class="number">100</span>, gt=<span class="number">0</span>, le=<span class="number">100</span>)</span><br><span class="line">    offset: <span class="built_in">int</span> = Field(<span class="number">0</span>, ge=<span class="number">0</span>)</span><br><span class="line">    order_by: <span class="type">Literal</span>[<span class="string">&quot;created_at&quot;</span>, <span class="string">&quot;updated_at&quot;</span>] = <span class="string">&quot;created_at&quot;</span></span><br><span class="line">    tags: <span class="built_in">list</span>[<span class="built_in">str</span>] = []</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_items</span>(<span class="params">filter_query: FilterParams = Query(<span class="params"></span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> filter_query</span><br></pre></td></tr></table></figure></p>
<p>2.ç¦æ­¢é¢å¤–å‚æ•°<code>model_config = &#123;"extra": "forbid"&#125;</code>ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Literal</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Query</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, Field</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FilterParams</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    model_config = &#123;<span class="string">&quot;extra&quot;</span>: <span class="string">&quot;forbid&quot;</span>&#125;  <span class="comment"># ç¦æ­¢é¢å¤–å‚æ•°è¾“å…¥ï¼Œå‡ºç°é¢å¤–å‚æ•°æŠ¥é”™</span></span><br><span class="line">    limit: <span class="built_in">int</span> = Field(<span class="number">100</span>, gt=<span class="number">0</span>, le=<span class="number">100</span>)</span><br><span class="line">    offset: <span class="built_in">int</span> = Field(<span class="number">0</span>, ge=<span class="number">0</span>)</span><br><span class="line">    order_by: <span class="type">Literal</span>[<span class="string">&quot;created_at&quot;</span>, <span class="string">&quot;updated_at&quot;</span>] = <span class="string">&quot;created_at&quot;</span></span><br><span class="line">    tags: <span class="built_in">list</span>[<span class="built_in">str</span>] = []</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_items</span>(<span class="params">filter_query: FilterParams = Query(<span class="params"></span>)</span>): <span class="comment"># ä»Queryå‚æ•°ä¸­è·å–ï¼ˆé»˜è®¤ä»Bodyä¸­è·å–ï¼‰</span></span><br><span class="line">    <span class="keyword">return</span> filter_query</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¿é—®http://localhost:8000/items/?q=foo&amp;limit=1&amp;offset=0&amp;order_by=updated_at&amp;tags=aï¼Œæœ‰é¢å¤–å‚æ•°qï¼ŒæŠ¥é”™</span></span><br></pre></td></tr></table></figure></p>
<h2 id="pydanticåµŒå¥—æ¨¡å‹">PydanticåµŒå¥—æ¨¡å‹</h2>
<p>FastAPIå¯ä»¥å®šä¹‰ã€æ ¡éªŒã€è®°å½•æ–‡æ¡£å¹¶ä½¿ç”¨ä»»æ„æ·±åº¦åµŒå¥—çš„æ¨¡å‹ï¼ˆå½’åŠŸäºPydanticï¼‰ã€‚<br />
1.å…·æœ‰å­ç±»å‹çš„å­—æ®µï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Union</span> <span class="comment"># List[str], Union[float, None]</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Item</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line">    price: <span class="built_in">float</span> </span><br><span class="line">    tax: <span class="built_in">float</span> | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line">    tags: <span class="built_in">list</span>[<span class="built_in">str</span>] = []  <span class="comment"># listä¸­æŒ‡å®šå­ç±»å‹ä¸ºstr</span></span><br><span class="line">    <span class="comment"># tags: set[str] = set()  # setåŒç†ï¼Œå¯ä»¥å»é‡</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">update_item</span>(<span class="params">item_id: <span class="built_in">int</span>, item: Item</span>):</span><br><span class="line">    results = &#123;<span class="string">&quot;item_id&quot;</span>: item_id, <span class="string">&quot;item&quot;</span>: item&#125;</span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/index-weights/&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># dictä¸­æŒ‡å®škeyä¸ºintï¼Œvalueä¸ºfloatã€‚Jsonçš„keyæ”¯æŒstrï¼Œä¼šè¢«è½¬æ¢ä¸ºint</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_index_weights</span>(<span class="params">weights: <span class="built_in">dict</span>[<span class="built_in">int</span>, <span class="built_in">float</span>]</span>):</span><br><span class="line">    <span class="keyword">return</span> weights</span><br></pre></td></tr></table></figure></p>
<p>2.è‡ªå®šä¹‰ç±»å‹çš„åµŒå¥—ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Image</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    url: <span class="built_in">str</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Item</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line">    price: <span class="built_in">float</span></span><br><span class="line">    tax: <span class="built_in">float</span> | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line">    tags: <span class="built_in">set</span>[<span class="built_in">str</span>] = <span class="built_in">set</span>()</span><br><span class="line">    image: Image | <span class="literal">None</span> = <span class="literal">None</span>  <span class="comment"># åµŒå¥—Imageæ¨¡å‹</span></span><br><span class="line">    <span class="comment"># images: list[Image] | None = None # æ”¯æŒä¸€ç»„åµŒå¥—</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">update_item</span>(<span class="params">item_id: <span class="built_in">int</span>, item: Item</span>):</span><br><span class="line">    results = &#123;<span class="string">&quot;item_id&quot;</span>: item_id, <span class="string">&quot;item&quot;</span>: item&#125;</span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ­¤æ—¶æœŸæœ›å‘é€çš„è¯·æ±‚ä½“ï¼š</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Foo&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;The pretender&quot;</span>,</span><br><span class="line">    <span class="string">&quot;price&quot;</span>: <span class="number">42.0</span>,</span><br><span class="line">    <span class="string">&quot;tax&quot;</span>: <span class="number">3.2</span>,</span><br><span class="line">    <span class="string">&quot;tags&quot;</span>: [<span class="string">&quot;rock&quot;</span>, <span class="string">&quot;metal&quot;</span>, <span class="string">&quot;bar&quot;</span>],</span><br><span class="line">    <span class="string">&quot;image&quot;</span>: &#123; <span class="comment"># åµŒå¥—</span></span><br><span class="line">        <span class="string">&quot;url&quot;</span>: <span class="string">&quot;http://example.com/baz.jpg&quot;</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;The Foo live&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># ä¸€ç»„åµŒå¥—æ—¶ï¼ŒæœŸæœ›å‘é€çš„è¯·æ±‚ä½“ï¼š</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Foo&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;The pretender&quot;</span>,</span><br><span class="line">    <span class="string">&quot;price&quot;</span>: <span class="number">42.0</span>,</span><br><span class="line">    <span class="string">&quot;tax&quot;</span>: <span class="number">3.2</span>,</span><br><span class="line">    <span class="string">&quot;tags&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;rock&quot;</span>,</span><br><span class="line">        <span class="string">&quot;metal&quot;</span>,</span><br><span class="line">        <span class="string">&quot;bar&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;images&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;url&quot;</span>: <span class="string">&quot;http://example.com/baz.jpg&quot;</span>,</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;The Foo live&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;url&quot;</span>: <span class="string">&quot;http://example.com/dave.jpg&quot;</span>,</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;The Baz&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="pydanticç‰¹æ®Šç±»å‹">Pydanticç‰¹æ®Šç±»å‹</h2>
<p>1.Pydanticè¿˜æ”¯æŒå…¶ä»–ç‰¹æ®Šç±»å‹çš„æ ¡éªŒï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, HttpUrl</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Image</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    url: HttpUrl  <span class="comment"># æ ¡éªŒurl</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Item</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line">    price: <span class="built_in">float</span></span><br><span class="line">    tax: <span class="built_in">float</span> | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line">    tags: <span class="built_in">set</span>[<span class="built_in">str</span>] = <span class="built_in">set</span>()</span><br><span class="line">    image: Image | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">update_item</span>(<span class="params">item_id: <span class="built_in">int</span>, item: Item</span>):</span><br><span class="line">    results = &#123;<span class="string">&quot;item_id&quot;</span>: item_id, <span class="string">&quot;item&quot;</span>: item&#125;</span><br><span class="line">    <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure></p>
<p>å¸¸è§çš„ä¸€äº›æ ¡éªŒï¼š<br />
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">|-UUID:</span><br><span class="line">    |-ä¸€ç§æ ‡å‡†çš„ &quot;é€šç”¨å”¯ä¸€æ ‡è¯†ç¬¦&quot; ï¼Œåœ¨è®¸å¤šæ•°æ®åº“å’Œç³»ç»Ÿä¸­ç”¨ä½œIDã€‚</span><br><span class="line">    |-åœ¨è¯·æ±‚å’Œå“åº”ä¸­å°†ä»¥ str è¡¨ç¤ºã€‚</span><br><span class="line">|-datetime.datetime:</span><br><span class="line">    |-ä¸€ä¸ª Python datetime.datetime.</span><br><span class="line">    |-åœ¨è¯·æ±‚å’Œå“åº”ä¸­å°†è¡¨ç¤ºä¸º ISO 8601 æ ¼å¼çš„ str ï¼Œæ¯”å¦‚: 2008-09-15T15:53:00+05:00.</span><br><span class="line">|-datetime.date:</span><br><span class="line">    |-Python datetime.date.</span><br><span class="line">    |-åœ¨è¯·æ±‚å’Œå“åº”ä¸­å°†è¡¨ç¤ºä¸º ISO 8601 æ ¼å¼çš„ str ï¼Œæ¯”å¦‚: 2008-09-15.</span><br><span class="line">|-datetime.time:</span><br><span class="line">    |-Python datetime.time.</span><br><span class="line">    |-åœ¨è¯·æ±‚å’Œå“åº”ä¸­å°†è¡¨ç¤ºä¸º ISO 8601 æ ¼å¼çš„ str ï¼Œæ¯”å¦‚: 14:23:55.003.</span><br><span class="line">|-datetime.timedelta:</span><br><span class="line">    |-Python datetime.timedelta.</span><br><span class="line">    |-åœ¨è¯·æ±‚å’Œå“åº”ä¸­å°†è¡¨ç¤ºä¸º float ä»£è¡¨æ€»ç§’æ•°ã€‚</span><br><span class="line">    |-Pydantic ä¹Ÿå…è®¸å°†å…¶è¡¨ç¤ºä¸º &quot;ISO 8601 æ—¶é—´å·®å¼‚ç¼–ç &quot;.</span><br><span class="line">|-frozenset:</span><br><span class="line">    |-åœ¨è¯·æ±‚å’Œå“åº”ä¸­ï¼Œä½œä¸º set å¯¹å¾…ï¼š</span><br><span class="line">    |-åœ¨è¯·æ±‚ä¸­ï¼Œåˆ—è¡¨å°†è¢«è¯»å–ï¼Œæ¶ˆé™¤é‡å¤ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºä¸€ä¸ª setã€‚</span><br><span class="line">    |-åœ¨å“åº”ä¸­ set å°†è¢«è½¬æ¢ä¸º list ã€‚</span><br><span class="line">    |-äº§ç”Ÿçš„æ¨¡å¼å°†æŒ‡å®šé‚£äº› set çš„å€¼æ˜¯å”¯ä¸€çš„ (ä½¿ç”¨ JSON æ¨¡å¼çš„ uniqueItems)ã€‚</span><br><span class="line">|-bytes:</span><br><span class="line">    |-æ ‡å‡†çš„ Python bytesã€‚</span><br><span class="line">    |-åœ¨è¯·æ±‚å’Œå“åº”ä¸­è¢«å½“ä½œ str å¤„ç†ã€‚</span><br><span class="line">    |-ç”Ÿæˆçš„æ¨¡å¼å°†æŒ‡å®šè¿™ä¸ª str æ˜¯ binary &quot;æ ¼å¼&quot;ã€‚</span><br><span class="line">|-Decimal:</span><br><span class="line">    |-æ ‡å‡†çš„ Python Decimalã€‚</span><br><span class="line">    |-åœ¨è¯·æ±‚å’Œå“åº”ä¸­è¢«å½“åš float ä¸€æ ·å¤„ç†ã€‚</span><br></pre></td></tr></table></figure></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, time, timedelta</span><br><span class="line"><span class="keyword">from</span> uuid <span class="keyword">import</span> UUID</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Body, FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_items</span>(<span class="params"></span></span><br><span class="line"><span class="params">    item_id: UUID,  <span class="comment"># UUID</span></span></span><br><span class="line"><span class="params">    start_datetime: datetime = Body(<span class="params"></span>),  <span class="comment"># datetime</span></span></span><br><span class="line"><span class="params">    end_datetime: datetime = Body(<span class="params"></span>), <span class="comment"># datetime</span></span></span><br><span class="line"><span class="params">    process_after: timedelta = Body(<span class="params"></span>), <span class="comment"># timedelta</span></span></span><br><span class="line"><span class="params">    repeat_at: time | <span class="literal">None</span> = Body(<span class="params">default=<span class="literal">None</span></span>), <span class="comment"># time</span></span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    start_process = start_datetime + process_after</span><br><span class="line">    duration = end_datetime - start_process</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&quot;item_id&quot;</span>: item_id,</span><br><span class="line">        <span class="string">&quot;start_datetime&quot;</span>: start_datetime,</span><br><span class="line">        <span class="string">&quot;end_datetime&quot;</span>: end_datetime,</span><br><span class="line">        <span class="string">&quot;process_after&quot;</span>: process_after,</span><br><span class="line">        <span class="string">&quot;repeat_at&quot;</span>: repeat_at,</span><br><span class="line">        <span class="string">&quot;start_process&quot;</span>: start_process,</span><br><span class="line">        <span class="string">&quot;duration&quot;</span>: duration,</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>2.ä½¿ç”¨ Config å’Œ schema_extra ä¸ºSwaggeræ–‡æ¡£æ·»åŠ æ¥å£ç¤ºä¾‹ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Item</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line">    price: <span class="built_in">float</span></span><br><span class="line">    tax: <span class="built_in">float</span> | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line">    model_config = &#123;</span><br><span class="line">        <span class="string">&quot;json_schema_extra&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;examples&quot;</span>: [  <span class="comment"># ä¼šåœ¨Request bodyä¸‹æ˜¾ç¤ºä¸‹é¢ç¤ºä¾‹</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Foo&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;A very nice Item&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;price&quot;</span>: <span class="number">35.4</span>,</span><br><span class="line">                    <span class="string">&quot;tax&quot;</span>: <span class="number">3.2</span>,</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">update_item</span>(<span class="params">item_id: <span class="built_in">int</span>, item: Item</span>):</span><br><span class="line">    results = &#123;<span class="string">&quot;item_id&quot;</span>: item_id, <span class="string">&quot;item&quot;</span>: item&#125;</span><br><span class="line">    <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure></p>
<p>åŒæ ·Field, Path, Query, Bodyéƒ½å¯ä»¥æ·»åŠ examplesï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, Field</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Item</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span> = Field(examples=[<span class="string">&quot;Foo&quot;</span>]) <span class="comment"># Fieldæ·»åŠ examples</span></span><br><span class="line">    description: <span class="built_in">str</span> | <span class="literal">None</span> = Field(default=<span class="literal">None</span>, examples=[<span class="string">&quot;A very nice Item&quot;</span>])</span><br><span class="line">    price: <span class="built_in">float</span> = Field(examples=[<span class="number">35.4</span>])</span><br><span class="line">    tax: <span class="built_in">float</span> | <span class="literal">None</span> = Field(default=<span class="literal">None</span>, examples=[<span class="number">3.2</span>])</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">update_item</span>(<span class="params">item_id: <span class="built_in">int</span>, item: Item</span>):</span><br><span class="line">    results = &#123;<span class="string">&quot;item_id&quot;</span>: item_id, <span class="string">&quot;item&quot;</span>: item&#125;</span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">update_item</span>(<span class="params"></span></span><br><span class="line"><span class="params">    item_id: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    item: Item = Body(<span class="params"> <span class="comment"># Bodyæ·»åŠ examples</span></span></span></span><br><span class="line"><span class="params"><span class="params">        examples=[</span></span></span><br><span class="line"><span class="params"><span class="params">            &#123;</span></span></span><br><span class="line"><span class="params"><span class="params">                <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Foo&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="params">                <span class="string">&quot;description&quot;</span>: <span class="string">&quot;A very nice Item&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="params">                <span class="string">&quot;price&quot;</span>: <span class="number">35.4</span>,</span></span></span><br><span class="line"><span class="params"><span class="params">                <span class="string">&quot;tax&quot;</span>: <span class="number">3.2</span>,</span></span></span><br><span class="line"><span class="params"><span class="params">            &#125;</span></span></span><br><span class="line"><span class="params"><span class="params">        ],</span></span></span><br><span class="line"><span class="params"><span class="params">    </span>),</span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    results = &#123;<span class="string">&quot;item_id&quot;</span>: item_id, <span class="string">&quot;item&quot;</span>: item&#125;</span><br><span class="line">    <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure></p>
<h2 id="dataclassæ¨¡å‹">dataclassæ¨¡å‹</h2>
<p>FastAPI
è¿˜å¯ä»¥ä½¿ç”¨Pythonè‡ªå¸¦çš„æ•°æ®ç±»ï¼ˆdataclassesï¼‰ï¼Œè‡ªåŠ¨ç”Ÿæˆä¸€äº›å¸¸è§çš„æ–¹æ³•ï¼Œå¦‚
<code>__init__</code>ã€<code>__repr__</code>ã€<code>__eq__</code>
ç­‰ã€‚å¯ä»¥å’ŒPydanticæ¨¡å‹ä¸€èµ·ä½¿ç”¨ï¼ŒPydanticæ¨¡å‹å¯ä»¥å¤„ç†æ•°æ®éªŒè¯ã€åºåˆ—åŒ–ç­‰ã€‚<br />
FastAPIä¸­ï¼Œå³ä½¿ä»£ç ä¸­æ²¡æœ‰æ˜¾å¼ä½¿ç”¨Pydanticï¼Œä»ä¼šè‡ªåŠ¨ä½¿ç”¨PydanticæŠŠdataclassesæ•°æ®ç±»è½¬æ¢ä¸ºPydanticæ•°æ®ç±»ï¼ˆPydanticæœ‰è‡ªå·±çš„dataclassesï¼‰ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass, field</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Union</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass  </span><span class="comment"># æ•°æ®ç±»ï¼Œè‡ªåŠ¨ä¸ºItemç”Ÿæˆä¸€äº›å¸¸è§çš„æ–¹æ³•</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Item</span>: <span class="comment"># FastAPIä¼šæŠŠ@dataclassè£…é¥°çš„Itemè½¬ä¸ºPydanticè‡ªå·±çš„dataclasses</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    price: <span class="built_in">float</span></span><br><span class="line">    tags: <span class="type">List</span>[<span class="built_in">str</span>] = field(default_factory=<span class="built_in">list</span>)</span><br><span class="line">    description: <span class="type">Union</span>[<span class="built_in">str</span>, <span class="literal">None</span>] = <span class="literal">None</span></span><br><span class="line">    tax: <span class="type">Union</span>[<span class="built_in">float</span>, <span class="literal">None</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/next&quot;</span>, response_model=Item</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_next_item</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Island In The Moon&quot;</span>,</span><br><span class="line">        <span class="string">&quot;price&quot;</span>: <span class="number">12.99</span>,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;A place to be playin&#x27; and havin&#x27; fun&quot;</span>,</span><br><span class="line">        <span class="string">&quot;tags&quot;</span>: [<span class="string">&quot;breater&quot;</span>],</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>åµŒå¥—dataclassï¼Œä½¿ç”¨Pydanticæœ‰è‡ªå·±çš„dataclassesï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> field  <span class="comment"># fieldçº¦æŸéœ€è¦ä»æ ‡å‡†åº“å¯¼å…¥</span></span><br><span class="line"><span class="keyword">from</span> pydantic.dataclasses <span class="keyword">import</span> dataclass  <span class="comment"># ä½¿ç”¨pydanticçš„dataclasses</span></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Union</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Item</span>:</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="type">Union</span>[<span class="built_in">str</span>, <span class="literal">None</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Author</span>:</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    items: <span class="type">List</span>[Item] = field(default_factory=<span class="built_in">list</span>)  <span class="comment"># çº¦æŸ</span></span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/authors/&#123;author_id&#125;/items/&quot;</span>, response_model=Author</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_author_items</span>(<span class="params">author_id: <span class="built_in">str</span>, items: <span class="type">List</span>[Item]</span>):</span><br><span class="line">    <span class="comment"># FastAPI ä½¿ç”¨ï¼ˆåŒ…å«æ•°æ®ç±»çš„ï¼‰ response_model å‚æ•°è½¬æ¢å“åº”ã€‚</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;name&quot;</span>: author_id, <span class="string">&quot;items&quot;</span>: items&#125;  </span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/authors/&quot;</span>, response_model=<span class="type">List</span>[Author]</span>)  </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_authors</span>():  </span><br><span class="line">    <span class="comment"># FastAPI ä½¿ç”¨ï¼ˆåŒ…å«æ•°æ®ç±»çš„ï¼‰ response_model å‚æ•°è½¬æ¢å“åº”ã€‚</span></span><br><span class="line">    <span class="keyword">return</span> [  </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Breaters&quot;</span>,</span><br><span class="line">            <span class="string">&quot;items&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Island In The Moon&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;A place to be playin&#x27; and havin&#x27; fun&quot;</span>,</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Holy Buddies&quot;</span>&#125;,</span><br><span class="line">            ],</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;System of an Up&quot;</span>,</span><br><span class="line">            <span class="string">&quot;items&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Salt&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;The kombucha mushroom people&#x27;s favorite&quot;</span>,</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Pad Thai&quot;</span>&#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Lonely Night&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;The mostests lonliest nightiest of allest&quot;</span>,</span><br><span class="line">                &#125;,</span><br><span class="line">            ],</span><br><span class="line">        &#125;,</span><br><span class="line">    ]</span><br></pre></td></tr></table></figure></p>
<h1 id="è¯·æ±‚ä½“">è¯·æ±‚ä½“</h1>
<p>FastAPI ä½¿ç”¨<strong>è¯·æ±‚ä½“</strong>ä»å®¢æˆ·ç«¯ï¼ˆä¾‹å¦‚æµè§ˆå™¨ï¼‰å‘ API
å‘é€æ•°æ®ã€‚<br />
<strong>è¯·æ±‚ä½“</strong>æ˜¯å®¢æˆ·ç«¯å‘é€ç»™ API
çš„æ•°æ®ã€‚<strong>å“åº”ä½“</strong>æ˜¯ API å‘é€ç»™å®¢æˆ·ç«¯çš„æ•°æ®ã€‚API
åŸºæœ¬ä¸Šè‚¯å®šè¦å‘é€<strong>å“åº”ä½“</strong>ï¼Œä½†æ˜¯å®¢æˆ·ç«¯ä¸ä¸€å®šå‘é€<strong>è¯·æ±‚ä½“</strong>ã€‚<br />
ä½¿ç”¨ Pydantic
æ¨¡å‹å£°æ˜<strong>è¯·æ±‚ä½“</strong>ï¼Œèƒ½å……åˆ†åˆ©ç”¨å®ƒçš„åŠŸèƒ½å’Œä¼˜ç‚¹ã€‚</p>
<h2 id="åŸºç¡€ä½¿ç”¨-2">åŸºç¡€ä½¿ç”¨</h2>
<p>1.ä» pydantic ä¸­å¯¼å…¥ BaseModelï¼ŒæŠŠæ•°æ®æ¨¡å‹å£°æ˜ä¸ºç»§æ‰¿ BaseModel
çš„ç±»ã€‚<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Item</span>(<span class="title class_ inherited__">BaseModel</span>): <span class="comment"># ç»§æ‰¿BaseModelç±»</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span>  <span class="comment"># å¯é€‰å‚æ•°ï¼ˆé»˜è®¤å€¼ä¸ºNoneï¼‰</span></span><br><span class="line">    price: <span class="built_in">float</span></span><br><span class="line">    tax: <span class="built_in">float</span> | <span class="literal">None</span> = <span class="literal">None</span>  <span class="comment"># å¯é€‰å‚æ•°ï¼ˆé»˜è®¤å€¼ä¸ºNoneï¼‰</span></span><br><span class="line"> </span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_item</span>(<span class="params">item: Item</span>): <span class="comment"># itemå‚æ•°çš„ç±»å‹ä¸ºItemï¼Œè‡ªåŠ¨å°†&quot;è¯·æ±‚ä½“&quot;ä¸­çš„æ•°æ®è§£æä¸ºItemç±»å‹</span></span><br><span class="line">    <span class="keyword">return</span> item</span><br><span class="line"></span><br><span class="line"><span class="comment"># descriptionå’Œtaxæ˜¯å¯é€‰çš„ï¼ˆé»˜è®¤å€¼ä¸º Noneï¼‰ï¼Œæ‰€ä»¥è¯·æ±‚bodyå¯ä»¥æ˜¯ï¼š</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Foo&quot;</span>,</span><br><span class="line">    <span class="string">&quot;price&quot;</span>: <span class="number">45.2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>2.ä½¿ç”¨"."è®¿é—®æ¨¡å‹å¯¹è±¡å±æ€§ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_item</span>(<span class="params">item: Item</span>):</span><br><span class="line">    item_dict = item.<span class="built_in">dict</span>()</span><br><span class="line">    <span class="keyword">if</span> item.tax:</span><br><span class="line">        price_with_tax = item.price + item.tax  <span class="comment"># è®¿é—®itemå±æ€§</span></span><br><span class="line">        item_dict.update(&#123;<span class="string">&quot;price_with_tax&quot;</span>: price_with_tax&#125;)</span><br><span class="line">    <span class="keyword">return</span> item_dict</span><br></pre></td></tr></table></figure></p>
<h2 id="å¤šå‚æ•°æ··åˆ">å¤šå‚æ•°æ··åˆ</h2>
<p>1.æ”¯æŒï¼Œ<strong>è·¯å¾„å‚æ•°</strong> + <strong>æŸ¥è¯¢å‚æ•°</strong> +
<strong>è¯·æ±‚ä½“</strong>ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Item</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line">    price: <span class="built_in">float</span></span><br><span class="line">    tax: <span class="built_in">float</span> | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>) </span><span class="comment"># è·¯å¾„å‚æ•°</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">update_item</span>(<span class="params">item_id: <span class="built_in">int</span>, item: Item, q: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span></span>): <span class="comment"># qæŸ¥è¯¢å‚æ•°ï¼Œitemè¯·æ±‚ä½“</span></span><br><span class="line">    result = &#123;<span class="string">&quot;item_id&quot;</span>: item_id, **item.<span class="built_in">dict</span>()&#125;</span><br><span class="line">    <span class="keyword">if</span> q:</span><br><span class="line">        result.update(&#123;<span class="string">&quot;q&quot;</span>: q&#125;)</span><br><span class="line">    <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure></p>
<p>2.å¤šä¸ªè¯·æ±‚ä½“å‚æ•° + å•ä¸ªè¯·æ±‚ä½“å‚æ•°ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Item</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line">    price: <span class="built_in">float</span></span><br><span class="line">    tax: <span class="built_in">float</span> | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    username: <span class="built_in">str</span></span><br><span class="line">    full_name: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># item å’Œ user ä¸¤ä¸ªè¯·æ±‚ä½“å‚æ•°ï¼Œimportanceå•ä¸ªå‚æ•°ï¼ˆæŒ‡å®šä»Bodyè·å–ï¼‰</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">update_item</span>(<span class="params">item_id: <span class="built_in">int</span>, item: Item, user: User, importance: <span class="built_in">int</span> = Body(<span class="params"></span>)</span>):</span><br><span class="line">    results = &#123;<span class="string">&quot;item_id&quot;</span>: item_id, <span class="string">&quot;item&quot;</span>: item, <span class="string">&quot;user&quot;</span>: user&#125;</span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ³¨æ„è¾“å…¥çš„è¯·æ±‚ä½“å°†&quot;å‚æ•°å&quot;ä½œä¸ºé”®ï¼ŒæœŸæœ›è¾“å…¥å¦‚ä¸‹ï¼š</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;item&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Foo&quot;</span>,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;The pretender&quot;</span>,</span><br><span class="line">        <span class="string">&quot;price&quot;</span>: <span class="number">42.0</span>,</span><br><span class="line">        <span class="string">&quot;tax&quot;</span>: <span class="number">3.2</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;user&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;username&quot;</span>: <span class="string">&quot;dave&quot;</span>,</span><br><span class="line">        <span class="string">&quot;full_name&quot;</span>: <span class="string">&quot;Dave Grohl&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;importance&quot;</span>: <span class="number">5</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>3.å¤šä¸ªè¯·æ±‚ä½“å‚æ•° + æŸ¥è¯¢å‚æ•°ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Body, FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Item</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line">    price: <span class="built_in">float</span></span><br><span class="line">    tax: <span class="built_in">float</span> | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    username: <span class="built_in">str</span></span><br><span class="line">    full_name: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">update_item</span>(<span class="params"></span></span><br><span class="line"><span class="params">    *,</span></span><br><span class="line"><span class="params">    item_id: <span class="built_in">int</span>, <span class="comment"># é»˜è®¤ä¸ºPathå‚æ•°</span></span></span><br><span class="line"><span class="params">    item: Item, <span class="comment"># é»˜è®¤ä¸ºBodyå‚æ•°ï¼ˆè‡ªå®šä¹‰ï¼‰</span></span></span><br><span class="line"><span class="params">    user: User, <span class="comment"># é»˜è®¤ä¸ºBodyå‚æ•°ï¼ˆè‡ªå®šä¹‰ï¼‰</span></span></span><br><span class="line"><span class="params">    importance: <span class="built_in">int</span> = Body(<span class="params">gt=<span class="number">0</span></span>), <span class="comment"># æŒ‡å®šä¸ºBodyå‚æ•°</span></span></span><br><span class="line"><span class="params">    q: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span>, <span class="comment"># é»˜è®¤ä¸ºQueryå‚æ•°</span></span></span><br><span class="line"><span class="params"></span>): </span><br><span class="line">    results = &#123;<span class="string">&quot;item_id&quot;</span>: item_id, <span class="string">&quot;item&quot;</span>: item, <span class="string">&quot;user&quot;</span>: user, <span class="string">&quot;importance&quot;</span>: importance&#125;</span><br><span class="line">    <span class="keyword">if</span> q:</span><br><span class="line">        results.update(&#123;<span class="string">&quot;q&quot;</span>: q&#125;)</span><br><span class="line">    <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure></p>
<p>4.å•ä¸ªè¯·æ±‚ä½“å‚æ•°ï¼ŒæŒ‡å®šä½¿ç”¨keyï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Body, FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Item</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line">    price: <span class="built_in">float</span></span><br><span class="line">    tax: <span class="built_in">float</span> | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># embed=Trueè¡¨ç¤ºæ­¤å‚æ•°åƒå¤šä¸ªè¯·æ±‚ä½“å‚æ•°ä¸€æ ·ï¼Œè¦æŠŠå‚æ•°åä½œä¸ºkey</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">update_item</span>(<span class="params">item_id: <span class="built_in">int</span>, item: Item = Body(<span class="params">embed=<span class="literal">True</span></span>)</span>):</span><br><span class="line">    results = &#123;<span class="string">&quot;item_id&quot;</span>: item_id, <span class="string">&quot;item&quot;</span>: item&#125;</span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ­¤æ—¶è¯·æ±‚æœŸæœ›å¦‚ä¸‹ï¼š</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;item&quot;</span>: &#123; <span class="comment"># è¦æŠŠå‚æ•°åä½œä¸ºkey</span></span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Foo&quot;</span>,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;The pretender&quot;</span>,</span><br><span class="line">        <span class="string">&quot;price&quot;</span>: <span class="number">42.0</span>,</span><br><span class="line">        <span class="string">&quot;tax&quot;</span>: <span class="number">3.2</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="å‚æ•°æ ¡éªŒ-2">å‚æ•°æ ¡éªŒ</h2>
<p>Bodyä¸Queryã€Pathå£°æ˜æ ¡éªŒä¸å…ƒæ•°æ®çš„æ–¹å¼ä¸€æ ·ï¼Œå‚æ•°ä¹Ÿç›¸åŒã€‚<br />
Pydanticæ¨¡å‹ä½¿ç”¨Fieldåœ¨æ¨¡å‹å†…éƒ¨å£°æ˜æ ¡éªŒå’Œå…ƒæ•°æ®ï¼Œä¹Ÿå’ŒBodyã€Queryã€Pathå£°æ˜æ ¡éªŒä¸å…ƒæ•°æ®çš„æ–¹å¼ä¸€æ ·ï¼Œå‚æ•°ä¹Ÿç›¸åŒã€‚<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Body, FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, Field</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Pydanticæ¨¡å‹ä¸­ä½¿ç”¨Fieldè¿›è¡Œå‚æ•°æ ¡éªŒ</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Item</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="built_in">str</span> | <span class="literal">None</span> = Field(default=<span class="literal">None</span>, title=<span class="string">&quot;The description of the item&quot;</span>, max_length=<span class="number">300</span>)</span><br><span class="line">    price: <span class="built_in">float</span> = Field(gt=<span class="number">0</span>, description=<span class="string">&quot;The price must be greater than zero&quot;</span>)</span><br><span class="line">    tax: <span class="built_in">float</span> | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">update_item</span>(<span class="params">item_id: <span class="built_in">int</span>, item: Item = Body(<span class="params">embed=<span class="literal">True</span></span>)</span>):</span><br><span class="line">    results = &#123;<span class="string">&quot;item_id&quot;</span>: item_id, <span class="string">&quot;item&quot;</span>: item&#125;</span><br><span class="line">    <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure></p>
<h1 id="cookieå‚æ•°">Cookieå‚æ•°</h1>
<p>1.å®šä¹‰ Cookie å‚æ•°ä¸å®šä¹‰ Query å’Œ Path å‚æ•°ä¸€æ ·ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Cookie, FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># ç¬¬ä¸€ä¸ªå€¼æ˜¯é»˜è®¤å€¼ï¼Œè¿˜å¯ä»¥ä¼ é€’æ‰€æœ‰éªŒè¯å‚æ•°æˆ–æ³¨é‡Šå‚æ•°ï¼š</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_items</span>(<span class="params">ads_id: <span class="built_in">str</span> | <span class="literal">None</span> = Cookie(<span class="params">default=<span class="literal">None</span></span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;ads_id&quot;</span>: ads_id&#125;</span><br></pre></td></tr></table></figure></p>
<p>2.Cookieä¹Ÿå¯ä»¥ä½¿ç”¨Pydanticæ¨¡å‹å®šä¹‰ï¼Œå¹¶ä¸”å¯ä»¥åŒ…å«å¤šä¸ªå­—æ®µï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Cookie, FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Cookies</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="comment"># model_config = &#123;&quot;extra&quot;: &quot;forbid&quot;&#125;</span></span><br><span class="line">    session_id: <span class="built_in">str</span></span><br><span class="line">    fatebook_tracker: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line">    googall_tracker: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_items</span>(<span class="params">cookies: Cookies = Cookie(<span class="params"></span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> cookies</span><br></pre></td></tr></table></figure></p>
<h1 id="å“åº”cookie">å“åº”Cookie</h1>
<p>å¯ä»¥åœ¨å“åº”ä¸­å®šä¹‰ä¸€ä¸ªResponseå‚æ•°ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨è¿™ä¸ªä¸´æ—¶å“åº”å¯¹è±¡ä¸­è®¾ç½®cookieã€‚<br />
ä¹Ÿå¯ä»¥åˆ›å»ºä¸€ä¸ªJSONResponseå¯¹è±¡ï¼Œå†æ·»åŠ cookieï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Response</span><br><span class="line"><span class="keyword">from</span> fastapi.responses <span class="keyword">import</span> JSONResponse</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/cookie-and-object/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_cookie</span>(<span class="params">response: Response</span>): <span class="comment"># ä¸´æ—¶å“åº”å¯¹è±¡</span></span><br><span class="line">    response.set_cookie(key=<span class="string">&quot;fakesession&quot;</span>, value=<span class="string">&quot;fake-cookie-session-value&quot;</span>) <span class="comment"># åœ¨å“åº”ä¸­æ·»åŠ cookie</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Come to the dark side, we have cookies&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/cookie/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_cookie</span>():</span><br><span class="line">    content = &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Come to the dark side, we have cookies&quot;</span>&#125;</span><br><span class="line">    response = JSONResponse(content=content) <span class="comment"># åˆ›å»ºJSONResponse</span></span><br><span class="line">    response.set_cookie(key=<span class="string">&quot;fakesession&quot;</span>, value=<span class="string">&quot;fake-cookie-session-value&quot;</span>) <span class="comment"># æ·»åŠ cookie</span></span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure></p>
<h1 id="headerå‚æ•°">Headerå‚æ•°</h1>
<p>Header å’Œ Pathã€Queryã€Cookie ä¸€æ ·çš„ç»“æ„ï¼Œä½†æä¾›äº†æ›´å¤šåŠŸèƒ½ã€‚<br />
1.æ¯”å¦‚å¤§éƒ¨åˆ†æ ‡å‡†è¯·æ±‚å¤´ç”¨<strong>è¿å­—ç¬¦</strong>åˆ†éš”ï¼Œå³<strong>å‡å·</strong>ï¼ˆ-ï¼‰ï¼Œä½†æ˜¯
user-agent è¿™æ ·çš„å˜é‡åœ¨ Python ä¸­æ˜¯æ— æ•ˆçš„ï¼Œå› æ­¤ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒHeader
æŠŠå‚æ•°åä¸­çš„å­—ç¬¦ç”±ä¸‹åˆ’çº¿ï¼ˆ_ï¼‰æ”¹ä¸ºè¿å­—ç¬¦ï¼ˆ-ï¼‰æ¥æå–å¹¶å­˜æ¡£è¯·æ±‚å¤´ï¼ŒåŒæ—¶ï¼ŒHTTP
çš„è¯·æ±‚å¤´ä¸åŒºåˆ†å¤§å°å†™ï¼Œå¯ä»¥ä½¿ç”¨ Python æ ‡å‡†æ ·å¼ï¼ˆå³
snake_caseï¼‰è¿›è¡Œå£°æ˜ã€‚å¦‚éœ€ç¦ç”¨ä¸‹åˆ’çº¿è‡ªåŠ¨è½¬æ¢ä¸ºè¿å­—ç¬¦ï¼Œå¯ä»¥æŠŠ Header çš„
convert_underscores å‚æ•°è®¾ç½®ä¸º Falseï¼ˆæ…ç”¨ï¼‰ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Header</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_items</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="comment"># æ…ç”¨convert_underscores=Falses</span></span></span><br><span class="line"><span class="params">    user_agent: <span class="built_in">str</span> | <span class="literal">None</span> = Header(<span class="params">default=<span class="literal">None</span>, </span>) <span class="comment"># ä»Headerä¸­è·å–User-Agent</span></span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;user_agent&quot;</span>: user_agent&#125;</span><br></pre></td></tr></table></figure></p>
<p>2.é‡å¤çš„è¯·æ±‚å¤´ï¼Œæœ‰æ—¶ï¼Œå¯èƒ½éœ€è¦æ¥æ”¶é‡å¤çš„è¯·æ±‚å¤´ã€‚å³åŒä¸€ä¸ªè¯·æ±‚å¤´æœ‰å¤šä¸ªå€¼ã€‚ä½¿ç”¨
Python list å¯ä»¥æ¥æ”¶é‡å¤è¯·æ±‚å¤´æ‰€æœ‰çš„å€¼ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Header</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># list[str]æ¥æ”¶é‡å¤çš„è¯·æ±‚å¤´</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_items</span>(<span class="params">x_token: <span class="built_in">list</span>[<span class="built_in">str</span>] | <span class="literal">None</span> = Header(<span class="params">default=<span class="literal">None</span></span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;X-Token values&quot;</span>: x_token&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ­¤æ—¶è¯·æ±‚Headerå‘é€ï¼š</span></span><br><span class="line">X-Token: foo</span><br><span class="line">X-Token: bar</span><br><span class="line"><span class="comment"># è¿”å›å“åº”ç»“æœï¼š</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;X-Token values&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;bar&quot;</span>,</span><br><span class="line">        <span class="string">&quot;foo&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>3.Headerå‚æ•°ä¹Ÿå¯ä»¥ä½¿ç”¨Pydanticæ¨¡å‹å®šä¹‰ï¼Œå¹¶ä¸”å¯ä»¥åŒ…å«å¤šä¸ªå­—æ®µï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Header</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CommonHeaders</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="comment"># model_config = &#123;&quot;extra&quot;: &quot;forbid&quot;&#125;</span></span><br><span class="line">    host: <span class="built_in">str</span></span><br><span class="line">    save_data: <span class="built_in">bool</span></span><br><span class="line">    if_modified_since: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line">    traceparent: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line">    x_tag: <span class="built_in">list</span>[<span class="built_in">str</span>] = []</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_items</span>(<span class="params">headers: CommonHeaders = Header(<span class="params"></span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> headers</span><br></pre></td></tr></table></figure></p>
<h1 id="å“åº”header">å“åº”Header</h1>
<p>å¯ä»¥åœ¨å“åº”ä¸­å®šä¹‰ä¸€ä¸ªResponseå‚æ•°ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨è¿™ä¸ªä¸´æ—¶å“åº”å¯¹è±¡ä¸­è®¾ç½®headerã€‚<br />
ä¹Ÿå¯ä»¥åˆ›å»ºä¸€ä¸ªJSONResponseå¯¹è±¡ï¼Œå†æ·»åŠ headerï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Response</span><br><span class="line"><span class="keyword">from</span> fastapi.responses <span class="keyword">import</span> JSONResponse</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/headers-and-object/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_headers</span>(<span class="params">response: Response</span>): <span class="comment"># ä¸´æ—¶å“åº”å¯¹è±¡</span></span><br><span class="line">    response.headers[<span class="string">&quot;X-Cat-Dog&quot;</span>] = <span class="string">&quot;alone in the world&quot;</span>  <span class="comment"># å“åº”ä¸­æ·»åŠ header</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Hello World&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/headers/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_headers</span>():</span><br><span class="line">    content = &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Hello World&quot;</span>&#125;</span><br><span class="line">    headers = &#123;<span class="string">&quot;X-Cat-Dog&quot;</span>: <span class="string">&quot;alone in the world&quot;</span>, <span class="string">&quot;Content-Language&quot;</span>: <span class="string">&quot;en-US&quot;</span>&#125;</span><br><span class="line">    <span class="keyword">return</span> JSONResponse(content=content, headers=headers) <span class="comment"># åˆ›å»ºJSONResponseï¼Œå¹¶æ·»åŠ header</span></span><br></pre></td></tr></table></figure></p>
<h1 id="å“åº”æ–¹å¼">å“åº”æ–¹å¼</h1>
<p>FastAPI é»˜è®¤ä¼šä½¿ç”¨ JSONResponse è¿”å›å“åº”ã€‚<br />
1.JSONResponseæ˜¯Responseçš„å­ç±»ï¼ŒJSONResponseä¸èƒ½ç›´æ¥ä½¿ç”¨Pydanticæ¨¡å‹ï¼Œéœ€è¦å°†å…¶è½¬æ¢ä¸ºdictï¼Œå¹¶å°†æ‰€æœ‰æ•°æ®ç±»å‹ï¼ˆå¦‚
datetimeã€UUID ç­‰ï¼‰è½¬æ¢ä¸ºå…¼å®¹ JSON
çš„ç±»å‹ï¼ˆä½¿ç”¨jsonable_encoderï¼Œå‚è€ƒã€ç¼–ç å…¼å®¹ã€‘ï¼‰ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Union</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> fastapi.encoders <span class="keyword">import</span> jsonable_encoder</span><br><span class="line"><span class="keyword">from</span> fastapi.responses <span class="keyword">import</span> JSONResponse</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Item</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    title: <span class="built_in">str</span></span><br><span class="line">    timestamp: datetime</span><br><span class="line">    description: <span class="type">Union</span>[<span class="built_in">str</span>, <span class="literal">None</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/items/&#123;id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">update_item</span>(<span class="params"><span class="built_in">id</span>: <span class="built_in">str</span>, item: Item</span>):</span><br><span class="line">    json_compatible_item_data = jsonable_encoder(item) <span class="comment"># éœ€è¦å…ˆè½¬åŒ–ä¸ºå…¼å®¹jsonç±»å‹</span></span><br><span class="line">    <span class="keyword">return</span> JSONResponse(content=json_compatible_item_data)</span><br></pre></td></tr></table></figure></p>
<p>2.ä¸Šé¢æœ¬å¯ä»¥ç›´æ¥è¿”å›itemï¼Œä½†ä¸ºäº†å…¼å®¹JSONï¼Œéœ€è¦ä½¿ç”¨jsonable_encoderã€‚<br />
ç°åœ¨ä½¿ç”¨Responseè¿”å›ä¸€ä¸ªè‡ªå®šä¹‰çš„å“åº”ï¼Œä¿æŒåŸå§‹ç±»å‹ï¼Œæ³¨æ„ï¼Œå®ƒæ²¡æœ‰æ ¡éªŒï¼Œä¹Ÿä¸ä¼šè½¬æ¢ï¼ˆåºåˆ—åŒ–ï¼‰ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Response</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/legacy/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_legacy_data</span>():</span><br><span class="line">    data = <span class="string">&quot;&quot;&quot;&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="string">    &lt;shampoo&gt;</span></span><br><span class="line"><span class="string">    &lt;Header&gt;</span></span><br><span class="line"><span class="string">        Apply shampoo here.</span></span><br><span class="line"><span class="string">    &lt;/Header&gt;</span></span><br><span class="line"><span class="string">    &lt;Body&gt;</span></span><br><span class="line"><span class="string">        You&#x27;ll have to use soap here.</span></span><br><span class="line"><span class="string">    &lt;/Body&gt;</span></span><br><span class="line"><span class="string">    &lt;/shampoo&gt;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> Response(content=data, media_type=<span class="string">&quot;application/xml&quot;</span>)  <span class="comment"># è¿”å›åŸå§‹çš„xmlç±»å‹</span></span><br></pre></td></tr></table></figure></p>
<p>3.è·¯å¾„å‡½æ•°ä¸­å£°æ˜ä¸´æ—¶å“åº”ï¼Œå¯ä»¥æ ¹æ®æ¡ä»¶æ”¹å˜å“åº”çš„status_codeã€headersã€cookiesç­‰ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Response, status</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line">tasks = &#123;<span class="string">&quot;foo&quot;</span>: <span class="string">&quot;Listen to the Bar Fighters&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/get-or-create-task/&#123;task_id&#125;&quot;</span>, status_code=<span class="number">200</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_or_create_task</span>(<span class="params">task_id: <span class="built_in">str</span>, response: Response</span>): <span class="comment"># ä¸´æ—¶å“åº”</span></span><br><span class="line">    <span class="keyword">if</span> task_id <span class="keyword">not</span> <span class="keyword">in</span> tasks:</span><br><span class="line">        tasks[task_id] = <span class="string">&quot;This didn&#x27;t exist before&quot;</span></span><br><span class="line">        response.status_code = status.HTTP_201_CREATED</span><br><span class="line">        response.headers[<span class="string">&quot;X-Cat-Dog&quot;</span>] = <span class="string">&quot;alone in the world&quot;</span>  <span class="comment"># å“åº”ä¸­æ·»åŠ header</span></span><br><span class="line">        response.set_cookie(key=<span class="string">&quot;fakesession&quot;</span>, value=<span class="string">&quot;fake-cookie-session-value&quot;</span>) <span class="comment"># åœ¨å“åº”ä¸­æ·»åŠ cookie</span></span><br><span class="line">    <span class="keyword">return</span> tasks[task_id]</span><br></pre></td></tr></table></figure></p>
<p>3.å…¶ä»–JSONå“åº”ï¼š<br />
JSONResponseï¼šæ€§èƒ½ä¸Šä¸€èˆ¬ï¼Œä½†æ”¯æŒå…¨éƒ¨Pythonçš„ç±»å‹ã€‚<br />
ORJSONResponseï¼šä½¿ç”¨orjonï¼Œåœ¨æ€§èƒ½ä¸Šå¼ºäºJSONResponseï¼Œä½†ä¸æ”¯æŒä¸€äº›Pythonçš„ç±»å‹ï¼Œå¦‚Decimal
å’Œ UUIDã€‚<br />
UJSONResponseï¼šä½¿ç”¨ujosnï¼ŒåŒORJSONResponseã€‚<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> fastapi.responses <span class="keyword">import</span> ORJSONResponse</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‚æ•° response_class ä¹Ÿä¼šç”¨æ¥å®šä¹‰å“åº”çš„ã€Œåª’ä½“ç±»å‹ã€</span></span><br><span class="line"><span class="comment"># æŒ‡å®šäº†è¿”å›ç±»å‹ï¼ŒHTTP å“åº”å¤´çš„ Content-Type ä¼šè¢«è®¾ç½®æˆ application/json</span></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span>, response_class=ORJSONResponse</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_items</span>():</span><br><span class="line">    <span class="keyword">return</span> ORJSONResponse([&#123;<span class="string">&quot;item_id&quot;</span>: <span class="string">&quot;Foo&quot;</span>&#125;])</span><br></pre></td></tr></table></figure></p>
<p>4.HTMLå“åº”ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> fastapi.responses <span class="keyword">import</span> HTMLResponse</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®šäº†è¿”å›ç±»å‹ï¼ŒHTTP å“åº”å¤´çš„ Content-Type ä¼šè¢«è®¾ç½®æˆ text/html</span></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span>, response_class=HTMLResponse</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_items</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    &lt;html&gt;</span></span><br><span class="line"><span class="string">        &lt;head&gt;</span></span><br><span class="line"><span class="string">            &lt;title&gt;Some HTML in here&lt;/title&gt;</span></span><br><span class="line"><span class="string">        &lt;/head&gt;</span></span><br><span class="line"><span class="string">        &lt;body&gt;</span></span><br><span class="line"><span class="string">            &lt;h1&gt;Look ma! HTML!&lt;/h1&gt;</span></span><br><span class="line"><span class="string">        &lt;/body&gt;</span></span><br><span class="line"><span class="string">    &lt;/html&gt;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆ–è€…å¦‚ä¸‹æ–¹å¼ï¼Œä½†æ²¡æœ‰response_classï¼Œè‡ªåŠ¨æ–‡æ¡£ä¸­å°±ä¸ä¼šè®°å½•è¿”å›çš„Response</span></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_items</span>():</span><br><span class="line">    html_content = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    &lt;html&gt;</span></span><br><span class="line"><span class="string">        &lt;head&gt;</span></span><br><span class="line"><span class="string">            &lt;title&gt;Some HTML in here&lt;/title&gt;</span></span><br><span class="line"><span class="string">        &lt;/head&gt;</span></span><br><span class="line"><span class="string">        &lt;body&gt;</span></span><br><span class="line"><span class="string">            &lt;h1&gt;Look ma! HTML!&lt;/h1&gt;</span></span><br><span class="line"><span class="string">        &lt;/body&gt;</span></span><br><span class="line"><span class="string">    &lt;/html&gt;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> HTMLResponse(content=html_content, status_code=<span class="number">200</span>)</span><br></pre></td></tr></table></figure></p>
<p>5.çº¯æ–‡æœ¬å“åº”ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> fastapi.responses <span class="keyword">import</span> PlainTextResponse</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®šäº†è¿”å›ç±»å‹ï¼ŒHTTP å“åº”å¤´çš„ Content-Type ä¼šè¢«è®¾ç½®æˆ text/html</span></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/&quot;</span>, response_class=PlainTextResponse</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hello World&quot;</span></span><br></pre></td></tr></table></figure></p>
<p>6.é‡å®šå‘å“åº”ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> fastapi.responses <span class="keyword">import</span> RedirectResponse</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="comment"># é»˜è®¤ä½¿ç”¨ 307 çŠ¶æ€ä»£ç ï¼ˆä¸´æ—¶é‡å®šå‘ï¼‰</span></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/typer&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">redirect_typer</span>():</span><br><span class="line">    <span class="keyword">return</span> RedirectResponse(<span class="string">&quot;https://typer.tiangolo.com&quot;</span>)</span><br></pre></td></tr></table></figure></p>
<p>7.æµå¼ä¼ è¾“å“åº”ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> fastapi.responses <span class="keyword">import</span> StreamingResponse</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼‚æ­¥/åŒæ­¥ç”Ÿæˆå™¨éƒ½å¯ä»¥</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">fake_video_streamer</span>():</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        <span class="keyword">yield</span> <span class="string">b&quot;some fake video bytes&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># ä½¿ç”¨æµå¼å“åº”ï¼Œä¼ è¾“å“åº”ä¸»ä½“</span></span><br><span class="line">    <span class="keyword">return</span> StreamingResponse(fake_video_streamer())</span><br><span class="line"></span><br><span class="line">some_file_path = <span class="string">&quot;large-video-file.mp4&quot;</span></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/video&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># è¿”å›ç”±openå‡½æ•°æ‰“å¼€çš„å¯¹è±¡ï¼Œå¯ä»¥æ˜¯æ–‡ä»¶ã€è¯­éŸ³ã€è§†é¢‘</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">iterfile</span>():  </span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(some_file_path, mode=<span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> file_like: </span><br><span class="line">            <span class="comment"># file_likeæœ¬èº«æ˜¯ä¸€ä¸ªç”Ÿæˆå™¨ï¼Œæ‰€ä»¥ç”¨yield from</span></span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">from</span> file_like  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> StreamingResponse(iterfile(), media_type=<span class="string">&quot;video/mp4&quot;</span>)</span><br></pre></td></tr></table></figure></p>
<p>8.å¼‚æ­¥æ–‡ä»¶å“åº”ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> fastapi.responses <span class="keyword">import</span> FileResponse</span><br><span class="line"></span><br><span class="line">some_file_path = <span class="string">&quot;large-video-file.mp4&quot;</span></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># å¼‚æ­¥ä¼ è¾“æ–‡ä»¶ä½œä¸ºå“åº”</span></span><br><span class="line">    <span class="comment"># path: è¦æµå¼ä¼ è¾“çš„æ–‡ä»¶çš„æ–‡ä»¶è·¯å¾„ã€‚</span></span><br><span class="line">    <span class="comment"># headers: ä»»ä½•è‡ªå®šä¹‰å“åº”å¤´ï¼Œä¼ å…¥å­—å…¸ç±»å‹ã€‚</span></span><br><span class="line">    <span class="comment"># media_type: ç»™å‡ºåª’ä½“ç±»å‹çš„å­—ç¬¦ä¸²ã€‚å¦‚æœæœªè®¾ç½®ï¼Œåˆ™æ–‡ä»¶åæˆ–è·¯å¾„å°†ç”¨äºæ¨æ–­åª’ä½“ç±»å‹ã€‚</span></span><br><span class="line">    <span class="comment"># filenameï¼šå¦‚æœç»™å‡ºï¼Œå®ƒå°†åŒ…å«åœ¨å“åº”çš„ Content-Disposition ä¸­ã€‚</span></span><br><span class="line">    <span class="keyword">return</span> FileResponse(some_file_path)</span><br></pre></td></tr></table></figure></p>
<h1 id="å“åº”æ¨¡å‹">å“åº”æ¨¡å‹</h1>
<p>FastAPI å…è®¸å£°æ˜å“åº”çš„æ¨¡å‹ï¼Œå¹¶è‡ªåŠ¨åºåˆ—åŒ–å®ƒä»¬ã€‚<br />
å¯ä»¥è¿”å›dictã€listç»“æ„ï¼Œä¹Ÿå¯ä»¥strã€intä¸€æ ·çš„å•ä¸ªå€¼ï¼Œè¿˜å¯ä»¥è¿”å› Pydantic
æ¨¡å‹ã€‚</p>
<p>1.å¯ä»¥åœ¨è·¯ç”±ä¸­ä½¿ç”¨<code>response_model</code>å‚æ•°æ¥å£°æ˜ç”¨äºå“åº”çš„æ¨¡å‹ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Any</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Item</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line">    price: <span class="built_in">float</span></span><br><span class="line">    tax: <span class="built_in">float</span> | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line">    tags: <span class="built_in">list</span>[<span class="built_in">str</span>] = []</span><br><span class="line"></span><br><span class="line"><span class="comment"># response_modelæŒ‡å®šè¿”å›æ¨¡å‹ä¸ºItem</span></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/items/&quot;</span>, response_model=Item</span>)</span></span><br><span class="line"><span class="comment"># è¿”å›æ¨¡å‹æ…ç”¨ &quot;-&gt; Item&quot;ï¼Œé˜²æ­¢å…¶ä»–ä½¿ç”¨è¯¥æ¨¡å‹çš„ä¹Ÿæ¥æ”¶åˆ°è¯¥æ¨¡å‹</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_item</span>(<span class="params">item: Item</span>) -&gt; <span class="type">Any</span>: </span><br><span class="line">    <span class="keyword">return</span> item</span><br><span class="line"></span><br><span class="line"><span class="comment"># response_modelæŒ‡å®šè¿”å›æ¨¡å‹ä¸ºDict[str, float]</span></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/items/dict&quot;</span>, response_model=<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">float</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_item</span>(<span class="params">item: Item</span>) -&gt; <span class="type">Any</span>: </span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;price&quot;</span>: item.price&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># response_modelæŒ‡å®šè¿”å›æ¨¡å‹ä¸ºlist[Item]</span></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span>, response_model=<span class="built_in">list</span>[Item]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_items</span>() -&gt; <span class="type">Any</span>: </span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Portal Gun&quot;</span>, <span class="string">&quot;price&quot;</span>: <span class="number">42.0</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Plumbus&quot;</span>, <span class="string">&quot;price&quot;</span>: <span class="number">32.0</span>&#125;,</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># /items/è¿”å›å“åº”ç»“æœï¼Œæ˜¯æŒ‡å®šçš„list[Item]æ¨¡å‹ï¼š</span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Portal Gun&quot;</span>,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: null,</span><br><span class="line">        <span class="string">&quot;price&quot;</span>: <span class="number">42.0</span>,</span><br><span class="line">        <span class="string">&quot;tax&quot;</span>: null,</span><br><span class="line">        <span class="string">&quot;tags&quot;</span>: []</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Plumbus&quot;</span>,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: null,</span><br><span class="line">        <span class="string">&quot;price&quot;</span>: <span class="number">32.0</span>,</span><br><span class="line">        <span class="string">&quot;tax&quot;</span>: null,</span><br><span class="line">        <span class="string">&quot;tags&quot;</span>: []</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure></p>
<p>2.å“åº”æ¨¡å‹çš„é»˜è®¤å€¼åŠé…ç½®ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Union</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Item</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="type">Union</span>[<span class="built_in">str</span>, <span class="literal">None</span>] = <span class="literal">None</span>  <span class="comment"># é»˜è®¤å€¼None</span></span><br><span class="line">    price: <span class="built_in">float</span></span><br><span class="line">    tax: <span class="built_in">float</span> = <span class="number">10.5</span> <span class="comment"># é»˜è®¤å€¼10.5</span></span><br><span class="line">    tags: <span class="type">List</span>[<span class="built_in">str</span>] = []</span><br><span class="line"></span><br><span class="line">items = &#123;</span><br><span class="line">    <span class="string">&quot;foo&quot;</span>: &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Foo&quot;</span>, <span class="string">&quot;price&quot;</span>: <span class="number">50.2</span>&#125;,</span><br><span class="line">    <span class="string">&quot;bar&quot;</span>: &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Bar&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;The bartenders&quot;</span>, <span class="string">&quot;price&quot;</span>: <span class="number">62</span>, <span class="string">&quot;tax&quot;</span>: <span class="number">20.2</span>&#125;,</span><br><span class="line">    <span class="string">&quot;baz&quot;</span>: &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Baz&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="literal">None</span>, <span class="string">&quot;price&quot;</span>: <span class="number">50.2</span>, <span class="string">&quot;tax&quot;</span>: <span class="number">10.5</span>, <span class="string">&quot;tags&quot;</span>: []&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#  response_model_exclude_unset=Trueï¼Œè¡¨ç¤ºåªè¿”å›ä¸»åŠ¨è®¾ç½®çš„å­—æ®µï¼Œå¦‚æœå­—æ®µæœªä¸»åŠ¨è®¾ç½®ä¸”æ˜¯é»˜è®¤å€¼çš„ï¼Œåˆ™ä¸è¿”å›</span></span><br><span class="line"><span class="comment">#  response_model_exclude_none=Trueï¼Œè¡¨ç¤ºåªè¿”å›éNoneçš„å€¼</span></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span>, response_model=Item, </span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_item</span>(<span class="params">item_id: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">return</span> items[item_id]</span><br></pre></td></tr></table></figure></p>
<p>3.å“åº”æ¨¡å‹çš„åŒ…å«ã€æ’é™¤ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Union</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Item</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="type">Union</span>[<span class="built_in">str</span>, <span class="literal">None</span>] = <span class="literal">None</span></span><br><span class="line">    price: <span class="built_in">float</span></span><br><span class="line">    tax: <span class="built_in">float</span> = <span class="number">10.5</span></span><br><span class="line"></span><br><span class="line">items = &#123;</span><br><span class="line">    <span class="string">&quot;foo&quot;</span>: &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Foo&quot;</span>, <span class="string">&quot;price&quot;</span>: <span class="number">50.2</span>&#125;,</span><br><span class="line">    <span class="string">&quot;bar&quot;</span>: &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Bar&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;The Bar fighters&quot;</span>, <span class="string">&quot;price&quot;</span>: <span class="number">62</span>, <span class="string">&quot;tax&quot;</span>: <span class="number">20.2</span>&#125;,</span><br><span class="line">    <span class="string">&quot;baw&quot;</span>: &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Baz&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="literal">None</span>, <span class="string">&quot;price&quot;</span>: <span class="number">50.2</span>, <span class="string">&quot;tax&quot;</span>: <span class="number">10.5</span>, <span class="string">&quot;tags&quot;</span>: []&#125;,</span><br><span class="line">    <span class="string">&quot;baz&quot;</span>: &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Baz&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;There goes my baz&quot;</span>, <span class="string">&quot;price&quot;</span>: <span class="number">50.2</span>, <span class="string">&quot;tax&quot;</span>: <span class="number">10.5</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># response_model_include = &#123;key1, key2...&#125;ï¼Œè¡¨ç¤ºåªè¿”å›æŒ‡å®šçš„å­—æ®µ</span></span><br><span class="line"><span class="meta">@app.get(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="meta">    <span class="string">&quot;/items/&#123;item_id&#125;/name&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="meta">    response_model=Item,</span></span></span><br><span class="line"><span class="params"><span class="meta">    response_model_include=&#123;<span class="string">&quot;name&quot;</span>, <span class="string">&quot;description&quot;</span>&#125;,</span></span></span><br><span class="line"><span class="params"><span class="meta"></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_item_name</span>(<span class="params">item_id: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">return</span> items[item_id]</span><br><span class="line"></span><br><span class="line"><span class="comment"># response_model_excludeï¼Œè¡¨ç¤ºæ’é™¤æŒ‡å®šçš„å­—æ®µ</span></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;/public&quot;</span>, response_model=Item, response_model_exclude=&#123;<span class="string">&quot;tax&quot;</span>&#125;</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_item_public_data</span>(<span class="params">item_id: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">return</span> items[item_id]</span><br></pre></td></tr></table></figure></p>
<p>4.è¾“å…¥å’Œè¾“å‡ºæ¨¡å‹çš„ä½¿ç”¨ï¼Œæ¯”å¦‚ç”¨æˆ·æ¨¡å‹ï¼Œè¾“å…¥æ¨¡å‹åº”è¯¥å«å¯†ç ã€è¾“å‡ºæ¨¡å‹ä¸åº”å«å¯†ç ã€æ•°æ®åº“æ¨¡å‹éœ€è¦åŠ å¯†çš„å¯†ç ï¼š<br />
<div class="tabs" id="1"><ul class="nav-tabs"><li class="tab active"><a href="#1-1">BaseModelæ¨¡å¼</a></li><li class="tab"><a href="#1-2">ç»§æ‰¿æ¨¡å¼</a></li></ul><div class="tab-content"><div class="tab-pane active" id="1-1"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, EmailStr</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserIn</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    username: <span class="built_in">str</span></span><br><span class="line">    password: <span class="built_in">str</span></span><br><span class="line">    email: EmailStr</span><br><span class="line">    full_name: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserOut</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    username: <span class="built_in">str</span></span><br><span class="line">    email: EmailStr</span><br><span class="line">    full_name: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserInDB</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    username: <span class="built_in">str</span></span><br><span class="line">    hashed_password: <span class="built_in">str</span></span><br><span class="line">    email: EmailStr</span><br><span class="line">    full_name: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fake_password_hasher</span>(<span class="params">raw_password: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;supersecret&quot;</span> + raw_password</span><br><span class="line"></span><br><span class="line"><span class="comment"># UserInDBæ˜¯æ•°æ®åº“æ¨¡å‹ï¼Œéœ€è¦åŠ å¯†çš„å¯†ç </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fake_save_user</span>(<span class="params">user_in: UserIn</span>):</span><br><span class="line">    hashed_password = fake_password_hasher(user_in.password)</span><br><span class="line">    <span class="comment"># **user_in.dict()è§£åŒ…ï¼Œå¹¶å¢åŠ æ–°kvå¯¹</span></span><br><span class="line">    user_in_db = UserInDB(**user_in.<span class="built_in">dict</span>(), hashed_password=hashed_password)  </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;User saved! ..not really&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> user_in_db</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/user/&quot;</span>, response_model=UserOut</span>) </span><span class="comment"># UserOutè¾“å‡ºæ¨¡å‹</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_user</span>(<span class="params">user_in: UserIn</span>): <span class="comment"># UserInè¾“å…¥æ¨¡å‹</span></span><br><span class="line">    user_saved = fake_save_user(user_in)</span><br><span class="line">    <span class="keyword">return</span> user_saved</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="1-2"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, EmailStr</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserBase</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    username: <span class="built_in">str</span></span><br><span class="line">    email: EmailStr</span><br><span class="line">    full_name: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»§æ‰¿UserBaseï¼Œä»…å£°æ˜æ¨¡å‹ä¹‹é—´çš„å·®å¼‚éƒ¨åˆ†ï¼Œä¾¿äºç»´æŠ¤</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserIn</span>(<span class="title class_ inherited__">UserBase</span>):</span><br><span class="line">    password: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserOut</span>(<span class="title class_ inherited__">UserBase</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserInDB</span>(<span class="title class_ inherited__">UserBase</span>):</span><br><span class="line">    hashed_password: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fake_password_hasher</span>(<span class="params">raw_password: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;supersecret&quot;</span> + raw_password</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fake_save_user</span>(<span class="params">user_in: UserIn</span>):</span><br><span class="line">    hashed_password = fake_password_hasher(user_in.password)</span><br><span class="line">    user_in_db = UserInDB(**user_in.<span class="built_in">dict</span>(), hashed_password=hashed_password)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;User saved! ..not really&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> user_in_db</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/user/&quot;</span>, response_model=UserOut</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_user</span>(<span class="params">user_in: UserIn</span>):</span><br><span class="line">    user_saved = fake_save_user(user_in)</span><br><span class="line">    <span class="keyword">return</span> user_saved</span><br></pre></td></tr></table></figure></div></div></div></p>
<p>5.å“åº”æ¨¡å‹ä¹Ÿå¯ä»¥æŒ‡å®šå¤šä¸ªæ¨¡å‹ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Union</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BaseItem</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    description: <span class="built_in">str</span></span><br><span class="line">    <span class="built_in">type</span>: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CarItem</span>(<span class="title class_ inherited__">BaseItem</span>):</span><br><span class="line">    <span class="built_in">type</span>: <span class="built_in">str</span> = <span class="string">&quot;car&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PlaneItem</span>(<span class="title class_ inherited__">BaseItem</span>):</span><br><span class="line">    <span class="built_in">type</span>: <span class="built_in">str</span> = <span class="string">&quot;plane&quot;</span></span><br><span class="line">    size: <span class="built_in">int</span></span><br><span class="line"></span><br><span class="line">items = &#123;</span><br><span class="line">    <span class="string">&quot;item1&quot;</span>: &#123;<span class="string">&quot;description&quot;</span>: <span class="string">&quot;All my friends drive a low rider&quot;</span>, <span class="string">&quot;type&quot;</span>: <span class="string">&quot;car&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;item2&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Music is my aeroplane, it&#x27;s my aeroplane&quot;</span>,</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;plane&quot;</span>,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: <span class="number">5</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Unionä¹Ÿå¯æŒ‡å®šå“åº”å¯ä»¥æ˜¯å¤šä¸ªæ¨¡å‹ï¼ŒUnion[PlaneItem, CarItem]</span></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span>, response_model=PlaneItem | CarItem</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_item</span>(<span class="params">item_id: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">return</span> items[item_id]</span><br></pre></td></tr></table></figure></p>
<h1 id="å¼‚å¸¸å¤„ç†">å¼‚å¸¸å¤„ç†</h1>
<p>1.å‘å®¢æˆ·ç«¯è¿”å› HTTP é”™è¯¯å“åº”ï¼Œå¯ä»¥ä½¿ç”¨ HTTPExceptionï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, HTTPException</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line">items = &#123;<span class="string">&quot;foo&quot;</span>: <span class="string">&quot;The Foo Wrestlers&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_item</span>(<span class="params">item_id: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">if</span> item_id <span class="keyword">not</span> <span class="keyword">in</span> items:</span><br><span class="line">        <span class="comment"># å®¢æˆ·ç«¯ç”¨ ID è¯·æ±‚çš„ item ä¸å­˜åœ¨æ—¶ï¼Œè§¦å‘çŠ¶æ€ç ä¸º 404 çš„å¼‚å¸¸</span></span><br><span class="line">        <span class="comment"># ä½¿ç”¨raiseæŠ›å‡ºå¼‚å¸¸ï¼Œå¹¶æŒ‡å®šHTTPçŠ¶æ€ç </span></span><br><span class="line">        <span class="comment"># è§¦å‘ HTTPException æ—¶ï¼Œå¯ä»¥ç”¨å‚æ•° detail ä¼ é€’ä»»ä½•èƒ½è½¬æ¢ä¸º JSON çš„å€¼ï¼Œä¸ä»…é™äº strã€‚è¿˜æ”¯æŒä¼ é€’ dictã€list ç­‰æ•°æ®ç»“æ„ã€‚</span></span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">404</span>, detail=<span class="string">&quot;Item not found&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;item&quot;</span>: items[item_id]&#125;</span><br></pre></td></tr></table></figure></p>
<p>2.å¯ä»¥ä¸º HTTP é”™è¯¯æ·»åŠ è‡ªå®šä¹‰å“åº”å¤´ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, HTTPException</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line">items = &#123;<span class="string">&quot;foo&quot;</span>: <span class="string">&quot;The Foo Wrestlers&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items-header/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_item_header</span>(<span class="params">item_id: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">if</span> item_id <span class="keyword">not</span> <span class="keyword">in</span> items:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(</span><br><span class="line">            status_code=<span class="number">404</span>,</span><br><span class="line">            detail=<span class="string">&quot;Item not found&quot;</span>,</span><br><span class="line">            headers=&#123;<span class="string">&quot;X-Error&quot;</span>: <span class="string">&quot;There goes my error&quot;</span>&#125;, <span class="comment"># è‡ªå®šä¹‰å“åº”å¤´</span></span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;item&quot;</span>: items[item_id]&#125;</span><br></pre></td></tr></table></figure></p>
<p>3.è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†å™¨ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># starletteä¹Ÿå¯ä»¥ç”¨äºå¯¼å…¥ Request å’Œ JSONResponseã€‚</span></span><br><span class="line"><span class="comment"># from starlette.requests import Request </span></span><br><span class="line"><span class="comment"># from starlette.responses import JSONResponse </span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Request</span><br><span class="line"><span class="keyword">from</span> fastapi.responses <span class="keyword">import</span> JSONResponse</span><br><span class="line"></span><br><span class="line"><span class="comment"># è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†å™¨ï¼Œéœ€è¦ç»§æ‰¿Exceptionç±»</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UnicornException</span>(<span class="title class_ inherited__">Exception</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name: <span class="built_in">str</span></span>):</span><br><span class="line">        self.name = name</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ @app.exception_handler() æ·»åŠ è‡ªå®šä¹‰å¼‚å¸¸æ§åˆ¶å™¨ï¼Œå¹¶æŒ‡å®šè¦å¤„ç†çš„å¼‚å¸¸ç±»</span></span><br><span class="line"><span class="meta">@app.exception_handler(<span class="params">UnicornException</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">unicorn_exception_handler</span>(<span class="params">request: Request, exc: UnicornException</span>):</span><br><span class="line">    <span class="comment"># æ¥æ”¶åˆ°çš„é”™è¯¯ä¿¡æ¯æ¸…æ™°æ˜äº†ï¼ŒHTTP çŠ¶æ€ç ä¸º 418ï¼ŒJSON å†…å®¹å¦‚contentï¼š</span></span><br><span class="line">    <span class="keyword">return</span> JSONResponse(</span><br><span class="line">        status_code=<span class="number">418</span>,</span><br><span class="line">        content=&#123;<span class="string">&quot;message&quot;</span>: <span class="string">f&quot;Oops! <span class="subst">&#123;exc.name&#125;</span> did something. There goes a rainbow...&quot;</span>&#125;,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/unicorns/&#123;name&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_unicorn</span>(<span class="params">name: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">if</span> name == <span class="string">&quot;yolo&quot;</span>:</span><br><span class="line">        <span class="comment"># è¯·æ±‚ /unicorns/yolo æ—¶ï¼Œè·¯å¾„æ“ä½œä¼šè§¦å‘ UnicornExceptionã€‚</span></span><br><span class="line">        <span class="comment"># ä½†è¯¥å¼‚å¸¸å°†ä¼šè¢« unicorn_exception_handler å¤„ç†ã€‚</span></span><br><span class="line">        <span class="keyword">raise</span> UnicornException(name=name)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;unicorn_name&quot;</span>: name&#125;</span><br></pre></td></tr></table></figure></p>
<p>4.è¦†ç›–é»˜è®¤çš„å¼‚å¸¸ï¼ŒFastAPI
è‡ªå¸¦äº†ä¸€äº›é»˜è®¤å¼‚å¸¸å¤„ç†å™¨ï¼Œä»¥ä½¿ç”¨è‡ªå®šä¹‰å¤„ç†å™¨è¦†ç›–é»˜è®¤å¼‚å¸¸å¤„ç†å™¨ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, HTTPException  <span class="comment"># HTTPExceptionç»§æ‰¿è‡ªStarletteHTTPException</span></span><br><span class="line"><span class="keyword">from</span> fastapi.exceptions <span class="keyword">import</span> RequestValidationError  </span><br><span class="line"><span class="keyword">from</span> fastapi.responses <span class="keyword">import</span> PlainTextResponse</span><br><span class="line"><span class="keyword">from</span> starlette.exceptions <span class="keyword">import</span> HTTPException <span class="keyword">as</span> StarletteHTTPException </span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¦†ç›–é»˜è®¤å¼‚å¸¸å¤„ç†å™¨StarletteHTTPExceptionï¼ˆè¦†ç›–Starlette çš„ HTTPExceptionï¼‰</span></span><br><span class="line"><span class="meta">@app.exception_handler(<span class="params">StarletteHTTPException</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">http_exception_handler</span>(<span class="params">request, exc</span>):</span><br><span class="line">    <span class="keyword">return</span> PlainTextResponse(<span class="built_in">str</span>(exc.detail), status_code=exc.status_code)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¦†ç›–é»˜è®¤å¼‚å¸¸å¤„ç†å™¨RequestValidationErrorï¼Œè¯·æ±‚ä¸­åŒ…å«æ— æ•ˆæ•°æ®æ—¶è§¦å‘</span></span><br><span class="line"><span class="meta">@app.exception_handler(<span class="params">RequestValidationError</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">validation_exception_handler</span>(<span class="params">request, exc</span>):</span><br><span class="line">    <span class="keyword">return</span> PlainTextResponse(<span class="built_in">str</span>(exc), status_code=<span class="number">400</span>) <span class="comment"># æŠŠé»˜è®¤çš„å¼‚å¸¸jsonï¼Œè½¬ä¸ºtextæ ¼å¼</span></span><br><span class="line">    <span class="comment"># RequestValidationError åŒ…å«å…¶æ¥æ”¶åˆ°çš„æ— æ•ˆæ•°æ®è¯·æ±‚çš„ bodyï¼Œå¼€å‘æ—¶ï¼Œå¯ä»¥ç”¨è¿™ä¸ªè¯·æ±‚ä½“ç”Ÿæˆæ—¥å¿—ã€è°ƒè¯•é”™è¯¯ï¼Œå¹¶è¿”å›ç»™ç”¨æˆ·ã€‚</span></span><br><span class="line">    <span class="comment"># return JSONResponse(</span></span><br><span class="line">    <span class="comment">#     status_code=status.HTTP_422_UNPROCESSABLE_ENTITY,</span></span><br><span class="line">    <span class="comment">#     content=jsonable_encoder(&#123;&quot;detail&quot;: exc.errors(), &quot;body&quot;: exc.body&#125;),</span></span><br><span class="line">    <span class="comment"># )</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_item</span>(<span class="params">item_id: <span class="built_in">int</span></span>):</span><br><span class="line">    <span class="keyword">if</span> item_id == <span class="number">3</span>:</span><br><span class="line">        <span class="comment"># è§¦å‘http_exception_handler</span></span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">418</span>, detail=<span class="string">&quot;Nope! I don&#x27;t like 3.&quot;</span>) </span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;item_id&quot;</span>: item_id&#125;</span><br></pre></td></tr></table></figure></p>
<p>5.å…ˆå¯¹å¼‚å¸¸è¿›è¡ŒæŸäº›å¤„ç†ï¼Œå†ä½¿ç”¨é»˜è®¤å¼‚å¸¸å¤„ç†å™¨ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, HTTPException</span><br><span class="line"><span class="keyword">from</span> fastapi.exception_handlers <span class="keyword">import</span> http_exception_handler, request_validation_exception_handler</span><br><span class="line"><span class="keyword">from</span> fastapi.exceptions <span class="keyword">import</span> RequestValidationError</span><br><span class="line"><span class="keyword">from</span> starlette.exceptions <span class="keyword">import</span> HTTPException <span class="keyword">as</span> StarletteHTTPException</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.exception_handler(<span class="params">StarletteHTTPException</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">custom_http_exception_handler</span>(<span class="params">request, exc</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;OMG! An HTTP error!: <span class="subst">&#123;<span class="built_in">repr</span>(exc)&#125;</span>&quot;</span>)  <span class="comment"># å…ˆå¯¹å¼‚å¸¸å¤„ç†</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> http_exception_handler(request, exc)  <span class="comment"># å†ä½¿ç”¨é»˜è®¤å¼‚å¸¸å¤„ç†å™¨</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.exception_handler(<span class="params">RequestValidationError</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">validation_exception_handler</span>(<span class="params">request, exc</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;OMG! The client sent invalid data!: <span class="subst">&#123;exc&#125;</span>&quot;</span>)  <span class="comment"># å…ˆå¯¹å¼‚å¸¸å¤„ç†</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> request_validation_exception_handler(request, exc) <span class="comment"># å†ä½¿ç”¨é»˜è®¤å¼‚å¸¸å¤„ç†å™¨</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_item</span>(<span class="params">item_id: <span class="built_in">int</span></span>):</span><br><span class="line">    <span class="keyword">if</span> item_id == <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">418</span>, detail=<span class="string">&quot;Nope! I don&#x27;t like 3.&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;item_id&quot;</span>: item_id&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="è¡¨å•å‚æ•°">è¡¨å•å‚æ•°</h1>
<p>æ¥æ”¶çš„ä¸æ˜¯ JSONï¼Œè€Œæ˜¯è¡¨å•å­—æ®µæ—¶ï¼Œè¦ä½¿ç”¨ Form
(Formæ˜¯ç»§æ‰¿è‡ªBodyç±»)ã€‚<br />
è¦ä½¿ç”¨è¡¨å•ï¼Œéœ€é¢„å…ˆå®‰è£… <code>pip install python-multipart</code>ã€‚</p>
<p>1.è¡¨å•çš„ä½¿ç”¨ä¸ Body å’Œ Query ç±»ä¼¼ï¼Œåªæ˜¯éœ€è¦å¯¼å…¥ Formï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Form</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/login/&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># ä¸€äº›å‚æ•°å¿…é¡»é€šè¿‡Form()ä¼ é€’ï¼Œæ¯”å¦‚OAuth2è§„èŒƒçš„&quot;å¯†ç æµ&quot;æ¨¡å¼è§„å®šè¦é€šè¿‡è¡¨å•å­—æ®µå‘é€usernameå’Œpasswordã€‚</span></span><br><span class="line"><span class="comment"># å£°æ˜è¡¨å•ä½“è¦æ˜¾å¼ä½¿ç”¨ Form ï¼Œå¦åˆ™ï¼ŒFastAPI ä¼šæŠŠè¯¥å‚æ•°å½“ä½œ&quot;æŸ¥è¯¢å‚æ•°&quot;æˆ–&quot;è¯·æ±‚ä½“&quot;å‚æ•°ã€‚</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">login</span>(<span class="params">username: <span class="built_in">str</span> = Form(<span class="params"></span>), password: <span class="built_in">str</span> = Form(<span class="params"></span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;username&quot;</span>: username&#125;</span><br></pre></td></tr></table></figure></p>
<p>2.è¡¨å•å‚æ•°éœ€Headerå‚æ•°<code>Content-Type</code>é…åˆä½¿ç”¨ï¼Œå…¶å€¼å¦‚ä¸‹ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¸¸ç”¨ä¸‰ä¸ªï¼ŒFormå’ŒBodyä¸èƒ½åŒæ—¶ä½¿ç”¨ï¼š</span></span><br><span class="line"><span class="comment"># Content-Type: application/x-www-form-urlencoded  # Formå‚æ•°</span></span><br><span class="line"><span class="comment"># Content-Type: multipart/form-data  # # Formå‚æ•°</span></span><br><span class="line"><span class="comment"># Content-Type: application/json  # Bodyå‚æ•°</span></span><br><span class="line">text/html  ï¼šHTMLæ ¼å¼</span><br><span class="line">text/plain ï¼šçº¯æ–‡æœ¬æ ¼å¼      </span><br><span class="line">text/xml   ï¼šXMLæ ¼å¼</span><br><span class="line">image/gif  ï¼šgifå›¾ç‰‡æ ¼å¼    </span><br><span class="line">image/jpeg ï¼šjpgå›¾ç‰‡æ ¼å¼ </span><br><span class="line">image/png  ï¼špngå›¾ç‰‡æ ¼å¼</span><br><span class="line">application/xhtml+xml ï¼šXHTMLæ ¼å¼</span><br><span class="line">application/xml       ï¼šXMLæ•°æ®æ ¼å¼</span><br><span class="line">application/atom+xml  ï¼šAtom XMLèšåˆæ ¼å¼    </span><br><span class="line">application/json      ï¼šJSONæ•°æ®æ ¼å¼</span><br><span class="line">application/pdf       ï¼špdfæ ¼å¼  </span><br><span class="line">application/msword    ï¼šWordæ–‡æ¡£æ ¼å¼</span><br><span class="line">application/octet-stream ï¼šäºŒè¿›åˆ¶æµæ•°æ®ï¼ˆå¦‚å¸¸è§çš„æ–‡ä»¶ä¸‹è½½ï¼‰</span><br><span class="line">application/x-www-form-urlencoded  : è¡¨å•æ•°æ®æ ¼å¼</span><br><span class="line">multipart/form-data  ï¼šéœ€è¦åœ¨è¡¨å•ä¸­è¿›è¡Œæ–‡ä»¶ä¸Šä¼ æ—¶ï¼Œå°±éœ€è¦ä½¿ç”¨è¯¥æ ¼å¼</span><br></pre></td></tr></table></figure></p>
<p>3.FormåŒæ ·æ”¯æŒPydanticæ¨¡å‹ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Form</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FormData</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="comment"># model_config = &#123;&quot;extra&quot;: &quot;forbid&quot;&#125;</span></span><br><span class="line">    username: <span class="built_in">str</span></span><br><span class="line">    password: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/login/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">login</span>(<span class="params">data: FormData = Form(<span class="params"></span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure></p>
<h1 id="æ–‡ä»¶å‚æ•°">æ–‡ä»¶å‚æ•°</h1>
<p>File ç”¨äºå®šä¹‰å®¢æˆ·ç«¯çš„ä¸Šä¼ æ–‡ä»¶ï¼Œæ˜¯ä»¥ Form å½¢å¼å‘é€ã€‚<br />
1.ä» fastapi å¯¼å…¥ File å’Œ UploadFileï¼Œè¿™ä¸¤ç§æ–¹å¼éƒ½å¯ä»¥ä¸Šä¼ æ–‡ä»¶ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, File, UploadFile</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/files/&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># ä»¥ bytes å½¢å¼è¯»å–æ–‡ä»¶ï¼Œå¹¶å­˜å‚¨äºå†…å­˜ï¼Œé€‚ç”¨äºå°æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_file</span>(<span class="params">file: <span class="built_in">bytes</span> = File(<span class="params"></span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;file_size&quot;</span>: <span class="built_in">len</span>(file)&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/uploadfile/&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># UploadFile æ¯” File çš„ä¼˜åŠ¿ï¼š</span></span><br><span class="line"><span class="comment"># 1.ä½¿ç”¨ spooled æ–‡ä»¶ï¼ˆå­˜å‚¨åœ¨å†…å­˜çš„æ–‡ä»¶è¶…å‡ºæœ€å¤§ä¸Šé™æ—¶ï¼Œä¼šæŠŠæ–‡ä»¶å­˜å…¥ç£ç›˜ï¼‰</span></span><br><span class="line"><span class="comment"># 2.è¿™ç§æ–¹å¼æ›´é€‚äºå¤„ç†å›¾åƒã€è§†é¢‘ã€äºŒè¿›åˆ¶æ–‡ä»¶ç­‰å¤§å‹æ–‡ä»¶ï¼Œå¥½å¤„æ˜¯ä¸ä¼šå ç”¨æ‰€æœ‰å†…å­˜</span></span><br><span class="line"><span class="comment"># 3.å¯è·å–ä¸Šä¼ æ–‡ä»¶çš„å…ƒæ•°æ®</span></span><br><span class="line"><span class="comment"># 4.è‡ªå¸¦ async æ¥å£ï¼Œå¯å¼‚æ­¥ä¸Šä¼ æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_upload_file</span>(<span class="params">file: UploadFile</span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;filename&quot;</span>: file.filename&#125;</span><br></pre></td></tr></table></figure></p>
<p>2.ä½¿ç”¨UploadFileçš„å±æ€§å’Œæ–¹æ³•ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">|-UploadFileå±æ€§ï¼š</span><br><span class="line">    |-filenameï¼šä¸Šä¼ æ–‡ä»¶åå­—ç¬¦ä¸²ï¼ˆ<span class="built_in">str</span>ï¼‰ï¼Œä¾‹å¦‚ï¼Œ myimage.jpgï¼›</span><br><span class="line">    |-content_typeï¼šå†…å®¹ç±»å‹ï¼ˆMIME ç±»å‹ / åª’ä½“ç±»å‹ï¼‰å­—ç¬¦ä¸²ï¼ˆ<span class="built_in">str</span>ï¼‰ï¼Œä¾‹å¦‚ï¼Œimage/jpegï¼›</span><br><span class="line">    |-fileï¼š SpooledTemporaryFileï¼ˆ file-like å¯¹è±¡ï¼‰ã€‚å…¶å®å°±æ˜¯ Pythonæ–‡ä»¶ï¼Œå¯ç›´æ¥ä¼ é€’ç»™å…¶ä»–é¢„æœŸ file-like å¯¹è±¡çš„å‡½æ•°æˆ–æ”¯æŒåº“ã€‚</span><br><span class="line">|-UploadFileçš„<span class="keyword">async</span>æ–¹æ³•ï¼ˆéœ€é…åˆ<span class="keyword">await</span>ä½¿ç”¨ï¼‰ï¼š</span><br><span class="line">    |-write(data)ï¼šæŠŠ data ï¼ˆ<span class="built_in">str</span> æˆ– <span class="built_in">bytes</span>ï¼‰å†™å…¥æ–‡ä»¶ï¼›</span><br><span class="line">    |-read(size)ï¼šæŒ‰æŒ‡å®šæ•°é‡çš„å­—èŠ‚æˆ–å­—ç¬¦ï¼ˆsize (<span class="built_in">int</span>)ï¼‰è¯»å–æ–‡ä»¶å†…å®¹ï¼›</span><br><span class="line">    |-seek(offset)ï¼šç§»åŠ¨è‡³æ–‡ä»¶ offset ï¼ˆ<span class="built_in">int</span>ï¼‰å­—èŠ‚å¤„çš„ä½ç½®ï¼›</span><br><span class="line">        |-ä¾‹å¦‚ï¼Œ<span class="keyword">await</span> myfile.seek(<span class="number">0</span>) ç§»åŠ¨åˆ°æ–‡ä»¶å¼€å¤´ï¼›</span><br><span class="line">        |-æ‰§è¡Œ <span class="keyword">await</span> myfile.read() åï¼Œéœ€å†æ¬¡è¯»å–å·²è¯»å–å†…å®¹æ—¶ï¼Œè¿™ç§æ–¹æ³•ç‰¹åˆ«å¥½ç”¨ï¼›</span><br><span class="line">    |-close()ï¼šå…³é—­æ–‡ä»¶ã€‚</span><br><span class="line"><span class="comment"># async è¯»å–æ–‡ä»¶ contents = await myfile.read()</span></span><br><span class="line"><span class="comment"># åœ¨æ™®é€š def è·¯å¾„æ“ä½œå‡½æ•° å†…ï¼Œåˆ™å¯ä»¥ç›´æ¥è®¿é—® UploadFile.fileï¼Œæ— éœ€ awaitã€‚ contents = myfile.file.read()</span></span><br></pre></td></tr></table></figure></p>
<p>3.å¯å°†"æ–‡ä»¶ä¸Šä¼ "é»˜è®¤å€¼è®¾ç½®Noneï¼Œè¡¨ç¤ºä¸ºå¯é€‰ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, File, UploadFile</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/files/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_file</span>(<span class="params">file: <span class="built_in">bytes</span> | <span class="literal">None</span> = File(<span class="params">default=<span class="literal">None</span></span>)</span>): <span class="comment"># é»˜è®¤å€¼None</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> file:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;No file sent&quot;</span>&#125;</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;file_size&quot;</span>: <span class="built_in">len</span>(file)&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/uploadfile/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_upload_file</span>(<span class="params">file: UploadFile | <span class="literal">None</span> = <span class="literal">None</span></span>): <span class="comment"># é»˜è®¤å€¼None</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> file:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;No upload file sent&quot;</span>&#125;</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;filename&quot;</span>: file.filename&#125;</span><br></pre></td></tr></table></figure></p>
<p>4.UploadFileå’ŒFileä¸€èµ·ä½¿ç”¨ï¼Œå¯ä¸ºSwaggeræ–‡æ¡£å¢åŠ é¢å¤–çš„å…ƒæ•°æ®ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, File, UploadFile</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/files/&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># Swaggeræ–‡æ¡£å¢åŠ äº†description</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_file</span>(<span class="params">file: <span class="built_in">bytes</span> = File(<span class="params">description=<span class="string">&quot;A file read as bytes&quot;</span></span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;file_size&quot;</span>: <span class="built_in">len</span>(file)&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/uploadfile/&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># Swaggeræ–‡æ¡£å¢åŠ äº†description</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_upload_file</span>(<span class="params">file: UploadFile = File(<span class="params">description=<span class="string">&quot;A file read as UploadFile&quot;</span></span>),</span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;filename&quot;</span>: file.filename&#125;</span><br></pre></td></tr></table></figure></p>
<p>5.æ”¯æŒåŒæ—¶ä¸Šä¼ å¤šä¸ªæ–‡ä»¶ï¼ŒåŒä¸€ä¸ªå­—æ®µå¯æ¥æ”¶å¤šä¸ªæ–‡ä»¶ï¼Œä¸Šä¼ å¤šä¸ªæ–‡ä»¶æ—¶ï¼Œè¦å£°æ˜å«
bytes æˆ– UploadFile çš„åˆ—è¡¨ï¼ˆListï¼‰ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, File, UploadFile</span><br><span class="line"><span class="keyword">from</span> fastapi.responses <span class="keyword">import</span> HTMLResponse</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/files/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_files</span>(<span class="params">files: <span class="built_in">list</span>[<span class="built_in">bytes</span>] = File(<span class="params"></span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;file_sizes&quot;</span>: [<span class="built_in">len</span>(file) <span class="keyword">for</span> file <span class="keyword">in</span> files]&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/uploadfiles/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_upload_files</span>(<span class="params">files: <span class="built_in">list</span>[UploadFile]</span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;filenames&quot;</span>: [file.filename <span class="keyword">for</span> file <span class="keyword">in</span> files]&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    content = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;form action=&quot;/files/&quot; enctype=&quot;multipart/form-data&quot; method=&quot;post&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;input name=&quot;files&quot; type=&quot;file&quot; multiple&gt;</span></span><br><span class="line"><span class="string">&lt;input type=&quot;submit&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;/form&gt;</span></span><br><span class="line"><span class="string">&lt;form action=&quot;/uploadfiles/&quot; enctype=&quot;multipart/form-data&quot; method=&quot;post&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;input name=&quot;files&quot; type=&quot;file&quot; multiple&gt;</span></span><br><span class="line"><span class="string">&lt;input type=&quot;submit&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;/form&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> HTMLResponse(content=content)</span><br></pre></td></tr></table></figure></p>
<h1 id="ç¼–ç å…¼å®¹">ç¼–ç å…¼å®¹</h1>
<p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¯èƒ½éœ€è¦å°†æ•°æ®ç±»å‹ï¼ˆå¦‚Pydanticæ¨¡å‹ï¼‰è½¬æ¢ä¸ºä¸JSONå…¼å®¹çš„æ•°æ®ç±»å‹ï¼ˆå¦‚dictã€listç­‰ï¼‰ã€‚å¸¸ç”¨äºNoSQLæ•°æ®åº“ï¼Œå¦‚MongoDBï¼Œå› ä¸ºMongoDBåªæ¥æ”¶JSONå…¼å®¹çš„æ•°æ®ç±»å‹ï¼Œè€Œä¸æ¥æ”¶Pythonå¯¹è±¡ã€‚<br />
1.æ¯”å¦‚ï¼Œéœ€è¦å°†è¯·æ±‚æ•°æ®å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Œæ•°æ®åº“å®ƒä¸æ¥æ”¶datetimeè¿™ç±»çš„å¯¹è±¡ï¼Œå› ä¸ºè¿™äº›å¯¹è±¡ä¸JSONä¸å…¼å®¹ï¼Œæ•°æ®åº“ä¹Ÿä¸ä¼šæ¥æ”¶Pydanticæ¨¡å‹ï¼ˆå¸¦æœ‰å±æ€§çš„å¯¹è±¡ï¼‰ï¼Œè€Œåªæ¥æ”¶dictã€‚å¯¹æ­¤å¯ä»¥ä½¿ç”¨<code>jsonable_encoder()</code>å°†æ•°æ®è½¬æ¢ä¸ºJSONå…¼å®¹æ ¼å¼ã€‚<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> fastapi.encoders <span class="keyword">import</span> jsonable_encoder</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">fake_db = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Item</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    title: <span class="built_in">str</span></span><br><span class="line">    timestamp: datetime</span><br><span class="line">    description: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/items/&#123;id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">update_item</span>(<span class="params"><span class="built_in">id</span>: <span class="built_in">str</span>, item: Item</span>):</span><br><span class="line">    json_compatible_item_data = jsonable_encoder(item) <span class="comment"># å°†itemè½¬æ¢ä¸ºJSONå…¼å®¹æ ¼å¼</span></span><br><span class="line">    fake_db[<span class="built_in">id</span>] = json_compatible_item_data <span class="comment"># ç›´æ¥å­˜å‚¨äºæ•°æ®åº“ä¸­</span></span><br></pre></td></tr></table></figure></p>
<p>2.æ³¨æ„ï¼Œåœ¨ä½¿ç”¨ PUT æ›´æ–°æ•°æ®åº“ä¸­æ•°æ®æ—¶ï¼Œå¦‚æœè®¾ç½®äº†é»˜è®¤å€¼ï¼ŒPUT
æ—¶æœªå†™è¯¥å­—æ®µï¼Œä½†æ›´æ–°æ—¶ä¹Ÿä¼šæŠŠé»˜è®¤å€¼ä¹Ÿå¸¦ä¸Šï¼Œä»è€Œæ›´æ–°è¯¥å­—æ®µã€‚å¯ä½¿ç”¨ PATCH
è¿›è¡Œéƒ¨åˆ†æ›´æ–°ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Union</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> fastapi.encoders <span class="keyword">import</span> jsonable_encoder</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Item</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="type">Union</span>[<span class="built_in">str</span>, <span class="literal">None</span>] = <span class="literal">None</span></span><br><span class="line">    description: <span class="type">Union</span>[<span class="built_in">str</span>, <span class="literal">None</span>] = <span class="literal">None</span></span><br><span class="line">    price: <span class="type">Union</span>[<span class="built_in">float</span>, <span class="literal">None</span>] = <span class="literal">None</span></span><br><span class="line">    tax: <span class="built_in">float</span> = <span class="number">10.5</span></span><br><span class="line">    tags: <span class="type">List</span>[<span class="built_in">str</span>] = []</span><br><span class="line"></span><br><span class="line">items = &#123;</span><br><span class="line">    <span class="string">&quot;foo&quot;</span>: &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Foo&quot;</span>, <span class="string">&quot;price&quot;</span>: <span class="number">50.2</span>&#125;,</span><br><span class="line">    <span class="string">&quot;bar&quot;</span>: &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Bar&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;The bartenders&quot;</span>, <span class="string">&quot;price&quot;</span>: <span class="number">62</span>, <span class="string">&quot;tax&quot;</span>: <span class="number">20.2</span>&#125;,</span><br><span class="line">    <span class="string">&quot;baz&quot;</span>: &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Baz&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="literal">None</span>, <span class="string">&quot;price&quot;</span>: <span class="number">50.2</span>, <span class="string">&quot;tax&quot;</span>: <span class="number">10.5</span>, <span class="string">&quot;tags&quot;</span>: []&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span>, response_model=Item</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_item</span>(<span class="params">item_id: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">return</span> items[item_id]</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.patch(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span>, response_model=Item</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">update_item</span>(<span class="params">item_id: <span class="built_in">str</span>, item: Item</span>):</span><br><span class="line">    stored_item_data = items[item_id]</span><br><span class="line">    <span class="comment"># åˆ›å»ºåŸå§‹å€¼çš„model</span></span><br><span class="line">    stored_item_model = Item(**stored_item_data) </span><br><span class="line">    <span class="comment"># exclude_unset=Trueï¼Œè¡¨ç¤ºç”Ÿæˆçš„ dict åªåŒ…å«åˆ›å»º item æ¨¡å‹æ—¶æ˜¾å¼è®¾ç½®çš„æ•°æ®ï¼Œè€Œä¸åŒ…æ‹¬é»˜è®¤å€¼</span></span><br><span class="line">    update_data = item.<span class="built_in">dict</span>(exclude_unset=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># .copy()ä¸ºå·²æœ‰æ¨¡å‹åˆ›å»ºè°ƒç”¨ update å‚æ•°çš„å‰¯æœ¬ï¼Œè®¾ç½®å€¼æ›´æ–°åˆ°modelä¸­</span></span><br><span class="line">    updated_item = stored_item_model.copy(update=update_data) </span><br><span class="line">    <span class="comment"># æŠŠæ¨¡å‹å‰¯æœ¬è½¬æ¢ä¸ºå¯å­˜å…¥æ•°æ®åº“çš„å½¢å¼</span></span><br><span class="line">    items[item_id] = jsonable_encoder(updated_item)</span><br><span class="line">    <span class="keyword">return</span> updated_item</span><br></pre></td></tr></table></figure></p>
<h1 id="ä¾èµ–é¡¹">ä¾èµ–é¡¹</h1>
<p>ä¾èµ–é¡¹æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¯ä»¥å¤ç”¨ç›¸åŒå¾—ä»£ç é€»è¾‘ï¼Œå¸¸ç”¨äºï¼šå…±äº«ä¸šåŠ¡é€»è¾‘ã€å…±äº«æ•°æ®åº“è¿æ¥ã€å®ç°å®‰å…¨ã€éªŒè¯ã€è§’è‰²æƒé™ç­‰ã€‚<br />
ä¾èµ–é¡¹ä½¿ç”¨Dependsæ³¨å…¥ï¼Œé»˜è®¤ä»Queryå‚æ•°ä¸­è·å–æ•°æ®ã€‚<br />
1.å‡½æ•°å½¢å¼ä¾èµ–é¡¹ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Union</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Depends, FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¾èµ–é¡¹common_parameterså‡½æ•°ï¼Œè¿”å›dict</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">common_parameters</span>(<span class="params">q: <span class="type">Union</span>[<span class="built_in">str</span>, <span class="literal">None</span>] = <span class="literal">None</span>, skip: <span class="built_in">int</span> = <span class="number">0</span>, limit: <span class="built_in">int</span> = <span class="number">100</span></span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;q&quot;</span>: q, <span class="string">&quot;skip&quot;</span>: skip, <span class="string">&quot;limit&quot;</span>: limit&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_items</span>(<span class="params">commons: <span class="built_in">dict</span> = Depends(<span class="params">common_parameters</span>)</span>): <span class="comment"># Dependsæ³¨å…¥ä¾èµ–é¡¹</span></span><br><span class="line">    <span class="keyword">return</span> commons</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_users</span>(<span class="params">commons: <span class="built_in">dict</span> = Depends(<span class="params">common_parameters</span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> commons</span><br></pre></td></tr></table></figure></p>
<p>2.ç±»ä½œä¸ºä¾èµ–é¡¹ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Depends, FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line">fake_items_db = [&#123;<span class="string">&quot;item_name&quot;</span>: <span class="string">&quot;Foo&quot;</span>&#125;, &#123;<span class="string">&quot;item_name&quot;</span>: <span class="string">&quot;Bar&quot;</span>&#125;, &#123;<span class="string">&quot;item_name&quot;</span>: <span class="string">&quot;Baz&quot;</span>&#125;]</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¾èµ–é¡¹</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CommonQueryParams</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, q: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span>, skip: <span class="built_in">int</span> = <span class="number">0</span>, limit: <span class="built_in">int</span> = <span class="number">100</span></span>):</span><br><span class="line">        self.q = q</span><br><span class="line">        self.skip = skip</span><br><span class="line">        self.limit = limit</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># æ³¨å…¥ä¾èµ–é¡¹Depends</span></span><br><span class="line"><span class="comment"># ç®€åŒ–å½¢å¼ï¼šcommons: CommonQueryParams = Depends() æˆ– commons=Depends(CommonQueryParams)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_items</span>(<span class="params">commons: CommonQueryParams = Depends(<span class="params">CommonQueryParams</span>)</span>):</span><br><span class="line">    response = &#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> commons.q:</span><br><span class="line">        response.update(&#123;<span class="string">&quot;q&quot;</span>: commons.q&#125;)</span><br><span class="line">    items = fake_items_db[commons.skip : commons.skip + commons.limit]</span><br><span class="line">    response.update(&#123;<span class="string">&quot;items&quot;</span>: items&#125;)</span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure></p>
<p>3.å­ä¾èµ–ï¼ˆåµŒå¥—ä¾èµ–ï¼‰ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Union</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Cookie, Depends, FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¬¬ä¸€å±‚ä¾èµ–</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">query_extractor</span>(<span class="params">q: <span class="type">Union</span>[<span class="built_in">str</span>, <span class="literal">None</span>] = <span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">return</span> q</span><br><span class="line"><span class="comment"># ç¬¬äºŒå±‚ä¾èµ–</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">query_or_cookie_extractor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    q: <span class="built_in">str</span> = Depends(<span class="params">query_extractor</span>),  <span class="comment"># ä½¿ç”¨ç¬¬ä¸€å±‚ä¾èµ–</span></span></span><br><span class="line"><span class="params">    last_query: <span class="type">Union</span>[<span class="built_in">str</span>, <span class="literal">None</span>] = Cookie(<span class="params">default=<span class="literal">None</span></span>),</span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> q:</span><br><span class="line">        <span class="keyword">return</span> last_query</span><br><span class="line">    <span class="keyword">return</span> q</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># åªä½¿ç”¨ç¬¬äºŒå±‚ä¾èµ–</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_query</span>(<span class="params">query_or_default: <span class="built_in">str</span> = Depends(<span class="params">query_or_cookie_extractor</span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;q_or_cookie&quot;</span>: query_or_default&#125;</span><br></pre></td></tr></table></figure></p>
<p>4.å¦‚æœåµŒå¥—ä¾èµ–ï¼Œå¤šæ¬¡ä½¿ç”¨åŒä¸€ä¸ªå­ä¾èµ–é¡¹ï¼ŒFastAPI
åœ¨å¤„ç†åŒä¸€è¯·æ±‚æ—¶ï¼Œåªè°ƒç”¨ä¸€æ¬¡è¯¥å­ä¾èµ–é¡¹ï¼Œä¸ä¼šä¸ºåŒä¸€ä¸ªè¯·æ±‚å¤šæ¬¡è°ƒç”¨åŒä¸€ä¸ªä¾èµ–é¡¹ï¼Œè€Œæ˜¯æŠŠä¾èµ–é¡¹çš„è¿”å›å€¼è¿›è¡Œã€Œç¼“å­˜ã€ï¼Œå¹¶æŠŠå®ƒä¼ é€’ç»™åŒä¸€è¯·æ±‚ä¸­æ‰€æœ‰éœ€è¦ä½¿ç”¨è¯¥è¿”å›å€¼çš„ã€Œä¾èµ–é¡¹ã€ã€‚å¦‚æœä¸æƒ³ä½¿ç”¨ã€Œç¼“å­˜ã€å€¼ï¼Œè€Œæ˜¯ä¸ºéœ€è¦åœ¨åŒä¸€è¯·æ±‚çš„æ¯ä¸€æ­¥æ“ä½œï¼ˆå¤šæ¬¡ï¼‰ä¸­éƒ½å®é™…è°ƒç”¨ä¾èµ–é¡¹ï¼Œå¯ä»¥æŠŠ
Depends çš„å‚æ•° <code>use_cache</code> çš„å€¼è®¾ç½®ä¸º Falseï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">needy_dependency</span>(<span class="params">fresh_value: <span class="built_in">str</span> = Depends(<span class="params">get_value, use_cache=<span class="literal">False</span></span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;fresh_value&quot;</span>: fresh_value&#125;</span><br></pre></td></tr></table></figure></p>
<p>5.åœ¨è·¯ç”±ä¸Šæ·»åŠ ä¾èµ–é¡¹ï¼Œä¸ä¼šæ¥æ”¶ä½¿ç”¨ä¾èµ–é¡¹çš„è¿”å›å€¼ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Depends, FastAPI, Header, HTTPException</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="comment"># èµ–é¡¹å¯ä»¥å£°æ˜è¯·æ±‚çš„éœ€æ±‚é¡¹ï¼ˆæ¯”å¦‚å“åº”å¤´ï¼‰æˆ–å…¶ä»–å­ä¾èµ–é¡¹</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">verify_token</span>(<span class="params">x_token: <span class="built_in">str</span> = Header(<span class="params"></span>)</span>):</span><br><span class="line">    <span class="keyword">if</span> x_token != <span class="string">&quot;fake-super-secret-token&quot;</span>:</span><br><span class="line">        <span class="comment"># å¯ä»¥ raise å¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">400</span>, detail=<span class="string">&quot;X-Token header invalid&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">verify_key</span>(<span class="params">x_key: <span class="built_in">str</span> = Header(<span class="params"></span>)</span>):</span><br><span class="line">    <span class="keyword">if</span> x_key != <span class="string">&quot;fake-super-secret-key&quot;</span>:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">400</span>, detail=<span class="string">&quot;X-Key header invalid&quot;</span>)</span><br><span class="line">    <span class="comment"># è·¯ç”±dependenciesä¾èµ–é¡¹ä¸ä¼šä½¿ç”¨è¿”å›å€¼</span></span><br><span class="line">    <span class="keyword">return</span> x_key</span><br><span class="line"></span><br><span class="line"><span class="comment"># dependencieså¿…é¡»æ˜¯Dependsç»„æˆçš„åˆ—è¡¨</span></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span>, dependencies=[Depends(<span class="params">verify_token</span>), Depends(<span class="params">verify_key</span>)]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_items</span>():</span><br><span class="line">    <span class="keyword">return</span> [&#123;<span class="string">&quot;item&quot;</span>: <span class="string">&quot;Foo&quot;</span>&#125;, &#123;<span class="string">&quot;item&quot;</span>: <span class="string">&quot;Bar&quot;</span>&#125;]</span><br></pre></td></tr></table></figure></p>
<p>6.å…¨å±€æ³¨å…¥ä¾èµ–ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Depends, FastAPI, Header, HTTPException</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">verify_token</span>(<span class="params">x_token: <span class="built_in">str</span> = Header(<span class="params"></span>)</span>):</span><br><span class="line">    <span class="keyword">if</span> x_token != <span class="string">&quot;fake-super-secret-token&quot;</span>:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">400</span>, detail=<span class="string">&quot;X-Token header invalid&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">verify_key</span>(<span class="params">x_key: <span class="built_in">str</span> = Header(<span class="params"></span>)</span>):</span><br><span class="line">    <span class="keyword">if</span> x_key != <span class="string">&quot;fake-super-secret-key&quot;</span>:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">400</span>, detail=<span class="string">&quot;X-Key header invalid&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> x_key</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¾èµ–æ³¨å…¥è‡³æ•´ä¸ªFastAPIåº”ç”¨ï¼Œappçš„æ‰€æœ‰è·¯ç”±éƒ½è‡ªå¸¦è¯¥ä¾èµ–é¡¹</span></span><br><span class="line"><span class="comment"># åªæ‰§è¡Œä¾èµ–é¡¹ï¼Œä¸ä¼šä½¿ç”¨ä¾èµ–é¡¹çš„è¿”å›å€¼</span></span><br><span class="line">app = FastAPI(dependencies=[Depends(verify_token), Depends(verify_key)])</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_items</span>():</span><br><span class="line">    <span class="keyword">return</span> [&#123;<span class="string">&quot;item&quot;</span>: <span class="string">&quot;Portal Gun&quot;</span>&#125;, &#123;<span class="string">&quot;item&quot;</span>: <span class="string">&quot;Plumbus&quot;</span>&#125;]</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_users</span>():</span><br><span class="line">    <span class="keyword">return</span> [&#123;<span class="string">&quot;username&quot;</span>: <span class="string">&quot;Rick&quot;</span>&#125;, &#123;<span class="string">&quot;username&quot;</span>: <span class="string">&quot;Morty&quot;</span>&#125;]</span><br></pre></td></tr></table></figure></p>
<p>7.ä¾èµ–é¡¹æ”¯æŒåœ¨å®Œæˆåï¼Œæ‰§è¡Œé¢å¤–æ“ä½œï¼Œæ­¤æ—¶ä½¿ç”¨yieldï¼Œä¸”åªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨åˆ›å»ºå“åº”ä¹‹å‰ï¼Œä»…æ‰§è¡Œyield è¯­å¥ä¹‹å‰çš„ä»£ç ï¼ˆåŒ…æ‹¬yield è¯­å¥ï¼‰</span></span><br><span class="line"><span class="comment"># åœ¨å“åº”å‘é€åæ‰§è¡Œyieldè¯­å¥åé¢çš„ä»£ç </span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_db</span>():</span><br><span class="line">    db = DBSession()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">yield</span> db</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        db.close()</span><br></pre></td></tr></table></figure></p>
<p>8.yieldä¹Ÿå¯ä»¥åµŒå¥—ä½¿ç”¨ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> Annotated</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Depends</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">dependency_a</span>():</span><br><span class="line">    dep_a = generate_dep_a()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">yield</span> dep_a</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        dep_a.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># è€Œ dependency_b åè¿‡æ¥åˆ™éœ€è¦ dependency_aï¼ˆæ­¤å¤„ç§°ä¸º dep_a ï¼‰çš„å€¼åœ¨å…¶é€€å‡ºä»£ç ä¸­å¯ç”¨ã€‚</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">dependency_b</span>(<span class="params">dep_a: Annotated[DepA, Depends(<span class="params">dependency_a</span>)]</span>):</span><br><span class="line">    dep_b = generate_dep_b()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">yield</span> dep_b</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        dep_b.close(dep_a)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œdependency_c åœ¨æ‰§è¡Œå…¶é€€å‡ºä»£ç æ—¶éœ€è¦ dependency_bï¼ˆæ­¤å¤„ç§°ä¸º dep_bï¼‰çš„å€¼ä»ç„¶å¯ç”¨ã€‚</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">dependency_c</span>(<span class="params">dep_b: Annotated[DepB, Depends(<span class="params">dependency_b</span>)]</span>):</span><br><span class="line">    dep_c = generate_dep_c()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">yield</span> dep_c</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        dep_c.close(dep_b)</span><br></pre></td></tr></table></figure></p>
<p>9.yieldçš„ä¾èµ–é¡¹ä¸­ä½¿ç”¨ except
æ•è·äº†ä¸€ä¸ªå¼‚å¸¸ï¼Œéœ€è¦raiseå®ƒï¼Œè¿™æ ·FastAPIæ‰èƒ½çŸ¥é“å‘ç”Ÿäº†é”™è¯¯ï¼Œå¹¶è¿”å›ä¸€ä¸ªé€‚å½“çš„å“åº”ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> Annotated</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Depends, FastAPI, HTTPException</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">InternalError</span>(<span class="title class_ inherited__">Exception</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_username</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">yield</span> <span class="string">&quot;Rick&quot;</span></span><br><span class="line">    <span class="keyword">except</span> InternalError:</span><br><span class="line">        <span class="comment"># åœ¨yieldè¯­å¥ä¸­æ•è·å¼‚å¸¸ï¼Œéœ€è¦raiseå®ƒï¼Œè®©FastAPIçŸ¥é“å‘ç”Ÿäº†é”™è¯¯</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Oops, we didn&#x27;t raise again, Britney ğŸ˜±&quot;</span>)</span><br><span class="line">        <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_item</span>(<span class="params">item_id: <span class="built_in">str</span>, username: Annotated[<span class="built_in">str</span>, Depends(<span class="params">get_username</span>)]</span>):</span><br><span class="line">    <span class="keyword">if</span> item_id == <span class="string">&quot;portal-gun&quot;</span>:</span><br><span class="line">        <span class="keyword">raise</span> InternalError(</span><br><span class="line">            <span class="string">f&quot;The portal gun is too dangerous to be owned by <span class="subst">&#123;username&#125;</span>&quot;</span></span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">if</span> item_id != <span class="string">&quot;plumbus&quot;</span>:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(</span><br><span class="line">            status_code=<span class="number">404</span>, detail=<span class="string">&quot;Item not found, there&#x27;s only a plumbus here&quot;</span></span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">return</span> item_id</span><br></pre></td></tr></table></figure></p>
<p>10.é€šè¿‡yieldä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªå¸¦æœ‰__enter__()å’Œ__exit__()æ–¹æ³•çš„ç±»</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MySuperContextManager</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.db = DBSession()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__enter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.db</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__exit__</span>(<span class="params">self, exc_type, exc_value, traceback</span>):</span><br><span class="line">        self.db.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># yield ä¾èµ–é¡¹ä¸­é€šè¿‡ with æˆ–è€… async with è¯­å¥æ¥ä½¿ç”¨å®ƒä»¬</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_db</span>():</span><br><span class="line">    <span class="keyword">with</span> MySuperContextManager() <span class="keyword">as</span> db:</span><br><span class="line">        <span class="keyword">yield</span> db</span><br></pre></td></tr></table></figure></p>
<p>å¦ä¸€ç§åˆ›å»ºä¸Šä¸‹æ–‡ç®¡ç†å™¨çš„æ–¹æ³•æ˜¯ï¼š<a
target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/contextlib.html#contextlib.contextmanager"><code>@contextlib.contextmanager</code></a>
æˆ–è€… <a
target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/contextlib.html#contextlib.asynccontextmanager"><code>@contextlib.asynccontextmanager</code></a></p>
<h1 id="é«˜çº§ä¾èµ–é¡¹">é«˜çº§ä¾èµ–é¡¹</h1>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Depends, FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FixedContentQueryChecker</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, fixed_content: <span class="built_in">str</span></span>):</span><br><span class="line">        self.fixed_content = fixed_content</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self, q: <span class="built_in">str</span> = <span class="string">&quot;&quot;</span></span>):</span><br><span class="line">        <span class="keyword">if</span> q:</span><br><span class="line">            <span class="keyword">return</span> self.fixed_content <span class="keyword">in</span> q</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/query-checker/&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># ä¼ é€’FixedContentQueryCheckerå®ä¾‹ï¼Œå¹¶åœ¨è¢«è°ƒç”¨æ—¶æ£€æŸ¥æŸ¥è¯¢å‚æ•°qæ˜¯å¦åŒ…å«&quot;bar&quot;</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_query_check</span>(<span class="params">fixed_content_included: <span class="built_in">bool</span> = Depends(<span class="params">FixedContentQueryChecker(<span class="params"><span class="string">&quot;bar&quot;</span></span>)</span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;fixed_content_in_query&quot;</span>: fixed_content_included&#125;</span><br></pre></td></tr></table></figure>
<h1 id="å®‰å…¨æ€§">å®‰å…¨æ€§</h1>
<p>OAuth2æ˜¯ä¸€ä¸ªè§„èŒƒï¼Œå®ƒå®šä¹‰äº†å‡ ç§å¤„ç†èº«ä»½è®¤è¯å’Œæˆæƒçš„æ–¹æ³•ã€‚å®ƒåŒ…æ‹¬äº†ä½¿ç”¨ã€Œç¬¬ä¸‰æ–¹ã€è¿›è¡Œèº«ä»½è®¤è¯çš„æ–¹æ³•ã€‚<br />
OpenAPIï¼ˆä»¥å‰ç§°ä¸º Swaggerï¼‰æ˜¯ç”¨äºæ„å»º API çš„å¼€æ”¾è§„èŒƒï¼ˆç°å·²æˆä¸º Linux
Foundation çš„ä¸€éƒ¨åˆ†ï¼‰ã€‚<br />
FastAPI åŸºäº
OpenAPIã€‚è¿™å°±æ˜¯ä½¿å¤šä¸ªè‡ªåŠ¨äº¤äº’å¼æ–‡æ¡£ç•Œé¢ï¼Œä»£ç ç”Ÿæˆç­‰æˆä¸ºå¯èƒ½çš„åŸå› ã€‚<br />
OpenAPI
æœ‰ä¸€ç§å®šä¹‰å¤šä¸ªå®‰å…¨ã€Œæ–¹æ¡ˆã€çš„æ–¹æ³•ã€‚é€šè¿‡ä½¿ç”¨å®ƒä»¬ï¼Œå¯ä»¥åˆ©ç”¨æ‰€æœ‰è¿™äº›åŸºäºæ ‡å‡†çš„å·¥å…·ï¼ŒåŒ…æ‹¬è¿™äº›äº¤äº’å¼æ–‡æ¡£ç³»ç»Ÿã€‚</p>
<p>1.OpenAPI å®šä¹‰äº†ä»¥ä¸‹å®‰å…¨æ–¹æ¡ˆï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">|-apiKeyï¼šä¸€ä¸ªç‰¹å®šäºåº”ç”¨ç¨‹åºçš„å¯†é’¥ï¼Œå¯ä»¥æ¥è‡ªï¼šQueryã€Headerã€Cookieã€‚</span><br><span class="line">|-httpï¼šæ ‡å‡†çš„ HTTP èº«ä»½è®¤è¯ç³»ç»Ÿï¼ŒåŒ…æ‹¬ï¼š</span><br><span class="line">    |-bearer: ä¸€ä¸ªå€¼ä¸º Bearer åŠ ä»¤ç‰Œå­—ç¬¦ä¸²çš„ Authorization è¯·æ±‚å¤´ã€‚è¿™æ˜¯ä» OAuth2 ç»§æ‰¿çš„ã€‚</span><br><span class="line">    |-HTTP Basic: ä¸€ä¸ªå€¼ä¸ºç”¨æˆ·åå’Œå¯†ç çš„ Authorization è¯·æ±‚å¤´ï¼Œä½¿ç”¨ Base64 ç¼–ç ã€‚</span><br><span class="line">    |-HTTP Digest: ä¸€ä¸ªå€¼ä¸ºç”¨æˆ·åå’Œå¯†ç çš„ Authorization è¯·æ±‚å¤´ï¼Œä½¿ç”¨ MD5 å“ˆå¸Œç®—æ³•ã€‚</span><br><span class="line">|-oauth2ï¼šæ‰€æœ‰çš„ OAuth2 å¤„ç†å®‰å…¨æ€§çš„æ–¹å¼ï¼ˆç§°ä¸ºã€Œæµç¨‹ã€ï¼‰ã€‚ å…¶ä¸­å‡ ä¸ªæµç¨‹é€‚åˆæ„å»º OAuth <span class="number">2.0</span> èº«ä»½éªŒè¯æä¾›ç¨‹åºï¼š </span><br><span class="line">    |-implicitï¼šéšå¼æµç¨‹ã€‚</span><br><span class="line">    |-clientCredentialsï¼šå®¢æˆ·ç«¯å‡­è¯æµç¨‹ã€‚</span><br><span class="line">    |-authorizationCode: æˆæƒç æµç¨‹ã€‚</span><br><span class="line">    |-password: å¯†ç æµç¨‹ã€‚å®Œç¾åœ°ç›´æ¥ç”¨äºåœ¨åŒä¸€åº”ç”¨ç¨‹åºä¸­å¤„ç†èº«ä»½éªŒè¯ã€‚</span><br><span class="line">|-openIdConnectï¼šæä¾›äº†ä¸€ç§å®šä¹‰å¦‚ä½•è‡ªåŠ¨å‘ç° OAuth2 èº«ä»½è®¤è¯æ•°æ®çš„æ–¹æ³•ã€‚æ­¤è‡ªåŠ¨å‘ç°æœºåˆ¶æ˜¯ OpenID Connect è§„èŒƒä¸­å®šä¹‰çš„å†…å®¹ã€‚</span><br></pre></td></tr></table></figure></p>
<p>Password æµæ˜¯ OAuth2 å®šä¹‰çš„ï¼Œç”¨äºå¤„ç†å®‰å…¨ä¸èº«ä»½éªŒè¯çš„æ–¹å¼ã€‚OAuth2
çš„è®¾è®¡ç›®æ ‡æ˜¯ä¸ºäº†è®©åç«¯æˆ– API ç‹¬ç«‹äºæœåŠ¡å™¨éªŒè¯ç”¨æˆ·èº«ä»½ã€‚<br />
2.FastAPI åº”ç”¨ä¼šå¤„ç† API ä¸èº«ä»½éªŒè¯ï¼Œå…¶ç®€åŒ–æµç¨‹å¦‚ä¸‹ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>ç”¨æˆ·åœ¨å‰ç«¯è¾“å…¥ username ä¸passwordï¼Œå¹¶ç‚¹å‡»<span class="string">&quot;å›è½¦&quot;</span>ï¼›</span><br><span class="line"><span class="number">2.</span>å‰ç«¯å°† username ä¸ password å‘é€åˆ° API ä¸­æŒ‡å®šçš„ URLï¼ˆä½¿ç”¨ tokenUrl=<span class="string">&quot;token&quot;</span> å£°æ˜ï¼‰ï¼›</span><br><span class="line"><span class="number">3.</span>API æ£€æŸ¥ username ä¸passwordï¼Œå¹¶ç”¨ä»¤ç‰Œï¼ˆTokenï¼‰ å“åº”ï¼ˆæš‚æœªå®ç°æ­¤åŠŸèƒ½ï¼‰ï¼›</span><br><span class="line"><span class="number">4.</span>å‰ç«¯å°†ä»¤ç‰Œå­˜å‚¨åœ¨æœ¬åœ°ï¼ˆä¾‹å¦‚ï¼Œåœ¨æµè§ˆå™¨çš„ LocalStorage ä¸­ï¼‰ï¼Œä»¤ç‰Œä¸€èˆ¬åœ¨ä¸€æ®µæ—¶é—´åè¿‡æœŸï¼Œéœ€å†æ¬¡ç™»å½•ï¼›</span><br><span class="line"><span class="number">5.</span>æ¯æ¬¡è¯·æ±‚æ—¶ï¼Œå‰ç«¯éƒ½ä¼šå°†ä»¤ç‰Œæ·»åŠ åˆ°è¯·æ±‚å¤´ä¸­ï¼ˆä¾‹å¦‚ï¼Œåœ¨ Authorization è¯·æ±‚å¤´ä¸­ï¼Œå€¼ä¸º Bearer &lt;token&gt;ï¼‰ï¼›</span><br><span class="line"><span class="number">6.</span>API æ£€æŸ¥ä»¤ç‰Œï¼Œå¦‚æœä»¤ç‰Œæœ‰æ•ˆï¼Œåˆ™å¤„ç†è¯·æ±‚ï¼Œå¦åˆ™è¿”å› <span class="number">401</span> Unauthorizedã€‚</span><br></pre></td></tr></table></figure></p>
<p>3.FastAPIä¸­çš„å®ç°ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Depends, FastAPI</span><br><span class="line"><span class="keyword">from</span> fastapi.security <span class="keyword">import</span> OAuth2PasswordBearer</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="comment"># OAuth2PasswordBearerä½¿ç”¨Password æµä»¥åŠ Bearer ä»¤ç‰Œï¼ˆTokenï¼‰å¤„ç†éªŒè¯</span></span><br><span class="line"><span class="comment"># tokenUrl=&quot;token&quot; å£°æ˜äº†ä»¤ç‰Œçš„ URLï¼ˆç›¸å¯¹è·¯å¾„&quot;/token&quot;ï¼‰ï¼Œå®ƒå°†ç”¨äºè·å–ä»¤ç‰Œ</span></span><br><span class="line">oauth2_scheme = OAuth2PasswordBearer(tokenUrl=<span class="string">&quot;token&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># oauth2_schemeæ˜¯ä¸€ä¸ªå¯è°ƒç”¨é¡¹ï¼Œä½¿ç”¨ Depends æŠŠ oauth2_scheme ä¼ å…¥ä¾èµ–é¡¹ï¼Œç”¨äºè·å–ä»¤ç‰Œ</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_items</span>(<span class="params">token: <span class="built_in">str</span> = Depends(<span class="params">oauth2_scheme</span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;token&quot;</span>: token&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># FastAPI æ ¡éªŒè¯·æ±‚ä¸­çš„ Authorization è¯·æ±‚å¤´ï¼Œæ ¸å¯¹è¯·æ±‚å¤´çš„å€¼æ˜¯ä¸æ˜¯ç”± Bearer ï¼‹ ä»¤ç‰Œç»„æˆï¼Œ å¹¶è¿”å›ä»¤ç‰Œå­—ç¬¦ä¸²ï¼ˆstrï¼‰ã€‚</span></span><br><span class="line"><span class="comment"># å¦‚æœæ²¡æœ‰æ‰¾åˆ° Authorization è¯·æ±‚å¤´ï¼Œæˆ–è¯·æ±‚å¤´çš„å€¼ä¸æ˜¯ Bearer ï¼‹ ä»¤ç‰Œã€‚FastAPI ç›´æ¥è¿”å› 401 é”™è¯¯çŠ¶æ€ç ï¼ˆUNAUTHORIZEDï¼‰ã€‚</span></span><br></pre></td></tr></table></figure></p>
<p>3.è¿›ä¸€æ­¥å®Œå–„ï¼Œä»oauth2_schemeè·å–ä»¤ç‰Œï¼Œè¿”å›å½“å‰ç”¨æˆ·ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Union</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Depends, FastAPI</span><br><span class="line"><span class="keyword">from</span> fastapi.security <span class="keyword">import</span> OAuth2PasswordBearer</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”¨æˆ·æ¨¡å‹</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    username: <span class="built_in">str</span></span><br><span class="line">    email: <span class="type">Union</span>[<span class="built_in">str</span>, <span class="literal">None</span>] = <span class="literal">None</span></span><br><span class="line">    full_name: <span class="type">Union</span>[<span class="built_in">str</span>, <span class="literal">None</span>] = <span class="literal">None</span></span><br><span class="line">    disabled: <span class="type">Union</span>[<span class="built_in">bool</span>, <span class="literal">None</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿”å›ç”¨æˆ·</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fake_decode_token</span>(<span class="params">token</span>):</span><br><span class="line">    <span class="keyword">return</span> User(</span><br><span class="line">        username=token + <span class="string">&quot;fakedecoded&quot;</span>, email=<span class="string">&quot;john@example.com&quot;</span>, full_name=<span class="string">&quot;John Doe&quot;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¾èµ–1</span></span><br><span class="line">oauth2_scheme = OAuth2PasswordBearer(tokenUrl=<span class="string">&quot;token&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¾èµ–2</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_current_user</span>(<span class="params">token: <span class="built_in">str</span> = Depends(<span class="params">oauth2_scheme</span>)</span>):</span><br><span class="line">    user = fake_decode_token(token)</span><br><span class="line">    <span class="keyword">return</span> user</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/me&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># æ³¨å…¥ä¾èµ–ï¼ˆè¿™é‡Œèƒ½çœ‹å‡ºï¼Œä¾èµ–çš„ç›Šå¤„ï¼šå®‰å…¨å’Œä¾èµ–æ³¨å…¥çš„ä»£ç åªéœ€è¦å†™ä¸€æ¬¡ï¼Œåœ¨å…¶ä»–è·¯ç”±å¯ç”¨Dependså¤ç”¨ï¼‰</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_users_me</span>(<span class="params">current_user: User = Depends(<span class="params">get_current_user</span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> current_user</span><br></pre></td></tr></table></figure></p>
<h2 id="oauth2ç®€å•çš„-password-å’Œ-bearer-éªŒè¯">OAuth2ç®€å•çš„ Password å’Œ
Bearer éªŒè¯</h2>
<p>OAuth2 ä½¿ç”¨<strong>è¡¨å•æ•°æ®</strong>å‘é€ username ä¸
passwordï¼Œéœ€å…ˆå®‰è£…<code>python-multipart</code>åº“ã€‚<br />
1.å®Œæ•´çš„ï¼ŒOAuth2 å®ç°ç®€å•çš„ Password å’Œ Bearer éªŒè¯ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Union</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Depends, FastAPI, HTTPException, status</span><br><span class="line"><span class="keyword">from</span> fastapi.security <span class="keyword">import</span> OAuth2PasswordBearer, OAuth2PasswordRequestForm</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line"><span class="comment"># ï¼ˆä¼ªï¼‰æ•°æ®åº“</span></span><br><span class="line">fake_users_db = &#123;</span><br><span class="line">    <span class="string">&quot;johndoe&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;username&quot;</span>: <span class="string">&quot;johndoe&quot;</span>,</span><br><span class="line">        <span class="string">&quot;full_name&quot;</span>: <span class="string">&quot;John Doe&quot;</span>,</span><br><span class="line">        <span class="string">&quot;email&quot;</span>: <span class="string">&quot;johndoe@example.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;hashed_password&quot;</span>: <span class="string">&quot;fakehashedsecret&quot;</span>,</span><br><span class="line">        <span class="string">&quot;disabled&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;alice&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;username&quot;</span>: <span class="string">&quot;alice&quot;</span>,</span><br><span class="line">        <span class="string">&quot;full_name&quot;</span>: <span class="string">&quot;Alice Wonderson&quot;</span>,</span><br><span class="line">        <span class="string">&quot;email&quot;</span>: <span class="string">&quot;alice@example.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;hashed_password&quot;</span>: <span class="string">&quot;fakehashedsecret2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;disabled&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fake_hash_password</span>(<span class="params">password: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;fakehashed&quot;</span> + password</span><br><span class="line"></span><br><span class="line">oauth2_scheme = OAuth2PasswordBearer(tokenUrl=<span class="string">&quot;token&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    username: <span class="built_in">str</span></span><br><span class="line">    email: <span class="type">Union</span>[<span class="built_in">str</span>, <span class="literal">None</span>] = <span class="literal">None</span></span><br><span class="line">    full_name: <span class="type">Union</span>[<span class="built_in">str</span>, <span class="literal">None</span>] = <span class="literal">None</span></span><br><span class="line">    disabled: <span class="type">Union</span>[<span class="built_in">bool</span>, <span class="literal">None</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸è¦ä¿å­˜æ˜æ–‡å¯†ç </span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserInDB</span>(<span class="title class_ inherited__">User</span>):</span><br><span class="line">    hashed_password: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/token&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># OAuth2PasswordRequestFormå£°æ˜äº†è¯·æ±‚è¡¨å•usernameå’Œpasswordå­—æ®µ</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">login</span>(<span class="params">form_data: OAuth2PasswordRequestForm = Depends(<span class="params"></span>)</span>):</span><br><span class="line">    <span class="comment"># ä½¿ç”¨è¡¨å•å­—æ®µ usernameï¼Œä»ï¼ˆä¼ªï¼‰æ•°æ®åº“ä¸­è·å–ç”¨æˆ·æ•°æ®</span></span><br><span class="line">    user_dict = fake_users_db.get(form_data.username)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user_dict:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">400</span>, detail=<span class="string">&quot;Incorrect username or password&quot;</span>)</span><br><span class="line">    <span class="comment"># åˆ›å»ºç”¨æˆ·pydanticæ¨¡å‹</span></span><br><span class="line">    user = UserInDB(**user_dict)</span><br><span class="line">    <span class="comment"># å°†&quot;ç”¨æˆ·å¯†ç &quot;å“ˆå¸Œå¤„ç†ï¼Œå’Œï¼ˆä¼ªï¼‰æ•°æ®åº“ä¸­ä¿å­˜çš„&quot;å“ˆå¸Œå€¼å¯†ç &quot;å¯¹æ¯”æ ¡éªŒ</span></span><br><span class="line">    hashed_password = fake_hash_password(form_data.password)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> hashed_password == user.hashed_password:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">400</span>, detail=<span class="string">&quot;Incorrect username or password&quot;</span>)</span><br><span class="line">    <span class="comment"># /tokençš„å“åº”å¿…é¡»æ˜¯jsonå¯¹è±¡ï¼Œå¿…é¡»åŒ…å«access_tokenå’Œtoken_typeå­—æ®µ</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;access_token&quot;</span>: user.username, <span class="string">&quot;token_type&quot;</span>: <span class="string">&quot;bearer&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»æ•°æ®åº“è·å–ç”¨æˆ·ï¼Œåˆ›å»ºpydanticæ¨¡å‹</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">db, username: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">if</span> username <span class="keyword">in</span> db:</span><br><span class="line">        user_dict = db[username]</span><br><span class="line">        <span class="keyword">return</span> UserInDB(**user_dict)</span><br><span class="line">        </span><br><span class="line"><span class="comment"># å¤„ç†token</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fake_decode_token</span>(<span class="params">token</span>):</span><br><span class="line">    <span class="comment"># This doesn&#x27;t provide any security at all</span></span><br><span class="line">    <span class="comment"># Check the next version</span></span><br><span class="line">    user = get_user(fake_users_db, token)</span><br><span class="line">    <span class="keyword">return</span> user</span><br><span class="line"></span><br><span class="line"><span class="comment"># éœ€åœ¨è¯·æ±‚å¤´ä¸­æ·»åŠ Authorizationå­—æ®µï¼Œå€¼ä¸º&quot;access_token&quot;çš„å€¼</span></span><br><span class="line"><span class="comment"># ä»oauth2_schemeè·å–Authorizationå­—æ®µå€¼ä¸ºtokenï¼Œè¿”å›å½“å‰ç”¨æˆ·</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_current_user</span>(<span class="params">token: <span class="built_in">str</span> = Depends(<span class="params">oauth2_scheme</span>)</span>):</span><br><span class="line">    user = fake_decode_token(token)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(</span><br><span class="line">            status_code=status.HTTP_401_UNAUTHORIZED,</span><br><span class="line">            detail=<span class="string">&quot;Invalid authentication credentials&quot;</span>,</span><br><span class="line">            headers=&#123;<span class="string">&quot;WWW-Authenticate&quot;</span>: <span class="string">&quot;Bearer&quot;</span>&#125;,</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">return</span> user</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_current_active_user</span>(<span class="params">current_user: User = Depends(<span class="params">get_current_user</span>)</span>):</span><br><span class="line">    <span class="keyword">if</span> current_user.disabled: <span class="comment"># éæ¿€æ´»ç”¨æˆ·</span></span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">400</span>, detail=<span class="string">&quot;Inactive user&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> current_user</span><br><span class="line"></span><br><span class="line"><span class="comment"># /tokenå“åº”å®Œï¼Œæ›´æ–°ä¾èµ–é¡¹ï¼ˆä»…å½“å‰ç”¨æˆ·ä¸ºæ¿€æ´»çŠ¶æ€æ—¶è·å–current_userï¼‰</span></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/me&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_users_me</span>(<span class="params">current_user: User = Depends(<span class="params">get_current_active_user</span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> current_user</span><br></pre></td></tr></table></figure></p>
<h2
id="oauth2å®ç°å¯†ç å“ˆå¸Œä¸bearer-jwtä»¤ç‰ŒéªŒè¯">OAuth2å®ç°å¯†ç å“ˆå¸Œä¸Bearer
JWTä»¤ç‰ŒéªŒè¯</h2>
<p>1.<strong>JWT</strong> å³ <strong>JSON Web Tokens</strong>ã€‚JWT
æ˜¯ä¸€ç§å°† JSON å¯¹è±¡ç¼–ç ä¸ºæ²¡æœ‰ç©ºæ ¼ï¼Œä¸”éš¾ä»¥ç†è§£çš„é•¿å­—ç¬¦ä¸²çš„æ ‡å‡†ã€‚<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">JWTçš„æ ¼å¼ï¼š<span class="string">&quot;xxx.xxx.xxx&quot;</span></span><br><span class="line"><span class="comment"># 1.JWT ä»¤ç‰Œç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼šå¤´éƒ¨ï¼ˆheaderï¼‰ã€è½½è·ï¼ˆpayloadï¼‰ã€ç­¾åï¼ˆsignatureï¼‰ã€‚</span></span><br><span class="line"><span class="comment"># 2.headeråŒ…å«ä»¤ç‰Œçš„ç±»å‹ï¼ˆJWTï¼‰å’Œæ‰€ä½¿ç”¨çš„å“ˆå¸Œç®—æ³•ï¼ˆæ¯”å¦‚ HMAC SHA256 æˆ– RSAï¼‰ã€‚</span></span><br><span class="line"><span class="comment"># 3.payloadåŒ…å«å£°æ˜ï¼ˆclaimsï¼‰ï¼Œå£°æ˜æ˜¯å…³äºå®ä½“ï¼ˆé€šå¸¸æ˜¯ç”¨æˆ·ï¼‰å’Œå…¶ä»–æ•°æ®çš„å£°æ˜ã€‚ç”±JWTçš„æ ‡å‡†æ‰€å®šä¹‰çš„ã€‚</span></span><br><span class="line"><span class="comment"># 4.signatureä½¿ç”¨headerä¸­æŒ‡å®šçš„ç®—æ³•å¯¹headerå’Œpayloadè¿›è¡Œå“ˆå¸Œï¼Œç„¶åä½¿ç”¨å¯†é’¥å¯¹å“ˆå¸Œå€¼è¿›è¡Œç­¾åã€‚ç”¨äºéªŒè¯JWTçš„å‘é€è€…æ˜¯å¦å¯ä¿¡ä»»ã€‚</span></span><br></pre></td></tr></table></figure></p>
<p>JWT å­—ç¬¦ä¸²æ²¡æœ‰åŠ å¯†ï¼Œä»»ä½•äººéƒ½èƒ½ç”¨å®ƒæ¢å¤åŸå§‹ä¿¡æ¯ï¼Œä½† JWT
ä½¿ç”¨äº†ç­¾åæœºåˆ¶ï¼Œæ¥å—ä»¤ç‰Œæ—¶ï¼Œå¯ä»¥ç”¨ç­¾åæ ¡éªŒä»¤ç‰Œã€‚<br />
JWT
ä»¤ç‰Œå…·æœ‰æ—¶é™æ€§ï¼Œè¿‡æœŸåä»¤ç‰Œå¤±æ•ˆï¼Œå¦‚æœç”¨æˆ·ç¯¡æ”¹ä»¤ç‰Œçš„è¿‡æœŸæ—¶é—´ï¼Œå› ä¸ºç­¾åä¸åŒ¹é…ä¼šå¯¼è‡´èº«ä»½éªŒè¯å¤±è´¥ã€‚<br />
JWT éœ€å®‰è£…<code>pip install pyjwt</code>ã€‚è‹¥ä½¿ç”¨ç±»ä¼¼ RSA æˆ– ECDSA
çš„æ•°å­—ç­¾åç®—æ³•ï¼Œåº”è¯¥å®‰è£…åŠ å¯†åº“ä¾èµ–é¡¹<code>pip install pyjwt[crypto]</code>ã€‚</p>
<p>2.<strong>å“ˆå¸Œ</strong>æ˜¯æŒ‡æŠŠç‰¹å®šå†…å®¹ï¼ˆæœ¬ä¾‹ä¸­ä¸ºå¯†ç ï¼‰è½¬æ¢ä¸ºä¹±ç å½¢å¼çš„å­—èŠ‚åºåˆ—ï¼ˆå…¶å®å°±æ˜¯å­—ç¬¦ä¸²ï¼‰ã€‚<br />
æ¯æ¬¡ä¼ å…¥å®Œå…¨ç›¸åŒçš„å†…å®¹æ—¶ï¼ˆæ¯”å¦‚ï¼Œå®Œå…¨ç›¸åŒçš„å¯†ç ï¼‰ï¼Œè¿”å›çš„éƒ½æ˜¯å®Œå…¨ç›¸åŒçš„ä¹±ç ã€‚<br />
ä½†è¿™ä¸ªä¹±ç æ— æ³•è½¬æ¢å›ä¼ å…¥çš„å¯†ç ã€‚<br />
éœ€å®‰è£…å¤„ç†å¯†ç å“ˆå¸Œçš„åŒ…ï¼Œæœ¬ä¾‹æ¨èç®—æ³•æ˜¯Bcryptï¼Œæ‰€ä»¥å®‰è£…<code>pip install passlib[bcrypt]</code>ã€‚</p>
<p>3.æ­¤ä¾‹ä¸ºå®Œæ•´å®ç”¨å®‰å…¨æœºåˆ¶å®ç°ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta, timezone</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Depends, FastAPI, HTTPException, status</span><br><span class="line"><span class="keyword">from</span> fastapi.security <span class="keyword">import</span> OAuth2PasswordBearer, OAuth2PasswordRequestForm</span><br><span class="line"><span class="keyword">from</span> jwt.exceptions <span class="keyword">import</span> InvalidTokenError</span><br><span class="line"><span class="keyword">from</span> passlib.context <span class="keyword">import</span> CryptContext</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆ32ä½åå…­è¿›åˆ¶éšæœºå­—ç¬¦ä¸²ï¼Œä½œä¸ºWTä»¤ç‰Œç­¾åçš„éšæœºå¯†é’¥ï¼šopenssl rand -hex 32</span></span><br><span class="line">SECRET_KEY = <span class="string">&quot;09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7&quot;</span></span><br><span class="line">ALGORITHM = <span class="string">&quot;HS256&quot;</span> <span class="comment"># JWTä»¤ç‰Œç­¾åç®—æ³•</span></span><br><span class="line">ACCESS_TOKEN_EXPIRE_MINUTES = <span class="number">30</span>  <span class="comment"># JWTä»¤ç‰Œè¿‡æœŸæ—¶é—´ï¼Œåˆ†é’Ÿ</span></span><br><span class="line"></span><br><span class="line">fake_users_db = &#123;</span><br><span class="line">    <span class="string">&quot;johndoe&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;username&quot;</span>: <span class="string">&quot;johndoe&quot;</span>,</span><br><span class="line">        <span class="string">&quot;full_name&quot;</span>: <span class="string">&quot;John Doe&quot;</span>,</span><br><span class="line">        <span class="string">&quot;email&quot;</span>: <span class="string">&quot;johndoe@example.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;hashed_password&quot;</span>: <span class="string">&quot;$2b$12$EixZaYVK1fsbw1ZfbX3OXePaWxn96p36WQoeG6Lruj3vjPGga31lW&quot;</span>,</span><br><span class="line">        <span class="string">&quot;disabled&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Token</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    access_token: <span class="built_in">str</span></span><br><span class="line">    token_type: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TokenData</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    username: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    username: <span class="built_in">str</span></span><br><span class="line">    email: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line">    full_name: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line">    disabled: <span class="built_in">bool</span> | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserInDB</span>(<span class="title class_ inherited__">User</span>):</span><br><span class="line">    hashed_password: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pwd_context = CryptContext(schemes=[<span class="string">&quot;bcrypt&quot;</span>], deprecated=<span class="string">&quot;auto&quot;</span>)</span><br><span class="line">oauth2_scheme = OAuth2PasswordBearer(tokenUrl=<span class="string">&quot;token&quot;</span>)</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ ¡éªŒæ¥æ”¶çš„å¯†ç ï¼Œæ˜¯å¦åŒ¹é…å­˜å‚¨çš„å“ˆå¸Œå€¼</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">verify_password</span>(<span class="params">plain_password, hashed_password</span>):</span><br><span class="line">    <span class="keyword">return</span> pwd_context.verify(plain_password, hashed_password)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_password_hash</span>(<span class="params">password</span>):</span><br><span class="line">    <span class="keyword">return</span> pwd_context.<span class="built_in">hash</span>(password)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">db, username: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">if</span> username <span class="keyword">in</span> db:</span><br><span class="line">        user_dict = db[username]</span><br><span class="line">        <span class="keyword">return</span> UserInDB(**user_dict)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–ç”¨æˆ·ï¼Œå¹¶å¯¹ç”¨æˆ·å¯†ç è¿›è¡Œå“ˆå¸ŒéªŒè¯</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">authenticate_user</span>(<span class="params">fake_db, username: <span class="built_in">str</span>, password: <span class="built_in">str</span></span>):</span><br><span class="line">    user = get_user(fake_db, username)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> verify_password(password, user.hashed_password):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> user</span><br><span class="line"></span><br><span class="line"><span class="comment"># payloadå­—æ®µï¼š</span></span><br><span class="line"><span class="comment"># iss: è¯¥JWTçš„ç­¾å‘è€…</span></span><br><span class="line"><span class="comment"># sub: è¯¥JWTæ‰€é¢å‘çš„ç”¨æˆ·</span></span><br><span class="line"><span class="comment"># aud: æ¥æ”¶è¯¥JWTçš„ä¸€æ–¹</span></span><br><span class="line"><span class="comment"># exp(expires): ä»€ä¹ˆæ—¶å€™è¿‡æœŸï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªUnixæ—¶é—´æˆ³</span></span><br><span class="line"><span class="comment"># iat(issued at): åœ¨ä»€ä¹ˆæ—¶å€™ç­¾å‘çš„</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_access_token</span>(<span class="params">data: <span class="built_in">dict</span>, expires_delta: timedelta | <span class="literal">None</span> = <span class="literal">None</span></span>): <span class="comment"># ç”ŸæˆJWTä»¤ç‰Œ</span></span><br><span class="line">    payload = data.copy()</span><br><span class="line">    <span class="keyword">if</span> expires_delta:</span><br><span class="line">        expire = datetime.now(timezone.utc) + expires_delta</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        expire = datetime.now(timezone.utc) + timedelta(minutes=<span class="number">15</span>)  <span class="comment"># é»˜è®¤æœ‰æ•ˆæ—¶é—´15åˆ†é’Ÿ</span></span><br><span class="line">    payload.update(&#123;<span class="string">&quot;exp&quot;</span>: expire&#125;) <span class="comment"># æ·»åŠ æœ‰æ•ˆæ—¶é—´</span></span><br><span class="line">    <span class="comment"># JWTä»¤ç‰Œç”Ÿæˆï¼Œto_encodeè¦åŠ å¯†çš„æ•°æ®ï¼ŒSECRET_KEYç”¨äºç­¾åå’ŒéªŒè¯JWTï¼ŒalgorithmæŒ‡å®šç­¾åç®—æ³•</span></span><br><span class="line">    encoded_jwt = jwt.encode(payload, SECRET_KEY, algorithm=ALGORITHM)</span><br><span class="line">    <span class="keyword">return</span> encoded_jwt</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ ¹æ®JWTä»¤ç‰Œï¼ˆç›´æ¥è·å–access_tokençš„å€¼ï¼‰è·å–ç”¨æˆ·</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_current_user</span>(<span class="params">token: <span class="built_in">str</span> = Depends(<span class="params">oauth2_scheme</span>)</span>):</span><br><span class="line">    credentials_exception = HTTPException(</span><br><span class="line">        status_code=status.HTTP_401_UNAUTHORIZED,</span><br><span class="line">        detail=<span class="string">&quot;Could not validate credentials&quot;</span>,</span><br><span class="line">        headers=&#123;<span class="string">&quot;WWW-Authenticate&quot;</span>: <span class="string">&quot;Bearer&quot;</span>&#125;,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># JWTä»¤ç‰Œè§£ç </span></span><br><span class="line">        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])</span><br><span class="line">        <span class="comment"># è·å–ä»¤ç‰Œå­˜å‚¨çš„æ•°æ®</span></span><br><span class="line">        username: <span class="built_in">str</span> = payload.get(<span class="string">&quot;sub&quot;</span>)</span><br><span class="line">        <span class="comment"># éªŒè¯æ•°æ®</span></span><br><span class="line">        <span class="keyword">if</span> username <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">raise</span> credentials_exception</span><br><span class="line">        <span class="comment"># å­˜å…¥TokenDataæ¨¡å‹</span></span><br><span class="line">        token_data = TokenData(username=username)</span><br><span class="line">    <span class="keyword">except</span> InvalidTokenError:</span><br><span class="line">        <span class="keyword">raise</span> credentials_exception</span><br><span class="line">    <span class="comment"># è·å–ç”¨æˆ·æ•°æ®</span></span><br><span class="line">    user = get_user(fake_users_db, username=token_data.username)</span><br><span class="line">    <span class="keyword">if</span> user <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> credentials_exception</span><br><span class="line">    <span class="keyword">return</span> user</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–å½“å‰æ¿€æ´»ç”¨æˆ·æ•°æ®</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_current_active_user</span>(<span class="params">current_user: User = Depends(<span class="params">get_current_user</span>)</span>):</span><br><span class="line">    <span class="keyword">if</span> current_user.disabled:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">400</span>, detail=<span class="string">&quot;Inactive user&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> current_user</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯·å‚è€ƒã€OAuth2ç®€å•çš„ Password å’Œ Bearer éªŒè¯ã€‘</span></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/token&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">login_for_access_token</span>(<span class="params">form_data: OAuth2PasswordRequestForm = Depends(<span class="params"></span>),</span>) -&gt; Token:</span><br><span class="line">    <span class="comment"># è·å–ç”¨æˆ·ï¼Œå¹¶å¯¹ç”¨æˆ·å¯†ç è¿›è¡Œå“ˆå¸ŒéªŒè¯</span></span><br><span class="line">    user = authenticate_user(fake_users_db, form_data.username, form_data.password)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(</span><br><span class="line">            status_code=status.HTTP_401_UNAUTHORIZED,</span><br><span class="line">            detail=<span class="string">&quot;Incorrect username or password&quot;</span>,</span><br><span class="line">            headers=&#123;<span class="string">&quot;WWW-Authenticate&quot;</span>: <span class="string">&quot;Bearer&quot;</span>&#125;,</span><br><span class="line">        )</span><br><span class="line">    <span class="comment"># è®¾å®štokenè¿‡æœŸæ—¶é—´</span></span><br><span class="line">    access_token_expires = timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)</span><br><span class="line">    <span class="comment"># ç”ŸæˆJWTä»¤ç‰Œï¼Œ&quot;sub&quot;æ˜¯JWTçš„ç”¨æˆ·</span></span><br><span class="line">    access_token = create_access_token(data=&#123;<span class="string">&quot;sub&quot;</span>: user.username&#125;, expires_delta=access_token_expires)</span><br><span class="line">    <span class="comment"># è¿”å›pydanticæ¨¡å‹ï¼Œå¿…é¡»æœ‰access_tokenå’Œtoken_type</span></span><br><span class="line">    <span class="keyword">return</span> Token(access_token=access_token, token_type=<span class="string">&quot;bearer&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–å½“å‰ç”¨æˆ·æ•°æ®ï¼Œè¾“å…¥æ—¶å¿…é¡»æºå¸¦JWTä»¤ç‰Œï¼ˆéœ€åœ¨è¯·æ±‚å¤´ä¸­æ·»åŠ Authorizationå­—æ®µï¼Œå€¼ä¸º&quot;access_token&quot;çš„å€¼ï¼‰</span></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/me/&quot;</span>, response_model=User</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_users_me</span>(<span class="params">current_user: User = Depends(<span class="params">get_current_active_user</span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> current_user</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŒä¸Š</span></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/me/items/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_own_items</span>(<span class="params">current_user: User = Depends(<span class="params">get_current_active_user</span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> [&#123;<span class="string">&quot;item_id&quot;</span>: <span class="string">&quot;Foo&quot;</span>, <span class="string">&quot;owner&quot;</span>: current_user.username&#125;]</span><br></pre></td></tr></table></figure></p>
<h2 id="oauth2ä½œç”¨åŸŸ">OAuth2ä½œç”¨åŸŸ</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta, timezone</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Union</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Depends, FastAPI, HTTPException, Security, status</span><br><span class="line"><span class="keyword">from</span> fastapi.security <span class="keyword">import</span> OAuth2PasswordBearer, OAuth2PasswordRequestForm, SecurityScopes</span><br><span class="line"><span class="keyword">from</span> jwt.exceptions <span class="keyword">import</span> InvalidTokenError</span><br><span class="line"><span class="keyword">from</span> passlib.context <span class="keyword">import</span> CryptContext</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, ValidationError</span><br><span class="line"></span><br><span class="line"><span class="comment"># to get a string like this run:</span></span><br><span class="line"><span class="comment"># openssl rand -hex 32</span></span><br><span class="line">SECRET_KEY = <span class="string">&quot;09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7&quot;</span></span><br><span class="line">ALGORITHM = <span class="string">&quot;HS256&quot;</span></span><br><span class="line">ACCESS_TOKEN_EXPIRE_MINUTES = <span class="number">30</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fake_users_db = &#123;</span><br><span class="line">    <span class="string">&quot;johndoe&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;username&quot;</span>: <span class="string">&quot;johndoe&quot;</span>,</span><br><span class="line">        <span class="string">&quot;full_name&quot;</span>: <span class="string">&quot;John Doe&quot;</span>,</span><br><span class="line">        <span class="string">&quot;email&quot;</span>: <span class="string">&quot;johndoe@example.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;hashed_password&quot;</span>: <span class="string">&quot;$2b$12$EixZaYVK1fsbw1ZfbX3OXePaWxn96p36WQoeG6Lruj3vjPGga31lW&quot;</span>,</span><br><span class="line">        <span class="string">&quot;disabled&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;alice&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;username&quot;</span>: <span class="string">&quot;alice&quot;</span>,</span><br><span class="line">        <span class="string">&quot;full_name&quot;</span>: <span class="string">&quot;Alice Chains&quot;</span>,</span><br><span class="line">        <span class="string">&quot;email&quot;</span>: <span class="string">&quot;alicechains@example.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;hashed_password&quot;</span>: <span class="string">&quot;$2b$12$gSvqqUPvlXP2tfVFaWK1Be7DlH.PKZbv5H8KnzzVgXXbVxpva.pFm&quot;</span>,</span><br><span class="line">        <span class="string">&quot;disabled&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Token</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    access_token: <span class="built_in">str</span></span><br><span class="line">    token_type: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TokenData</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    username: <span class="type">Union</span>[<span class="built_in">str</span>, <span class="literal">None</span>] = <span class="literal">None</span></span><br><span class="line">    scopes: <span class="type">List</span>[<span class="built_in">str</span>] = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    username: <span class="built_in">str</span></span><br><span class="line">    email: <span class="type">Union</span>[<span class="built_in">str</span>, <span class="literal">None</span>] = <span class="literal">None</span></span><br><span class="line">    full_name: <span class="type">Union</span>[<span class="built_in">str</span>, <span class="literal">None</span>] = <span class="literal">None</span></span><br><span class="line">    disabled: <span class="type">Union</span>[<span class="built_in">bool</span>, <span class="literal">None</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserInDB</span>(<span class="title class_ inherited__">User</span>):</span><br><span class="line">    hashed_password: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pwd_context = CryptContext(schemes=[<span class="string">&quot;bcrypt&quot;</span>], deprecated=<span class="string">&quot;auto&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¢åŠ scopesä½œç”¨åŸŸï¼Œmeå’Œitems</span></span><br><span class="line">oauth2_scheme = OAuth2PasswordBearer(</span><br><span class="line">    tokenUrl=<span class="string">&quot;token&quot;</span>,</span><br><span class="line">    scopes=&#123;<span class="string">&quot;me&quot;</span>: <span class="string">&quot;Read information about the current user.&quot;</span>, <span class="string">&quot;items&quot;</span>: <span class="string">&quot;Read items.&quot;</span>&#125;,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">verify_password</span>(<span class="params">plain_password, hashed_password</span>):</span><br><span class="line">    <span class="keyword">return</span> pwd_context.verify(plain_password, hashed_password)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_password_hash</span>(<span class="params">password</span>):</span><br><span class="line">    <span class="keyword">return</span> pwd_context.<span class="built_in">hash</span>(password)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">db, username: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">if</span> username <span class="keyword">in</span> db:</span><br><span class="line">        user_dict = db[username]</span><br><span class="line">        <span class="keyword">return</span> UserInDB(**user_dict)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">authenticate_user</span>(<span class="params">fake_db, username: <span class="built_in">str</span>, password: <span class="built_in">str</span></span>):</span><br><span class="line">    user = get_user(fake_db, username)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> verify_password(password, user.hashed_password):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> user</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_access_token</span>(<span class="params">data: <span class="built_in">dict</span>, expires_delta: <span class="type">Union</span>[timedelta, <span class="literal">None</span>] = <span class="literal">None</span></span>):</span><br><span class="line">    to_encode = data.copy()</span><br><span class="line">    <span class="keyword">if</span> expires_delta:</span><br><span class="line">        expire = datetime.now(timezone.utc) + expires_delta</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        expire = datetime.now(timezone.utc) + timedelta(minutes=<span class="number">15</span>)</span><br><span class="line">    to_encode.update(&#123;<span class="string">&quot;exp&quot;</span>: expire&#125;)</span><br><span class="line">    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)</span><br><span class="line">    <span class="keyword">return</span> encoded_jwt</span><br><span class="line"></span><br><span class="line"><span class="comment"># æœ€åº•å±‚çš„ä¾èµ–é¡¹ï¼ŒSecurityScopesç±»ä¼¼Requestï¼Œå¯ç›´æ¥æå–è¯·æ±‚ä¸­çš„ä¿¡æ¯</span></span><br><span class="line"><span class="comment"># SecurityScopesæœ‰å±æ€§scopesï¼Œæ˜¯ä½œç”¨åŸŸåˆ—è¡¨ï¼ˆscope_stræ˜¯ä½œç”¨åŸŸç©ºæ ¼å½¢å¼è¿æ¥çš„å­—ç¬¦ä¸²ï¼‰</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_current_user</span>(<span class="params"></span></span><br><span class="line"><span class="params">    security_scopes: SecurityScopes, token: <span class="built_in">str</span> = Depends(<span class="params">oauth2_scheme</span>)</span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    <span class="keyword">if</span> security_scopes.scopes:</span><br><span class="line">        authenticate_value = <span class="string">f&#x27;Bearer scope=&quot;<span class="subst">&#123;security_scopes.scope_str&#125;</span>&quot;&#x27;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        authenticate_value = <span class="string">&quot;Bearer&quot;</span></span><br><span class="line">    credentials_exception = HTTPException(</span><br><span class="line">        status_code=status.HTTP_401_UNAUTHORIZED,</span><br><span class="line">        detail=<span class="string">&quot;Could not validate credentials&quot;</span>,</span><br><span class="line">        headers=&#123;<span class="string">&quot;WWW-Authenticate&quot;</span>: authenticate_value&#125;,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])</span><br><span class="line">        username: <span class="built_in">str</span> = payload.get(<span class="string">&quot;sub&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> username <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">raise</span> credentials_exception</span><br><span class="line">        token_scopes = payload.get(<span class="string">&quot;scopes&quot;</span>, [])</span><br><span class="line">        <span class="comment"># ä½¿ç”¨TokenDataéªŒè¯æ•°æ®ç±»å‹</span></span><br><span class="line">        token_data = TokenData(scopes=token_scopes, username=username)</span><br><span class="line">    <span class="keyword">except</span> (InvalidTokenError, ValidationError):</span><br><span class="line">        <span class="keyword">raise</span> credentials_exception</span><br><span class="line">    user = get_user(fake_users_db, username=token_data.username)</span><br><span class="line">    <span class="keyword">if</span> user <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> credentials_exception</span><br><span class="line">    <span class="comment"># ä»¤ç‰Œä¸­çš„ä½œç”¨åŸŸï¼Œè¦åœ¨å½“å‰è·¯å¾„ä½œç”¨åŸŸå­—ç¬¦ä¸²åˆ—è¡¨ä¸­</span></span><br><span class="line">    <span class="keyword">for</span> scope <span class="keyword">in</span> security_scopes.scopes:</span><br><span class="line">        <span class="keyword">if</span> scope <span class="keyword">not</span> <span class="keyword">in</span> token_data.scopes:</span><br><span class="line">            <span class="keyword">raise</span> HTTPException(</span><br><span class="line">                status_code=status.HTTP_401_UNAUTHORIZED,</span><br><span class="line">                detail=<span class="string">&quot;Not enough permissions&quot;</span>,</span><br><span class="line">                headers=&#123;<span class="string">&quot;WWW-Authenticate&quot;</span>: authenticate_value&#125;,</span><br><span class="line">            )</span><br><span class="line">    <span class="keyword">return</span> user</span><br><span class="line"></span><br><span class="line"><span class="comment"># å­ä¾èµ–é¡¹ï¼Œä¹Ÿå¯ä»¥æœ‰è‡ªå·±çš„ä½œç”¨åŸŸme</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_current_active_user</span>(<span class="params"></span></span><br><span class="line"><span class="params">    current_user: User = Security(<span class="params">get_current_user, scopes=[<span class="string">&quot;me&quot;</span>]</span>),</span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    <span class="keyword">if</span> current_user.disabled:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">400</span>, detail=<span class="string">&quot;Inactive user&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> current_user</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/token&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># form_dataæ¥æ”¶ä½œç”¨åŸŸscopes</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">login_for_access_token</span>(<span class="params"></span></span><br><span class="line"><span class="params">    form_data: OAuth2PasswordRequestForm = Depends(<span class="params"></span>),</span></span><br><span class="line"><span class="params"></span>) -&gt; Token:</span><br><span class="line">    user = authenticate_user(fake_users_db, form_data.username, form_data.password)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">400</span>, detail=<span class="string">&quot;Incorrect username or password&quot;</span>)</span><br><span class="line">    access_token_expires = timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)</span><br><span class="line">    <span class="comment"># è¿™é‡ŒæŠŠä½œç”¨åŸŸscopesæ·»åŠ åˆ°tokenä¸­äº†ï¼Œæ³¨æ„ï¼Œå®é™…åº”æŠŠscopesæ·»åŠ åˆ°éœ€è¦è¯¥ä½œç”¨åŸŸçš„ç”¨æˆ·ä¸­</span></span><br><span class="line">    access_token = create_access_token(</span><br><span class="line">        data=&#123;<span class="string">&quot;sub&quot;</span>: user.username, <span class="string">&quot;scopes&quot;</span>: form_data.scopes&#125;,</span><br><span class="line">        expires_delta=access_token_expires,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> Token(access_token=access_token, token_type=<span class="string">&quot;bearer&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/me/&quot;</span>, response_model=User</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_users_me</span>(<span class="params">current_user: User = Depends(<span class="params">get_current_active_user</span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> current_user</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/me/items/&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># æƒ³å£°æ˜è·¯å¾„çš„ä½œç”¨åŸŸï¼Œéœ€è¦Securityï¼Œå®ƒæœ‰scopeså‚æ•°</span></span><br><span class="line"><span class="comment"># Securityä½¿ç”¨å’ŒDependsæ–¹å¼ç›¸åŒï¼Œéƒ½æ˜¯ä¾èµ–æ³¨å…¥</span></span><br><span class="line"><span class="comment"># get_current_active_userå­ä¾èµ–å¯ä»¥æœ‰è‡ªå·±çš„ä¾èµ–é¡¹</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_own_items</span>(<span class="params"></span></span><br><span class="line"><span class="params">    current_user: User = Security(<span class="params">get_current_active_user, scopes=[<span class="string">&quot;items&quot;</span>]</span>),</span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    <span class="keyword">return</span> [&#123;<span class="string">&quot;item_id&quot;</span>: <span class="string">&quot;Foo&quot;</span>, <span class="string">&quot;owner&quot;</span>: current_user.username&#125;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/status/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_system_status</span>(<span class="params">current_user: User = Depends(<span class="params">get_current_user</span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;ok&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<h2 id="httpåŸºç¡€æˆæƒ">HTTPåŸºç¡€æˆæƒ</h2>
<p>åœ¨ HTTP åŸºç¡€æˆæƒä¸­ï¼Œåº”ç”¨éœ€è¦è¯·æ±‚å¤´åŒ…å«ç”¨æˆ·åä¸å¯†ç ã€‚<br />
å¦‚æœæ²¡æœ‰æ¥æ”¶åˆ° HTTP åŸºç¡€æˆæƒï¼Œå°±è¿”å› HTTP 401 "Unauthorized"
é”™è¯¯ã€‚<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Depends, FastAPI</span><br><span class="line"><span class="keyword">from</span> fastapi.security <span class="keyword">import</span> HTTPBasic, HTTPBasicCredentials</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/me&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># ä½¿ç”¨HTTPBasic()å®ä¾‹æ¥æ”¶headerä¸­çš„ç”¨æˆ·åå’Œå¯†ç </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_current_user</span>(<span class="params">credentials: HTTPBasicCredentials = Depends(<span class="params">HTTPBasic(<span class="params"></span>)</span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;username&quot;</span>: credentials.username, <span class="string">&quot;password&quot;</span>: credentials.password&#125;</span><br></pre></td></tr></table></figure></p>
<p>pythonçš„secretsåº“ï¼Œæ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç ï¼Œèƒ½é˜²æ­¢æ—¶å·®æ”»å‡»ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> secrets</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Depends, FastAPI, HTTPException, status</span><br><span class="line"><span class="keyword">from</span> fastapi.security <span class="keyword">import</span> HTTPBasic, HTTPBasicCredentials</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line">security = HTTPBasic()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_current_username</span>(<span class="params">credentials: HTTPBasicCredentials = Depends(<span class="params">security</span>)</span>):</span><br><span class="line">    current_username_bytes = credentials.username.encode(<span class="string">&quot;utf8&quot;</span>)</span><br><span class="line">    correct_username_bytes = <span class="string">b&quot;stanleyjobson&quot;</span></span><br><span class="line">    is_correct_username = secrets.compare_digest(</span><br><span class="line">        current_username_bytes, correct_username_bytes</span><br><span class="line">    )</span><br><span class="line">    current_password_bytes = credentials.password.encode(<span class="string">&quot;utf8&quot;</span>)</span><br><span class="line">    correct_password_bytes = <span class="string">b&quot;swordfish&quot;</span></span><br><span class="line">    <span class="comment"># ä½¿ç”¨secretsçš„compare_digestæ¥å¯¹æ¯”å¯†ç ï¼Œé˜²æ­¢æ—¶å·®æ”»å‡»</span></span><br><span class="line">    is_correct_password = secrets.compare_digest(</span><br><span class="line">        current_password_bytes, correct_password_bytes</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> (is_correct_username <span class="keyword">and</span> is_correct_password):</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(</span><br><span class="line">            status_code=status.HTTP_401_UNAUTHORIZED,</span><br><span class="line">            detail=<span class="string">&quot;Incorrect username or password&quot;</span>,</span><br><span class="line">            headers=&#123;<span class="string">&quot;WWW-Authenticate&quot;</span>: <span class="string">&quot;Basic&quot;</span>&#125;,</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">return</span> credentials.username</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/me&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_current_user</span>(<span class="params">username: <span class="built_in">str</span> = Depends(<span class="params">get_current_username</span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;username&quot;</span>: username&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="ä¸­é—´ä»¶">ä¸­é—´ä»¶</h1>
<p>ä¸­é—´ä»¶æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒåœ¨æ¯ä¸ª<strong>è¯·æ±‚</strong>è¢«è·¯ç”±å¤„ç†ä¹‹å‰ã€ä»¥åŠæ¯ä¸ª<strong>å“åº”</strong>è¿”å›ä¹‹å‰è°ƒç”¨ã€‚</p>
<p>1.ä¸­é—´ä»¶ç¤ºä¾‹<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Request</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.middleware(<span class="params"><span class="string">&quot;http&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">add_process_time_header</span>(<span class="params">request: Request, call_next</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    è®¡ç®—è¯·æ±‚å¤„ç†è€—æ—¶ï¼Œå¹¶å°†ç»“æœæ·»åŠ åˆ°å“åº”å¤´ä¸­</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    start_time = time.time()</span><br><span class="line">    <span class="comment"># è°ƒç”¨ä¸‹ä¸€ä¸ªä¸­é—´ä»¶æˆ–è·¯ç”±å¤„ç†å‡½æ•°</span></span><br><span class="line">    response = <span class="keyword">await</span> call_next(request)</span><br><span class="line">    process_time = time.time() - start_time</span><br><span class="line">    response.headers[<span class="string">&quot;X-Process-Time&quot;</span>] = <span class="built_in">str</span>(process_time)</span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure></p>
<p>CORSæŒ‡æµè§ˆå™¨ä¸­è¿è¡Œçš„å‰ç«¯æ‹¥æœ‰ä¸åç«¯é€šä¿¡çš„ JavaScript
ä»£ç ï¼Œè€Œåç«¯å¤„äºä¸å‰ç«¯ä¸åŒçš„ã€Œæºã€çš„æƒ…å†µã€‚<br />
æºæ˜¯<strong>åè®®</strong>ï¼ˆhttpï¼Œhttpsï¼‰ã€<strong>åŸŸ</strong>ï¼ˆmyapp.comï¼Œlocalhostï¼‰ä»¥åŠ<strong>ç«¯å£</strong>ï¼ˆ80ã€443ã€8080ï¼‰çš„ç»„åˆã€‚å®ƒä»¬å¿…é¡»å®Œå…¨åŒ¹é…æ‰èƒ½è¢«è§†ä¸ºç›¸åŒçš„æºã€‚å³ä½¿å®ƒä»¬éƒ½åœ¨
localhost
ä¸­ï¼Œä½†æ˜¯å®ƒä»¬ä½¿ç”¨ä¸åŒçš„åè®®æˆ–è€…ç«¯å£ï¼Œæ‰€ä»¥å®ƒä»¬éƒ½æ˜¯ä¸åŒçš„ã€Œæºã€ã€‚<br />
2.CORSè·¨åŸŸèµ„æºå…±äº«ä¸­é—´ä»¶ï¼Œåç«¯æ·»åŠ ä¸€ä¸ªã€Œå…è®¸çš„æºã€åˆ—è¡¨ï¼Œä¿è¯å‰åç«¯èƒ½æ­£å¸¸é€šä¿¡ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> fastapi.middleware.cors <span class="keyword">import</span> CORSMiddleware</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line">origins = [</span><br><span class="line">    <span class="string">&quot;http://localhost:80&quot;</span>,</span><br><span class="line">    <span class="string">&#x27;http://127.0.0.1:80&#x27;</span>,</span><br><span class="line">    <span class="string">&quot;http://localhost:8080&quot;</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># &quot;allow_origins&quot;: å…è®¸è·¨åŸŸè¯·æ±‚çš„æºåˆ—è¡¨ï¼Œ[&#x27;*&#x27;] å…è®¸ä»»ä½•æºã€‚</span></span><br><span class="line"><span class="comment"># &quot;allow_origin_regex&quot;: å…è®¸è·¨åŸŸè¯·æ±‚çš„æ­£åˆ™è¡¨è¾¾å¼ã€‚</span></span><br><span class="line"><span class="comment"># &quot;allow_credentials&quot;: æ˜¯å¦å…è®¸å‘é€Cookieï¼Œé»˜è®¤Falseï¼Œè‹¥ä¸ºTrueï¼Œåˆ™allow_originsä¸èƒ½è®¾å®šä¸º[&#x27;*&#x27;]ï¼Œå¿…é¡»æŒ‡å®šæºã€‚</span></span><br><span class="line"><span class="comment"># &quot;allow_methods&quot;: å…è®¸è·¨åŸŸè¯·æ±‚çš„è¯·æ±‚çš„ HTTP æ–¹æ³•åˆ—è¡¨ï¼Œé»˜è®¤ä¸º [&#x27;GET&#x27;]ï¼Œ[&#x27;*&#x27;] å…è®¸ä»»ä½•æ–¹æ³•ã€‚</span></span><br><span class="line"><span class="comment"># &quot;allow_headers&quot;: å…è®¸è·¨åŸŸè¯·æ±‚çš„ HTTP è¯·æ±‚å¤´åˆ—è¡¨ï¼Œé»˜è®¤ä¸º []ï¼Œ[&#x27;*&#x27;] å…è®¸ä»»ä½•è¯·æ±‚å¤´ã€‚</span></span><br><span class="line"><span class="comment"># &quot;expose_headers&quot;: æŒ‡ç¤ºå¯ä»¥è¢«æµè§ˆå™¨è®¿é—®çš„å“åº”å¤´ï¼Œé»˜è®¤ä¸º []ã€‚</span></span><br><span class="line">app.add_middleware(</span><br><span class="line">    CORSMiddleware,</span><br><span class="line">    allow_origins=origins,</span><br><span class="line">    allow_credentials=<span class="literal">True</span>,</span><br><span class="line">    allow_methods=[<span class="string">&quot;*&quot;</span>],</span><br><span class="line">    allow_headers=[<span class="string">&quot;*&quot;</span>],</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Hello World&quot;</span>&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="é«˜çº§ä¸­é—´ä»¶">é«˜çº§ä¸­é—´ä»¶</h1>
<p>FaskAPIä¸­é›†æˆäº†ä¸€äº›ä¸­é—´ä»¶ï¼Œæ–¹ä¾¿å¼€å‘è€…ä½¿ç”¨ï¼Œä½†ç»å¤§å¤šæ•°å¯ç”¨çš„ä¸­é—´ä»¶éƒ½ç›´æ¥ç»§æ‰¿è‡ª
Starletteã€‚<br />
1.HTTPSRedirectMiddlewareï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> fastapi.middleware.httpsredirect <span class="keyword">import</span> HTTPSRedirectMiddleware</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"><span class="comment"># å¼ºåˆ¶æ‰€æœ‰ä¼ å…¥è¯·æ±‚å¿…é¡»æ˜¯ https æˆ– wssã€‚</span></span><br><span class="line"><span class="comment"># ä»»ä½•ä¼ å‘ http æˆ– ws çš„è¯·æ±‚éƒ½ä¼šè¢«é‡å®šå‘è‡³å®‰å…¨æ–¹æ¡ˆã€‚</span></span><br><span class="line">app.add_middleware(HTTPSRedirectMiddleware)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Hello World&quot;</span>&#125;</span><br></pre></td></tr></table></figure></p>
<p>2.TrustedHostMiddlewareï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> fastapi.middleware.trustedhost <span class="keyword">import</span> TrustedHostMiddleware</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼ºåˆ¶æ‰€æœ‰ä¼ å…¥è¯·æ±‚éƒ½å¿…é¡»æ­£ç¡®è®¾ç½® Host è¯·æ±‚å¤´ï¼Œä»¥é˜² HTTP ä¸»æœºå¤´æ”»å‡»ã€‚</span></span><br><span class="line"><span class="comment"># allowed_hostsï¼šå…è®¸çš„åŸŸåï¼ˆä¸»æœºåï¼‰åˆ—è¡¨ã€‚</span></span><br><span class="line"><span class="comment"># *.example.com ç­‰é€šé…ç¬¦åŸŸåå¯ä»¥åŒ¹é…å­åŸŸåï¼Œæˆ–ä½¿ç”¨ allowed_hosts=[&quot;*&quot;] å…è®¸ä»»æ„ä¸»æœºåï¼Œæˆ–çœç•¥ä¸­é—´ä»¶ã€‚</span></span><br><span class="line">app.add_middleware(</span><br><span class="line">    TrustedHostMiddleware, allowed_hosts=[<span class="string">&quot;example.com&quot;</span>, <span class="string">&quot;*.example.com&quot;</span>]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Hello World&quot;</span>&#125;</span><br></pre></td></tr></table></figure></p>
<p>3.GZipMiddlewareï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> fastapi.middleware.gzip <span class="keyword">import</span> GZipMiddleware</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤„ç† Accept-Encoding è¯·æ±‚å¤´ä¸­åŒ…å« gzip è¯·æ±‚çš„ GZip å“åº”ã€‚</span></span><br><span class="line"><span class="comment"># ä¸­é—´ä»¶ä¼šå¤„ç†æ ‡å‡†å“åº”ä¸æµå“åº”ã€‚</span></span><br><span class="line"><span class="comment"># minimum_sizeï¼šå°äºæœ€å°å­—èŠ‚çš„å“åº”ä¸ä½¿ç”¨ GZipã€‚ é»˜è®¤å€¼æ˜¯ 500ã€‚</span></span><br><span class="line">app.add_middleware(GZipMiddleware, minimum_size=<span class="number">1000</span>, compresslevel=<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;somebigcontent&quot;</span></span><br></pre></td></tr></table></figure></p>
<h1 id="å­è·¯ç”±">å­è·¯ç”±</h1>
<p>å­è·¯ç”±ï¼Œå¯ä»¥ä¸ºå¤§å‹é¡¹ç›®æ„å»ºæä¾›éå†ï¼ŒæŒ‰ç…§åŠŸèƒ½æ¨¡å—åˆ’åˆ†ï¼Œå°†ä¸åŒæ¨¡å—çš„APIæ”¾åœ¨ä¸åŒçš„æ–‡ä»¶ä¸­ï¼Œå†ç»Ÿä¸€å¯¼å…¥åˆ°ä¸»æ–‡ä»¶ä¸­ï¼Œæœ€åç»Ÿä¸€æ³¨å†Œåˆ°FastAPIå®ä¾‹ä¸­ã€‚<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ app</span><br><span class="line">â”‚   â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚   â”œâ”€â”€ main.py</span><br><span class="line">â”‚   â”œâ”€â”€ dependencies.py</span><br><span class="line">â”‚   â””â”€â”€ routers <span class="comment"># å­è·¯ç”±</span></span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ items.py</span><br><span class="line">â”‚   â”‚   â””â”€â”€ users.py</span><br><span class="line">â”‚   â””â”€â”€ internal</span><br><span class="line">â”‚       â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚       â””â”€â”€ admin.py</span><br></pre></td></tr></table></figure></p>
<p>1.å­è·¯ç”±çš„ä½¿ç”¨ï¼Œå’Œä¸»è·¯ç”±ä¸€æ ·ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> APIRouter <span class="comment"># å­è·¯ç”±</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Depends</span><br><span class="line"><span class="keyword">from</span> ..dependencies <span class="keyword">import</span> get_token_header</span><br><span class="line"></span><br><span class="line">router = APIRouter(</span><br><span class="line">    prefix=<span class="string">&quot;/items&quot;</span>, <span class="comment"># å­è·¯ç”±å‰ç¼€</span></span><br><span class="line">    tags=[<span class="string">&quot;items&quot;</span>], <span class="comment"># å­è·¯ç”±æ ‡ç­¾</span></span><br><span class="line">    dependencies=[Depends(get_token_header)],</span><br><span class="line">    responses=&#123;<span class="number">404</span>: &#123;<span class="string">&quot;description&quot;</span>: <span class="string">&quot;Not found&quot;</span>&#125;&#125;,</span><br><span class="line">) <span class="comment"># åˆ›å»ºå­è·¯ç”±</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@router.get(<span class="params"><span class="string">&quot;/users/&quot;</span>, tags=[<span class="string">&quot;users&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_users</span>():</span><br><span class="line">    <span class="keyword">return</span> [&#123;<span class="string">&quot;username&quot;</span>: <span class="string">&quot;Rick&quot;</span>&#125;, &#123;<span class="string">&quot;username&quot;</span>: <span class="string">&quot;Morty&quot;</span>&#125;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@router.get(<span class="params"><span class="string">&quot;/users/me&quot;</span>, tags=[<span class="string">&quot;users&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_user_me</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;username&quot;</span>: <span class="string">&quot;fakecurrentuser&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@router.get(<span class="params"><span class="string">&quot;/users/&#123;username&#125;&quot;</span>, tags=[<span class="string">&quot;users&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_user</span>(<span class="params">username: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;username&quot;</span>: username&#125;</span><br></pre></td></tr></table></figure></p>
<p>2.ä¸»è·¯ç”±ä¸­ï¼Œæ³¨å†Œå­è·¯ç”±ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Depends, FastAPI</span><br><span class="line"><span class="keyword">from</span> .dependencies <span class="keyword">import</span> get_query_token, get_token_header</span><br><span class="line"><span class="keyword">from</span> .internal <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> .routers <span class="keyword">import</span> items, users</span><br><span class="line"></span><br><span class="line">app = FastAPI(dependencies=[Depends(get_query_token)]) <span class="comment"># ä¸»è·¯ç”±</span></span><br><span class="line"></span><br><span class="line">app.include_router(users.router) <span class="comment"># ä¸»è·¯ç”±æ³¨å†Œå­è·¯ç”±</span></span><br><span class="line">app.include_router(items.router) <span class="comment"># ä¸»è·¯ç”±æ³¨å†Œå­è·¯ç”±</span></span><br><span class="line">app.include_router(</span><br><span class="line">    admin.router,</span><br><span class="line">    prefix=<span class="string">&quot;/admin&quot;</span>,</span><br><span class="line">    tags=[<span class="string">&quot;admin&quot;</span>],</span><br><span class="line">    dependencies=[Depends(get_token_header)],</span><br><span class="line">    responses=&#123;<span class="number">418</span>: &#123;<span class="string">&quot;description&quot;</span>: <span class="string">&quot;I&#x27;m a teapot&quot;</span>&#125;&#125;,</span><br><span class="line">) <span class="comment"># ä¸»è·¯ç”±æ³¨å†Œå­è·¯ç”±</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">root</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Hello Bigger Applications!&quot;</span>&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="åå°ä»»åŠ¡">åå°ä»»åŠ¡</h1>
<p>æœ‰æ—¶ä¼šé‡åˆ°éœ€è¦åœ¨è¯·æ±‚å¤„ç†å®Œæˆåæ‰§è¡Œä¸€äº›ä»»åŠ¡çš„æƒ…å†µï¼Œæ¯”å¦‚å‘é€é‚®ä»¶ã€æ¸…ç†ç¼“å­˜ç­‰ã€‚FastAPI
æä¾›äº† BackgroundTasks ç±»æ¥å¤„ç†è¿™ç§æƒ…å†µã€‚<br />
æ³¨æ„ï¼Œè‹¥åå°ä»»åŠ¡éå¸¸å¤æ‚å’Œç¹é‡ï¼Œåº”å½“é€‰æ‹©ä¸“ç”¨çš„"å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—"ï¼Œå¦‚Celeryï¼Œå†é…åˆä¸€ä¸ª"æ¶ˆæ¯ä»£ç†"ï¼ˆï¼‰ï¼Œå¦‚RabbitMQã€‚<br />
Celeryï¼šç®¡ç†åˆ†é…ä»»åŠ¡åˆ°ä¸åŒçš„æœåŠ¡å™¨ï¼Œå¹¶å–å¾—ç»“æœã€‚ä¸ç®¡å’ŒæœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡ã€‚<br />
RabbitMQï¼šæ¶ˆæ¯ä»£ç†ï¼Œç”¨äºCeleryå’ŒæœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡ã€‚</p>
<p>1.æ¯”å¦‚æ”¶åˆ°çš„æ–‡ä»¶å¿…é¡»ç»è¿‡ä¸€ä¸ªç¼“æ…¢çš„è¿‡ç¨‹ï¼Œå¯ä»¥å…ˆè¿”å›ä¸€ä¸ª"Accepted"(HTTP
202)å“åº”ï¼Œå¹¶åœ¨åå°å¤„ç†è¿™ä¸ªä»»åŠ¡ã€‚<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> BackgroundTasks, FastAPI </span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ä¸€ä¸ªåå°ä»»åŠ¡å‡½æ•°ï¼Œå¯ä»¥æ˜¯asyncæˆ–éasyncï¼Œè¿™é‡Œå†™å…¥ä¸éœ€è¦asyncå’Œawaitï¼Œæ‰€ä»¥æ˜¯éasyncã€‚</span></span><br><span class="line"><span class="comment"># write_notificationæ¨¡æ‹Ÿå‘é€ç”µå­é‚®ä»¶ï¼Œåœ¨send_notificationçš„å“åº”è¿”å›åæ‰§è¡Œ</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write_notification</span>(<span class="params">email: <span class="built_in">str</span>, message=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;log.txt&quot;</span>, mode=<span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> email_file:</span><br><span class="line">        content = <span class="string">f&quot;notification for <span class="subst">&#123;email&#125;</span>: <span class="subst">&#123;message&#125;</span>&quot;</span></span><br><span class="line">        email_file.write(content)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/send-notification/&#123;email&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># ä½¿ç”¨ç±»å‹å£°æ˜ BackgroundTasksï¼ŒFastAPI ä¼šåˆ›å»ºä¸€ä¸ªè¯¥ç±»å‹çš„å¯¹è±¡å¹¶ä¼ ç»™æŒ‡å®šå‚æ•°ã€‚</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">send_notification</span>(<span class="params">email: <span class="built_in">str</span>, background_tasks: BackgroundTasks</span>):</span><br><span class="line">    <span class="comment"># æ·»åŠ åå°ä»»åŠ¡ï¼Œå‚æ•°æ˜¯&quot;åå°ä»»åŠ¡å‡½æ•°&quot;å’Œ&quot;ä»»åŠ¡å‡½æ•°çš„å¤šä¸ªå‚æ•°&quot;</span></span><br><span class="line">    background_tasks.add_task(write_notification, email, message=<span class="string">&quot;some notification&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Notification sent in the background&quot;</span>&#125;</span><br></pre></td></tr></table></figure></p>
<p>2.ä¾èµ–æ³¨å…¥ä¸­ä¹Ÿèƒ½ä½¿ç”¨BackgroundTasksï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> BackgroundTasks, Depends, FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write_log</span>(<span class="params">message: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;log.txt&quot;</span>, mode=<span class="string">&quot;a&quot;</span>) <span class="keyword">as</span> log:</span><br><span class="line">        log.write(message)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¾èµ–ä¸­ä½¿ç”¨BackgroundTasksï¼Œä¿¡æ¯ä¼šåœ¨å“åº”å‘å‡º ä¹‹å è¢«å†™åˆ° log.txt æ–‡ä»¶ã€‚</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_query</span>(<span class="params">background_tasks: BackgroundTasks, q: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">if</span> q:</span><br><span class="line">        message = <span class="string">f&quot;found query: <span class="subst">&#123;q&#125;</span>\n&quot;</span></span><br><span class="line">        background_tasks.add_task(write_log, message)</span><br><span class="line">    <span class="keyword">return</span> q</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/send-notification/&#123;email&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">send_notification</span>(<span class="params">email: <span class="built_in">str</span>, background_tasks: BackgroundTasks, q: <span class="built_in">str</span> = Depends(<span class="params">get_query</span>)</span>):</span><br><span class="line">    message = <span class="string">f&quot;message to <span class="subst">&#123;email&#125;</span>\n&quot;</span></span><br><span class="line">    background_tasks.add_task(write_log, message)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Message sent&quot;</span>&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="é™æ€æ–‡ä»¶">é™æ€æ–‡ä»¶</h1>
<p>å¯ä»¥ä½¿ç”¨ StaticFiles ä»ç›®å½•ä¸­è‡ªåŠ¨æä¾›é™æ€æ–‡ä»¶ã€‚</p>
<p>1.ä½¿ç”¨ StaticFiles
åˆ›å»ºä¸€ä¸ªé™æ€æ–‡ä»¶è·¯å¾„å®ä¾‹ï¼Œå¹¶æŒ‚è½½ï¼ˆMountï¼‰åˆ°appä¸Šï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> fastapi.staticfiles <span class="keyword">import</span> StaticFiles</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ª StaticFiles å®ä¾‹ï¼Œå¹¶æŒ‡å®šé™æ€æ–‡ä»¶ç›®å½•ä¸º &quot;static&quot;ï¼ŒæŒ‚è½½åˆ° &quot;/static&quot; è·¯å¾„ä¸‹</span></span><br><span class="line"><span class="comment"># name=&quot;static&quot; æ˜¯å¯é€‰çš„ï¼Œç”¨äºåœ¨ FastAPI åº”ç”¨ä¸­å¼•ç”¨è¿™ä¸ª StaticFiles å®ä¾‹</span></span><br><span class="line">app.mount(<span class="string">&quot;/static&quot;</span>, StaticFiles(directory=<span class="string">&quot;static&quot;</span>), name=<span class="string">&quot;static&quot;</span>)</span><br></pre></td></tr></table></figure></p>
<h1 id="æŒ‚è½½å­åº”ç”¨">æŒ‚è½½å­åº”ç”¨</h1>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line"><span class="comment"># é¡¶å±‚åº”ç”¨</span></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/app&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_main</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Hello World from main app&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># å­åº”ç”¨</span></span><br><span class="line">subapi = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@subapi.get(<span class="params"><span class="string">&quot;/sub&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_sub</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Hello World from sub API&quot;</span>&#125;</span><br><span class="line"><span class="comment"># æŒ‚è½½å­åº”ç”¨åˆ°/subapi</span></span><br><span class="line"><span class="comment"># é€šè¿‡/subapi/subè®¿é—®ä¸Šé¢get(&quot;/sub&quot;)çš„æ¥å£</span></span><br><span class="line">app.mount(<span class="string">&quot;/subapi&quot;</span>, subapi)</span><br></pre></td></tr></table></figure>
<h1 id="ç›´æ¥ä½¿ç”¨è¯·æ±‚">ç›´æ¥ä½¿ç”¨è¯·æ±‚</h1>
<p>1.æœ‰äº›æ—¶å€™éœ€è¦ç›´æ¥ä» Request
å¯¹è±¡æå–æ•°æ®ï¼Œæ¯”å¦‚è·å–å®¢æˆ·ç«¯IPå’Œç«¯å£ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Request</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_root</span>(<span class="params">item_id: <span class="built_in">str</span>, request: Request</span>):</span><br><span class="line">    client_host = request.client.host <span class="comment"># è·å–å®¢æˆ·ç«¯IP</span></span><br><span class="line">    client_port = request.client.port <span class="comment"># è™ä¸˜å®¢æˆ·ç«¯ç«¯å£</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;client_host&quot;</span>: client_host, <span class="string">&quot;item_id&quot;</span>: item_id, <span class="string">&quot;client_port&quot;</span>: client_port&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="æ¨¡æ¿å¼•æ“">æ¨¡æ¿å¼•æ“</h1>
<p>1.ä½¿ç”¨Jinja2æ¨¡æ¿å¼•æ“ï¼Œéœ€è¦å®‰è£…<code>pip install jinja2</code>ï¼Œå¯¼å…¥Jinja2Templatesï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Request</span><br><span class="line"><span class="keyword">from</span> fastapi.responses <span class="keyword">import</span> HTMLResponse</span><br><span class="line"><span class="keyword">from</span> fastapi.staticfiles <span class="keyword">import</span> StaticFiles</span><br><span class="line"><span class="keyword">from</span> fastapi.templating <span class="keyword">import</span> Jinja2Templates</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"><span class="comment"># åˆ›å»ºé™æ€æ–‡ä»¶æŒ‚è½½ç‚¹</span></span><br><span class="line">app.mount(<span class="string">&quot;/static&quot;</span>, StaticFiles(directory=<span class="string">&quot;static&quot;</span>), name=<span class="string">&quot;static&quot;</span>)</span><br><span class="line"><span class="comment"># åˆ›å»ºæ¨¡æ¿æ¸²æŸ“å™¨</span></span><br><span class="line">templates = Jinja2Templates(directory=<span class="string">&quot;templates&quot;</span>)</span><br><span class="line"><span class="comment"># å®šä¹‰ä¸€ä¸ªHTMLæ¨¡æ¿æ–‡ä»¶item.htmlï¼Œæ”¾åœ¨templatesç›®å½•ä¸‹</span></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&#123;id&#125;&quot;</span>, response_class=HTMLResponse</span>) </span><span class="comment"># response_classæŒ‡å®šåï¼ŒAPIæ–‡æ¡£èƒ½è¯†åˆ«å“åº”å¯¹è±¡æ˜¯HTML</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_item</span>(<span class="params">request: Request, <span class="built_in">id</span>: <span class="built_in">str</span></span>): <span class="comment"># åœ¨è¿”å›æ¨¡æ¿çš„è·¯å¾„æ“ä½œä¸­å£°æ˜ Request å‚æ•°</span></span><br><span class="line">    <span class="comment"># ä½¿ç”¨ templates æ¸²æŸ“å¹¶è¿”å› TemplateResponse</span></span><br><span class="line">    <span class="comment"># ä¼ é€’æ¨¡æ¿çš„åç§°ã€requestå¯¹è±¡ä»¥åŠä¸€ä¸ªåŒ…å«å¤šä¸ªé”®å€¼å¯¹ï¼ˆç”¨äºJinja2æ¨¡æ¿ï¼‰çš„&quot;context&quot;å­—å…¸ï¼Œ</span></span><br><span class="line">    <span class="keyword">return</span> templates.TemplateResponse(request=request, name=<span class="string">&quot;item.html&quot;</span>, context=&#123;<span class="string">&quot;id&quot;</span>: <span class="built_in">id</span>&#125;)</span><br></pre></td></tr></table></figure></p>
<p>ç¼–å†™æ¨¡æ¿ï¼š<br />
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Item Details<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- url_for()å‚æ•°å’Œè·¯å¾„å‡½æ•°çš„å‚æ•°ç›¸åŒ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;&#123;&#123; url_for(&#x27;static&#x27;, path=&#x27;/styles.css&#x27;) &#125;&#125;&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &#123;&#123; id &#125;&#125; ä¼šæ˜¾ç¤ºä»contextå­—å…¸ä¼ é€’çš„idå€¼ --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- url_for(&#x27;read_item&#x27;, id=id) ç”Ÿæˆread_item(id=id)å‡½æ•°urlç›¸åŒçš„è¿æ¥ï¼Œæ¯”å¦‚id=42æ—¶ï¼Œherf=&quot;/items/42&quot; --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&#123;&#123; url_for(&#x27;read_item&#x27;, id=id) &#125;&#125;&quot;</span>&gt;</span>Item ID: &#123;&#123; id &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h1 id="websocketsé€šä¿¡">WebSocketsé€šä¿¡</h1>
<p>éœ€è¦å®‰è£…<code>pip install websockets</code>ã€‚</p>
<p>1.ä½¿ç”¨ç°ä»£æ¡†æ¶ï¼ˆå¦‚Reactã€Vue.jsæˆ–Angularï¼‰åˆ›å»ºäº†ä¸€ä¸ªå‰ç«¯ï¼Œè¦ä½¿ç”¨
WebSockets ä¸åç«¯è¿›è¡Œé€šä¿¡ã€‚<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, WebSocket <span class="comment"># WebSocketé€šä¿¡</span></span><br><span class="line"><span class="keyword">from</span> fastapi.responses <span class="keyword">import</span> HTMLResponse</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line">html = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">    &lt;head&gt;</span></span><br><span class="line"><span class="string">        &lt;title&gt;Chat&lt;/title&gt;</span></span><br><span class="line"><span class="string">    &lt;/head&gt;</span></span><br><span class="line"><span class="string">    &lt;body&gt;</span></span><br><span class="line"><span class="string">        &lt;h1&gt;WebSocket Chat&lt;/h1&gt;</span></span><br><span class="line"><span class="string">        &lt;form action=&quot;&quot; onsubmit=&quot;sendMessage(event)&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;input type=&quot;text&quot; id=&quot;messageText&quot; autocomplete=&quot;off&quot;/&gt;</span></span><br><span class="line"><span class="string">            &lt;button&gt;Send&lt;/button&gt;</span></span><br><span class="line"><span class="string">        &lt;/form&gt;</span></span><br><span class="line"><span class="string">        # åˆ›å»ºä¸€ä¸ªmessagesåˆ—è¡¨</span></span><br><span class="line"><span class="string">        &lt;ul id=&#x27;messages&#x27;&gt;</span></span><br><span class="line"><span class="string">        &lt;/ul&gt;</span></span><br><span class="line"><span class="string">        &lt;script&gt;</span></span><br><span class="line"><span class="string">            var ws = new WebSocket(&quot;ws://localhost:8000/ws&quot;);</span></span><br><span class="line"><span class="string">            # æ¥æ”¶åç«¯è¿”å›çš„æ•°æ®ï¼Œæ”¾å…¥messagesåˆ—è¡¨</span></span><br><span class="line"><span class="string">            ws.onmessage = function(event) &#123;</span></span><br><span class="line"><span class="string">                var messages = document.getElementById(&#x27;messages&#x27;)</span></span><br><span class="line"><span class="string">                var message = document.createElement(&#x27;li&#x27;)</span></span><br><span class="line"><span class="string">                var content = document.createTextNode(event.data)</span></span><br><span class="line"><span class="string">                message.appendChild(content)</span></span><br><span class="line"><span class="string">                messages.appendChild(message)</span></span><br><span class="line"><span class="string">            &#125;;</span></span><br><span class="line"><span class="string">            # å‘é€æ•°æ®</span></span><br><span class="line"><span class="string">            function sendMessage(event) &#123;</span></span><br><span class="line"><span class="string">                var input = document.getElementById(&quot;messageText&quot;)</span></span><br><span class="line"><span class="string">                ws.send(input.value)</span></span><br><span class="line"><span class="string">                input.value = &#x27;&#x27;</span></span><br><span class="line"><span class="string">                event.preventDefault()</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">    &lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get</span>():</span><br><span class="line">    <span class="keyword">return</span> HTMLResponse(html)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ª websocket</span></span><br><span class="line"><span class="meta">@app.websocket(<span class="params"><span class="string">&quot;/ws&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">websocket_endpoint</span>(<span class="params">websocket: WebSocket</span>):</span><br><span class="line">    <span class="keyword">await</span> websocket.accept() <span class="comment"># ç­‰å¾…æ¶ˆæ¯</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data = <span class="keyword">await</span> websocket.receive_text() <span class="comment"># æ¥æ”¶æ¶ˆæ¯</span></span><br><span class="line">        <span class="comment"># å¯ä»¥æ¥æ”¶å’Œå‘é€äºŒè¿›åˆ¶ã€æ–‡æœ¬å’Œ JSON æ•°æ®</span></span><br><span class="line">        <span class="keyword">await</span> websocket.send_text(<span class="string">f&quot;Message text was: <span class="subst">&#123;data&#125;</span>&quot;</span>) <span class="comment"># å‘é€æ¶ˆæ¯</span></span><br></pre></td></tr></table></figure></p>
<p>2.WebSocketsæ”¯æŒä½¿ç”¨ä¾èµ–é¡¹ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Cookie, Depends, FastAPI, Query, WebSocket, WebSocketException, status</span><br><span class="line"><span class="keyword">from</span> fastapi.responses <span class="keyword">import</span> HTMLResponse</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line">html = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">    &lt;head&gt;</span></span><br><span class="line"><span class="string">        &lt;title&gt;Chat&lt;/title&gt;</span></span><br><span class="line"><span class="string">    &lt;/head&gt;</span></span><br><span class="line"><span class="string">    &lt;body&gt;</span></span><br><span class="line"><span class="string">        &lt;h1&gt;WebSocket Chat&lt;/h1&gt;</span></span><br><span class="line"><span class="string">        &lt;form action=&quot;&quot; onsubmit=&quot;sendMessage(event)&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;label&gt;Item ID: &lt;input type=&quot;text&quot; id=&quot;itemId&quot; autocomplete=&quot;off&quot; value=&quot;foo&quot;/&gt;&lt;/label&gt;</span></span><br><span class="line"><span class="string">            &lt;label&gt;Token: &lt;input type=&quot;text&quot; id=&quot;token&quot; autocomplete=&quot;off&quot; value=&quot;some-key-token&quot;/&gt;&lt;/label&gt;</span></span><br><span class="line"><span class="string">            &lt;button onclick=&quot;connect(event)&quot;&gt;Connect&lt;/button&gt;</span></span><br><span class="line"><span class="string">            &lt;hr&gt;</span></span><br><span class="line"><span class="string">            &lt;label&gt;Message: &lt;input type=&quot;text&quot; id=&quot;messageText&quot; autocomplete=&quot;off&quot;/&gt;&lt;/label&gt;</span></span><br><span class="line"><span class="string">            &lt;button&gt;Send&lt;/button&gt;</span></span><br><span class="line"><span class="string">        &lt;/form&gt;</span></span><br><span class="line"><span class="string">        &lt;ul id=&#x27;messages&#x27;&gt;</span></span><br><span class="line"><span class="string">        &lt;/ul&gt;</span></span><br><span class="line"><span class="string">        &lt;script&gt;</span></span><br><span class="line"><span class="string">        var ws = null;</span></span><br><span class="line"><span class="string">            function connect(event) &#123;</span></span><br><span class="line"><span class="string">                var itemId = document.getElementById(&quot;itemId&quot;)</span></span><br><span class="line"><span class="string">                var token = document.getElementById(&quot;token&quot;)</span></span><br><span class="line"><span class="string">                ws = new WebSocket(&quot;ws://localhost:8000/items/&quot; + itemId.value + &quot;/ws?token=&quot; + token.value);</span></span><br><span class="line"><span class="string">                ws.onmessage = function(event) &#123;</span></span><br><span class="line"><span class="string">                    var messages = document.getElementById(&#x27;messages&#x27;)</span></span><br><span class="line"><span class="string">                    var message = document.createElement(&#x27;li&#x27;)</span></span><br><span class="line"><span class="string">                    var content = document.createTextNode(event.data)</span></span><br><span class="line"><span class="string">                    message.appendChild(content)</span></span><br><span class="line"><span class="string">                    messages.appendChild(message)</span></span><br><span class="line"><span class="string">                &#125;;</span></span><br><span class="line"><span class="string">                event.preventDefault()</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            function sendMessage(event) &#123;</span></span><br><span class="line"><span class="string">                var input = document.getElementById(&quot;messageText&quot;)</span></span><br><span class="line"><span class="string">                ws.send(input.value)</span></span><br><span class="line"><span class="string">                input.value = &#x27;&#x27;</span></span><br><span class="line"><span class="string">                event.preventDefault()</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">    &lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get</span>():</span><br><span class="line">    <span class="keyword">return</span> HTMLResponse(html)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å­ä¾èµ–</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_cookie_or_token</span>(<span class="params"></span></span><br><span class="line"><span class="params">    websocket: WebSocket,  <span class="comment"># ä¹Ÿæ¥æ”¶websocket</span></span></span><br><span class="line"><span class="params">    session: <span class="built_in">str</span> | <span class="literal">None</span> = Cookie(<span class="params">default=<span class="literal">None</span></span>),</span></span><br><span class="line"><span class="params">    token: <span class="built_in">str</span> | <span class="literal">None</span> = Query(<span class="params">default=<span class="literal">None</span></span>),</span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    <span class="keyword">if</span> session <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">and</span> token <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> WebSocketException(code=status.WS_1008_POLICY_VIOLATION)</span><br><span class="line">    <span class="keyword">return</span> session <span class="keyword">or</span> token</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.websocket(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;/ws&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">websocket_endpoint</span>(<span class="params"></span></span><br><span class="line"><span class="params">    websocket: WebSocket,</span></span><br><span class="line"><span class="params">    item_id: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">    q: <span class="built_in">int</span> | <span class="literal">None</span> = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    cookie_or_token: <span class="built_in">str</span> = Depends(<span class="params">get_cookie_or_token</span>),  <span class="comment"># åœ¨websocketä¸­ä½¿ç”¨ä¾èµ–</span></span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    <span class="keyword">await</span> websocket.accept()</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data = <span class="keyword">await</span> websocket.receive_text()</span><br><span class="line">        <span class="keyword">await</span> websocket.send_text(<span class="string">f&quot;Session cookie or query token value is: <span class="subst">&#123;cookie_or_token&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> q <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">await</span> websocket.send_text(<span class="string">f&quot;Query parameter q is: <span class="subst">&#123;q&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">await</span> websocket.send_text(<span class="string">f&quot;Message text was: <span class="subst">&#123;data&#125;</span>, for item ID: <span class="subst">&#123;item_id&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure></p>
<p>3.WebSocketså¤„ç†è¿æ¥å…³é—­ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, WebSocket, WebSocketDisconnect</span><br><span class="line"><span class="keyword">from</span> fastapi.responses <span class="keyword">import</span> HTMLResponse</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line">html = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">    &lt;head&gt;</span></span><br><span class="line"><span class="string">        &lt;title&gt;Chat&lt;/title&gt;</span></span><br><span class="line"><span class="string">    &lt;/head&gt;</span></span><br><span class="line"><span class="string">    &lt;body&gt;</span></span><br><span class="line"><span class="string">        &lt;h1&gt;WebSocket Chat&lt;/h1&gt;</span></span><br><span class="line"><span class="string">        &lt;h2&gt;Your ID: &lt;span id=&quot;ws-id&quot;&gt;&lt;/span&gt;&lt;/h2&gt;</span></span><br><span class="line"><span class="string">        &lt;form action=&quot;&quot; onsubmit=&quot;sendMessage(event)&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;input type=&quot;text&quot; id=&quot;messageText&quot; autocomplete=&quot;off&quot;/&gt;</span></span><br><span class="line"><span class="string">            &lt;button&gt;Send&lt;/button&gt;</span></span><br><span class="line"><span class="string">        &lt;/form&gt;</span></span><br><span class="line"><span class="string">        &lt;ul id=&#x27;messages&#x27;&gt;</span></span><br><span class="line"><span class="string">        &lt;/ul&gt;</span></span><br><span class="line"><span class="string">        &lt;script&gt;</span></span><br><span class="line"><span class="string">            var client_id = Date.now()</span></span><br><span class="line"><span class="string">            document.querySelector(&quot;#ws-id&quot;).textContent = client_id;</span></span><br><span class="line"><span class="string">            var ws = new WebSocket(`ws://localhost:8000/ws/$&#123;client_id&#125;`);</span></span><br><span class="line"><span class="string">            ws.onmessage = function(event) &#123;</span></span><br><span class="line"><span class="string">                var messages = document.getElementById(&#x27;messages&#x27;)</span></span><br><span class="line"><span class="string">                var message = document.createElement(&#x27;li&#x27;)</span></span><br><span class="line"><span class="string">                var content = document.createTextNode(event.data)</span></span><br><span class="line"><span class="string">                message.appendChild(content)</span></span><br><span class="line"><span class="string">                messages.appendChild(message)</span></span><br><span class="line"><span class="string">            &#125;;</span></span><br><span class="line"><span class="string">            function sendMessage(event) &#123;</span></span><br><span class="line"><span class="string">                var input = document.getElementById(&quot;messageText&quot;)</span></span><br><span class="line"><span class="string">                ws.send(input.value)</span></span><br><span class="line"><span class="string">                input.value = &#x27;&#x27;</span></span><br><span class="line"><span class="string">                event.preventDefault()</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">    &lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿æ¥ç®¡ç†</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ConnectionManager</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.active_connections: <span class="built_in">list</span>[WebSocket] = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">connect</span>(<span class="params">self, websocket: WebSocket</span>):</span><br><span class="line">        <span class="keyword">await</span> websocket.accept()</span><br><span class="line">        self.active_connections.append(websocket)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">disconnect</span>(<span class="params">self, websocket: WebSocket</span>):</span><br><span class="line">        self.active_connections.remove(websocket)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">send_personal_message</span>(<span class="params">self, message: <span class="built_in">str</span>, websocket: WebSocket</span>):</span><br><span class="line">        <span class="keyword">await</span> websocket.send_text(message)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">broadcast</span>(<span class="params">self, message: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="keyword">for</span> connection <span class="keyword">in</span> self.active_connections:</span><br><span class="line">            <span class="keyword">await</span> connection.send_text(message)</span><br><span class="line"></span><br><span class="line">manager = ConnectionManager()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get</span>():</span><br><span class="line">    <span class="keyword">return</span> HTMLResponse(html)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.websocket(<span class="params"><span class="string">&quot;/ws/&#123;client_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">websocket_endpoint</span>(<span class="params">websocket: WebSocket, client_id: <span class="built_in">int</span></span>):</span><br><span class="line">    <span class="keyword">await</span> manager.connect(websocket)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            data = <span class="keyword">await</span> websocket.receive_text()</span><br><span class="line">            <span class="keyword">await</span> manager.send_personal_message(<span class="string">f&quot;You wrote: <span class="subst">&#123;data&#125;</span>&quot;</span>, websocket)</span><br><span class="line">            <span class="keyword">await</span> manager.broadcast(<span class="string">f&quot;Client #<span class="subst">&#123;client_id&#125;</span> says: <span class="subst">&#123;data&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> WebSocketDisconnect: <span class="comment"># è¿æ¥æ–­å¼€çš„è¯ï¼Œå¹¿æ’­æŠ¥é”™</span></span><br><span class="line">        manager.disconnect(websocket)</span><br><span class="line">        <span class="keyword">await</span> manager.broadcast(<span class="string">f&quot;Client #<span class="subst">&#123;client_id&#125;</span> left the chat&quot;</span>)</span><br></pre></td></tr></table></figure></p>
<h1 id="åº”ç”¨å¯åŠ¨å…³é—­äº‹ä»¶">åº”ç”¨å¯åŠ¨å…³é—­äº‹ä»¶</h1>
<p>Fastapi 0.115.0ç‰ˆæœ¬ä»¥åï¼Œä½¿ç”¨Lifespan
Eventsæ¥å¤„ç†åº”ç”¨å¯åŠ¨å‰åäº‹ä»¶ã€‚<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> contextlib <span class="keyword">import</span> asynccontextmanager  <span class="comment"># å¼•å…¥ä¸Šä¸‹æ–‡ç®¡ç†</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fake_answer_to_everything_ml_model</span>(<span class="params">x: <span class="built_in">float</span></span>):</span><br><span class="line">    <span class="keyword">return</span> x * <span class="number">42</span></span><br><span class="line"></span><br><span class="line">ml_models = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@asynccontextmanager</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">lifespan</span>(<span class="params">app: FastAPI</span>):</span><br><span class="line">    <span class="comment"># Load the ML modelï¼Œåº”ç”¨å¯åŠ¨å‰æ‰§è¡Œ</span></span><br><span class="line">    ml_models[<span class="string">&quot;answer_to_everything&quot;</span>] = fake_answer_to_everything_ml_model</span><br><span class="line">    <span class="keyword">yield</span></span><br><span class="line">    <span class="comment"># Clean up the ML models and release the resourcesï¼Œåº”ç”¨å…³é—­å‰æ‰§è¡Œ</span></span><br><span class="line">    ml_models.clear()</span><br><span class="line"></span><br><span class="line">app = FastAPI(lifespan=lifespan)  <span class="comment"># æŒ‡å®šåº”ç”¨lifespan</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/predict&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">predict</span>(<span class="params">x: <span class="built_in">float</span></span>):</span><br><span class="line">    result = ml_models[<span class="string">&quot;answer_to_everything&quot;</span>](x)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;result&quot;</span>: result&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="æ¥å£æµ‹è¯•">æ¥å£æµ‹è¯•</h1>
<p>å¤šä¸ªæ¥å£å¯é€šè¿‡pythonä»£ç ç»Ÿä¸€è¿›è¡Œæµ‹è¯•ï¼Œéœ€è¦å®‰è£…ä¸¤ä¸ªæ’ä»¶<code>pip install httpx</code>å’Œ<code>pip install pytest</code>ã€‚</p>
<p>1.åˆ›å»ºä¸€ä¸ªæµ‹è¯•æ–‡ä»¶test_main.pyï¼Œå¯¹å¤šä¸ªæ¥å£è¿›è¡Œæµ‹è¯•ï¼Œè¿è¡Œtest_main.pyå³å¯ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi.testclient <span class="keyword">import</span> TestClient</span><br><span class="line"><span class="keyword">from</span> .main <span class="keyword">import</span> app</span><br><span class="line"></span><br><span class="line">client = TestClient(app) <span class="comment"># åˆ›å»ºä¸€ä¸ªæµ‹è¯•å®ä¾‹</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pytestçº¦å®šåå­—ä»¥ test_ å¼€å¤´çš„å‡½æ•°</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_read_item</span>():</span><br><span class="line">    <span class="comment"># æµ‹è¯•get</span></span><br><span class="line">    response = client.get(<span class="string">&quot;/items/foo&quot;</span>, headers=&#123;<span class="string">&quot;X-Token&quot;</span>: <span class="string">&quot;coneofsilence&quot;</span>&#125;)</span><br><span class="line">    <span class="keyword">assert</span> response.status_code == <span class="number">200</span></span><br><span class="line">    <span class="keyword">assert</span> response.json() == &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="string">&quot;foo&quot;</span>,</span><br><span class="line">        <span class="string">&quot;title&quot;</span>: <span class="string">&quot;Foo&quot;</span>,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;There goes my hero&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_read_item_bad_token</span>():</span><br><span class="line">    response = client.get(<span class="string">&quot;/items/foo&quot;</span>, headers=&#123;<span class="string">&quot;X-Token&quot;</span>: <span class="string">&quot;hailhydra&quot;</span>&#125;)</span><br><span class="line">    <span class="keyword">assert</span> response.status_code == <span class="number">400</span></span><br><span class="line">    <span class="keyword">assert</span> response.json() == &#123;<span class="string">&quot;detail&quot;</span>: <span class="string">&quot;Invalid X-Token header&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_read_nonexistent_item</span>():</span><br><span class="line">    response = client.get(<span class="string">&quot;/items/baz&quot;</span>, headers=&#123;<span class="string">&quot;X-Token&quot;</span>: <span class="string">&quot;coneofsilence&quot;</span>&#125;)</span><br><span class="line">    <span class="keyword">assert</span> response.status_code == <span class="number">404</span></span><br><span class="line">    <span class="keyword">assert</span> response.json() == &#123;<span class="string">&quot;detail&quot;</span>: <span class="string">&quot;Item not found&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_create_item</span>():</span><br><span class="line">    <span class="comment"># æµ‹è¯•post</span></span><br><span class="line">    response = client.post(</span><br><span class="line">        <span class="string">&quot;/items/&quot;</span>,</span><br><span class="line">        headers=&#123;<span class="string">&quot;X-Token&quot;</span>: <span class="string">&quot;coneofsilence&quot;</span>&#125;,</span><br><span class="line">        json=&#123;<span class="string">&quot;id&quot;</span>: <span class="string">&quot;foobar&quot;</span>, <span class="string">&quot;title&quot;</span>: <span class="string">&quot;Foo Bar&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;The Foo Barters&quot;</span>&#125;,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">assert</span> response.status_code == <span class="number">200</span></span><br><span class="line">    <span class="keyword">assert</span> response.json() == &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="string">&quot;foobar&quot;</span>,</span><br><span class="line">        <span class="string">&quot;title&quot;</span>: <span class="string">&quot;Foo Bar&quot;</span>,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;The Foo Barters&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_create_item_bad_token</span>():</span><br><span class="line">    response = client.post(</span><br><span class="line">        <span class="string">&quot;/items/&quot;</span>,</span><br><span class="line">        headers=&#123;<span class="string">&quot;X-Token&quot;</span>: <span class="string">&quot;hailhydra&quot;</span>&#125;,</span><br><span class="line">        json=&#123;<span class="string">&quot;id&quot;</span>: <span class="string">&quot;bazz&quot;</span>, <span class="string">&quot;title&quot;</span>: <span class="string">&quot;Bazz&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Drop the bazz&quot;</span>&#125;,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">assert</span> response.status_code == <span class="number">400</span></span><br><span class="line">    <span class="keyword">assert</span> response.json() == &#123;<span class="string">&quot;detail&quot;</span>: <span class="string">&quot;Invalid X-Token header&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_create_existing_item</span>():</span><br><span class="line">    response = client.post(</span><br><span class="line">        <span class="string">&quot;/items/&quot;</span>,</span><br><span class="line">        headers=&#123;<span class="string">&quot;X-Token&quot;</span>: <span class="string">&quot;coneofsilence&quot;</span>&#125;,</span><br><span class="line">        json=&#123;</span><br><span class="line">            <span class="string">&quot;id&quot;</span>: <span class="string">&quot;foo&quot;</span>,</span><br><span class="line">            <span class="string">&quot;title&quot;</span>: <span class="string">&quot;The Foo ID Stealers&quot;</span>,</span><br><span class="line">            <span class="string">&quot;description&quot;</span>: <span class="string">&quot;There goes my stealer&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">assert</span> response.status_code == <span class="number">409</span></span><br><span class="line">    <span class="keyword">assert</span> response.json() == &#123;<span class="string">&quot;detail&quot;</span>: <span class="string">&quot;Item already exists&quot;</span>&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h1>
<p><span class="exturl" data-url="aHR0cHM6Ly9mYXN0YXBpLnRpYW5nb2xvLmNvbS8=">fastapiå®˜æ–¹æ–‡æ¡£<i class="fa fa-external-link-alt"></i></span><br />
<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLnB5ZGFudGljLmRldi9sYXRlc3Qv">Pydanticå®˜ç½‘<i class="fa fa-external-link-alt"></i></span></p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>æœ¬æ–‡ä½œè€…ï¼š </strong>SoundMemories
  </li>
  <li class="post-copyright-link">
      <strong>æœ¬æ–‡é“¾æ¥ï¼š</strong>
      <a href="https://soundmemories.github.io/2024/10/09/Python/23.FastAPI/" title="FastAPI">https://soundmemories.github.io/2024/10/09/Python/23.FastAPI/</a>
  </li>
  <li class="post-copyright-license">
      <strong>ç‰ˆæƒå£°æ˜ï¼š </strong>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC8="><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</span> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/Python/" rel="tag"><i class="fa fa-tag"></i> Python</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/07/18/Paper/04.Retrieval-Augmented%20Generation%20Survey/" rel="prev" title="Retrieval-Augmented Generation Survey">
                  <i class="fa fa-chevron-left"></i> Retrieval-Augmented Generation Survey
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2024/11/05/Python/24.Django5+Vue3%E4%BE%8B%E5%AD%90/" rel="next" title="Django5+Vue3ä¾‹å­">
                  Django5+Vue3ä¾‹å­ <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2019 â€“ 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">SoundMemories</span>
  </div>
  <div class="powered-by">ç”± <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl" data-url="aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZy9tdXNlLw==">NexT.Muse</span> å¼ºåŠ›é©±åŠ¨
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="è¿”å›é¡¶éƒ¨">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js" integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.8/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script src="/js/pjax.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>

  <script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.2.12/pdfobject.min.js","integrity":"sha256-g2xji1rlE3KsGVClvuxTbcR0Kn2+wtQADSff2Tbb4zA="},"url":"/lib/pdf/web/viewer.html"}</script>
  <script src="/js/third-party/tags/pdf.js"></script>

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"neutral","dark":"neutral"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.2.3/mermaid.min.js","integrity":"sha256-JFptYy4KzJ5OQP+Q9fubNf3cxpPPmZKqUOovyEONKrQ="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>


  <script src="/js/third-party/fancybox.js"></script>



  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/2.3.0/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"url":"https://soundmemories.github.io/2024/10/09/Python/23.FastAPI/"}</script>
  <script src="/js/third-party/quicklink.js"></script>

</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Monda:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"soundmemories.github.io","root":"/","images":"/images","scheme":"Muse","version":"8.0.2","exturl":true,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>

  <meta name="description" content="特殊属性魔术方法：指被 __ 全包裹的方法，比如__init__。 基础篇讲的特殊属性，这些都是魔术方法：|方法 |意义||:—:|:———||__name__|类、函数、方法等的名字。||__module__|类定义所在的模块名。||__class__|对象或者类所属的类。||__bases__|类的基类的元组，顺序为它们在基类列表中出现的顺序。||__doc__|类、函数的文档字符串，如果没有">
<meta property="og:type" content="article">
<meta property="og:title" content="Python-面向对象-进阶">
<meta property="og:url" content="https://soundmemories.github.io/2019/01/31/Python/14.Python-%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%BF%9B%E9%98%B6/index.html">
<meta property="og:site_name" content="SoundMemories">
<meta property="og:description" content="特殊属性魔术方法：指被 __ 全包裹的方法，比如__init__。 基础篇讲的特殊属性，这些都是魔术方法：|方法 |意义||:—:|:———||__name__|类、函数、方法等的名字。||__module__|类定义所在的模块名。||__class__|对象或者类所属的类。||__bases__|类的基类的元组，顺序为它们在基类列表中出现的顺序。||__doc__|类、函数的文档字符串，如果没有">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2019-01-30T16:00:00.000Z">
<meta property="article:modified_time" content="2021-02-07T05:52:25.037Z">
<meta property="article:author" content="SoundMemories">
<meta property="article:tag" content="Python">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://soundmemories.github.io/2019/01/31/Python/14.Python-%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%BF%9B%E9%98%B6/">


<script data-pjax class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Python-面向对象-进阶 | SoundMemories</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">SoundMemories</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-主页">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>主页</a>

  </li>
        <li class="menu-item menu-item-分类">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-标签">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-归档">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>
	   
		  
      <div class="sidebar-panel-container">
        <!--noindex-->
        <section class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%B9%E6%AE%8A%E5%B1%9E%E6%80%A7"><span class="nav-number">1.</span> <span class="nav-text">特殊属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%B1%9E%E6%80%A7"><span class="nav-number">2.</span> <span class="nav-text">查看属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95"><span class="nav-number">3.</span> <span class="nav-text">魔术方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E3%80%81%E5%88%9D%E5%A7%8B%E5%8C%96%E3%80%81%E9%94%80%E6%AF%81"><span class="nav-number">3.1.</span> <span class="nav-text">创建、初始化、销毁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%93%88%E5%B8%8C"><span class="nav-number">3.2.</span> <span class="nav-text">哈希</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%83%E5%B0%94"><span class="nav-number">3.3.</span> <span class="nav-text">布尔</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%AF%E8%A7%86%E5%8C%96"><span class="nav-number">3.4.</span> <span class="nav-text">可视化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%90%E7%AE%97%E7%AC%A6%E9%87%8D%E8%BD%BD"><span class="nav-number">3.5.</span> <span class="nav-text">运算符重载</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%B9%E5%99%A8%E7%9B%B8%E5%85%B3%E6%96%B9%E6%B3%95"><span class="nav-number">3.6.</span> <span class="nav-text">容器相关方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%AF%E8%B0%83%E7%94%A8%E5%AF%B9%E8%B1%A1"><span class="nav-number">3.7.</span> <span class="nav-text">可调用对象</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%8A%E4%B8%8B%E6%96%87%E7%AE%A1%E7%90%86"><span class="nav-number">3.8.</span> <span class="nav-text">上下文管理</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%8A%E4%B8%8B%E6%96%87%E7%AE%A1%E7%90%86%E7%9A%84%E5%AE%89%E5%85%A8%E6%80%A7"><span class="nav-number">3.8.1.</span> <span class="nav-text">上下文管理的安全性</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#with%E8%AF%AD%E5%8F%A5"><span class="nav-number">3.8.2.</span> <span class="nav-text">with语句</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E7%9A%84%E5%8F%82%E6%95%B0"><span class="nav-number">3.8.3.</span> <span class="nav-text">方法的参数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BB%83%E4%B9%A0"><span class="nav-number">3.8.4.</span> <span class="nav-text">练习</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%8A%E4%B8%8B%E6%96%87%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">3.8.5.</span> <span class="nav-text">上下文应用场景</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#contextlib-contextmanager"><span class="nav-number">3.8.6.</span> <span class="nav-text">contextlib.contextmanager</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%8D%E5%B0%84"><span class="nav-number">3.9.</span> <span class="nav-text">反射</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8F%8D%E5%B0%84%E7%9B%B8%E5%85%B3%E7%9A%84%E5%87%BD%E6%95%B0%E5%92%8C%E6%96%B9%E6%B3%95"><span class="nav-number">3.9.1.</span> <span class="nav-text">反射相关的函数和方法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8F%8D%E5%B0%84%E7%9B%B8%E5%85%B3%E7%9A%84%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95"><span class="nav-number">3.9.2.</span> <span class="nav-text">反射相关的魔术方法</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%8F%E8%BF%B0%E5%99%A8"><span class="nav-number">3.10.</span> <span class="nav-text">描述器</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8F%8F%E8%BF%B0%E5%99%A8%E7%9A%84%E5%88%86%E7%B1%BB"><span class="nav-number">3.10.1.</span> <span class="nav-text">描述器的分类</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%B1%9E%E6%80%A7%E7%9A%84%E8%AE%BF%E9%97%AE%E9%A1%BA%E5%BA%8F"><span class="nav-number">3.10.2.</span> <span class="nav-text">属性的访问顺序</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Python%E4%B8%AD%E7%9A%84%E6%8F%8F%E8%BF%B0%E5%99%A8"><span class="nav-number">3.10.3.</span> <span class="nav-text">Python中的描述器</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BB%83%E4%B9%A0-1"><span class="nav-number">3.10.4.</span> <span class="nav-text">练习</span></a></li></ol></li></ol></li></ol></div>
        </section>
        <!--/noindex-->

        <section class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="SoundMemories"
      src="https://i.loli.net/2020/11/04/6JhNuwtBe4adylS.png">
  <p class="site-author-name" itemprop="name">SoundMemories</p>
  <div class="site-description" itemprop="description">今日事，今日毕</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">119</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3NvdW5kbWVtb3JpZXM=" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;soundmemories"><i class="fab fa-github fa-fw"></i>GitHub</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="bWFpbHRvOnNvdW5kbWVtb3JpZXNAMTYzLmNvbQ==" title="E-Mail → mailto:soundmemories@163.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</span>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC8="><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></span>
  </div>



        </section>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">
      

      

  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://soundmemories.github.io/2019/01/31/Python/14.Python-%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%BF%9B%E9%98%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://i.loli.net/2020/11/04/6JhNuwtBe4adylS.png">
      <meta itemprop="name" content="SoundMemories">
      <meta itemprop="description" content="今日事，今日毕">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SoundMemories">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Python-面向对象-进阶
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-01-31 00:00:00" itemprop="dateCreated datePublished" datetime="2019-01-31T00:00:00+08:00">2019-01-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>60k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>55 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h3 id="特殊属性"><a href="#特殊属性" class="headerlink" title="特殊属性"></a>特殊属性</h3><p>魔术方法：指被 <code>__</code> 全包裹的方法，比如<code>__init__</code>。</p>
<p>基础篇讲的特殊属性，这些都是魔术方法：<br>|方法 |意义|<br>|:—:|:———|<br>|<code>__name__</code>|类、函数、方法等的名字。|<br>|<code>__module__</code>|类定义所在的模块名。|<br>|<code>__class__</code>|对象或者类所属的类。|<br>|<code>__bases__</code>|类的基类的元组，顺序为它们在基类列表中出现的顺序。|<br>|<code>__doc__</code>|类、函数的文档字符串，如果没有定义则为None。|<br>|<code>__mro__</code>|类的mro，class.mor()返回的结果保存在<code>__mro__</code>中。|<br>|<code>__dict__</code>|类或实例的属性，可写的字典。|<br><a id="more"></a></p>
<h3 id="查看属性"><a href="#查看属性" class="headerlink" title="查看属性"></a>查看属性</h3><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">方法</th>
<th style="text-align:left">意义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>__dir__</code></td>
<td style="text-align:left">返回类或者对象的所有成员<code>名称列表</code>。</td>
</tr>
</tbody>
</table>
</div>
<p><code>dir()</code>：<code>dir(对象)</code>，就是调用对象的<code>__dir__()</code>。<br>如果<code>dir([obj])</code>参数obj有方法<code>__dir__()</code>，该方法将被调用，如果参数obj没有<code>__dir__()</code>，则dir将最大限度收集属性信息。</p>
<p><code>dir(obj)</code>对于不同类型的对象obj具有不同的行为：    </p>
<ul>
<li><p>如果obj是模块，返回的名列表包含模块的属性、变量名。</p>
</li>
<li><p>如果对象是类型、类，返回的列表包含类的属性名、它的祖先类的属性名。</p>
</li>
<li><p>如果是实例（<code>__dir__</code>与<code>self</code>有关）：  </p>
<ul>
<li>有<strong>dir</strong>方法，返回可迭代对象的返回值。</li>
<li>没有<strong>dir</strong>方法，则尽可能收集实例的属性名、类的属性、祖先类的属性名。</li>
</ul>
</li>
<li><p>如果obj不写，返回列表包含内容不同（与作用域有关）：</p>
<ul>
<li>在模块中，返回模块的属性、变量名。</li>
<li>在函数中，返回本地作用域的变量名。</li>
<li>在方法中，返回本地作用域的变量名。</li>
</ul>
</li>
</ul>
<p>看下面实例：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># animal.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span>:</span></span><br><span class="line">    x = <span class="number">123</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name</span>):</span></span><br><span class="line">        self._name = name</span><br><span class="line">        self.__age = <span class="number">10</span></span><br><span class="line">        self.weight = <span class="number">20</span></span><br><span class="line">print(<span class="string">&quot;animal Module\&#x27;s names = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">dir</span>())) <span class="comment"># 模块的属性</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># animal Module&#x27;s names = [&#x27;Animal&#x27;, &#x27;__annotations__&#x27;, &#x27;__builtins__&#x27;, &#x27;__cached__&#x27;, &#x27;__doc__&#x27;, &#x27;__file__&#x27;, &#x27;__loader__&#x27;, &#x27;__name__&#x27;, &#x27;__package__&#x27;, &#x27;__spec__&#x27;]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cat.py</span></span><br><span class="line"><span class="keyword">import</span> animal</span><br><span class="line"><span class="keyword">from</span> animal <span class="keyword">import</span> Animal</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cat</span>(<span class="params">Animal</span>):</span></span><br><span class="line">    x = <span class="string">&#x27;xxx&#x27;</span></span><br><span class="line">    y = <span class="string">&#x27;yyy&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span>(<span class="params">Animal</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__dir__</span>(<span class="params">self</span>):</span> <span class="comment"># 这个dir与实例有关</span></span><br><span class="line">        <span class="keyword">return</span> [<span class="string">&#x27;dog&#x27;</span>] <span class="comment"># 必须返回可迭代对象</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># obj是模块</span></span><br><span class="line"><span class="comment"># 前面输出的是animal.py的print</span></span><br><span class="line">print(<span class="string">&#x27;animal Module\&#x27;s names = &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">dir</span>(animal))) <span class="comment"># 指定，指定模块名词空间内的属性</span></span><br><span class="line">print(<span class="string">&#x27;Current Module\&#x27;s names = &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">dir</span>())) <span class="comment"># 不指定，当前模块名词空间内的属性（现在dir作用域是模块）</span></span><br><span class="line"><span class="comment"># obj是类型、类对象</span></span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">30</span>)</span><br><span class="line">print(<span class="string">&quot;object&#x27;s __dict__ = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">sorted</span>(<span class="built_in">object</span>.__dict__.keys()))) <span class="comment"># object的字典</span></span><br><span class="line">print(<span class="string">&quot;Animal&#x27;s dir() = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">dir</span>(Animal))) <span class="comment"># 类Animal的dir()</span></span><br><span class="line">print(<span class="string">&quot;Cat&#x27;s dir() = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">dir</span>(Cat))) <span class="comment"># 类Cat的dir()</span></span><br><span class="line">print(<span class="string">&quot;Dog&#x27;s dir = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">dir</span>(Dog))) <span class="comment"># 类Dog的dir()</span></span><br><span class="line"><span class="comment"># obj是实例</span></span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">30</span>)</span><br><span class="line">tom = Cat(<span class="string">&#x27;Tom&#x27;</span>)</span><br><span class="line">print(<span class="built_in">sorted</span>(<span class="built_in">dir</span>(tom))) <span class="comment"># 没有__dir__方法，实例tom的属性、Cat类及所有祖先类的类属性的集合体</span></span><br><span class="line">print(<span class="built_in">sorted</span>(tom.__dir__())) <span class="comment"># 同上</span></span><br><span class="line"><span class="comment"># dir()的等价 近似如下，__dict__字典中几乎包括了所有属性</span></span><br><span class="line">print(<span class="built_in">sorted</span>(<span class="built_in">set</span>(tom.__dict__.keys()) | <span class="built_in">set</span>(Cat.__dict__.keys()) | <span class="built_in">set</span>(<span class="built_in">object</span>.__dict__.keys())))</span><br><span class="line">dog = Dog(<span class="string">&#x27;snoppy&#x27;</span>)</span><br><span class="line">print(<span class="built_in">dir</span>(dog)) <span class="comment"># dog实例有__dir__所以用自己的</span></span><br><span class="line">print(dog.__dict__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># animal Module&#x27;s names = [&#x27;Animal&#x27;, &#x27;__builtins__&#x27;, &#x27;__cached__&#x27;, &#x27;__doc__&#x27;, &#x27;__file__&#x27;, &#x27;__loader__&#x27;, &#x27;__name__&#x27;, &#x27;__package__&#x27;, &#x27;__spec__&#x27;]</span></span><br><span class="line"><span class="comment"># animal Module&#x27;s names = [&#x27;Animal&#x27;, &#x27;__builtins__&#x27;, &#x27;__cached__&#x27;, &#x27;__doc__&#x27;, &#x27;__file__&#x27;, &#x27;__loader__&#x27;, &#x27;__name__&#x27;, &#x27;__package__&#x27;, &#x27;__spec__&#x27;]</span></span><br><span class="line"><span class="comment"># Current Module&#x27;s names = [&#x27;Animal&#x27;, &#x27;Cat&#x27;, &#x27;Dog&#x27;, &#x27;__annotations__&#x27;, &#x27;__builtins__&#x27;, &#x27;__cached__&#x27;, &#x27;__doc__&#x27;, &#x27;__file__&#x27;, &#x27;__loader__&#x27;, &#x27;__name__&#x27;, &#x27;__package__&#x27;, &#x27;__spec__&#x27;, &#x27;animal&#x27;]</span></span><br><span class="line"><span class="comment"># ------------------------------</span></span><br><span class="line"><span class="comment"># object&#x27;s __dict__ = [&#x27;__class__&#x27;, &#x27;__delattr__&#x27;, &#x27;__dir__&#x27;, &#x27;__doc__&#x27;, &#x27;__eq__&#x27;, &#x27;__format__&#x27;, &#x27;__ge__&#x27;, &#x27;__getattribute__&#x27;, &#x27;__gt__&#x27;, &#x27;__hash__&#x27;, &#x27;__init__&#x27;, &#x27;__init_subclass__&#x27;, &#x27;__le__&#x27;, &#x27;__lt__&#x27;, &#x27;__ne__&#x27;, &#x27;__new__&#x27;, &#x27;__reduce__&#x27;, &#x27;__reduce_ex__&#x27;, &#x27;__repr__&#x27;, &#x27;__setattr__&#x27;, &#x27;__sizeof__&#x27;, &#x27;__str__&#x27;, &#x27;__subclasshook__&#x27;]</span></span><br><span class="line"><span class="comment"># Animal&#x27;s dir() = [&#x27;__class__&#x27;, &#x27;__delattr__&#x27;, &#x27;__dict__&#x27;, &#x27;__dir__&#x27;, &#x27;__doc__&#x27;, &#x27;__eq__&#x27;, &#x27;__format__&#x27;, &#x27;__ge__&#x27;, &#x27;__getattribute__&#x27;, &#x27;__gt__&#x27;, &#x27;__hash__&#x27;, &#x27;__init__&#x27;, &#x27;__init_subclass__&#x27;, &#x27;__le__&#x27;, &#x27;__lt__&#x27;, &#x27;__module__&#x27;, &#x27;__ne__&#x27;, &#x27;__new__&#x27;, &#x27;__reduce__&#x27;, &#x27;__reduce_ex__&#x27;, &#x27;__repr__&#x27;, &#x27;__setattr__&#x27;, &#x27;__sizeof__&#x27;, &#x27;__str__&#x27;, &#x27;__subclasshook__&#x27;, &#x27;__weakref__&#x27;, &#x27;a&#x27;]</span></span><br><span class="line"><span class="comment"># Cat&#x27;s dir() = [&#x27;__class__&#x27;, &#x27;__delattr__&#x27;, &#x27;__dict__&#x27;, &#x27;__dir__&#x27;, &#x27;__doc__&#x27;, &#x27;__eq__&#x27;, &#x27;__format__&#x27;, &#x27;__ge__&#x27;, &#x27;__getattribute__&#x27;, &#x27;__gt__&#x27;, &#x27;__hash__&#x27;, &#x27;__init__&#x27;, &#x27;__init_subclass__&#x27;, &#x27;__le__&#x27;, &#x27;__lt__&#x27;, &#x27;__module__&#x27;, &#x27;__ne__&#x27;, &#x27;__new__&#x27;, &#x27;__reduce__&#x27;, &#x27;__reduce_ex__&#x27;, &#x27;__repr__&#x27;, &#x27;__setattr__&#x27;, &#x27;__sizeof__&#x27;, &#x27;__str__&#x27;, &#x27;__subclasshook__&#x27;, &#x27;__weakref__&#x27;, &#x27;a&#x27;, &#x27;x&#x27;, &#x27;y&#x27;]</span></span><br><span class="line"><span class="comment"># Dog&#x27;s dir = [&#x27;__class__&#x27;, &#x27;__delattr__&#x27;, &#x27;__dict__&#x27;, &#x27;__dir__&#x27;, &#x27;__doc__&#x27;, &#x27;__eq__&#x27;, &#x27;__format__&#x27;, &#x27;__ge__&#x27;, &#x27;__getattribute__&#x27;, &#x27;__gt__&#x27;, &#x27;__hash__&#x27;, &#x27;__init__&#x27;, &#x27;__init_subclass__&#x27;, &#x27;__le__&#x27;, &#x27;__lt__&#x27;, &#x27;__module__&#x27;, &#x27;__ne__&#x27;, &#x27;__new__&#x27;, &#x27;__reduce__&#x27;, &#x27;__reduce_ex__&#x27;, &#x27;__repr__&#x27;, &#x27;__setattr__&#x27;, &#x27;__sizeof__&#x27;, &#x27;__str__&#x27;, &#x27;__subclasshook__&#x27;, &#x27;__weakref__&#x27;, &#x27;a&#x27;]</span></span><br><span class="line"><span class="comment"># ------------------------------</span></span><br><span class="line"><span class="comment"># [&#x27;_Animal__age&#x27;, &#x27;__class__&#x27;, &#x27;__delattr__&#x27;, &#x27;__dict__&#x27;, &#x27;__dir__&#x27;, &#x27;__doc__&#x27;, &#x27;__eq__&#x27;, &#x27;__format__&#x27;, &#x27;__ge__&#x27;, &#x27;__getattribute__&#x27;, &#x27;__gt__&#x27;, &#x27;__hash__&#x27;, &#x27;__init__&#x27;, &#x27;__init_subclass__&#x27;, &#x27;__le__&#x27;, &#x27;__lt__&#x27;, &#x27;__module__&#x27;, &#x27;__ne__&#x27;, &#x27;__new__&#x27;, &#x27;__reduce__&#x27;, &#x27;__reduce_ex__&#x27;, &#x27;__repr__&#x27;, &#x27;__setattr__&#x27;, &#x27;__sizeof__&#x27;, &#x27;__str__&#x27;, &#x27;__subclasshook__&#x27;, &#x27;__weakref__&#x27;, &#x27;_name&#x27;, &#x27;a&#x27;, &#x27;weight&#x27;, &#x27;x&#x27;, &#x27;y&#x27;]</span></span><br><span class="line"><span class="comment"># [&#x27;_Animal__age&#x27;, &#x27;__class__&#x27;, &#x27;__delattr__&#x27;, &#x27;__dict__&#x27;, &#x27;__dir__&#x27;, &#x27;__doc__&#x27;, &#x27;__eq__&#x27;, &#x27;__format__&#x27;, &#x27;__ge__&#x27;, &#x27;__getattribute__&#x27;, &#x27;__gt__&#x27;, &#x27;__hash__&#x27;, &#x27;__init__&#x27;, &#x27;__init_subclass__&#x27;, &#x27;__le__&#x27;, &#x27;__lt__&#x27;, &#x27;__module__&#x27;, &#x27;__ne__&#x27;, &#x27;__new__&#x27;, &#x27;__reduce__&#x27;, &#x27;__reduce_ex__&#x27;, &#x27;__repr__&#x27;, &#x27;__setattr__&#x27;, &#x27;__sizeof__&#x27;, &#x27;__str__&#x27;, &#x27;__subclasshook__&#x27;, &#x27;__weakref__&#x27;, &#x27;_name&#x27;, &#x27;a&#x27;, &#x27;weight&#x27;, &#x27;x&#x27;, &#x27;y&#x27;]</span></span><br><span class="line"><span class="comment"># [&#x27;_Animal__age&#x27;, &#x27;__class__&#x27;, &#x27;__delattr__&#x27;, &#x27;__dir__&#x27;, &#x27;__doc__&#x27;, &#x27;__eq__&#x27;, &#x27;__format__&#x27;, &#x27;__ge__&#x27;, &#x27;__getattribute__&#x27;, &#x27;__gt__&#x27;, &#x27;__hash__&#x27;, &#x27;__init__&#x27;, &#x27;__init_subclass__&#x27;, &#x27;__le__&#x27;, &#x27;__lt__&#x27;, &#x27;__module__&#x27;, &#x27;__ne__&#x27;, &#x27;__new__&#x27;, &#x27;__reduce__&#x27;, &#x27;__reduce_ex__&#x27;, &#x27;__repr__&#x27;, &#x27;__setattr__&#x27;, &#x27;__sizeof__&#x27;, &#x27;__str__&#x27;, &#x27;__subclasshook__&#x27;, &#x27;_name&#x27;, &#x27;weight&#x27;, &#x27;x&#x27;, &#x27;y&#x27;]</span></span><br><span class="line"><span class="comment"># [&#x27;dog&#x27;]</span></span><br><span class="line"><span class="comment"># &#123;&#x27;_name&#x27;: &#x27;snoppy&#x27;, &#x27;_Animal__age&#x27;: 10, &#x27;weight&#x27;: 20&#125;</span></span><br></pre></td></tr></table></figure><br><code>dir()</code>作用域的测试：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> animal</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">self</span>):</span></span><br><span class="line">        a = <span class="string">&#x27;aaa&#x27;</span></span><br><span class="line">        t = <span class="string">&#x27;ttt&#x27;</span></span><br><span class="line">        print(<span class="built_in">dir</span>())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span>(<span class="params">a=<span class="number">50</span>, b=<span class="number">100</span></span>):</span></span><br><span class="line">    print(<span class="built_in">dir</span>())</span><br><span class="line"></span><br><span class="line">print(<span class="built_in">dir</span>()) <span class="comment"># 作用域是 当前模块</span></span><br><span class="line">Person().show() <span class="comment"># 作用域是 show方法</span></span><br><span class="line">test() <span class="comment"># 作用域是 test函数</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [&#x27;Person&#x27;, &#x27;__annotations__&#x27;, &#x27;__builtins__&#x27;, &#x27;__cached__&#x27;, &#x27;__doc__&#x27;, &#x27;__file__&#x27;, &#x27;__loader__&#x27;, &#x27;__name__&#x27;, &#x27;__package__&#x27;, &#x27;__spec__&#x27;, &#x27;animal&#x27;, &#x27;test&#x27;]</span></span><br><span class="line"><span class="comment"># [&#x27;a&#x27;, &#x27;self&#x27;, &#x27;t&#x27;]</span></span><br><span class="line"><span class="comment"># [&#x27;a&#x27;, &#x27;b&#x27;]</span></span><br></pre></td></tr></table></figure><br>上例中，证实dir()收集的属性根据它所在的作用域有关的。注意：作用域是当前模块时，即使有import，dir()也不会收集animal的属性名。</p>
<hr>
<h3 id="魔术方法"><a href="#魔术方法" class="headerlink" title="魔术方法"></a>魔术方法</h3><h4 id="创建、初始化、销毁"><a href="#创建、初始化、销毁" class="headerlink" title="创建、初始化、销毁"></a>创建、初始化、销毁</h4><p>在基础篇中讲解过初始化（<code>__init__</code>）和销毁（<code>__del__</code>），这次来讲解下实例化的本质，其实就是用了<code>object</code>的<code>__new__</code>。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">方法</th>
<th style="text-align:left">意义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>__new__(cls, *args, **kwargs)</code></td>
<td style="text-align:left">1.&ensp;实例化一个对象；<br>2.&ensp;该方法需要返回一个值，如果该值不是cls的实例，则不会调用<code>__init__</code>；<br>3.&ensp;该方法永远都是<code>静态方法</code>；</td>
</tr>
</tbody>
</table>
</div>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span>(<span class="params">cls, *args, **kwargs</span>):</span></span><br><span class="line">        print(cls)</span><br><span class="line">        print(*args)</span><br><span class="line">        print(**kwargs)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        <span class="comment"># return super().__new__(cls)</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name</span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line"></span><br><span class="line">a = A() <span class="comment"># 此时能执行__init__吗？ 不执行，因为__new__返回的不是实例</span></span><br><span class="line">print(a)</span><br><span class="line"></span><br><span class="line"><span class="comment"># &lt;class &#x27;__main__.A&#x27;&gt;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 1</span></span><br></pre></td></tr></table></figure>
<p>在实例化时，先执行<code>__new__</code>返回一个实例化对象，然后才执行初始化<code>__init__</code>。<br>上例由于<code>__new__</code>返回的不是实例，所以不会执行<code>__init__</code>。</p>
<p>正确的<code>__new__</code>实例化方式：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span>(<span class="params">cls, *args, **kwargs</span>):</span></span><br><span class="line">        print(cls)</span><br><span class="line">        print(*args)</span><br><span class="line">        print(**kwargs)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().__new__(cls) <span class="comment"># 实例化</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name</span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line"></span><br><span class="line">a = A(<span class="string">&#x27;tom&#x27;</span>)</span><br><span class="line">print(a)</span><br><span class="line"></span><br><span class="line"><span class="comment"># &lt;class &#x27;__main__.A&#x27;&gt;</span></span><br><span class="line"><span class="comment"># tom</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># &lt;__main__.A object at 0x000001D95B5B3278&gt;</span></span><br></pre></td></tr></table></figure><br>上例中，<code>__new__</code>最后成功返回了实例。所以说自定义的类的<code>__new__</code>本质上使用的是object的<code>__new__</code>来创建的实例。<br><code>__new__</code>方法很少使用，即使自定义创建了该方法，也会使用<code>return super().__new__(cls)</code>，即基类<code>object</code>的<code>__new__</code>方法；奥创建实例并返回。</p>
<hr>
<h4 id="哈希"><a href="#哈希" class="headerlink" title="哈希"></a>哈希</h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">方法</th>
<th style="text-align:left">意义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>__hash__(self)</code></td>
<td style="text-align:left">1.&ensp;内建函数<code>hash()</code>调用的返回值，<code>返回一个整数</code>。<br>2.&ensp;如果定义了这个方法，该类的实例就可hash。</td>
</tr>
</tbody>
</table>
</div>
<p>可以使用<code>hash()</code>来观看哈希效果：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">print(<span class="built_in">hash</span>(<span class="number">1</span>)) <span class="comment"># 1</span></span><br><span class="line">print(<span class="built_in">hash</span>(<span class="string">&#x27;tom&#x27;</span>))</span><br><span class="line">print(<span class="built_in">hash</span>((<span class="string">&#x27;tom&#x27;</span>,)))</span><br></pre></td></tr></table></figure><br>上例中后面两个值的hash结果不是固定的，和环境有关，这里就不写结果了。</p>
<p>现在使用类来测试：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只有__hash__</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name, age=<span class="number">18</span></span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__hash__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">100</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span> <span class="comment"># 查看实例时，返回实例的名字</span></span><br><span class="line">        <span class="keyword">return</span> self.name</span><br><span class="line"></span><br><span class="line">print(<span class="built_in">hash</span>(A(<span class="string">&#x27;tom&#x27;</span>)))</span><br><span class="line">print(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line">print((A(<span class="string">&#x27;tom&#x27;</span>),A(<span class="string">&#x27;tom&#x27;</span>))) <span class="comment"># tuple</span></span><br><span class="line">print([A(<span class="string">&#x27;tom&#x27;</span>),A(<span class="string">&#x27;tom&#x27;</span>)]) <span class="comment"># list</span></span><br><span class="line">print(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line">print(&#123;<span class="number">1</span>,<span class="number">1</span>&#125;) <span class="comment"># set</span></span><br><span class="line">print(&#123;(<span class="string">&#x27;tom&#x27;</span>,),(<span class="string">&#x27;tom&#x27;</span>,)&#125;) <span class="comment"># set</span></span><br><span class="line">print(&#123;<span class="string">&#x27;tom&#x27;</span>,<span class="string">&#x27;tom&#x27;</span>&#125;) <span class="comment"># set</span></span><br><span class="line">print(&#123;A(<span class="string">&#x27;tom&#x27;</span>),A(<span class="string">&#x27;tom&#x27;</span>)&#125;) <span class="comment"># 去重了吗？</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 100</span></span><br><span class="line"><span class="comment"># ------------------------------</span></span><br><span class="line"><span class="comment"># (tom, tom)</span></span><br><span class="line"><span class="comment"># [tom, tom]</span></span><br><span class="line"><span class="comment"># ------------------------------</span></span><br><span class="line"><span class="comment"># &#123;1&#125;</span></span><br><span class="line"><span class="comment"># &#123;(&#x27;tom&#x27;,)&#125;</span></span><br><span class="line"><span class="comment"># &#123;&#x27;tom&#x27;&#125;</span></span><br><span class="line"><span class="comment"># &#123;tom, tom&#125;</span></span><br></pre></td></tr></table></figure><br>hash值相同就会<code>去重</code>吗？<br>通过上例可知，hash了A的实例，调用的是A类的<code>__hash__</code>，返回的是100；<br>接下来使用tuple、list装载A的实例，正常输出，但使用set装载呢？<br>set是有去重功能的，但通过上例发现并没有去重，不能剔除相同的key，这是为什么呢？<br>上例中<code>A(&#39;tom&#39;)</code>hash值都是100呀，难道不是有相同的hash值就去重的吗？<br>看样子并不是这样的，这里需要借助另一个魔术方法<code>__eq__</code>了。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">方法</th>
<th style="text-align:left">意义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>__eq__(self, other)</code></td>
<td style="text-align:left">1. 对应 <code>==</code> 操作符，判断2个对象是否相等，<code>返回bool值</code>。<br>2. 一般这里写判断<code>内容</code>是否相同，判断情况可根据自己需要来写。</td>
</tr>
</tbody>
</table>
</div>
<p>注意：  </p>
<ol>
<li><code>__hash__</code>方法只是返回一个hash值作为set的key，但是<code>去重</code>，还需要<code>__eq__</code>来判断2个对象是否相等。  </li>
<li>hash值相等，只是hash冲突，不能说明两个对象是相等的。  </li>
<li>一般来说提供<code>__hash__</code>方法是为了作为set或者dict的key，所以去重要同时提供<code>__eq__</code>方法。  </li>
<li>不可hash对象<code>isinstance(p1, collections.Hashable)</code>一定为False，可以通过这种方式判断是否可hash。</li>
</ol>
<p>这个<code>__eq__</code>是只与<code>==</code>有关的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name, age=<span class="number">18</span></span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line"></span><br><span class="line">    <span class="comment"># def __hash__(self):</span></span><br><span class="line">    <span class="comment">#     return 100</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span>(<span class="params">self, other</span>):</span> <span class="comment"># 只与 == 有关</span></span><br><span class="line">        <span class="keyword">return</span> self.name == other.name</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.name</span><br><span class="line"></span><br><span class="line">print(A(<span class="string">&#x27;tom&#x27;</span>) == A(<span class="string">&#x27;tom&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># True</span></span><br></pre></td></tr></table></figure>
<p>注意：<code>==</code>和<code>is</code>的区别？<br><code>==</code> 比较的是两个对象的内容是否相等，即内存地址可以不一样，内容一样就可以了。<br><code>is</code> 比较的是两个实例对象是不是完全相同，它们是不是同一个对象，占用的内存地址是否相同。</p>
<p>继续思考<code>去重</code>，如果只有<code>__eq__</code>呢：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只有__eq__</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name, age=<span class="number">18</span></span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line"></span><br><span class="line">    <span class="comment"># def __hash__(self):</span></span><br><span class="line">    <span class="comment">#     return 100</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span>(<span class="params">self, other</span>):</span> </span><br><span class="line">        <span class="keyword">return</span> self.name == other.name</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.name</span><br><span class="line"></span><br><span class="line">print(&#123;A(<span class="string">&#x27;tom&#x27;</span>),A(<span class="string">&#x27;tom&#x27;</span>)&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># TypeError: unhashable type: &#x27;A&#x27;</span></span><br></pre></td></tr></table></figure><br>通过上例发现，只有<code>__eq__</code>就一定不可hash。</p>
<p>如果都不写呢？<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 无__hash__和__eq__</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name, age=<span class="number">18</span></span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line"></span><br><span class="line">    <span class="comment"># def __hash__(self):</span></span><br><span class="line">    <span class="comment">#     return 100</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># def __eq__(self, other):</span></span><br><span class="line">    <span class="comment">#     return self.name == other.name</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.name</span><br><span class="line">    </span><br><span class="line">print(<span class="built_in">hash</span>(A(<span class="string">&#x27;tom&#x27;</span>)))</span><br><span class="line">print(&#123;A(<span class="string">&#x27;tom&#x27;</span>),A(<span class="string">&#x27;tom&#x27;</span>)&#125;)</span><br><span class="line"></span><br><span class="line"><span class="number">-9223371935099804349</span></span><br><span class="line">&#123;tom, tom&#125;</span><br></pre></td></tr></table></figure><br>上例可知，无<code>__hash__</code>和<code>__eq__</code>，可以hash（用object的），可以eq（用object的），没去重，是因为object的<code>__eq__</code>只比较地址，相同返回True，不同返回False。</p>
<p>来看下<code>去重</code>到底是如何做的：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 有__hash__和__eq__</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name, age=<span class="number">18</span></span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__hash__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">100</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span>(<span class="params">self, other</span>):</span> <span class="comment"># 这个函数的作用？</span></span><br><span class="line">        <span class="keyword">return</span> self.name == other.name <span class="comment"># 返回bool值</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.name</span><br><span class="line"></span><br><span class="line">print(&#123;A(<span class="string">&#x27;tom&#x27;</span>),A(<span class="string">&#x27;tom&#x27;</span>)&#125;) <span class="comment"># 去重了吗？</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># &#123;tom&#125;</span></span><br></pre></td></tr></table></figure><br>上例中可知，确实对name相同实例的去重了。首先判断hash值是否相同，相同再看<code>__eq__</code>返回值是否是True，True就是内容相同了，去重，反之不去重。</p>
<p>总结下<code>去重</code>原理：</p>
<ul>
<li>object的<code>__eq__</code>比较地址（是否同一个），相同是True，不同是False。</li>
<li>只有<code>__hash__</code>：可hash，不去重。</li>
<li>只有<code>__eq__</code>：一定不可hash；</li>
<li><code>__hash__</code>和<code>__eq__</code>都没有（用object的）：<ul>
<li>object的<code>__hash__</code>返回hash值，可hash。</li>
<li>object的<code>__eq__</code>比较地址，True表示内容相同（去重），False表示不同（不去重）。</li>
</ul>
</li>
<li><code>__hash__</code>和<code>__eq__</code>都有：<ul>
<li>首先存在set、dict中的key必须是可hash的。</li>
<li>把key拿出来hash后返回值当做新key。</li>
<li>如果新key（hash值）相同，看<code>__eq__</code>返回的值，True表示内容相同（去重），False表示不同（不去重）。</li>
</ul>
</li>
</ul>
<p>思考：list类实例为什么不可hash？<br>源码中有一句<code>__hash__ = None</code>，也就是说如果调用<code>__hash__()</code>相当于<code>None()</code>，一定会报错。<br>技巧：所有类都继承object，而这个类是具有<code>__hash__ ()</code>方法的，如果一个类不能被hash，就把<code>__hash__</code>设置为None。</p>
<p>练习：设计二维坐标类Point，使其成为可hash类型，并比较2个坐标的实例是否相等？<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> Hashable</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, x, y</span>):</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__hash__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">hash</span>((self.x, self.y)) <span class="comment"># 使用内建函数hash</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span>(<span class="params">self, other</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.x == other.x <span class="keyword">and</span> self.y == other.y</span><br><span class="line"></span><br><span class="line">p1 = Point(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">p2 = Point(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">print(<span class="built_in">hash</span>(p1))</span><br><span class="line">print(<span class="built_in">hash</span>(p2))</span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">30</span>)</span><br><span class="line">print(p1 <span class="keyword">is</span> p2) </span><br><span class="line">print(p1 == p2) <span class="comment"># True 使用__eq__</span></span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">30</span>)</span><br><span class="line">print(<span class="built_in">hex</span>(<span class="built_in">id</span>(p1)), <span class="built_in">hex</span>(<span class="built_in">id</span>(p2))) <span class="comment"># 查看地址</span></span><br><span class="line">print(<span class="built_in">set</span>((p1, p2))) <span class="comment"># set去重了吗？ 去重了</span></span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">30</span>)</span><br><span class="line">print(<span class="built_in">isinstance</span>(p1, Hashable)) <span class="comment"># p1是hashable？ 是</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3713084879518070856</span></span><br><span class="line"><span class="comment"># 3713084879518070856</span></span><br><span class="line"><span class="comment"># ------------------------------</span></span><br><span class="line"><span class="comment"># False</span></span><br><span class="line"><span class="comment"># True</span></span><br><span class="line"><span class="comment"># ------------------------------</span></span><br><span class="line"><span class="comment"># 0x213c6978d30 0x213c6aa53c8</span></span><br><span class="line"><span class="comment"># &#123;&lt;__main__.Point object at 0x00000213C6978D30&gt;&#125;</span></span><br><span class="line"><span class="comment"># ------------------------------</span></span><br><span class="line"><span class="comment"># True</span></span><br></pre></td></tr></table></figure><br>上例中可知，p1，p2是相同的实例，先看hash值相同，然后看<code>__eq__</code>返回的值是True，所以可以去重。<code>is</code>判断是False，因为p1，p2地址是不同的。</p>
<p>注意：<code>set()</code>里面必须是iterable（可迭代对象），所以用p1、p2元组包裹起来了<code>(p1, p2)</code>。</p>
<p>注意：hash值不是内存地址，hash是内部算法得到的。</p>
<hr>
<h4 id="布尔"><a href="#布尔" class="headerlink" title="布尔"></a>布尔</h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">方法</th>
<th style="text-align:left">意义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>__bool__(self)</code></td>
<td style="text-align:left">1. 内建函数<code>bool()</code>，或者<code>实例对象</code>放在逻辑表达式的位置（<code>if A():pass</code>），调用这个函数返回布尔值。<code>__bool__</code>只与实例有关。<br>2. 没有定义<code>__bool__ ()</code>，就找<code>__len__ ()</code>返回长度，非0为真。<br>3. 如果<code>__len__ ()</code>也没有定义，那么所有实例都返回真（objec的<code>__bool__</code>默认返回True）。</td>
</tr>
</tbody>
</table>
</div>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span><span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">print(<span class="built_in">bool</span>(A))</span><br><span class="line">print(<span class="built_in">bool</span>(A()))</span><br><span class="line"></span><br><span class="line"><span class="comment"># True</span></span><br><span class="line"><span class="comment"># True</span></span><br></pre></td></tr></table></figure>
<p>上例中，A类和A()的bool值都是True。调用的是object的<code>__bool__</code>，它默认是True。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__bool__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">print(<span class="built_in">bool</span>(B))</span><br><span class="line">print(<span class="built_in">bool</span>(B())) <span class="comment"># 实例</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># True</span></span><br><span class="line"><span class="comment"># False</span></span><br></pre></td></tr></table></figure>
<p>上例中，类B还是走objec（<code>__bool__</code>只与实例有关，从self就可以看出来）；<code>B()</code>走B类的<code>__bool__</code>返回False。</p>
<p><code>__len__</code>对应内建函数<code>len</code>，测试长度用的：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># return -1 # ValueError: __len__() should return &gt;= 0</span></span><br><span class="line">        <span class="comment"># return 0 # C-&gt;True、 C()-&gt;Flase</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span> <span class="comment"># C-&gt;True、 C()-&gt;True</span></span><br><span class="line"></span><br><span class="line">print(<span class="built_in">bool</span>(C))</span><br><span class="line">print(<span class="built_in">bool</span>(C()))</span><br></pre></td></tr></table></figure><br>由上例可知，没有定义<code>__bool__</code>，就走<code>__len__</code>。<code>__len__</code>返回值必须是正整数，<code>__bool__</code>根据这个返回值做判断，非0为真。</p>
<hr>
<h4 id="可视化"><a href="#可视化" class="headerlink" title="可视化"></a>可视化</h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">方法</th>
<th style="text-align:left">意义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>__str__(self)</code></td>
<td style="text-align:left">1. <code>str()</code>函数、<code>format()</code>函数、<code>print()</code>函数调用，需要返回对象的<code>字符串</code>表达。<br>2. 如果没有定义，就去调用<code>__repr__</code>方法返回字符串表达，如果<code>__repr__</code>没有定义，就直接返回对象的内存地址信息。</td>
</tr>
<tr>
<td style="text-align:center"><code>__repr__(self)</code></td>
<td style="text-align:left">1. 内建函数<code>repr()</code>对一个对象获取<code>字符串</code>表达。<br>2. 调用<code>__repr__</code>方法返回字符串表达，如果 <code>__repr__</code>也没有定义，就直接返回object的定义（就是显示内存地址信息）。</td>
</tr>
<tr>
<td style="text-align:center"><code>__bytes__(self)</code></td>
<td style="text-align:left">1. <code>bytes()</code>函数调用，返回一个对象的<code>bytes</code>表达，即<code>返回bytes对象</code>。</td>
</tr>
</tbody>
</table>
</div>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name, age=<span class="number">18</span></span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;repr: &#123;&#125;,&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(self.name, self.age)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;str: &#123;&#125;,&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(self.name, self.age)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__bytes__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment">#return &quot;&#123;&#125; is &#123;&#125;&quot;.format(self.name, self.age).encode()</span></span><br><span class="line">        <span class="keyword">import</span> json</span><br><span class="line">        <span class="keyword">return</span> json.dumps(self.__dict__).encode()</span><br><span class="line"></span><br><span class="line">print(<span class="built_in">str</span>(A(<span class="string">&#x27;tom&#x27;</span>))) <span class="comment"># str函数使用__str__</span></span><br><span class="line">print(A(<span class="string">&#x27;tom&#x27;</span>)) <span class="comment"># print函数使用__str__</span></span><br><span class="line">print(<span class="string">&#x27;&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(A(<span class="string">&#x27;tom&#x27;</span>))) <span class="comment"># format函数使用__str__</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">30</span>)</span><br><span class="line">print([A(<span class="string">&#x27;tom&#x27;</span>)]) <span class="comment"># []使用__str__，但其内部使用__repr__</span></span><br><span class="line">print([<span class="built_in">str</span>(A(<span class="string">&#x27;tom&#x27;</span>))]) <span class="comment"># []使用__str__，其内部的元素使用str()函数优先调用__str__</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">30</span>)</span><br><span class="line">print(<span class="built_in">bytes</span>(A(<span class="string">&#x27;tom&#x27;</span>)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># str: tom,18</span></span><br><span class="line"><span class="comment"># str: tom,18</span></span><br><span class="line"><span class="comment"># str: tom,18</span></span><br><span class="line"><span class="comment"># ------------------------------</span></span><br><span class="line"><span class="comment"># [repr: tom,18]</span></span><br><span class="line"><span class="comment"># [&#x27;str: tom,18&#x27;]</span></span><br><span class="line"><span class="comment"># ------------------------------</span></span><br><span class="line"><span class="comment"># b&#x27;&#123;&quot;name&quot;: &quot;tom&quot;, &quot;age&quot;: 18&#125;&#x27;</span></span><br></pre></td></tr></table></figure>
<p>如果没有<code>__str__</code>那就去找<code>__repr__</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name, age=<span class="number">18</span></span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;repr: &#123;&#125;,&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(self.name, self.age)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># def __str__(self):</span></span><br><span class="line">    <span class="comment">#     return &#x27;str: &#123;&#125;,&#123;&#125;&#x27;.format(self.name, self.age)</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__bytes__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment">#return &quot;&#123;&#125; is &#123;&#125;&quot;.format(self.name, self.age).encode()</span></span><br><span class="line">        <span class="keyword">import</span> json</span><br><span class="line">        <span class="keyword">return</span> json.dumps(self.__dict__).encode()</span><br><span class="line"></span><br><span class="line">print(<span class="built_in">str</span>(A(<span class="string">&#x27;tom&#x27;</span>))) <span class="comment"># str函数使用__str__</span></span><br><span class="line">print(A(<span class="string">&#x27;tom&#x27;</span>)) <span class="comment"># print函数使用__str__</span></span><br><span class="line">print(<span class="string">&#x27;&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(A(<span class="string">&#x27;tom&#x27;</span>))) <span class="comment"># format函数使用__str__</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">30</span>)</span><br><span class="line">print([A(<span class="string">&#x27;tom&#x27;</span>)]) <span class="comment"># []使用__str__，但其内部使用__repr__</span></span><br><span class="line">print([<span class="built_in">str</span>(A(<span class="string">&#x27;tom&#x27;</span>))]) <span class="comment"># []使用__str__，其中的元素使用str()函数也调用__str__</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">30</span>)</span><br><span class="line">print(<span class="built_in">bytes</span>(A(<span class="string">&#x27;tom&#x27;</span>)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># repr: tom,18</span></span><br><span class="line"><span class="comment"># repr: tom,18</span></span><br><span class="line"><span class="comment"># repr: tom,18</span></span><br><span class="line"><span class="comment"># ------------------------------</span></span><br><span class="line"><span class="comment"># [repr: tom,18]</span></span><br><span class="line"><span class="comment"># [&#x27;repr: tom,18&#x27;]</span></span><br><span class="line"><span class="comment"># ------------------------------</span></span><br><span class="line"><span class="comment"># b&#x27;&#123;&quot;name&quot;: &quot;tom&quot;, &quot;age&quot;: 18&#125;&#x27;</span></span><br></pre></td></tr></table></figure>
<p>上例可知，在没有<code>__str__</code>时，会去找<code>__repr__</code>代替。</p>
<p>那么<code>__bytes__</code>呢？<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name, age=<span class="number">18</span></span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;repr: &#123;&#125;,&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(self.name, self.age)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;str: &#123;&#125;,&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(self.name, self.age)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># def __bytes__(self):</span></span><br><span class="line">    <span class="comment">#     #return &quot;&#123;&#125; is &#123;&#125;&quot;.format(self.name, self.age).encode()</span></span><br><span class="line">    <span class="comment">#     import json</span></span><br><span class="line">    <span class="comment">#     return json.dumps(self.__dict__).encode()</span></span><br><span class="line"></span><br><span class="line">print(<span class="built_in">bytes</span>(A(<span class="string">&#x27;tom&#x27;</span>)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># TypeError: cannot convert &#x27;A&#x27; object to bytes</span></span><br></pre></td></tr></table></figure><br>上例可知，<code>__bytes__</code>是独立的一个方法，在使用<code>bytes()</code>时，有<code>__bytes__</code>就使用，没有就会报错。</p>
<p>注意：不能通过判断是否带引号来判断输出值的类型，类型判断要使用type或isinstance。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">print(<span class="string">&#x27;1&#x27;</span>)<span class="comment"># 字符串直接输出没有引号</span></span><br><span class="line">print(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">print([<span class="string">&#x27;a&#x27;</span>],(<span class="string">&#x27;1&#x27;</span>,)) <span class="comment"># 字符串在基本数据类型内部输出有引号</span></span><br><span class="line">print(&#123;<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;a&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1</span></span><br><span class="line"><span class="comment"># a</span></span><br><span class="line"><span class="comment"># [&#x27;a&#x27;] (&#x27;1&#x27;,)</span></span><br><span class="line"><span class="comment"># &#123;&#x27;1&#x27;, &#x27;a&#x27;&#125;</span></span><br></pre></td></tr></table></figure><br>上例中可知，不能通过输出的值来判断它的类型，比如上例输出的是<code>1</code>，你并不能确定这是数字类型还是字符串类型，所以不能片面的根据输出值来推断它是什么类型，要使用type或isinstance来判断。</p>
<hr>
<h4 id="运算符重载"><a href="#运算符重载" class="headerlink" title="运算符重载"></a>运算符重载</h4><p>operator模块提供一下的特殊方法，可将类的实例使用下面的操作符来操作：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">运算符</th>
<th style="text-align:center">特殊方法</th>
<th style="text-align:center">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>&lt;</code>, <code>&lt;=</code>, <code>&gt;</code>, <code>&gt;=</code>, <code>==</code>, <code>!=</code></td>
<td style="text-align:center"><code>__lt__</code>, <code>__le__</code> , <code>__gt__</code> , <code>__ge__</code> ,<code>__eq__</code>, <code>__ne__</code></td>
<td style="text-align:center">比较运算符</td>
</tr>
<tr>
<td style="text-align:center"><code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>, <code>%</code>, <code>//</code>,<code>**</code>, <code>divmod</code></td>
<td style="text-align:center"><code>__add__</code> , <code>__sub__</code> , <code>__mul__</code> , <code>__truediv__</code> , <code>__mod__</code> ,<code>__floordiv__</code> , <code>__pow__</code> , <code>__divmod__</code></td>
<td style="text-align:center">算数运算符，移位、位运算也有对应的方法</td>
</tr>
<tr>
<td style="text-align:center"><code>+=</code>, <code>-=</code>, <code>*=</code>, <code>/=</code>,<code>%=</code>, <code>//=</code>, <code>**=</code></td>
<td style="text-align:center"><code>__iadd__</code> , <code>__isub__</code> , <code>__imul__</code> , <code>__itruediv__</code> ,<code>__imod__</code> , <code>__ifloordiv__</code> , <code>__ipow__</code></td>
</tr>
</tbody>
</table>
</div>
<p>实现A类的2个实例相减（这里举例一种方法，其他方法同理）：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name, age=<span class="number">18</span></span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__sub__</span>(<span class="params">self, other</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.age - other.age</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__isub__</span>(<span class="params">self, other</span>):</span> <span class="comment"># 如果没有定义__isub__，则会调用__sub__</span></span><br><span class="line">        <span class="keyword">return</span> A(self.name,self.age - other.age) <span class="comment"># 前面有i的，表示就地修改，返回新对象</span></span><br><span class="line"></span><br><span class="line">tom = A(<span class="string">&#x27;tom&#x27;</span>)</span><br><span class="line">jerry = A(<span class="string">&#x27;jerry&#x27;</span>,<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">print(tom - jerry,tom.__sub__(jerry)) <span class="comment"># __sub__</span></span><br><span class="line">print(jerry - tom,jerry.__sub__(tom)) <span class="comment"># __sub__</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">40</span>)</span><br><span class="line">print(tom)</span><br><span class="line">tom -= jerry <span class="comment"># __isub__</span></span><br><span class="line">print(tom)</span><br><span class="line">print(tom.age, <span class="built_in">hex</span>(<span class="built_in">id</span>(tom)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2 2</span></span><br><span class="line"><span class="comment"># -2 -2</span></span><br><span class="line"><span class="comment"># ----------------------------------------</span></span><br><span class="line"><span class="comment"># &lt;__main__.A object at 0x00000213963D32B0&gt;</span></span><br><span class="line"><span class="comment"># &lt;__main__.A object at 0x00000213963D3320&gt;</span></span><br><span class="line"><span class="comment"># 2 0x213963d3320</span></span><br></pre></td></tr></table></figure><br>使用单运算符（如<code>-</code>），调用的非i开头的方法；使用混合运算符（如<code>-=</code>），调用的是i开头的方法，表示就地修改，此时注意i开头方法的返回值的类型不能改变。</p>
<p><code>__isub__</code>方法定义，一般会in-place就地来修改自身。</p>
<p>如果没有定义<code>__isub__</code>方法，则会调用<code>__sub__</code>：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name, age=<span class="number">18</span></span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__sub__</span>(<span class="params">self, other</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.age - other.age</span><br><span class="line"></span><br><span class="line">    <span class="comment"># def __isub__(self, other):</span></span><br><span class="line">    <span class="comment">#     return A(self.name,self.age - other.age)</span></span><br><span class="line"></span><br><span class="line">tom = A(<span class="string">&#x27;tom&#x27;</span>)</span><br><span class="line">jerry = A(<span class="string">&#x27;jerry&#x27;</span>,<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">print(tom)</span><br><span class="line">tom -= jerry <span class="comment"># 没有__isub__，使用__sub__</span></span><br><span class="line">print(tom)</span><br><span class="line"></span><br><span class="line"><span class="comment"># &lt;__main__.A object at 0x000002275F233240&gt;</span></span><br><span class="line"><span class="comment"># 2</span></span><br></pre></td></tr></table></figure><br>上例中，没有<code>__isub__</code>方法，<code>tom -= jerry</code>调用<code>__sub__</code>代替，将<code>__sub__</code>的返回值赋值给tom了，所以tom就不是A的实例了，这是赋值即重新定义了。</p>
<p>运算符重载应用场景：  </p>
<ul>
<li>往往是用面向对象实现的类，需要做大量的运算，而运算符是这种运算在数学上最常见的表达方式。例如，求向量（需要坐标类的实例加减）。</li>
<li>提供运算符重载，比直接提供加法方法要更加适合该领域使用者的习惯。</li>
<li>int类，几乎实现了所有运算符重载，可以作为参考。</li>
</ul>
<p><strong><code>@functools.total_ordering</code>装饰器</strong>：<br><code>__lt__</code> , <code>__le__</code>, <code>__eq__</code> , <code>__gt__</code> , <code>__ge__</code> 是比较大小必须实现的方法，但是全部写完太麻烦，可以使用<code>@functools.total_ordering</code>装饰器。</p>
<p>但是要求<code>__eq__</code>必须实现，其它方法<code>__lt__</code> , <code>__le__</code> , <code>__gt__</code> , <code>__ge__</code>实现其一。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> total_ordering</span><br><span class="line"></span><br><span class="line"><span class="meta">@total_ordering</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name, age</span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span>(<span class="params">self, other</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.age == other.age</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__gt__</span>(<span class="params">self, other</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.age &gt; other.age</span><br><span class="line"></span><br><span class="line">tom = Person(<span class="string">&#x27;tom&#x27;</span>, <span class="number">20</span>)</span><br><span class="line">jerry = Person(<span class="string">&#x27;jerry&#x27;</span>, <span class="number">16</span>)</span><br><span class="line">print(tom == jerry)</span><br><span class="line">print(tom &gt; jerry)</span><br><span class="line">print(tom &lt; jerry)</span><br><span class="line">print(tom &gt;= jerry)</span><br><span class="line">print(tom &lt;= jerry)</span><br><span class="line"></span><br><span class="line"><span class="comment"># False</span></span><br><span class="line"><span class="comment"># True</span></span><br><span class="line"><span class="comment"># False</span></span><br><span class="line"><span class="comment"># True</span></span><br><span class="line"><span class="comment"># False</span></span><br></pre></td></tr></table></figure>
<p>上例中虽然简化了代码，但是一般来说比较实现<code>等于</code>或者<code>小于</code>方法也就够了，其它可以不实现，所以这个装饰器只是看着很美好，且可能会带来性能问题，建议需要什么方法就自己创建，少用这个装饰器。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name, age</span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span>(<span class="params">self, other</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.age == other.age</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__gt__</span>(<span class="params">self, other</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.age &gt; other.age</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__ge__</span>(<span class="params">self, other</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.age &gt;= other.age</span><br><span class="line"></span><br><span class="line">tom = Person(<span class="string">&#x27;tom&#x27;</span>, <span class="number">20</span>)</span><br><span class="line">jerry = Person(<span class="string">&#x27;jerry&#x27;</span>, <span class="number">16</span>)</span><br><span class="line">print(tom == jerry)</span><br><span class="line">print(tom &gt; jerry)</span><br><span class="line">print(tom &lt; jerry)</span><br><span class="line">print(tom &gt;= jerry)</span><br><span class="line">print(tom &lt;= jerry)</span><br><span class="line"></span><br><span class="line"><span class="comment"># False</span></span><br><span class="line"><span class="comment"># True</span></span><br><span class="line"><span class="comment"># False</span></span><br><span class="line"><span class="comment"># True</span></span><br><span class="line"><span class="comment"># False</span></span><br></pre></td></tr></table></figure>
<p>总共使用3个方法，就可以把所有比较解决了：  </p>
<ul>
<li><code>__eq__</code>等于可以推断不等于；  </li>
<li><code>__gt__</code>大于可以推断小于；  </li>
<li><code>__ge__</code>大于等于可以推断小于等于；  </li>
</ul>
<p>所以<code>@total_ordering</code>可以不使用（最好不要使用，兼容上可能会有性能问题，能自己写就自己写）。</p>
<h4 id="容器相关方法"><a href="#容器相关方法" class="headerlink" title="容器相关方法"></a>容器相关方法</h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">方法</th>
<th style="text-align:left">意义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>__len__(self)</code></td>
<td style="text-align:left">1.&ensp;内建函数<code>len()</code>，返回对象的<code>长度（&gt;=0的整数）</code>，如果把对象当做容器类型看，就如同 list 或者 dict 。<br>2.&ensp;<code>bool()</code>函数调用的时候，如果没有<code>__bool__()</code> 方法，则会看<code>__len__()</code>方法是否存在，存在时返回非0为真。</td>
</tr>
<tr>
<td style="text-align:center"><code>__iter__(self)</code></td>
<td style="text-align:left">迭代容器时，调用它，返回一个<code>新的迭代器对象</code>。</td>
</tr>
<tr>
<td style="text-align:center"><code>__contains__(self, item)</code></td>
<td style="text-align:left"><code>in</code>成员运算符，没有这个方法，就调用<code>__iter__</code>方法遍历</td>
</tr>
<tr>
<td style="text-align:center"><code>__getitem__(self, item)</code></td>
<td style="text-align:left">1.&ensp;实现<code>self[index]</code>或<code>self[key]</code>访问方式，即序列化对象，可以是<code>index</code>或者<code>key</code>。<br>2.&ensp;对于<code>index</code>类型（ list 和 tuple ），应是整数作为<code>index</code>，或者切片。<br>3.&ensp;对于<code>key</code>类型（ set 和 dict ），应是<code>hashable</code>作为<code>key</code>。<code>key</code>不存在会引发KeyError异常。</td>
</tr>
<tr>
<td style="text-align:center"><code>__setitem__(self, key, value)</code></td>
<td style="text-align:left">与<code>__getitem__</code>的访问类似，是设置值的方法。</td>
</tr>
<tr>
<td style="text-align:center"><code>__missing__(self, key)</code></td>
<td style="text-align:left">1.&ensp;<code>dict</code>或<code>dict子类</code>，必须是调用<code>dict</code>的<code>__getitem__()</code>方法时，key不存在时执行该方法。<br>2.&ensp;若类中有写<code>__getitem__()</code>方法时，正常报错，不走<code>__missing__</code>。</td>
</tr>
</tbody>
</table>
</div>
<p>由于<code>__len__</code>和<code>__bool__</code>上面已讲，这里不再赘述。</p>
<p>下面是<code>__iter__</code>和<code>__contains__</code>讲解：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 有__contains__</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.d = &#123;<span class="string">&#x27;a&#x27;</span>:<span class="string">&#x27;tom&#x27;</span>,<span class="string">&#x27;b&#x27;</span>:<span class="string">&#x27;jerry&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;iter!&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">iter</span>(self.d)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__contains__</span>(<span class="params">self, item</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;contains！&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">a = A()</span><br><span class="line">print(<span class="string">&#x27;a&#x27;</span> <span class="keyword">in</span> a) <span class="comment"># 有__contains__方法就调用它，没有就调用__iter__</span></span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">20</span>)</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> a: <span class="comment"># __iter__</span></span><br><span class="line">    print(x)</span><br><span class="line"></span><br><span class="line"><span class="comment"># contains！</span></span><br><span class="line"><span class="comment"># False</span></span><br><span class="line"><span class="comment"># --------------------</span></span><br><span class="line"><span class="comment"># iter!</span></span><br><span class="line"><span class="comment"># a</span></span><br><span class="line"><span class="comment"># b</span></span><br></pre></td></tr></table></figure><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 没有__contains__</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.d = &#123;<span class="string">&#x27;a&#x27;</span>:<span class="string">&#x27;tom&#x27;</span>,<span class="string">&#x27;b&#x27;</span>:<span class="string">&#x27;jerry&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;iter!&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">iter</span>(self.d)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># def __contains__(self, item):</span></span><br><span class="line">    <span class="comment">#     print(&#x27;contains！&#x27;)</span></span><br><span class="line">    <span class="comment">#     return False</span></span><br><span class="line"></span><br><span class="line">a = A()</span><br><span class="line">print(<span class="string">&#x27;a&#x27;</span> <span class="keyword">in</span> a) <span class="comment"># 有__contains__方法就调用它，没有就调用__iter__</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># iter!</span></span><br><span class="line"><span class="comment"># True</span></span><br></pre></td></tr></table></figure></p>
<p>下面是<code>__getitem__</code>和<code>__setitem__</code>用法举例：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># index类型</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.<span class="built_in">list</span> = [<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span>(<span class="params">self, item</span>):</span> <span class="comment"># 按index取值</span></span><br><span class="line">        <span class="keyword">return</span> self.<span class="built_in">list</span>[item]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span>(<span class="params">self, key, value</span>):</span> <span class="comment"># 这里只实现修改</span></span><br><span class="line">        self.<span class="built_in">list</span>[key] = value</span><br><span class="line"></span><br><span class="line">a = A()</span><br><span class="line">print(a[<span class="number">0</span>]) <span class="comment"># __getitem__</span></span><br><span class="line">a[<span class="number">0</span>] = <span class="string">&#x27;a&#x27;</span> <span class="comment"># __setitem__</span></span><br><span class="line">print(a[<span class="number">0</span>]) <span class="comment"># __getitem__</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 0</span></span><br><span class="line"><span class="comment"># a</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># key类型</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.d = &#123;<span class="string">&#x27;0&#x27;</span>:<span class="string">&#x27;tom&#x27;</span>,<span class="string">&#x27;1&#x27;</span>:<span class="string">&#x27;jerry&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span>(<span class="params">self, item</span>):</span> <span class="comment"># 按key取值</span></span><br><span class="line">        <span class="keyword">return</span> self.d[item]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span>(<span class="params">self, key, value</span>):</span> <span class="comment"># 这里只实现修改</span></span><br><span class="line">        self.d[key] = value</span><br><span class="line"></span><br><span class="line">a = A()</span><br><span class="line">print(a[<span class="string">&#x27;0&#x27;</span>]) <span class="comment"># __getitem__</span></span><br><span class="line">a[<span class="string">&#x27;0&#x27;</span>] = <span class="string">&#x27;a&#x27;</span> <span class="comment"># __setitem__</span></span><br><span class="line">print(a[<span class="string">&#x27;0&#x27;</span>]) <span class="comment"># __getitem__</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># tom</span></span><br><span class="line"><span class="comment"># a</span></span><br></pre></td></tr></table></figure>
<p>下面是<code>__missing__</code>用法举例：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>(<span class="params"><span class="built_in">dict</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__missing__</span>(<span class="params">self, key</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;Missing key : &#x27;</span>,key)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">10</span></span><br><span class="line">a = A()</span><br><span class="line">print(a[<span class="string">&#x27;cat&#x27;</span>]) <span class="comment"># 返回10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Missing key :  cat</span></span><br><span class="line"><span class="comment"># 10</span></span><br></pre></td></tr></table></figure><br>上例，实例使用<code>a[&#39;key&#39;]</code>这种字典访问方式时，首先调用<code>dict</code>的<code>__getitem__</code>方法按<code>key</code>找，找不到说明没有<code>key</code>，再去当前类的<code>__missing__</code>方法报错处理。相当于拦住了KeyError。<br>注意<code>__missing__</code>只适用于字典类型或者继承字典类的类型。</p>
<p>综合使用：实现购物车购物？<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cart</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.items = [] <span class="comment"># 购物车[]</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">additem</span>(<span class="params">self, item</span>):</span></span><br><span class="line">        self.items.append(item) <span class="comment"># 添加物品item</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self.items) <span class="comment"># 计算物品数量</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 返回新的迭代对象</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">iter</span>(self.items) <span class="comment"># 查看购物车内所有物品</span></span><br><span class="line">        <span class="comment">#yield from self.items # 和上面效果一样</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span>(<span class="params">self, item</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.items[item] <span class="comment"># 查找车内某件物品</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span>(<span class="params">self, key, value</span>):</span></span><br><span class="line">        self.items[key] = value <span class="comment"># 修改车内某物数量</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">str</span>(self.items) <span class="comment"># 可视化</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__add__</span>(<span class="params">self, other</span>):</span></span><br><span class="line">        self.items.append(other) <span class="comment"># 运算符重载</span></span><br><span class="line">        <span class="keyword">return</span> self <span class="comment"># 实现链式编程</span></span><br><span class="line"></span><br><span class="line">cart = Cart()</span><br><span class="line"></span><br><span class="line"><span class="comment"># __len__、bool</span></span><br><span class="line">print(<span class="built_in">len</span>(cart))</span><br><span class="line">print(<span class="built_in">bool</span>(cart)) <span class="comment"># 没有__bool__使用__len__</span></span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义additem方法添加</span></span><br><span class="line">cart.additem(<span class="number">0</span>)</span><br><span class="line">cart.additem(<span class="string">&#x27;abc&#x27;</span>)</span><br><span class="line">cart.additem(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 索引操作，修改。__setitem__</span></span><br><span class="line">print(cart[<span class="number">1</span>])</span><br><span class="line">cart[<span class="number">1</span>] = <span class="string">&#x27;xyz&#x27;</span> <span class="comment"># 修改索引1的值为&#x27;xyz&#x27;</span></span><br><span class="line">print(cart[<span class="number">1</span>])</span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 迭代__iter__</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> cart:</span><br><span class="line">    print(x)</span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># in，没有__contains__，用__iter__</span></span><br><span class="line">print(<span class="number">10</span> <span class="keyword">in</span> cart)</span><br><span class="line">print(<span class="string">&#x27;xyz&#x27;</span> <span class="keyword">in</span> cart)</span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 链式变成实现加法</span></span><br><span class="line">print(cart)</span><br><span class="line">print(cart + <span class="number">4</span> + <span class="number">5</span>)</span><br><span class="line">print(cart.__add__(<span class="number">17</span>).__add__(<span class="number">18</span>)) <span class="comment"># 与上面等价</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 0</span></span><br><span class="line"><span class="comment"># False</span></span><br><span class="line"><span class="comment"># --------------------</span></span><br><span class="line"><span class="comment"># abc</span></span><br><span class="line"><span class="comment"># xyz</span></span><br><span class="line"><span class="comment"># --------------------</span></span><br><span class="line"><span class="comment"># 0</span></span><br><span class="line"><span class="comment"># xyz</span></span><br><span class="line"><span class="comment"># 2</span></span><br><span class="line"><span class="comment"># --------------------</span></span><br><span class="line"><span class="comment"># False</span></span><br><span class="line"><span class="comment"># True</span></span><br><span class="line"><span class="comment"># --------------------</span></span><br><span class="line"><span class="comment"># [0, &#x27;xyz&#x27;, 2]</span></span><br><span class="line"><span class="comment"># [0, &#x27;xyz&#x27;, 2, 4, 5]</span></span><br><span class="line"><span class="comment"># [0, &#x27;xyz&#x27;, 2, 4, 5, 17, 18]</span></span><br></pre></td></tr></table></figure></p>
<h4 id="可调用对象"><a href="#可调用对象" class="headerlink" title="可调用对象"></a>可调用对象</h4><p>Python中，一切皆对象，函数也不例外。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span>():</span></span><br><span class="line">    print(foo.__module__,foo.__name__)</span><br><span class="line"></span><br><span class="line">foo() <span class="comment"># 和下面等价</span></span><br><span class="line">foo.__call__()</span><br><span class="line"></span><br><span class="line"><span class="comment"># __main__ foo</span></span><br><span class="line"><span class="comment"># __main__ foo</span></span><br></pre></td></tr></table></figure><br>函数即对象，对象foo加上()，就是调用此函数对象的<code>__call__()</code>方法。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">方法</th>
<th style="text-align:left">意义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>__call__(self, *args, **kwargs)</code></td>
<td style="text-align:left">类中定义了该方法，其实例就可以像函数一样调用</td>
</tr>
</tbody>
</table>
</div>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, x, y</span>):</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&lt;Point &#123;&#125;:&#123;&#125;&gt;&quot;</span>.<span class="built_in">format</span>(self.x, self.y)</span><br><span class="line"></span><br><span class="line">p = Point(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">print(p)</span><br><span class="line">print(p())</span><br><span class="line"></span><br><span class="line"><span class="comment"># &lt;__main__.Point object at 0x000001265E428668&gt;</span></span><br><span class="line"><span class="comment"># &lt;Point 4:5&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Adder</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, *args</span>):</span></span><br><span class="line">        ret = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> args: <span class="comment"># 求和</span></span><br><span class="line">            ret += x</span><br><span class="line">        self.ret = ret <span class="comment"># 写入实例属性</span></span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">adder = Adder()</span><br><span class="line">print(adder(<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>))</span><br><span class="line">print(adder.ret)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 15</span></span><br><span class="line"><span class="comment"># 15</span></span><br></pre></td></tr></table></figure>
<p>练习：<br>定义一个斐波那契数列的类，方便调用，计算第n项。<br>增加迭代的方法、返回容器长度、支持索引的方法。  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Fib</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.fib = [<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>] <span class="comment"># 方便阅读，0位添加个数，从1位开始计算</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, index</span>):</span> <span class="comment"># 这里为方便使用改成index </span></span><br><span class="line">        <span class="keyword">if</span> index &lt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> IndexError(<span class="string">&#x27;Wrong Index&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> index &lt; <span class="built_in">len</span>(self.fib):</span><br><span class="line">            <span class="keyword">return</span> self.fib[index]</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(self.fib), index+<span class="number">1</span>):</span><br><span class="line">            self.fib.append(self.fib[x - <span class="number">2</span>] + self.fib[x - <span class="number">1</span>])</span><br><span class="line">        <span class="keyword">return</span> self.fib[index]</span><br><span class="line"></span><br><span class="line">fib = Fib()</span><br><span class="line">print(fib(<span class="number">10</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 55</span></span><br></pre></td></tr></table></figure>
<p>上例中，增加迭代的方法、返回容器长度、支持索引的方法：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Fib</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.fib = [<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>] <span class="comment"># 方便阅读，0位添加个数，从1位开始计算</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, index</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self[index] <span class="comment"># 跳转到__getitem__</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">iter</span>(self.fib)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self.fib)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span>(<span class="params">self, index</span>):</span></span><br><span class="line">        <span class="keyword">if</span> index &lt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> IndexError(<span class="string">&#x27;Wrong Index&#x27;</span>)</span><br><span class="line">        <span class="keyword">elif</span> index &lt; <span class="built_in">len</span>(self.fib):</span><br><span class="line">            <span class="keyword">return</span> self.fib[index]</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(self.fib), index + <span class="number">1</span>):</span><br><span class="line">            self.fib.append(self.fib[x - <span class="number">2</span>] + self.fib[x - <span class="number">1</span>])</span><br><span class="line">        <span class="keyword">return</span> self.fib[index]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">str</span>(self.fib)</span><br><span class="line"></span><br><span class="line">    __repr__ = __str__ <span class="comment"># 间接也是用__str__</span></span><br><span class="line"></span><br><span class="line">fib = Fib()</span><br><span class="line">print(fib(<span class="number">5</span>),<span class="built_in">len</span>(fib)) <span class="comment"># __call__ __len__</span></span><br><span class="line">print(fib(<span class="number">10</span>),<span class="built_in">len</span>(fib)) <span class="comment"># __call__ __len__</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">20</span>)</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> fib: <span class="comment"># __iter__</span></span><br><span class="line">    print(x, end=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line"></span><br><span class="line">print()</span><br><span class="line">print(fib[<span class="number">5</span>],fib[<span class="number">6</span>]) <span class="comment"># __getitem__</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5 6</span></span><br><span class="line"><span class="comment"># 55 11</span></span><br><span class="line"><span class="comment"># --------------------</span></span><br><span class="line"><span class="comment"># 0 1 1 2 3 5 8 13 21 34 55 </span></span><br><span class="line"><span class="comment"># 5 8</span></span><br></pre></td></tr></table></figure><br>上例，可以看出使用类来实现斐波那契数列也是非常好的实现，还可以缓存数据，便于检索。</p>
<h4 id="上下文管理"><a href="#上下文管理" class="headerlink" title="上下文管理"></a>上下文管理</h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">方法</th>
<th style="text-align:left">意义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>__enter__(self)</code></td>
<td style="text-align:left">进入与此对象相关的上下文。如果存在该方法，with语法会把该方法的返回值作为绑定到as子句中指定的变量上</td>
</tr>
<tr>
<td style="text-align:center"><code>__exit__(self, exc_type, exc_val, exc_tb)</code></td>
<td style="text-align:left">退出与此对象先关的上下文</td>
</tr>
</tbody>
</table>
</div>
<p>文件IO操作可以对文件对象实现上下文管理功能，即<code>with...as</code>语法。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 打开名字为test的文件，文件对象作为f</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;test&#x27;</span>) <span class="keyword">as</span> f:<span class="keyword">pass</span></span><br></pre></td></tr></table></figure><br>在文件操作时，<code>with...as</code>语法提供不用文件时自动close文件的功能，这方便了用户的使用，那么类可以这么用吗？<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 简单的测试</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span><span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> A() <span class="keyword">as</span> f:<span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># AttributeError: __enter__</span></span><br></pre></td></tr></table></figure><br>提示属性错误，没有<code>__enter__</code>，某些版本会显示没有<code>__exit__</code>。上例可知，class想使用<code>with...as</code>语句需要调用<code>__enter__</code>和<code>__exit__</code>。</p>
<p>其实在类中，<code>__enter__</code>和<code>__exit__</code>都存在时，它就是属于上下文管理的对象。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;init&#x27;</span>)</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        print(<span class="string">&#x27;init over&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;enter&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span>(<span class="params">self, exc_type, exc_val, exc_tb</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;exit&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> Point() <span class="keyword">as</span> p:</span><br><span class="line">    print(<span class="string">&#x27;with&#x27;</span>)</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    print(<span class="string">&#x27;with over&#x27;</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">&#x27;end&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># init</span></span><br><span class="line"><span class="comment"># init over</span></span><br><span class="line"><span class="comment"># enter</span></span><br><span class="line"><span class="comment"># with</span></span><br><span class="line"><span class="comment"># with over</span></span><br><span class="line"><span class="comment"># exit</span></span><br><span class="line"><span class="comment"># end</span></span><br></pre></td></tr></table></figure>
<p>上例可知，执行顺序：<code>new（Point()实例化）-&gt;init-&gt;p=前面实例化对象-&gt;enter-&gt;with-&gt;exit-&gt;end</code>。<br>实例化对象的时候，并不会调用enter，进入with语句块调用<code>__enter__</code>方法，然后执行语句体，最后离开with语句块的时候，调用<code>__exit__</code>方法。</p>
<p>with可以开启一个上下文运行环境，在执行前做一些准备工作，执行后做一些收尾工作。</p>
<p>注意：with并不开启一个新的作用域。  </p>
<h5 id="上下文管理的安全性"><a href="#上下文管理的安全性" class="headerlink" title="上下文管理的安全性"></a>上下文管理的安全性</h5><p>先看看异常对上下文的影响：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;init&#x27;</span>)</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        print(<span class="string">&#x27;init over&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;enter&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span>(<span class="params">self, exc_type, exc_val, exc_tb</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;exit&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> Point() <span class="keyword">as</span> p:</span><br><span class="line">    print(<span class="string">&#x27;with&#x27;</span>)</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;error&#x27;</span>) <span class="comment"># 测试异常影响</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    print(<span class="string">&#x27;with over&#x27;</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">&#x27;end&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># init</span></span><br><span class="line"><span class="comment"># init over</span></span><br><span class="line"><span class="comment"># enter</span></span><br><span class="line"><span class="comment"># with</span></span><br><span class="line"><span class="comment"># Exception: error</span></span><br><span class="line"><span class="comment"># exit</span></span><br></pre></td></tr></table></figure><br>上例可以看出，enter和exit照常执行。</p>
<p>极端例子：调用<code>sys.exit()</code>，它会直接退出当前解释器。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;init&#x27;</span>)</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        print(<span class="string">&#x27;init over&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;enter&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span>(<span class="params">self, exc_type, exc_val, exc_tb</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;exit&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> Point() <span class="keyword">as</span> p:</span><br><span class="line">    print(<span class="string">&#x27;with&#x27;</span>)</span><br><span class="line">    <span class="keyword">import</span> sys</span><br><span class="line">    sys.exit(<span class="number">1</span>) <span class="comment"># 测试退出解释器影响</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    print(<span class="string">&#x27;with over&#x27;</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">&#x27;end&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># init</span></span><br><span class="line"><span class="comment"># init over</span></span><br><span class="line"><span class="comment"># enter</span></span><br><span class="line"><span class="comment"># with</span></span><br><span class="line"><span class="comment"># exit</span></span><br></pre></td></tr></table></figure><br>从上例执行结果来看，依然执行了<code>__exit__</code>函数，哪怕是退出Python运行环境。</p>
<p>通过上面两例，可以说明<code>上下文管理是安全的</code>！</p>
<h5 id="with语句"><a href="#with语句" class="headerlink" title="with语句"></a>with语句</h5><p>来看看with语句到底是怎么执行的：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 打开一个文件</span></span><br><span class="line">p = <span class="built_in">open</span>(<span class="string">&#x27;animal.py&#x27;</span>)</span><br><span class="line"><span class="keyword">with</span> p <span class="keyword">as</span> f:</span><br><span class="line">    print(p)</span><br><span class="line">    print(f)</span><br><span class="line">    print(f <span class="keyword">is</span> p) <span class="comment"># 打印什么？</span></span><br><span class="line">    print(f == p) <span class="comment"># 打印什么？</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># &lt;_io.TextIOWrapper name=&#x27;animal.py&#x27; mode=&#x27;r&#x27; encoding=&#x27;cp936&#x27;&gt;</span></span><br><span class="line"><span class="comment"># &lt;_io.TextIOWrapper name=&#x27;animal.py&#x27; mode=&#x27;r&#x27; encoding=&#x27;cp936&#x27;&gt;</span></span><br><span class="line"><span class="comment"># True</span></span><br><span class="line"><span class="comment"># True</span></span><br></pre></td></tr></table></figure><br>由上例可知，p所指的对象和f所指的对象是同一个，<code>with...as</code>语句相当于执行了<code>f = p</code>（这是推断）。</p>
<p>其实class要使用<code>with</code>语句，需要有<code>__enter__</code>和<code>__exit__</code>。来看看class中：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;init&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;enter&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span>(<span class="params">self, exc_type, exc_val, exc_tb</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;exit&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p = Point()</span><br><span class="line"><span class="keyword">with</span> p <span class="keyword">as</span> f:</span><br><span class="line">    print(<span class="string">&#x27;with----&#x27;</span>)</span><br><span class="line">    print(p)</span><br><span class="line">    print(f)</span><br><span class="line">    print(f <span class="keyword">is</span> p)</span><br><span class="line">    print(f == p)</span><br><span class="line">    print(<span class="string">&#x27;with over----&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># init</span></span><br><span class="line"><span class="comment"># enter</span></span><br><span class="line"><span class="comment"># with----</span></span><br><span class="line"><span class="comment"># &lt;__main__.Point object at 0x00000259DF473208&gt;</span></span><br><span class="line"><span class="comment"># None</span></span><br><span class="line"><span class="comment"># False</span></span><br><span class="line"><span class="comment"># False</span></span><br><span class="line"><span class="comment"># with over----</span></span><br><span class="line"><span class="comment"># exit</span></span><br></pre></td></tr></table></figure><br>上例发现，p确实指向了<code>Ponit()</code>，但是f却是<code>None</code>，并没有实现类似<code>f = p</code>效果，这是为什么呢？</p>
<p>问题出在<code>__enter__</code>方法上面，它将自己的返回值赋值给<code>f</code>，修改上例：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;init&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;enter&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> self <span class="comment"># 修改此处，使其有返回值</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span>(<span class="params">self, exc_type, exc_val, exc_tb</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;exit&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p = Point()</span><br><span class="line"><span class="keyword">with</span> p <span class="keyword">as</span> f:</span><br><span class="line">    print(<span class="string">&#x27;with----&#x27;</span>)</span><br><span class="line">    print(p)</span><br><span class="line">    print(f)</span><br><span class="line">    print(f <span class="keyword">is</span> p)</span><br><span class="line">    print(f == p)</span><br><span class="line">    print(<span class="string">&#x27;with over----&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># init</span></span><br><span class="line"><span class="comment"># enter</span></span><br><span class="line"><span class="comment"># with----</span></span><br><span class="line"><span class="comment"># &lt;__main__.Point object at 0x0000016F24DC3208&gt;</span></span><br><span class="line"><span class="comment"># &lt;__main__.Point object at 0x0000016F24DC3208&gt;</span></span><br><span class="line"><span class="comment"># True</span></span><br><span class="line"><span class="comment"># True</span></span><br><span class="line"><span class="comment"># with over----</span></span><br><span class="line"><span class="comment"># exit</span></span><br></pre></td></tr></table></figure><br>上例可知，<code>with...as</code>成功实现类似<code>f = p</code>效果，实际上执行的是<code>f = p.__enter__()</code>。<br><code>with</code>语法，在开始时会使用<code>with</code>后面对象的<code>__enter__</code>方法，在结束时会使用<code>__exit__</code>方法，如果有<code>as</code>，则将该方法的返回值赋值给<code>as</code>子句的变量。</p>
<h5 id="方法的参数"><a href="#方法的参数" class="headerlink" title="方法的参数"></a>方法的参数</h5><p><code>__enter__(self)</code>方法没有其他参数。</p>
<p><code>__exit__(self, exc_type, exc_val, exc_tb)</code>，<br>有3个参数：  </p>
<ul>
<li><code>exc_type</code>，异常类型。</li>
<li><code>exc_value</code>，异常的值。</li>
<li><code>exc_tb</code>，异常的追踪信息。</li>
<li><code>__exit__</code>方法返回一个等效True的值，则压制异常；否则，继续抛出异常</li>
</ul>
<p>这三个参数都与异常有关。<br>如果该上下文退出时没有异常，这3个参数都为None。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;init&#x27;</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;enter&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> self  <span class="comment"># 增加返回值</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span>(<span class="params">self, exc_type, exc_val, exc_tb</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;exit-------&#x27;</span>)</span><br><span class="line">        print(<span class="number">1</span>, exc_type) <span class="comment"># 异常类型</span></span><br><span class="line">        print(<span class="number">2</span>, exc_val) <span class="comment"># 异常值</span></span><br><span class="line">        print(<span class="number">3</span>, exc_tb) <span class="comment"># 异常追踪traceback</span></span><br><span class="line">        print(<span class="string">&#x27;exit over--------&#x27;</span>)</span><br><span class="line">        <span class="comment"># return None # 无法压制异常，等价False</span></span><br><span class="line">        <span class="comment"># return 0 # 无法压制异常，等价False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;a&#x27;</span> <span class="comment"># 可以压制异常，等价True</span></span><br><span class="line"></span><br><span class="line">p = Point()</span><br><span class="line"><span class="keyword">with</span> p <span class="keyword">as</span> f:</span><br><span class="line">    print(<span class="string">&#x27;with&#x27;</span>)</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Error&#x27;</span>)</span><br><span class="line">    print(<span class="string">&#x27;with over&#x27;</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">&#x27;end&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># init</span></span><br><span class="line"><span class="comment"># enter</span></span><br><span class="line"><span class="comment"># with</span></span><br><span class="line"><span class="comment"># exit-------</span></span><br><span class="line"><span class="comment"># 1 &lt;class &#x27;Exception&#x27;&gt;</span></span><br><span class="line"><span class="comment"># 2 Error</span></span><br><span class="line"><span class="comment"># 3 &lt;traceback object at 0x0000016925304A48&gt;</span></span><br><span class="line"><span class="comment"># exit over--------</span></span><br><span class="line"><span class="comment"># end</span></span><br></pre></td></tr></table></figure>
<h5 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h5><p>为加法函数计时，显示该函数的执行时长？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 加法函数</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x, y</span>):</span></span><br><span class="line">    time.sleep(<span class="number">2</span>) <span class="comment"># 增加时间</span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br></pre></td></tr></table></figure>
<p>第一种，普通装饰器实现：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">timeit</span>(<span class="params">fn</span>):</span></span><br><span class="line"><span class="meta">    @wraps(fn)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">*args,**kwargs</span>):</span></span><br><span class="line">        start = datetime.datetime.now()</span><br><span class="line">        ret = fn(*args,**kwargs)</span><br><span class="line">        delta = (datetime.datetime.now() - start).total_seconds()</span><br><span class="line">        print(<span class="string">&#x27;&#123;&#125; took &#123;&#125;s&#x27;</span>.<span class="built_in">format</span>(fn.__name__,delta))</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@timeit # add = timeit(add)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x, y</span>):</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line">print(add(<span class="number">4</span>,<span class="number">5</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># add took 2.000874s</span></span><br><span class="line"><span class="comment"># 9</span></span><br></pre></td></tr></table></figure></p>
<p>第二种，上下文管理实现：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x, y</span>):</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Timeit</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, fn</span>):</span></span><br><span class="line">        self.fn = fn</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.start = datetime.datetime.now()</span><br><span class="line">        <span class="keyword">return</span> self.fn <span class="comment"># 返回函数名</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span>(<span class="params">self, exc_type, exc_val, exc_tb</span>):</span></span><br><span class="line">        delta = (datetime.datetime.now() - self.start).total_seconds()</span><br><span class="line">        print(<span class="string">&#x27;&#123;&#125; took &#123;&#125;s&#x27;</span>.<span class="built_in">format</span>(self.fn.__name__, delta)) <span class="comment"># 是在退出时输出</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> Timeit(add) <span class="keyword">as</span> f: <span class="comment"># f = add</span></span><br><span class="line">    print(f(<span class="number">4</span>,<span class="number">5</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 9</span></span><br><span class="line"><span class="comment"># add took 2.000221s</span></span><br></pre></td></tr></table></figure><br>上例，注意输出的顺序，先执行<code>print(f(4,5))</code>，后执行<code>print(&#39;&#123;&#125; took &#123;&#125;s&#39;.format(self.fn.__name__, delta))</code>。</p>
<p>第三种，使用可调用对象实现：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x, y</span>):</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Timeit</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, fn</span>):</span></span><br><span class="line">        self.fn = fn</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.start = datetime.datetime.now()</span><br><span class="line">        <span class="keyword">return</span> self <span class="comment"># 返回实例</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span>(<span class="params">self, exc_type, exc_val, exc_tb</span>):</span></span><br><span class="line">        delta = (datetime.datetime.now() - self.start).total_seconds()</span><br><span class="line">        print(<span class="string">&#x27;&#123;&#125; took &#123;&#125;s&#x27;</span>.<span class="built_in">format</span>(self.fn.__name__, delta))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, x, y</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.fn(x,y) <span class="comment"># 返回计算的值</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> Timeit(add) <span class="keyword">as</span> f: <span class="comment"># f = Timeit(add)</span></span><br><span class="line">    print(f(<span class="number">4</span>,<span class="number">5</span>)) <span class="comment"># Timeit(add)(4,5)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 9</span></span><br><span class="line"><span class="comment"># add took 2.000224s</span></span><br></pre></td></tr></table></figure><br>第四种，把类当做装饰器用：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Timeit</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, fn</span>):</span></span><br><span class="line">        self.fn = fn</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, x, y</span>):</span></span><br><span class="line">        self.start = datetime.datetime.now()</span><br><span class="line">        ret = self.fn(x, y) <span class="comment"># 计算</span></span><br><span class="line">        delta = (datetime.datetime.now() - self.start).total_seconds()</span><br><span class="line">        print(<span class="string">&#x27;&#123;&#125; took &#123;&#125;s&#x27;</span>.<span class="built_in">format</span>(self.fn.__name__, delta))</span><br><span class="line">        <span class="keyword">return</span> ret <span class="comment"># 返回结果</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Timeit # add = Timeit(add)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x, y</span>):</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line">print(add(<span class="number">4</span>,<span class="number">5</span>)) <span class="comment"># Timeit(add)(4,5)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># add took 2.000056s</span></span><br><span class="line"><span class="comment"># 9</span></span><br></pre></td></tr></table></figure><br>思考：使用类装饰器，如何解决文档字符串问题？<br>方法一，直接修改<code>__doc__</code>：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Timeit</span>:</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;This is Timeit&quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, fn</span>):</span></span><br><span class="line">        self.fn = fn</span><br><span class="line">        self.__doc__ = fn.__doc__ <span class="comment"># 把函数对象的文档字符串赋值给实例字符串</span></span><br></pre></td></tr></table></figure><br>方法二，使用<code>functools.wraps</code>函数：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps, update_wrapper</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Timeit</span>:</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;This is Timeit&quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, fn</span>):</span></span><br><span class="line">        self.fn = fn</span><br><span class="line">        <span class="comment"># wrapper=self,wrapped=fn</span></span><br><span class="line">        <span class="comment"># fn的属性装饰到self上</span></span><br><span class="line">        update_wrapper(self, fn)</span><br></pre></td></tr></table></figure><br>使用<code>wraps</code>装饰，<code>wraps</code>使用的是pratial偏函数：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps, update_wrapper</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Timeit</span>:</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;This is Timeit&quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, fn</span>):</span></span><br><span class="line">        self.fn = fn</span><br><span class="line">        <span class="comment"># wrapper=self,wrapped=fn</span></span><br><span class="line">        <span class="comment"># fn的属性装饰到self上</span></span><br><span class="line">        wraps(fn)(self)</span><br></pre></td></tr></table></figure><br>有兴趣的可以看我的<code>funtools.wraps</code>讲解，这里简单讲解下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wraps</span>(<span class="params">wrapped,</span></span></span><br><span class="line"><span class="function"><span class="params">          assigned = WRAPPER_ASSIGNMENTS,</span></span></span><br><span class="line"><span class="function"><span class="params">          updated = WRAPPER_UPDATES</span>):</span></span><br><span class="line">                <span class="comment"># 略</span></span><br><span class="line"><span class="keyword">return</span> partial(update_wrapper, wrapped=wrapped,</span><br><span class="line">                   assigned=assigned, updated=updated)</span><br></pre></td></tr></table></figure><br><code>partial</code>返回的是一个固定了<code>wrapped</code>的新函数，新函数需要给<code>wrapper</code>参数，所以就是<code>wraps(fn)(self)</code>形式。</p>
<p>测试一下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps, update_wrapper</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Timeit</span>:</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;This is Timeit&quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, fn</span>):</span></span><br><span class="line">        self.fn = fn</span><br><span class="line">        <span class="comment"># wrapper=self,wrapped=fn</span></span><br><span class="line">        <span class="comment"># fn的属性装饰到self上</span></span><br><span class="line">        wraps(fn)(self)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, x, y</span>):</span></span><br><span class="line">        self.start = datetime.datetime.now()</span><br><span class="line">        ret = self.fn(x, y) <span class="comment"># 计算</span></span><br><span class="line">        delta = (datetime.datetime.now() - self.start).total_seconds()</span><br><span class="line">        print(<span class="string">&#x27;&#123;&#125; took &#123;&#125;s&#x27;</span>.<span class="built_in">format</span>(self.fn.__name__, delta))</span><br><span class="line">        <span class="keyword">return</span> ret <span class="comment"># 返回结果</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Timeit # add = Timeit(add) -&gt; add = Timeit的实例 -&gt; add = self</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x, y</span>):</span> </span><br><span class="line">    <span class="string">&quot;&quot;&quot;This is add&quot;&quot;&quot;</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line">print(add.__doc__) <span class="comment"># 检测</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This is add</span></span><br></pre></td></tr></table></figure><br>测试成功，实现了属性转换。</p>
<h5 id="上下文应用场景"><a href="#上下文应用场景" class="headerlink" title="上下文应用场景"></a>上下文应用场景</h5><ul>
<li>增强功能：在代码执行的前后增加代码，以增强其功能。类似装饰器的功能。</li>
<li>资源管理：打开了资源需要关闭，例如文件对象、网络连接、数据库连接等。</li>
<li>权限验证：在执行代码之前，做权限的验证，在<code>__enter__</code>中处理。</li>
</ul>
<h5 id="contextlib-contextmanager"><a href="#contextlib-contextmanager" class="headerlink" title="contextlib.contextmanager"></a>contextlib.contextmanager</h5><p><code>contextlib.contextmanager</code>它是一个装饰器实现上下文管理，装饰一个<code>函数</code>，而不用像类一样实现<code>__enter__</code>和<code>__exit__</code>方法。  </p>
<p>对下面的函数有要求：必须有<code>yield</code>，也就是这个函数必须返回一个<code>生成器</code>，<code>且只有yield一个值</code>。</p>
<p>也就是这个装饰器接收一个生成器对象（因为必须有<code>yield</code>）作为参数。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> contextlib</span><br><span class="line"><span class="meta">@contextlib.contextmanager</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span>():</span> <span class="comment">#</span></span><br><span class="line">    print(<span class="string">&#x27;enter&#x27;</span>) <span class="comment"># 相当于__enter__()</span></span><br><span class="line">    <span class="keyword">yield</span>  <span class="number">100</span> <span class="comment"># yield 5，yield的值只能有一个，作为__enter__方法的返回值</span></span><br><span class="line">    print(<span class="string">&#x27;exit&#x27;</span>) <span class="comment"># 相当于__exit__()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> foo() <span class="keyword">as</span> f:</span><br><span class="line">    <span class="comment">#raise Exception() # 有异常不能执行print(&#x27;exit&#x27;)</span></span><br><span class="line">    print(f)</span><br><span class="line"></span><br><span class="line"><span class="comment"># enter</span></span><br><span class="line"><span class="comment"># 100</span></span><br><span class="line"><span class="comment"># exit</span></span><br></pre></td></tr></table></figure><br>f接收<code>yield</code>的返回值。</p>
<p>上面的程序看似不错但是，增加一个异常试一试，发现不能保证exit的执行，怎么办？<br>增加<code>try</code>和<code>finally</code>！<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> contextlib</span><br><span class="line"></span><br><span class="line"><span class="meta">@contextlib.contextmanager</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span>():</span> </span><br><span class="line">    print(<span class="string">&#x27;enter&#x27;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">yield</span> <span class="number">100</span>  <span class="comment"># yield 5，yield的值只能有一个，作为__enter__方法的返回值</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        print(<span class="string">&#x27;exit&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> foo() <span class="keyword">as</span> f: <span class="comment"># f = 100</span></span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;wrong&#x27;</span>)</span><br><span class="line">    print(f)</span><br><span class="line"></span><br><span class="line"><span class="comment"># enter</span></span><br><span class="line"><span class="comment"># Exception: wrong</span></span><br><span class="line"><span class="comment"># exit</span></span><br></pre></td></tr></table></figure><br>上例，在<code>yield 100 -&gt; f = 100</code>执行完，开始执行<code>raise Exception(&#39;wrong&#39;)</code>，报错后会去执行<code>finally</code>下的语句。</p>
<p>上例这么做有什么意义呢？<br>当<code>yield</code>发生处为生成器函数增加了上下文管理。这是为函数增加上下文机制的方式。</p>
<p>总结：</p>
<ul>
<li>把yield之前的当做<strong>enter</strong>方法执行。</li>
<li>把yield的值作为<strong>enter</strong>的返回值。</li>
<li>把yield之后的当做<strong>exit</strong>方法执行。</li>
</ul>
<p>如果业务逻辑简单可以使用函数加<code>contextlib.contextmanager</code>装饰器方式，如果业务复杂，用类的方式加<code>__enter__</code>和<code>__exit__</code>方法方便。</p>
<h4 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h4><p>反射（reflection），指的是运行时获取类型定义信息。<br>注：运行时，是指程序被加载到内存中执行的时候。编译时，是指程序执行前编译成字节码的阶段。</p>
<p>简单说，在Python中通过<code>某种函数或对象</code>，找出其它对象type、class、attribute、method的能力，这种过程称为反射或者自省。</p>
<p>具有反射能力的函数有<code>type()</code>、<code>isinstance()</code>、<code>callable()</code>、<code>dir()</code>、<code>getattr()</code>等。</p>
<h5 id="反射相关的函数和方法"><a href="#反射相关的函数和方法" class="headerlink" title="反射相关的函数和方法"></a>反射相关的函数和方法</h5><p>定一个坐标类Point，查看它的属性，并修改它，动态为实例增加属性。：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, x, y</span>):</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Point(&#123;&#125;, &#123;&#125;)&quot;</span>.<span class="built_in">format</span>(self.x, self.y)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(self.x, self.y)</span><br><span class="line"></span><br><span class="line">p = Point(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">print(p) <span class="comment"># __str__</span></span><br><span class="line">print(p.__dict__)</span><br><span class="line">p.__dict__[<span class="string">&#x27;y&#x27;</span>] = <span class="number">16</span> <span class="comment"># 通过实例字典改属性的值</span></span><br><span class="line">print(p.__dict__)</span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">30</span>)</span><br><span class="line">p.z = <span class="number">10</span></span><br><span class="line">print(p.__dict__)</span><br><span class="line">print(<span class="built_in">dir</span>(p)) <span class="comment"># ordered list</span></span><br><span class="line">print(p.__dir__()) <span class="comment"># list</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Point(4, 5)</span></span><br><span class="line"><span class="comment"># &#123;&#x27;x&#x27;: 4, &#x27;y&#x27;: 5&#125;</span></span><br><span class="line"><span class="comment"># &#123;&#x27;x&#x27;: 4, &#x27;y&#x27;: 16&#125;</span></span><br><span class="line"><span class="comment"># ------------------------------</span></span><br><span class="line"><span class="comment"># &#123;&#x27;x&#x27;: 4, &#x27;y&#x27;: 16, &#x27;z&#x27;: 10&#125;</span></span><br><span class="line"><span class="comment"># [&#x27;__class__&#x27;, &#x27;__delattr__&#x27;, &#x27;__dict__&#x27;, &#x27;__dir__&#x27;, &#x27;__doc__&#x27;, &#x27;__eq__&#x27;, &#x27;__format__&#x27;, &#x27;__ge__&#x27;, &#x27;__getattribute__&#x27;, &#x27;__gt__&#x27;, &#x27;__hash__&#x27;, &#x27;__init__&#x27;, &#x27;__init_subclass__&#x27;, &#x27;__le__&#x27;, &#x27;__lt__&#x27;, &#x27;__module__&#x27;, &#x27;__ne__&#x27;, &#x27;__new__&#x27;, &#x27;__reduce__&#x27;, &#x27;__reduce_ex__&#x27;, &#x27;__repr__&#x27;, &#x27;__setattr__&#x27;, &#x27;__sizeof__&#x27;, &#x27;__str__&#x27;, &#x27;__subclasshook__&#x27;, &#x27;__weakref__&#x27;, &#x27;show&#x27;, &#x27;x&#x27;, &#x27;y&#x27;, &#x27;z&#x27;]</span></span><br><span class="line"><span class="comment"># [&#x27;x&#x27;, &#x27;y&#x27;, &#x27;z&#x27;, &#x27;__module__&#x27;, &#x27;__init__&#x27;, &#x27;__str__&#x27;, &#x27;show&#x27;, &#x27;__dict__&#x27;, &#x27;__weakref__&#x27;, &#x27;__doc__&#x27;, &#x27;__repr__&#x27;, &#x27;__hash__&#x27;, &#x27;__getattribute__&#x27;, &#x27;__setattr__&#x27;, &#x27;__delattr__&#x27;, &#x27;__lt__&#x27;, &#x27;__le__&#x27;, &#x27;__eq__&#x27;, &#x27;__ne__&#x27;, &#x27;__gt__&#x27;, &#x27;__ge__&#x27;, &#x27;__new__&#x27;, &#x27;__reduce_ex__&#x27;, &#x27;__reduce__&#x27;, &#x27;__subclasshook__&#x27;, &#x27;__init_subclass__&#x27;, &#x27;__format__&#x27;, &#x27;__sizeof__&#x27;, &#x27;__dir__&#x27;, &#x27;__class__&#x27;]</span></span><br></pre></td></tr></table></figure><br>上例通过属性字典<code>__dict__</code>来访问和修改对象的属性，本质上也是利用了反射。并且使用<code>p.z = 10</code>为实例增加了一个属性<code>z</code>。</p>
<p>但上例的方式并不优雅，Python提供了内置的函数：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">方法</th>
<th style="text-align:left">意义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>getattr(object,name[, default])</code></td>
<td style="text-align:left">通过name返回object的属性值。当属性不存在，使用default返回，如果没有default，则抛出AttributeError。name必须是字符串形式。</td>
</tr>
<tr>
<td style="text-align:center"><code>setattr(object,name, value)</code></td>
<td style="text-align:left">object的属性存在，则覆盖，不存在，新增。name必须是字符串形式，注意和<code>__getattr__</code>的区别。</td>
</tr>
<tr>
<td style="text-align:center"><code>hasattr(object,name)</code></td>
<td style="text-align:left">判断对象是否有name属性，返回bool。name必须是字符串形式。</td>
</tr>
</tbody>
</table>
</div>
<p>使用内置函数的做法：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, x, y</span>):</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Point(&#123;&#125;, &#123;&#125;)&quot;</span>.<span class="built_in">format</span>(self.x, self.y)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(self)</span><br><span class="line"></span><br><span class="line">    __repr__ = __str__</span><br><span class="line"></span><br><span class="line">p1 = Point(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">print(<span class="built_in">repr</span>(p1))</span><br><span class="line">print(p1.__dict__)</span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">30</span>)</span><br><span class="line"><span class="built_in">setattr</span>(p1, <span class="string">&#x27;y&#x27;</span>, <span class="number">16</span>) <span class="comment"># 有属性y，所以是覆盖</span></span><br><span class="line"><span class="built_in">setattr</span>(p1, <span class="string">&#x27;z&#x27;</span>, <span class="number">10</span>) <span class="comment"># 无属性z，所以是新增</span></span><br><span class="line">print(<span class="built_in">getattr</span>(p1, <span class="string">&#x27;__dict__&#x27;</span>))</span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">30</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 动态调用方法</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">hasattr</span>(p1, <span class="string">&#x27;show&#x27;</span>): <span class="comment"># 如果p1有show方法</span></span><br><span class="line">    <span class="built_in">getattr</span>(p1, <span class="string">&#x27;show&#x27;</span>)() <span class="comment"># 就取出方法并执行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 动态增加方法</span></span><br><span class="line"><span class="comment"># 类增加，实例使用是绑定</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(Point, <span class="string">&#x27;add&#x27;</span>): <span class="comment"># 如果p1没有add方法</span></span><br><span class="line">    <span class="comment"># 类就增加add方法，把两个坐标相加</span></span><br><span class="line">    <span class="built_in">setattr</span>(Point, <span class="string">&#x27;add&#x27;</span>, <span class="keyword">lambda</span> self,other: Point(self.x + other.x, self.y + other.y))</span><br><span class="line"></span><br><span class="line">print(Point.add) <span class="comment"># 类调用新增的add方法，未绑定</span></span><br><span class="line">print(p1.add) <span class="comment"># 实例调用新增的add方法，绑定</span></span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">30</span>)</span><br><span class="line">p2 = Point(<span class="number">10</span>, <span class="number">10</span>)</span><br><span class="line">print(p1.add(p2)) <span class="comment"># 注意，实例调用是绑定的，相当于传了self参数（p1）</span></span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">30</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实例增加，实例使用是未绑定</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(p1, <span class="string">&#x27;sub&#x27;</span>): <span class="comment"># 如果p1没有sub方法</span></span><br><span class="line">    <span class="comment"># 实例就增加sub方法，把两个坐标相减</span></span><br><span class="line">    <span class="built_in">setattr</span>(p1, <span class="string">&#x27;sub&#x27;</span>, <span class="keyword">lambda</span> self, other: Point(self.x - other.x, self.y - other.y))</span><br><span class="line"></span><br><span class="line">print(p1.sub) <span class="comment"># 实例调用新增的sub方法，未绑定</span></span><br><span class="line">print(p1.sub(p1, p1)) <span class="comment"># 注意，这是未绑定的，sub是普通函数</span></span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">30</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># add在谁里面，sub在谁里面</span></span><br><span class="line">print(Point.__dict__) <span class="comment"># add在Point里面</span></span><br><span class="line">print(p1.__dict__) <span class="comment"># sub在p1里面</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Point(4, 5)</span></span><br><span class="line"><span class="comment"># &#123;&#x27;x&#x27;: 4, &#x27;y&#x27;: 5&#125;</span></span><br><span class="line"><span class="comment"># ------------------------------</span></span><br><span class="line"><span class="comment"># &#123;&#x27;x&#x27;: 4, &#x27;y&#x27;: 16, &#x27;z&#x27;: 10&#125;</span></span><br><span class="line"><span class="comment"># ------------------------------</span></span><br><span class="line"><span class="comment"># Point(4, 16)</span></span><br><span class="line"><span class="comment"># &lt;function &lt;lambda&gt; at 0x000001F1ECBB1E18&gt;</span></span><br><span class="line"><span class="comment"># &lt;bound method &lt;lambda&gt; of Point(4, 16)&gt;</span></span><br><span class="line"><span class="comment"># ------------------------------</span></span><br><span class="line"><span class="comment"># Point(14, 26)</span></span><br><span class="line"><span class="comment"># ------------------------------</span></span><br><span class="line"><span class="comment"># &lt;function &lt;lambda&gt; at 0x000001F1ECD88A60&gt;</span></span><br><span class="line"><span class="comment"># Point(0, 0)</span></span><br><span class="line"><span class="comment"># ------------------------------</span></span><br><span class="line"><span class="comment"># &#123;&#x27;__module__&#x27;: &#x27;__main__&#x27;, &#x27;__init__&#x27;: &lt;function Point.__init__ at 0x000001F1ECD888C8&gt;, &#x27;__str__&#x27;: &lt;function Point.__str__ at 0x000001F1ECD88950&gt;, &#x27;show&#x27;: &lt;function Point.show at 0x000001F1ECD889D8&gt;, &#x27;__repr__&#x27;: &lt;function Point.__str__ at 0x000001F1ECD88950&gt;, &#x27;__dict__&#x27;: &lt;attribute &#x27;__dict__&#x27; of &#x27;Point&#x27; objects&gt;, &#x27;__weakref__&#x27;: &lt;attribute &#x27;__weakref__&#x27; of &#x27;Point&#x27; objects&gt;, &#x27;__doc__&#x27;: None, &#x27;add&#x27;: &lt;function &lt;lambda&gt; at 0x000001F1ECBB1E18&gt;&#125;</span></span><br><span class="line"><span class="comment"># &#123;&#x27;x&#x27;: 4, &#x27;y&#x27;: 16, &#x27;z&#x27;: 10, &#x27;sub&#x27;: &lt;function &lt;lambda&gt; at 0x000001F1ECD88A60&gt;&#125;</span></span><br></pre></td></tr></table></figure><br>注意新增的方法，实例在调用时是否是绑定的！</p>
<p>思考：<br>这种动态增加属性的方式和装饰器修饰一个类、Mixin方式的差异？<br><code>装饰器</code>或<code>Mixin</code>都是定义时就决定了，但是反射这种动态增删属性的方式是运行时改变类或者实例的方式，因此反射更具有更大的灵活性。</p>
<p>比如做一个命令分发器：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dispatcher</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reg</span>(<span class="params">self, name, fn</span>):</span></span><br><span class="line">        <span class="built_in">setattr</span>(self, name, fn)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            cmd = <span class="built_in">input</span>(<span class="string">&#x27;&gt;&gt;&gt;&#x27;</span>).strip()</span><br><span class="line">            <span class="keyword">if</span> cmd == <span class="string">&#x27;quit&#x27;</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="built_in">getattr</span>(self, cmd, <span class="keyword">lambda</span>:print(<span class="string">&#x27;Unknown Cmd &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(cmd)))()</span><br><span class="line">    </span><br><span class="line">dis = Dispatcher()</span><br><span class="line">dis.reg(<span class="string">&#x27;ls&#x27;</span>, <span class="keyword">lambda</span> :print(<span class="string">&#x27;ls&#x27;</span>)) <span class="comment"># 先注册ls函数</span></span><br><span class="line">dis.run() <span class="comment"># 启动</span></span><br></pre></td></tr></table></figure><br>上例中使用<code>getattr</code>方法找到对象的属性和<code>setattr</code>方法注册函数的方式，比自己维护一个字典来建立名称和函数之间的关系的方式好多了。</p>
<h5 id="反射相关的魔术方法"><a href="#反射相关的魔术方法" class="headerlink" title="反射相关的魔术方法"></a>反射相关的魔术方法</h5><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">方法</th>
<th style="text-align:left">意义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>__getattr__(self, item)</code></td>
<td style="text-align:left">当通过搜素实例，实例的类及祖先类<code>查不到</code>属性，就会调用此方法。</td>
</tr>
<tr>
<td style="text-align:center"><code>__setattr__(self, key, value)</code></td>
<td style="text-align:left">通过 <code>.</code> 访问实例属性，进行增加、修改都要调用它。</td>
</tr>
<tr>
<td style="text-align:center"><code>__delattr__(self, item)</code></td>
<td style="text-align:left">当通过实例来删除属性时，调用此方法。</td>
</tr>
<tr>
<td style="text-align:center"><code>__getattribute__(self, item)</code></td>
<td style="text-align:left">实例所有的属性调用都从这个方法开始。</td>
</tr>
</tbody>
</table>
</div>
<p>先来看看<code>__getattr__</code>的例子：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span>:</span></span><br><span class="line">    n = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>(<span class="params">Base</span>):</span></span><br><span class="line">    z = <span class="number">6</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, x, y</span>):</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(self.x, self.y)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span>(<span class="params">self, item</span>):</span> <span class="comment"># 都找不到是调用此方法</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;missing &#123;&#125;&quot;</span>.<span class="built_in">format</span>(item)</span><br><span class="line"></span><br><span class="line">p1 = Point(<span class="number">4</span>,<span class="number">5</span>)</span><br><span class="line">print(p1.x, p1.y)</span><br><span class="line">print(p1.z)</span><br><span class="line">print(p1.n)</span><br><span class="line">print(p1.t) <span class="comment"># 没有t，调用__getattr__</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4 5</span></span><br><span class="line"><span class="comment"># 6</span></span><br><span class="line"><span class="comment"># 0</span></span><br><span class="line"><span class="comment"># missing t</span></span><br></pre></td></tr></table></figure><br>上例可知，一个类的属性会按照继承关系查找，如果都找不到，就会执行<code>__getattr__</code>方法，如果没有这个方法，就会抛出AttributeError异常，表示找不到这个属性。</p>
<p>上例查找顺序：<code>instance.__dict__-&gt;instance.__class__.dict-&gt;祖先类(直到object)的__dict__-&gt;都没有调用__getattr__</code>。</p>
<p><code>__setattr__</code>例子：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span>:</span></span><br><span class="line">    n = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>(<span class="params">Base</span>):</span></span><br><span class="line">    z = <span class="number">6</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, x, y</span>):</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(self.x, self.y)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span>(<span class="params">self, item</span>):</span> <span class="comment"># 都找不到是调用此方法</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;missing &#123;&#125;&quot;</span>.<span class="built_in">format</span>(item)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span>(<span class="params">self, key, value</span>):</span> <span class="comment"># 通过实例增加属时调用</span></span><br><span class="line">        print(<span class="string">&quot;setattr &#123;&#125;=&#123;&#125;&quot;</span>.<span class="built_in">format</span>(key, value))</span><br><span class="line"></span><br><span class="line">p1 = Point(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">print(p1.x) <span class="comment"># 为什么找不到？</span></span><br><span class="line">p1.x = <span class="number">50</span></span><br><span class="line">print(p1.__dict__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># setattr x=4</span></span><br><span class="line"><span class="comment"># setattr y=5</span></span><br><span class="line"><span class="comment"># missing x</span></span><br><span class="line"><span class="comment"># setattr x=50</span></span><br><span class="line"><span class="comment"># &#123;&#125;</span></span><br></pre></td></tr></table></figure><br>上例中，其实在对p1初始化时，就调用了<code>__setattr__</code>方法，而在这个方法中只是做了print，并没有往实例字典中添加属性，所以找不到<code>p1.x</code>属性，从<code>p1.__dict__</code>中就可以看出来了。</p>
<p>也就是说<code>__setattr__</code>方法，可以<code>拦截通过实例对其属性的增加、修改操作</code>，如果要设置生效，需要自己操作实例的<code>__dict__</code>。</p>
<p>上例只需把拦截的属性添加到一个字典中存储即可，以后都对这个字典操作：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span>:</span></span><br><span class="line">    n = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>(<span class="params">Base</span>):</span></span><br><span class="line">    z = <span class="number">6</span></span><br><span class="line">    d = &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, x, y</span>):</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(self.x, self.y)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span>(<span class="params">self, item</span>):</span> <span class="comment"># 都找不到是调用此方法</span></span><br><span class="line">        <span class="comment"># return &quot;missing &#123;&#125;&quot;.format(item)</span></span><br><span class="line">        <span class="keyword">return</span> self.d[item]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span>(<span class="params">self, key, value</span>):</span> <span class="comment"># 通过实例增加属时调用</span></span><br><span class="line">        <span class="comment"># print(&quot;setattr &#123;&#125;=&#123;&#125;&quot;.format(key, value))</span></span><br><span class="line">        self.d[key] = value</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p1 = Point(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">print(p1.d)</span><br><span class="line">p1.x = <span class="number">50</span></span><br><span class="line">print(p1.d)</span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">20</span>)</span><br><span class="line">print(p1.__dict__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># &#123;&#x27;x&#x27;: 4, &#x27;y&#x27;: 5&#125;</span></span><br><span class="line"><span class="comment"># &#123;&#x27;x&#x27;: 50, &#x27;y&#x27;: 5&#125;</span></span><br><span class="line"><span class="comment"># --------------------</span></span><br><span class="line"><span class="comment"># &#123;&#125;</span></span><br></pre></td></tr></table></figure></p>
<p><code>__delattr__</code>例子:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span>:</span></span><br><span class="line">    n = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>(<span class="params">Base</span>):</span></span><br><span class="line">    z = <span class="number">6</span></span><br><span class="line">    d = &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, x, y</span>):</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(self.x, self.y)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span>(<span class="params">self, item</span>):</span> <span class="comment"># 都找不到是调用此方法</span></span><br><span class="line">        <span class="comment"># return &quot;missing &#123;&#125;&quot;.format(item)</span></span><br><span class="line">        <span class="keyword">return</span> self.d[item]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span>(<span class="params">self, key, value</span>):</span> <span class="comment"># 通过实例增加属时调用</span></span><br><span class="line">        <span class="comment"># print(&quot;setattr &#123;&#125;=&#123;&#125;&quot;.format(key, value))</span></span><br><span class="line">        self.d[key] = value</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__delattr__</span>(<span class="params">self, item</span>):</span> <span class="comment"># 通过实例删除属性时调用</span></span><br><span class="line">        print(<span class="string">&quot;Can&#x27;t del &#123;&#125;&quot;</span>.<span class="built_in">format</span>(item))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p1 = Point(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">print(p1.d)</span><br><span class="line"><span class="keyword">del</span> p1.x</span><br><span class="line"><span class="keyword">del</span> p1.z</span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">20</span>)</span><br><span class="line">print(Point.__dict__)</span><br><span class="line"><span class="keyword">del</span> Point.z</span><br><span class="line">print(Point.__dict__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># &#123;&#x27;x&#x27;: 4, &#x27;y&#x27;: 5&#125;</span></span><br><span class="line"><span class="comment"># Can&#x27;t del x</span></span><br><span class="line"><span class="comment"># Can&#x27;t del z</span></span><br><span class="line"><span class="comment"># --------------------</span></span><br><span class="line"><span class="comment"># &#123;&#x27;__module__&#x27;: &#x27;__main__&#x27;, &#x27;z&#x27;: 6, &#x27;d&#x27;: &#123;&#x27;x&#x27;: 4, &#x27;y&#x27;: 5&#125;, &#x27;__init__&#x27;: &lt;function Point.__init__ at 0x0000020670D288C8&gt;, &#x27;show&#x27;: &lt;function Point.show at 0x0000020670D28950&gt;, &#x27;__getattr__&#x27;: &lt;function Point.__getattr__ at 0x0000020670D289D8&gt;, &#x27;__setattr__&#x27;: &lt;function Point.__setattr__ at 0x0000020670D28A60&gt;, &#x27;__delattr__&#x27;: &lt;function Point.__delattr__ at 0x0000020670D28AE8&gt;, &#x27;__doc__&#x27;: None&#125;</span></span><br><span class="line"><span class="comment"># &#123;&#x27;__module__&#x27;: &#x27;__main__&#x27;, &#x27;d&#x27;: &#123;&#x27;x&#x27;: 4, &#x27;y&#x27;: 5&#125;, &#x27;__init__&#x27;: &lt;function Point.__init__ at 0x0000020670D288C8&gt;, &#x27;show&#x27;: &lt;function Point.show at 0x0000020670D28950&gt;, &#x27;__getattr__&#x27;: &lt;function Point.__getattr__ at 0x0000020670D289D8&gt;, &#x27;__setattr__&#x27;: &lt;function Point.__setattr__ at 0x0000020670D28A60&gt;, &#x27;__delattr__&#x27;: &lt;function Point.__delattr__ at 0x0000020670D28AE8&gt;, &#x27;__doc__&#x27;: None&#125;</span></span><br></pre></td></tr></table></figure><br>上例中，<code>__delattr__</code>可以<code>拦截通过实例对其属性的删除操作</code>，但是通过类依然可以删除属性。</p>
<p><code>__getattribute__</code>例子“<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span>:</span></span><br><span class="line">    n = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>(<span class="params">Base</span>):</span></span><br><span class="line">    z = <span class="number">6</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, x, y</span>):</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(self.x, self.y)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span>(<span class="params">self, item</span>):</span> <span class="comment"># 都找不到是调用此方法</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;missing &#123;&#125;&quot;</span>.<span class="built_in">format</span>(item)</span><br><span class="line">        <span class="comment"># return self.d[item]</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattribute__</span>(<span class="params">self, item</span>):</span> <span class="comment"># 通过实例访问，先走此处</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;getattribute-&#x27;</span>+ item</span><br><span class="line">        <span class="comment"># return object.__getattribute__(self, item)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p1 = Point(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">print(p1.x)</span><br><span class="line">print(p1.z)</span><br><span class="line">print(p1.n)</span><br><span class="line">print(Point.z)</span><br><span class="line"></span><br><span class="line"><span class="comment"># getattribute-x</span></span><br><span class="line"><span class="comment"># getattribute-z</span></span><br><span class="line"><span class="comment"># getattribute-n</span></span><br><span class="line"><span class="comment"># 6</span></span><br></pre></td></tr></table></figure><br><code>__getattribute__</code>方法中为了避免在该方法中无限的递归，它的实现应该永远调用基类的同名方法以访问需要的任何属性，例如<code>object.__getattribute__(self, item)</code> 如果使用<code>self.__dict__[item]</code>还会先进入<code>__getattribute__</code>查找，这样就会形成死循环，所以应该避免这种情况发生。</p>
<p>提示：除非你明确知道<code>__getattribute__</code>方法用来做什么，否则不要使用它。</p>
<p>当时用<code>__getattribute__</code>时查找顺序：<code>__getattribute__-&gt;instance.__dict__-&gt;instance.__class__.dict-&gt;祖先类(直到object)的__dict__-&gt;都没有调用__getattr__</code>。</p>
<h4 id="描述器"><a href="#描述器" class="headerlink" title="描述器"></a>描述器</h4><p>描述器用到3个魔术方法：  </p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">方法</th>
<th style="text-align:left">意义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>__get__(self, instance, owner)</code></td>
<td style="text-align:left">通过<code>owner类</code>或owner的实例<code>instance</code>，访问<code>owner类属性</code>，而<code>这个类属性指向当前类的实例</code>时，调用该方法。</td>
</tr>
<tr>
<td style="text-align:center"><code>__set__(self, instance, value)</code></td>
<td style="text-align:left">通过调用类的实例访问调用类的属性且这个属性指向描述器，那么就调用该方法。简单记就是<code>instance</code>不能是<code>None</code>。</td>
</tr>
<tr>
<td style="text-align:center"><code>__delete__(self, instance)</code></td>
<td style="text-align:left">同<code>__set__</code>一样。</td>
</tr>
</tbody>
</table>
</div>
<p>参数解释：<br><code>self</code>指当前实例，调用者；<br><code>instance</code>指<code>owner</code>的实例；<br><code>owner</code>是属性的所属类；  </p>
<p>先来看下面程序：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;A.init&#x27;</span>)</span><br><span class="line">        self.a1 = <span class="string">&#x27;a1&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>:</span></span><br><span class="line">    x = A() <span class="comment"># x-&gt;A()</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;B.init&#x27;</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">20</span>)</span><br><span class="line">print(B.x.a1) </span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">20</span>)</span><br><span class="line">b = B()</span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">20</span>)</span><br><span class="line">print(b.x.a1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># A.init</span></span><br><span class="line"><span class="comment"># --------------------</span></span><br><span class="line"><span class="comment"># a1</span></span><br><span class="line"><span class="comment"># --------------------</span></span><br><span class="line"><span class="comment"># B.init</span></span><br><span class="line"><span class="comment"># --------------------</span></span><br><span class="line"><span class="comment"># a1</span></span><br></pre></td></tr></table></figure><br>上例，可以看出执行的先后顺序：<br>类加载的时候，类变量需要先生成，而类B的x属性是类A的实例，所以类A先初始化，所以打印<code>A.init</code>。即执行类B的<code>x = A()</code>，<code>A()</code>执行时初始化<code>__init__</code>，打印了<code>A.init</code>。然后执行到<code>print(&#39;-&#39; * 20)</code>，之后<code>print(B.x.a1)</code>，然后<code>b = B()</code>类B实例化生成b，打印<code>B.init</code>，再<code>print(&#39;-&#39; * 20)</code>，之后<code>print(b.x.a1)</code>，这句会查找类属性<code>b.x</code>，指向<code>A()</code>A实例，所以返回A实例的属性<code>a1</code>的值。</p>
<p>上面程序执行流程看懂了，再看下面程序，对类A做一些改造，比如在类A中实现<code>__get__</code>方法，看看变化：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;A.init&#x27;</span>)</span><br><span class="line">        self.a1 = <span class="string">&#x27;a1&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span>(<span class="params">self, instance, owner</span>):</span></span><br><span class="line">        print(<span class="string">&quot;A.__get__ &#123;&#125;, &#123;&#125;, &#123;&#125;&quot;</span>.<span class="built_in">format</span>(self, instance, owner))</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>:</span></span><br><span class="line">    x = A() <span class="comment"># x-&gt;A()</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;B.init&#x27;</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">20</span>)</span><br><span class="line">print(B.x) <span class="comment"># __get__返回None</span></span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">20</span>)</span><br><span class="line">b = B()</span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">20</span>)</span><br><span class="line">print(b.x) <span class="comment"># __get__返回None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># A.init</span></span><br><span class="line"><span class="comment"># --------------------</span></span><br><span class="line"><span class="comment"># A.__get__ &lt;__main__.A object at 0x000002521F9311D0&gt;, None, &lt;class &#x27;__main__.B&#x27;&gt;</span></span><br><span class="line"><span class="comment"># None</span></span><br><span class="line"><span class="comment"># --------------------</span></span><br><span class="line"><span class="comment"># B.init</span></span><br><span class="line"><span class="comment"># --------------------</span></span><br><span class="line"><span class="comment"># A.__get__ &lt;__main__.A object at 0x000002521F9311D0&gt;, &lt;__main__.B object at 0x000002521F931208&gt;, &lt;class &#x27;__main__.B&#x27;&gt;</span></span><br><span class="line"><span class="comment"># None</span></span><br></pre></td></tr></table></figure><br>上例，因为定义了<code>__get__</code>方法，类A就是一个<code>描述器</code>，不过只定义了<code>__get__</code>，所以是<code>非数据描述器</code>，通过类B、类B的实例b，访问类B的属性x时，成为对类A的实例的访问，就会调用描述器的<code>__get__</code>方法。</p>
<p>上例中，访问B类属性x，返回的是None，这样就不能通过B类属性x来访问<code>a1</code>属性了。</p>
<p>上例中，<code>__get__</code>的三个参数：<code>self</code>是当前类的实例（<code>A()</code>），<code>instance</code>是调用者实例（<code>b</code>），<code>owner</code>是调用者的类（<code>B</code>）。注意<code>instance</code>在类调用时没有实例，所以是<code>None</code>。</p>
<p>描述器拦截对类属性的访问，不管是通过类访问，还是通过类的实例访问。</p>
<p>如何解决不能访问<code>a1</code>的问题呢？问题来自<code>__get__</code>方法，只需把正确的值返回即可。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;A.init&#x27;</span>)</span><br><span class="line">        self.a1 = <span class="string">&#x27;a1&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span>(<span class="params">self, instance, owner</span>):</span></span><br><span class="line">        print(<span class="string">&quot;A.__get__ &#123;&#125;, &#123;&#125;, &#123;&#125;&quot;</span>.<span class="built_in">format</span>(self, instance, owner))</span><br><span class="line">        <span class="keyword">return</span> self <span class="comment"># 解决返回None的问题</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>:</span></span><br><span class="line">    x = A() <span class="comment"># x-&gt;A()</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;B.init&#x27;</span>)</span><br><span class="line"></span><br><span class="line">print(B.x.a1)</span><br><span class="line">print(b.x.a1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># a1</span></span><br><span class="line"><span class="comment"># a1</span></span><br></pre></td></tr></table></figure></p>
<p>上面发现访问<code>类属性</code>时，这个属性指向一个描述器，就会调用描述器的<code>__get__</code>方法，那么换成<code>类的实例属性</code>会这样吗？<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;A.init&#x27;</span>)</span><br><span class="line">        self.a1 = <span class="string">&#x27;a1&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span>(<span class="params">self, instance, owner</span>):</span></span><br><span class="line">        print(<span class="string">&quot;A.__get__ &#123;&#125;, &#123;&#125;, &#123;&#125;&quot;</span>.<span class="built_in">format</span>(self, instance, owner))</span><br><span class="line">        <span class="keyword">return</span> self </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;B.init&#x27;</span>)</span><br><span class="line">        self.k = A()</span><br><span class="line">b = B()</span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">20</span>)</span><br><span class="line">print(b.k) <span class="comment"># 走__get__方法吗？不走</span></span><br><span class="line">print(b.k.a1) <span class="comment"># 走__get__方法吗？不走</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># B.init</span></span><br><span class="line"><span class="comment"># A.init</span></span><br><span class="line"><span class="comment"># --------------------</span></span><br><span class="line"><span class="comment"># &lt;__main__.A object at 0x00000283651F12B0&gt;</span></span><br><span class="line"><span class="comment"># a1</span></span><br></pre></td></tr></table></figure><br>上例可知，换成<code>类的实例属性</code>，并不走<code>__get__</code>方法。也就是说，只有<code>类属性</code>才行。</p>
<h5 id="描述器的分类"><a href="#描述器的分类" class="headerlink" title="描述器的分类"></a>描述器的分类</h5><p>Python中，一个类实现了 <code>__get__</code> 、 <code>__set__</code> 、 <code>__delete__</code> 三个方法中的任何一个方法，就是描述器。实现这三个中的某些方法，就支持了描述器协议。</p>
<p>如果仅实现了 <code>__get__</code> ，就是<code>非数据描述符（non-data descriptor）</code>。<br>同时实现了 <code>__get__</code> 、 <code>__set__</code> 就是<code>数据描述符 （data descriptor）</code>。</p>
<p>如果一个类的<code>类属性</code>设置为<code>描述器实例</code>，那么它被称为<code>owner属主</code>。前面例子中类B就是属主，类A就是描述器。<br>当该类的<code>类属性</code>被查找、设置、删除时，就会调用描述器相应的方法。</p>
<h5 id="属性的访问顺序"><a href="#属性的访问顺序" class="headerlink" title="属性的访问顺序"></a>属性的访问顺序</h5><p>当实例和类有相同属性（类属性指向描述器）时，先访问谁呢？<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只有__get__是非数据描述符</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;A.init&#x27;</span>)</span><br><span class="line">        self.a1 = <span class="string">&#x27;a1&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span>(<span class="params">self, instance, owner</span>):</span></span><br><span class="line">        print(<span class="string">&quot;A.__get__ &#123;&#125;, &#123;&#125;, &#123;&#125;&quot;</span>.<span class="built_in">format</span>(self, instance, owner))</span><br><span class="line">        <span class="keyword">return</span> self <span class="comment"># 返回A()</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>:</span></span><br><span class="line">    x = A() <span class="comment"># x-&gt;A()</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;B.init&#x27;</span>)</span><br><span class="line">        self.x = <span class="string">&#x27;b.x&#x27;</span> <span class="comment"># 实例属性不走描述器，所以这里用普通属性即可</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">20</span>)</span><br><span class="line">print(B.x) <span class="comment"># __get__返回None</span></span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">20</span>)</span><br><span class="line">print(B.x.a1)</span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">20</span>)</span><br><span class="line">b = B()</span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">20</span>)</span><br><span class="line">print(b.x) <span class="comment"># 先访问实例字典还是数据描述符呢？实例字典</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># A.__get__ &lt;__main__.A object at 0x000001D4FFE51240&gt;, None, &lt;class &#x27;__main__.B&#x27;&gt;</span></span><br><span class="line"><span class="comment"># &lt;__main__.A object at 0x000001D4FFE51240&gt;</span></span><br><span class="line"><span class="comment"># --------------------</span></span><br><span class="line"><span class="comment"># A.__get__ &lt;__main__.A object at 0x000001D4FFE51240&gt;, None, &lt;class &#x27;__main__.B&#x27;&gt;</span></span><br><span class="line"><span class="comment"># a1</span></span><br><span class="line"><span class="comment"># --------------------</span></span><br><span class="line"><span class="comment"># B.init</span></span><br><span class="line"><span class="comment"># --------------------</span></span><br><span class="line"><span class="comment"># b.x</span></span><br></pre></td></tr></table></figure><br>上例可知，先访问的是实例字典。优先级：<code>实例字典-&gt;非数据描述符</code></p>
<p>为类A增加<code>__set__</code>方法：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;A.init&#x27;</span>)</span><br><span class="line">        self.a1 = <span class="string">&#x27;a1&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span>(<span class="params">self, instance, owner</span>):</span> <span class="comment"># instance可以是None，可以通过类进入</span></span><br><span class="line">        print(<span class="string">&quot;A.__get__ &#123;&#125;, &#123;&#125;, &#123;&#125;&quot;</span>.<span class="built_in">format</span>(self, instance, owner))</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span>(<span class="params">self, instance, value</span>):</span><span class="comment"># instance不能是None，不能通过类进入</span></span><br><span class="line">        print(<span class="string">&quot;A.__set__ &#123;&#125;, &#123;&#125;, &#123;&#125;&quot;</span>.<span class="built_in">format</span>(self, instance, value))</span><br><span class="line">        self.data = value</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>:</span></span><br><span class="line">    x = A()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;B.init&#x27;</span>)</span><br><span class="line">        <span class="comment"># 数据描述符&gt;实例字典&gt;非数据描述符</span></span><br><span class="line">        <span class="comment"># 有__get__和__set__方法是数据描述符，所以b.x先访问的是类B的x，即数据描述器</span></span><br><span class="line">        <span class="comment"># 由于是赋值，走__set__，但是没有把&#x27;a&#x27;赋值给b.x，所以b字典没有x属性;&#x27;a&#x27;给b.x指向的A()的data属性了</span></span><br><span class="line">        self.x = <span class="string">&#x27;a&#x27;</span> <span class="comment"># b.x-&gt;A()-&gt;set</span></span><br><span class="line">        <span class="comment"># self.c不指向描述器，所以正常给b实例属性赋值，写入实例字典</span></span><br><span class="line">        self.c = <span class="string">&#x27;c&#x27;</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">20</span>)</span><br><span class="line">b = B()</span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">20</span>)</span><br><span class="line">print(B.x.__dict__) <span class="comment"># 查看x指向的A()的属性字典</span></span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">20</span>)</span><br><span class="line">print(b.__dict__) <span class="comment"># 查看b实例的属性字典</span></span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">20</span>)</span><br><span class="line">print(b.x.a1) <span class="comment"># 相当于访问B类的x属性的A()的a1属性</span></span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">20</span>)</span><br><span class="line">print(b.x.data) <span class="comment"># 相当于访问B类的x属性的A()的data属性</span></span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">20</span>)</span><br><span class="line">print(b.c) <span class="comment"># b.c不指向描述器，所以访问先访问自己字典</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># A.init</span></span><br><span class="line"><span class="comment"># --------------------</span></span><br><span class="line"><span class="comment"># B.init</span></span><br><span class="line"><span class="comment"># A.__set__ &lt;__main__.A object at 0x000001B8A1B874A8&gt;, &lt;__main__.B object at 0x000001B8A1B91240&gt;, a</span></span><br><span class="line"><span class="comment"># --------------------</span></span><br><span class="line"><span class="comment"># A.__get__ &lt;__main__.A object at 0x000001B8A1B874A8&gt;, None, &lt;class &#x27;__main__.B&#x27;&gt;</span></span><br><span class="line"><span class="comment"># &#123;&#x27;a1&#x27;: &#x27;a1&#x27;, &#x27;data&#x27;: &#x27;a&#x27;&#125;</span></span><br><span class="line"><span class="comment"># --------------------</span></span><br><span class="line"><span class="comment"># &#123;&#x27;c&#x27;: &#x27;c&#x27;&#125;</span></span><br><span class="line"><span class="comment"># --------------------</span></span><br><span class="line"><span class="comment"># A.__get__ &lt;__main__.A object at 0x000001B8A1B874A8&gt;, &lt;__main__.B object at 0x000001B8A1B91240&gt;, &lt;class &#x27;__main__.B&#x27;&gt;</span></span><br><span class="line"><span class="comment"># a1</span></span><br><span class="line"><span class="comment"># --------------------</span></span><br><span class="line"><span class="comment"># A.__get__ &lt;__main__.A object at 0x000001B8A1B874A8&gt;, &lt;__main__.B object at 0x000001B8A1B91240&gt;, &lt;class &#x27;__main__.B&#x27;&gt;</span></span><br><span class="line"><span class="comment"># a</span></span><br><span class="line"><span class="comment"># --------------------</span></span><br><span class="line"><span class="comment"># c</span></span><br></pre></td></tr></table></figure><br>上例中，类A有<code>__get__</code>和<code>__set__</code>方法是数据描述符，访问顺序可以推断出是：<code>数据描述符&gt;实例字典&gt;非数据描述符</code>。</p>
<p>上例中，类B实例化时，通过实例b给x赋值，由于类B中也有同样的x属性且指向<code>A()</code>，所以根据访问顺序可知，先访问<code>数据描述符</code>，赋值使用<code>__set__</code>的方法。</p>
<p>思考：通过类、类的实例给x属性赋值都走<code>__set__</code>吗：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">20</span>)</span><br><span class="line">b = B()</span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">20</span>)</span><br><span class="line"><span class="comment"># 通过类的实例b给x赋值</span></span><br><span class="line">b.x = <span class="number">500</span> <span class="comment"># b.x指向描述器，走__set__，所以500给了A().data</span></span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">20</span>)</span><br><span class="line">print(B.x.__dict__)</span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">20</span>)</span><br><span class="line">print(b.__dict__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># A.init</span></span><br><span class="line"><span class="comment"># --------------------</span></span><br><span class="line"><span class="comment"># B.init</span></span><br><span class="line"><span class="comment"># A.__set__ &lt;__main__.A object at 0x000002E45E5411D0&gt;, &lt;__main__.B object at 0x000002E45E541278&gt;, a</span></span><br><span class="line"><span class="comment"># --------------------</span></span><br><span class="line"><span class="comment"># A.__set__ &lt;__main__.A object at 0x000002E45E5411D0&gt;, &lt;__main__.B object at 0x000002E45E541278&gt;, 500</span></span><br><span class="line"><span class="comment"># --------------------</span></span><br><span class="line"><span class="comment"># A.__get__ &lt;__main__.A object at 0x000002E45E5411D0&gt;, None, &lt;class &#x27;__main__.B&#x27;&gt;</span></span><br><span class="line"><span class="comment"># &#123;&#x27;a1&#x27;: &#x27;a1&#x27;, &#x27;data&#x27;: 500&#125;</span></span><br><span class="line"><span class="comment"># --------------------</span></span><br><span class="line"><span class="comment"># &#123;&#x27;c&#x27;: &#x27;c&#x27;&#125;</span></span><br></pre></td></tr></table></figure><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">20</span>)</span><br><span class="line">b = B()</span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">20</span>)</span><br><span class="line"><span class="comment"># 通过类给x赋值</span></span><br><span class="line">B.x = <span class="number">600</span> <span class="comment"># 虽然B.x指向描述器，但不走__set__，所以是赋值即定义，600给了B.x，覆盖了A()</span></span><br><span class="line">print(B.x)</span><br><span class="line"></span><br><span class="line"><span class="comment"># A.init</span></span><br><span class="line"><span class="comment"># --------------------</span></span><br><span class="line"><span class="comment"># B.init</span></span><br><span class="line"><span class="comment"># A.__set__ &lt;__main__.A object at 0x0000021F080C11D0&gt;, &lt;__main__.B object at 0x0000021F080C1278&gt;, a</span></span><br><span class="line"><span class="comment"># --------------------</span></span><br><span class="line"><span class="comment"># 600</span></span><br></pre></td></tr></table></figure><br>总结：  </p>
<ul>
<li>首先必须是<code>类属性，指向一个描述器</code>。  </li>
<li><code>__get__</code>方法：通过类（B.x）、类的实例（b.x）指向描述器时，访问是走<code>__get__</code>的。</li>
<li><code>__set__</code>方法：通过类（B.x）指向描述器，走赋值即定义，不走<code>__set__</code>；通过类的实例（b.x）指向描述器，给其赋值走<code>__set__</code>。</li>
<li>相当于<code>__set__</code>的<code>instance</code>不能是<code>None</code>，<code>__get__</code>的<code>instance</code>可以是<code>None</code>。</li>
</ul>
<p><code>__delete__</code>同<code>__set__</code>一样，只能通过调用类的实例访问：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;A.init&#x27;</span>)</span><br><span class="line">        self.a1 = <span class="string">&#x27;a1&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span>(<span class="params">self, instance, owner</span>):</span> <span class="comment"># instance可以是None，可以通过类进入</span></span><br><span class="line">        print(<span class="string">&quot;A.__get__ &#123;&#125;, &#123;&#125;, &#123;&#125;&quot;</span>.<span class="built_in">format</span>(self, instance, owner))</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span>(<span class="params">self, instance, value</span>):</span><span class="comment"># instance不能是None，不能通过类进入</span></span><br><span class="line">        print(<span class="string">&quot;A.__set__ &#123;&#125;, &#123;&#125;, &#123;&#125;&quot;</span>.<span class="built_in">format</span>(self, instance, value))</span><br><span class="line">        self.data = value</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__delete__</span>(<span class="params">self, instance</span>):</span></span><br><span class="line">        print(<span class="string">&quot;A.__delete__ &#123;&#125;, &#123;&#125;&quot;</span>.<span class="built_in">format</span>(self, instance))</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>:</span></span><br><span class="line">    x = A()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;B.init&#x27;</span>)</span><br><span class="line">        self.x = <span class="string">&#x27;a&#x27;</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">20</span>)</span><br><span class="line">b = B()</span><br><span class="line">print(<span class="string">&#x27;-&#x27;</span> * <span class="number">20</span>)</span><br><span class="line"><span class="keyword">del</span> b.x</span><br><span class="line"></span><br><span class="line"><span class="comment"># A.init</span></span><br><span class="line"><span class="comment"># --------------------</span></span><br><span class="line"><span class="comment"># B.init</span></span><br><span class="line"><span class="comment"># A.__set__ &lt;__main__.A object at 0x00000266611E1240&gt;, &lt;__main__.B object at 0x00000266611E12E8&gt;, a</span></span><br><span class="line"><span class="comment"># --------------------</span></span><br><span class="line"><span class="comment"># A.__delete__ &lt;__main__.A object at 0x00000266611E1240&gt;, &lt;__main__.B object at 0x00000266611E12E8&gt;</span></span><br></pre></td></tr></table></figure></p>
<h5 id="Python中的描述器"><a href="#Python中的描述器" class="headerlink" title="Python中的描述器"></a>Python中的描述器</h5><p>描述器在Python中应用非常广泛。</p>
<p>Python中<code>staticmethod()</code>和<code>classmethod()</code>都通过<code>非数据描述器</code>实现的，用了这两个方法，实例也可以重新定义和覆盖方法。这允许单个实例获取与同一类的其他实例不同的行为。</p>
<p><code>property()</code>函数通过<code>数据描述器</code>实现的，用了这个方法，实例不能重新定义和覆盖方法。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下面foo、bar都可以通过实例覆盖，但是z不可以</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line"><span class="meta">    @classmethod  # 非数据描述器</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">foo</span>(<span class="params">cls</span>):</span> print(<span class="string">&#x27;foo&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod  # 非数据描述器</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">bar</span>():</span>print(<span class="string">&#x27;bar&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property  # 数据描述器</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">z</span>(<span class="params">self</span>):</span>print(<span class="string">&#x27;z&#x27;</span>)</span><br><span class="line"></span><br><span class="line">a = A()</span><br><span class="line">a.foo = <span class="keyword">lambda</span> :print(<span class="string">&#x27;new foo&#x27;</span>) <span class="comment"># 能被覆盖</span></span><br><span class="line">a.bar = <span class="keyword">lambda</span> :print(<span class="string">&#x27;new bar&#x27;</span>) <span class="comment"># 能被覆盖</span></span><br><span class="line"><span class="comment"># a.z = lambda :print(&#x27;new z&#x27;) # 不能被覆盖</span></span><br><span class="line">a.foo()</span><br><span class="line">a.bar()</span><br><span class="line">a.z</span><br><span class="line"></span><br><span class="line"><span class="comment"># new foo</span></span><br><span class="line"><span class="comment"># new bar</span></span><br><span class="line"><span class="comment"># z</span></span><br></pre></td></tr></table></figure></p>
<h5 id="练习-1"><a href="#练习-1" class="headerlink" title="练习"></a>练习</h5><ol>
<li><p>实现<code>StaticMethod</code>装饰器，完成<code>staticmethod</code>装饰器的功能。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StaticMethod</span>:</span><span class="comment"># 开头大写，防止命名冲突</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, fn</span>):</span></span><br><span class="line">        self._fn = fn</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span>(<span class="params">self, instance, owner</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self._fn</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line"><span class="meta">    @StaticMethod</span></span><br><span class="line">    <span class="comment"># stmtd = StaticMethod(stmtd) 非数据描述符</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">stmtd</span>():</span></span><br><span class="line">        print(<span class="string">&#x27;static method&#x27;</span>)</span><br><span class="line"></span><br><span class="line">A.stmtd()</span><br><span class="line">A().stmtd()</span><br><span class="line"></span><br><span class="line"><span class="comment"># static method</span></span><br><span class="line"><span class="comment"># static method</span></span><br></pre></td></tr></table></figure>
<p>静态方法不需要传参，那么只需要在<code>__get__</code>方法拦截后，仅仅返回方法本身即可。  </p>
</li>
<li><p>实现<code>ClassMethod</code>装饰器，完成<code>classmethod</code>装饰器的功能。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClassMethod</span>:</span><span class="comment"># 开头大写，防止命名冲突</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, fn</span>):</span></span><br><span class="line">        self._fn = fn</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span>(<span class="params">self, instance, owner</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self._fn(owner) <span class="comment"># 相当于返回了函数的执行结果</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line"><span class="meta">    @ClassMethod</span></span><br><span class="line">    <span class="comment"># clsmtd = ClassMethod(clsmtd) 非数据描述符</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clsmtd</span>(<span class="params">cls</span>):</span></span><br><span class="line">        print(cls.__name__)</span><br><span class="line"></span><br><span class="line">print(A.clsmtd) <span class="comment"># 返回的是None</span></span><br><span class="line"><span class="comment"># A.clsmtd() # 报错如何修改?</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># A</span></span><br><span class="line"><span class="comment"># None</span></span><br></pre></td></tr></table></figure>
<p>如何处理调用问题呢？使用偏函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClassMethod</span>:</span><span class="comment"># 开头大写，防止命名冲突</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, fn</span>):</span></span><br><span class="line">        self._fn = fn</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span>(<span class="params">self, instance, owner</span>):</span></span><br><span class="line">        <span class="comment"># 偏函数返回固定了一个cls参数的newfunc，这样就可以调用了</span></span><br><span class="line">        <span class="keyword">return</span> partial(self._fn,owner)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line"><span class="meta">    @ClassMethod</span></span><br><span class="line">    <span class="comment"># clsmtd = ClassMethod(clsmtd) 非数据描述符</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clsmtd</span>(<span class="params">cls</span>):</span></span><br><span class="line">        print(cls.__name__)</span><br><span class="line"></span><br><span class="line">print(A.clsmtd)</span><br><span class="line">A.clsmtd() <span class="comment"># 可以调用了，相当于newfunc()</span></span><br><span class="line">A().clsmtd() <span class="comment"># 可以调用了，newfunc()</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># functools.partial(&lt;function A.clsmtd at 0x00000225BEFA2268&gt;, &lt;class &#x27;__main__.A&#x27;&gt;)</span></span><br><span class="line"><span class="comment"># A</span></span><br><span class="line"><span class="comment"># A</span></span><br></pre></td></tr></table></figure>
<p>类方法由于默认会把类当作参数传递，所以需要把方法的第一个参数固定为类，所以使用偏函数来固定，是一个比较好的办法，又或者使用lambda，由于lambda函数只能接受一个参数，所以当类方法是多个参数时，无法接受。</p>
</li>
<li><p>对实例的数据进行效验。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name:<span class="built_in">str</span>, age:<span class="built_in">int</span></span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br></pre></td></tr></table></figure>
<p>对上面的类的实例的属性name、age进行数据效验。</p>
</li>
</ol>
<p>思路：</p>
<p>1.&ensp;写函数，直接在<code>__init__</code>中检查，如果不符合直接抛出异常(一般人都会)<br>2.&ensp;装饰器(多数人会)<br>3.&ensp;描述器(少数人会)<br>4.&ensp;描述器+函数装饰器(基本没人会)<br>5.&ensp;描述器+类装饰器(基本没人会)</p>
<p>第一种，写函数，在<code>__init__</code>中检查，如果不合格，直接抛异常：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name:<span class="built_in">str</span>, age:<span class="built_in">int</span></span>):</span></span><br><span class="line">        <span class="comment"># 每次都判断，然后赋值</span></span><br><span class="line">        <span class="comment"># if self._typecheck(name,str):</span></span><br><span class="line">        <span class="comment">#     self.name = name</span></span><br><span class="line">        <span class="comment"># if self._typecheck(age, int):</span></span><br><span class="line">        <span class="comment">#     self.age = age</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 或者直接构建需要的数据类型，一次性判断，最后赋值</span></span><br><span class="line">        params = [(name,<span class="built_in">str</span>),(age,<span class="built_in">int</span>)]</span><br><span class="line">        <span class="keyword">for</span> param <span class="keyword">in</span> params:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> self._typecheck(*param):</span><br><span class="line">                <span class="keyword">raise</span> TypeError(param[<span class="number">0</span>])</span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_typecheck</span>(<span class="params">self,value,typ</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(value, typ):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(value)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">tom = Person(<span class="string">&#x27;tom&#x27;</span>, <span class="number">20</span>)</span><br><span class="line"><span class="comment"># jerry = Person(20,&#x27;jerry&#x27;) # 报错，检测不符合</span></span><br></pre></td></tr></table></figure><br>这种方法耦合度太高，而且不能复用，在初始化阶段做了大量逻辑判断，太丑。</p>
<p>第二种，装饰器：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">TypeCheck</span>(<span class="params">cls</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">*args, **kwargs</span>):</span></span><br><span class="line">        sig = inspect.signature(cls)  <span class="comment"># 获取签名对象</span></span><br><span class="line">        param = sig.parameters.values()  <span class="comment"># 抽取签名信息(有序)</span></span><br><span class="line">        data = <span class="built_in">zip</span>(args, param)  <span class="comment"># 构建值与类型的元组</span></span><br><span class="line">        <span class="keyword">for</span> value, typ <span class="keyword">in</span> data:</span><br><span class="line">            <span class="keyword">if</span> typ.annotation != inspect._empty:  <span class="comment"># 当定义了参数注解时，开始参数判断</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(value, typ.annotation):</span><br><span class="line">                    <span class="keyword">raise</span> TypeError(value)  <span class="comment"># 判断不通过，抛出异常</span></span><br><span class="line">        <span class="keyword">return</span> cls(*args, **kwargs)</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@TypeCheck # Person = TypeCheck(Person)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,name:<span class="built_in">str</span>, age:<span class="built_in">int</span></span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">tom = Person(<span class="string">&#x27;tom&#x27;</span>, <span class="number">20</span>)<span class="comment"># Person(&#x27;tom&#x27;, 20)-&gt;TypeCheck(Person)(&#x27;tom&#x27;, 20)</span></span><br><span class="line"><span class="comment"># jerry = Person(20,&#x27;jerry&#x27;) # 报错，检测不符合</span></span><br></pre></td></tr></table></figure><br>看起来很好的解决了类型检查，而且装饰器可以跟根据类的变动而动态检测，很灵活。</p>
<p>第三种，描述器：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TypeCheck</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name, typ</span>):</span></span><br><span class="line">        self.name = name <span class="comment"># 记录当前参数名</span></span><br><span class="line">        self.typ = typ  <span class="comment"># 记录当前参数类型</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span>(<span class="params">self, instance, owner</span>):</span></span><br><span class="line">        <span class="keyword">return</span> instance.__dict__[self.name]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span>(<span class="params">self, instance, value</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(value,self.typ):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(value)</span><br><span class="line">        instance.__dict__[self.name] = value</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    name = TypeCheck(<span class="string">&#x27;name&#x27;</span>,<span class="built_in">str</span>) <span class="comment"># 硬编码</span></span><br><span class="line">    age = TypeCheck(<span class="string">&#x27;age&#x27;</span>,<span class="built_in">int</span>) <span class="comment"># 硬编码</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name:<span class="built_in">str</span>, age:<span class="built_in">int</span></span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line"></span><br><span class="line">tom = Person(<span class="string">&#x27;tom&#x27;</span>, <span class="number">20</span>)</span><br><span class="line"><span class="comment"># jerry = Person(20,&#x27;jerry&#x27;) # 报错，检测不符合</span></span><br></pre></td></tr></table></figure><br>第四种，描述器+函数装饰器：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TypeCheck</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name, typ</span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.typ = typ</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span>(<span class="params">self, instance, owner</span>):</span></span><br><span class="line">        <span class="keyword">return</span> instance.__dict__[self.name]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span>(<span class="params">self, instance, value</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(value,self.typ):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(value)</span><br><span class="line">        instance.__dict__[self.name] = value</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 动态注入name，age描述器属性</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">AttriCheck</span>(<span class="params">cls:<span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">*args,**kwargs</span>):</span></span><br><span class="line">        sig = inspect.signature(cls)</span><br><span class="line">        params = sig.parameters</span><br><span class="line">        <span class="keyword">for</span> name,typ <span class="keyword">in</span> params.items():</span><br><span class="line">            <span class="comment"># print(v.annotation) # 当前参数类型</span></span><br><span class="line">            <span class="keyword">if</span> typ.annotation != inspect._empty:</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(cls,name):</span><br><span class="line">                    <span class="built_in">setattr</span>(cls,name,TypeCheck(name,typ.annotation))</span><br><span class="line">        <span class="keyword">return</span> cls(*args,**kwargs)</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@AttriCheck  # Person = AttriCheck(Person)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name: <span class="built_in">str</span>, age: <span class="built_in">int</span></span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line"></span><br><span class="line">tom = Person(<span class="string">&#x27;tom&#x27;</span>, <span class="number">20</span>)</span><br><span class="line"><span class="comment"># jerry = Person(20,&#x27;jerry&#x27;) # 报错，检测不符合</span></span><br></pre></td></tr></table></figure><br>本质上，就是用函数装饰器动态的给类中添加描述器，参数检查还是在描述器中做。</p>
<p>第五种，描述器+类装饰器：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TypeCheck</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, attr, typ</span>):</span></span><br><span class="line">        self.attr = attr</span><br><span class="line">        self.typ = typ</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span>(<span class="params">self, instance, owner</span>):</span></span><br><span class="line">        <span class="keyword">return</span> instance.__dict__[self.attr]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span>(<span class="params">self, instance, value</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(value,self.typ):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(value)</span><br><span class="line">        instance.__dict__[self.attr] = value</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AttriCheck</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,cls</span>):</span></span><br><span class="line">        self.cls = cls</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        sig = inspect.signature(self.cls)</span><br><span class="line">        params = sig.parameters</span><br><span class="line">        <span class="keyword">for</span> name,typ <span class="keyword">in</span> params.items():</span><br><span class="line">            <span class="keyword">if</span> typ.annotation != inspect._empty:</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(self.cls, name):</span><br><span class="line">                    <span class="built_in">setattr</span>(self.cls,name,TypeCheck(name,typ.annotation))</span><br><span class="line">        <span class="keyword">return</span> self.cls(*args,**kwargs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@AttriCheck  # Person = AttriCheck(Person)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name: <span class="built_in">str</span>, age: <span class="built_in">int</span></span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line"></span><br><span class="line">tom = Person(<span class="string">&#x27;tom&#x27;</span>, <span class="number">20</span>)</span><br><span class="line"><span class="comment"># jerry = Person(20,&#x27;jerry&#x27;) # 报错，检测不符合</span></span><br></pre></td></tr></table></figure></p>

    </div>

    
    
    
      
  <div class="popular-posts-header">相关文章</div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2019\01\09\Python\00.Python-pdb\" rel="bookmark">Python-pdb调试器</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2019\01\11\Python\01.Python-基础语法\" rel="bookmark">Python-基础语法</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2019\01\12\Python\02.Python-列表、元组\" rel="bookmark">Python-列表、元组</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2019\01\13\Python\03.Python-字符串\" rel="bookmark">Python-字符串</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2019\01\14\Python\04.Python-集合\" rel="bookmark">Python-集合</a></div>
    </li>
  </ul>


    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>SoundMemories
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://soundmemories.github.io/2019/01/31/Python/14.Python-%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%BF%9B%E9%98%B6/" title="Python-面向对象-进阶">https://soundmemories.github.io/2019/01/31/Python/14.Python-面向对象进阶/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC8="><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</span> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/Python/" rel="tag"><i class="fa fa-tag"></i> Python</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2019/01/27/Other/Python%E9%A2%98%E5%90%88%E9%9B%86/" rel="prev" title="Python题合集">
                  <i class="fa fa-chevron-left"></i> Python题合集
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2019/02/01/Python/15.Python-%E5%BC%82%E5%B8%B8/" rel="next" title="Python-异常">
                  Python-异常 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






      

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">SoundMemories</span>
</div>
  <div class="powered-by">由 <span class="exturl theme-link" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl theme-link" data-url="aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZy9tdXNlLw==">NexT.Muse</span> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/@next-theme/pjax@0.4.0/pjax.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>
  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '.page-configurations',
    '.main-inner',
    '.post-toc-wrap',
    '.languages',
    '.pjax'
  ],
  analytics: false,
  cacheBust: false,
  scrollRestoration: false,
  scrollTo: !CONFIG.bookmark.enable
});

document.addEventListener('pjax:success', () => {
  pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  const hasTOC = document.querySelector('.post-toc');
  document.querySelector('.sidebar-inner').classList.toggle('sidebar-nav-active', hasTOC);
  document.querySelector(hasTOC ? '.sidebar-nav-toc' : '.sidebar-nav-overview').click();
  NexT.utils.updateSidebarPosition();
});
</script>


  




  <script src="/js/local-search.js"></script>








<script data-pjax>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  const url = element.dataset.target;
  const pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  const pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  const fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>


<script data-pjax>
if (document.querySelectorAll('.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8.8.2/dist/mermaid.min.js', () => {
    mermaid.init({
      theme    : 'neutral',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    }, '.mermaid');
  }, window.mermaid);
}
</script>





  








    <div class="pjax">
  

  
      <script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              const target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    const script = document.createElement('script');
    script.src = '//cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js';
    script.defer = true;
    document.head.appendChild(script);
  } else {
    MathJax.startup.document.state(0);
    MathJax.typesetClear();
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  
  <script src="//cdn.jsdelivr.net/npm/quicklink@2.0.0/dist/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink.listen({
        timeout : 3000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri === 'https://soundmemories.github.io/2019/01/31/Python/14.Python-%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%BF%9B%E9%98%B6/',]
      });
      });
  </script>

    </div>
</body>
</html>
